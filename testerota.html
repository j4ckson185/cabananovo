<!DOCTYPE html>
<html>
<head>
    <title>Teste Rotas Motoboys</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ddd; }
        input, select, textarea { width: 100%; margin: 5px 0; padding: 5px; }
        button { background: #25D366; color: white; padding: 10px; border: none; cursor: pointer; }
        .error { color: red; margin: 10px 0; }
        .success { color: green; margin: 10px 0; }
        #debug { background: #f5f5f5; padding: 10px; margin-top: 20px; font-family: monospace; }
        .endereco-exemplo { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Teste de Rotas - Motoboys</h2>
        
        <div>
            <label>URL da Função:</label>
            <input type="text" id="functionUrl" placeholder="https://rota-motoboys-whatsapp-9573.twil.io/rota">
        </div>

        <div>
            <label>Destinatário:</label>
            <select id="motoboy">
                <option value="Eduardo">Eduardo (84987673202)</option>
                <option value="Gabriel Andrade">Gabriel Andrade (84988529385)</option>
                <option value="Boaz">Boaz (8492090818)</option>
                <option value="Rafael">Rafael (8491472409)</option>
            </select>
        </div>

        <div>
            <label>Endereços (um por linha):</label>
            <div class="endereco-exemplo">Exemplo de formato: Rua Monte Sinai, 123, Potengi</div>
            <textarea id="enderecos" rows="6">Rua Monte Sinai, 123, Potengi
Av. das Fronteiras, 456, N. Sra. Apresentação
Rua João Medeiros, 789, Pajuçara
Av. Itapetinga, 321, Potengi
Rua das Pedras, 654, N. Sra. Apresentação
Av. das Cirandas, 987, Pajuçara</textarea>
        </div>

        <button onclick="testar()">Testar Envio</button>

        <div id="error" class="error" style="display:none"></div>
        <div id="success" class="success" style="display:none"></div>
        <div id="debug"></div>
    </div>

    <script>
        const numerosPorNome = {
            'Eduardo': '+5584987673202',
            'Gabriel Andrade': '+5584988529385',
            'Boaz': '+558492090818',
            'Rafael': '+558491472409'
        };

        function log(msg) {
            const debug = document.getElementById('debug');
            debug.innerHTML += msg + '<br>';
            console.log(msg);
        }

        function showError(msg) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerText = msg;
            document.getElementById('success').style.display = 'none';
        }

        function showSuccess(msg) {
            document.getElementById('success').style.display = 'block';
            document.getElementById('success').innerText = msg;
            document.getElementById('error').style.display = 'none';
        }

        function testar() {
            const debug = document.getElementById('debug');
            debug.innerHTML = '';
            
            try {
                const url = document.getElementById('functionUrl').value;
                if (!url) {
                    throw new Error('Informe a URL da função');
                }

                const motoboy = document.getElementById('motoboy').value;
                const enderecos = document.getElementById('enderecos').value
                    .split('\n')
                    .filter(e => e.trim());

                if (enderecos.length < 6) {
                    throw new Error('Adicione pelo menos 6 endereços');
                }

                log('Iniciando teste...');
                log(`Destinatário: ${motoboy}`);
                log(`Número: whatsapp:${numerosPorNome[motoboy]}`);
                log(`Total de endereços: ${enderecos.length}`);

                // Criar elemento script para JSONP
                const script = document.createElement('script');
                const callbackName = 'callback_' + Date.now();
                
                // Definir callback global
                window[callbackName] = function(response) {
                    if (response.success) {
                        showSuccess('Teste enviado com sucesso! Verifique seu WhatsApp.');
                        log('Resposta: ' + JSON.stringify(response, null, 2));
                    } else {
                        showError(response.error || 'Erro no envio');
                        log('Erro: ' + JSON.stringify(response, null, 2));
                    }
                    // Limpar callback e script
                    delete window[callbackName];
                    document.body.removeChild(script);
                };

                // Construir URL com parâmetros
                const params = new URLSearchParams({
                    test: 'true',
                    motoboy: motoboy,
                    numero: `whatsapp:${numerosPorNome[motoboy]}`,
                    enderecos: JSON.stringify(enderecos),
                    callback: callbackName
                });

                script.src = `${url}?${params.toString()}`;
                document.body.appendChild(script);

                log('Requisição enviada, aguardando resposta...');

            } catch (error) {
                showError(error.message);
                log('Erro: ' + error.message);
            }
        }
    </script>
</body>
</html>
