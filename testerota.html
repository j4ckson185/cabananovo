<!DOCTYPE html>
<html>
<head>
    <title>Teste Rotas Motoboys</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ddd; }
        input, select, textarea { width: 100%; margin: 5px 0; padding: 5px; }
        button { background: #25D366; color: white; padding: 10px; border: none; cursor: pointer; }
        .error { color: red; margin: 10px 0; }
        .success { color: green; margin: 10px 0; }
        #debug { background: #f5f5f5; padding: 10px; margin-top: 20px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Teste de Rotas - Motoboys</h2>
        
        <div>
            <label>URL da Função:</label>
            <input type="text" id="functionUrl" placeholder="URL da sua função Twilio">
        </div>

        <div>
            <label>Motoboy:</label>
            <select id="motoboy">
                <option value="Gabriel Andrade">Gabriel Andrade</option>
                <option value="Boaz">Boaz</option>
                <option value="Rafael">Rafael</option>
            </select>
        </div>

        <div>
            <label>Endereços (um por linha):</label>
            <textarea id="enderecos" rows="6"></textarea>
        </div>

        <button onclick="testar()">Testar Envio</button>

        <div id="error" class="error" style="display:none"></div>
        <div id="success" class="success" style="display:none"></div>
        <div id="debug"></div>
    </div>

    <script>
        function log(msg) {
            const debug = document.getElementById('debug');
            debug.innerHTML += msg + '<br>';
            console.log(msg);
        }

        function showError(msg) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerText = msg;
            document.getElementById('success').style.display = 'none';
        }

        function showSuccess(msg) {
            document.getElementById('success').style.display = 'block';
            document.getElementById('success').innerText = msg;
            document.getElementById('error').style.display = 'none';
        }

        async function testar() {
            const debug = document.getElementById('debug');
            debug.innerHTML = ''; // Limpa logs anteriores
            
            try {
                const url = document.getElementById('functionUrl').value;
                const motoboy = document.getElementById('motoboy').value;
                const enderecos = document.getElementById('enderecos').value
                    .split('\n')
                    .filter(e => e.trim());

                if (!url) {
                    throw new Error('Informe a URL da função');
                }

                if (enderecos.length < 6) {
                    throw new Error('Adicione pelo menos 6 endereços');
                }

                log('Iniciando teste...');
                log(`Motoboy: ${motoboy}`);
                log(`Total de endereços: ${enderecos.length}`);

                // Cria um script tag para JSONP
                const script = document.createElement('script');
                const callback = 'callback_' + Math.floor(Math.random() * 1000000);
                
                window[callback] = function(response) {
                    if (response.success) {
                        showSuccess('Teste enviado com sucesso!');
                        log('Resposta: ' + JSON.stringify(response, null, 2));
                    } else {
                        showError(response.error || 'Erro no envio');
                        log('Erro: ' + JSON.stringify(response, null, 2));
                    }
                    // Limpa o callback
                    delete window[callback];
                    document.body.removeChild(script);
                };

                const params = new URLSearchParams({
                    test: 'true',
                    motoboy: motoboy,
                    callback: callback,
                    enderecos: JSON.stringify(enderecos)
                });

                script.src = `${url}?${params.toString()}`;
                document.body.appendChild(script);

                log('Requisição enviada, aguardando resposta...');

            } catch (error) {
                showError(error.message);
                log('Erro: ' + error.message);
            }
        }
    </script>
</body>
</html>
