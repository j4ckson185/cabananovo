<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabana Açaí</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a0e4e;
            --secondary-color: #8e44ad;
            --background-color: #f5f5f5;
            --text-color: #333;
            --accent-color: #e74c3c;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5em 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 100%;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .cart-icon {
            font-size: 24px;
            cursor: pointer;
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }

        main {
            max-width: 1200px;
            margin: 70px auto 1em;
            padding: 0 20px;
        }

        .categories {
            display: flex;
            overflow-x: auto;
            margin-bottom: 1em;
            padding-bottom: 10px;
            position: sticky;
            top: 60px;
            background-color: var(--background-color);
            z-index: 999;
            padding-top: 12px;
        }

        .category-btn {
            margin-right: 0.5em;
            padding: 0.5em 1em;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }

        .category-btn:hover,
        .category-btn.active {
            background-color: var(--primary-color);
        }

        .search-bar {
            margin-bottom: 20px;
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 40px 12px 20px;
            font-size: 16px;
            border: 2px solid var(--secondary-color);
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .search-bar input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(138, 43, 226, 0.2);
        }

        .search-bar::before {
            content: '\1F50D';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .search-bar {
                width: 90%;
            }

            .search-bar input {
                font-size: 14px;
                padding: 10px 35px 10px 15px;
            }

            .search-bar::before {
                font-size: 18px;
            }
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1em;
        }

        .product-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            cursor: pointer;
        }

        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
        }

        .product-info {
            padding: 1em;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-title {
            margin: 0;
            font-size: 1em;
            color: var(--primary-color);
        }

        .product-description {
            font-size: 0.8em;
            color: #666;
            margin: 0.5em 0;
            flex-grow: 1;
        }

        .product-price {
            font-weight: bold;
            color: var(--secondary-color);
            margin-top: auto;
        }

        .btn {
            display: inline-block;
            padding: 0.5em 1em;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
            text-align: center;
            font-size: 0.9em;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        .btn:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .extras-list {
            margin-top: 1em;
        }

        .extras-list h3 {
            margin-bottom: 0.5em;
        }

        .extras-list ul {
            list-style-type: none;
            padding-left: 0;
        }

        .extras-list li {
            margin-bottom: 0.5em;
        }

        .checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input {
            margin-right: 5px;
        }

        #cartModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-item-remove {
            color: red;
            cursor: pointer;
        }

        .cart-item-details {
    flex-grow: 1;
    text-align: left;
}

.cart-item-details p {
    margin: 5px 0;
}

.indent {
    margin-left: 20px;
}
        .error-message {
            color: red;
            margin-top: 10px;
        }

        #customerIdentificationForm {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #customerIdentificationForm h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #customerIdentificationForm label {
            display: block;
            margin-top: 10px;
            color: var(--secondary-color);
        }

        #customerIdentificationForm input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #customerIdentificationForm .btn {
            margin-top: 20px;
            width: 100%;
        }

        .input-icon {
            position: relative;
        }

        .input-icon i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .input-icon input {
            padding-left: 35px;
            text-align: center;
        }

        #checkoutForm {
            margin-top: 20px;
        }

        #checkoutForm label {
            display: block;
            margin-top: 10px;
        }

        #checkoutForm input,
        #checkoutForm textarea,
        #checkoutForm select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }

        #orderSummary {
            margin-top: 20px;
        }

        .loyalty-info {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .required-field {
            color: red;
        }

        .extras-suggestion {
            background-color: #f0e6ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .extras-suggestion h3 {
            color: #4a0e4e;
            margin-bottom: 15px;
            text-align: center;
        }

        .extra-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .extra-item {
            background-color: white;
            border: 2px solid #8e44ad;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .extra-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .extra-item p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .extra-item.selected {
            background-color: #e6e6fa;
            border-color: #4a0e4e;
            transform: scale(1.05);
        }

        #comboModal .modal-content {
            max-width: 800px;
        }

        .combo-step {
            margin-bottom: 20px;
        }

        .combo-options {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .combo-option {
            background-color: #fff;
            border: 2px solid #8e44ad;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .combo-option:hover,
        .combo-option.selected {
            background-color: #e6e6fa;
            border-color: #4a0e4e;
            transform: scale(1.05);
        }

        .combo-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .combo-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .combo-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .combo-item.selected {
            border-color: #4a0e4e;
            background-color: #e6e6fa;
        }

        #comboSummary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }

        .user-options {
            display: flex;
            justify-content: center;
            margin-top: 25px;
            margin-bottom: 20px;
            padding-top: 15px;
        }

        .user-options .btn {
            margin: 0 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        #loadingOverlay div {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }
    </style>
</head>
<body>
    <header id="mainHeader">
        <div class="header-content">
            <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana Açaí Logo" class="logo">
            <h1>Cabana Açaí</h1>
            <div class="cart-icon" onclick="window.openCart()">
    🛒
    <span class="cart-count" id="cartCount">0</span>
</div>
        </div>
    </header>
    <main>
        <div class="user-options">
            <button class="btn" onclick="openMyOrders()">Meus Pedidos</button>
            <button class="btn" onclick="openComboBuilder()">Montar Combo</button>
            <button class="btn" onclick="openLoyaltyProgram()">Programa Fidelidade</button>
        </div>
        <div id="categoriesContainer" class="categories"></div>
        <div class="store-hours">
            Aberta de Quarta à Domingo, de 12:30h às 22:30h
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="O que você quer comer hoje?" onkeyup="searchProducts()">
        </div>
        <div class="product-grid" id="productGrid"></div>
    </main>
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Seu Carrinho</h2>
            <div id="cartContent"></div>
            <div id="cartTotal"></div>
            <button class="btn" onclick="openCustomerIdentification()">Finalizar Pedido</button>
            <button class="btn" onclick="continueShopping()">Continuar Comprando</button>
        </div>
    </div>
    <div id="customerIdentificationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="customerIdentificationForm">
                <h2><i class="fas fa-user"></i> Identifique-se</h2>
                <div class="input-icon">
                    <i class="fas fa-user"></i>
                    <input type="text" id="customerName" placeholder="Nome Completo" required>
                </div>
                <div class="input-icon">
                    <i class="fab fa-whatsapp"></i>
                    <input type="tel" id="customerPhone" placeholder="WhatsApp (com DDD)" required>
                </div>
                <button type="submit" class="btn">Avançar</button>
            </form>
        </div>
    </div>
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Finalizar Pedido</h2>
            <form id="checkoutForm">
                <div id="deliveryAddressSection">
                    <h3>Endereço de Entrega</h3>
                    <select id="savedAddresses" onchange="handleSavedAddressChange()">
                        <option value="">Selecione um endereço salvo ou cadastre um novo</option>
                    </select>
                    <button type="button" class="btn" onclick="showNewAddressForm()">Cadastrar Novo Endereço</button>
                    <div id="newAddressForm" style="display: none;">
                        <label for="street">Rua: <span class="required-field"></span></label>
                        <input type="text" id="street" required>
                        <label for="number">Número: <span class="required-field"></span></label>
                        <input type="text" id="number" required>
                        <label for="complement">Complemento:</label>
                        <input type="text" id="complement">
                        <label for="neighborhood">Bairro: <span class="required-field"></span></label>
                        <input type="text" id="neighborhood" required>
                        <label for="city">Cidade: <span class="required-field"></span></label>
                        <input type="text" id="city" required>
                        <label for="state">Estado: <span class="required-field">*</span></label>
                        <input type="text" id="state" required>
                        <button type="button" class="btn" onclick="saveNewAddress()">Salvar Endereço</button>
                    </div>
                </div>
                <div id="paymentSection" style="display: none;">
                    <label for="paymentMethod">Método de Pagamento:</label>
                    <select id="paymentMethod" required onchange="handlePaymentChange()">
                        <option value="card">Cartão na entrega</option>
                        <option value="money">Dinheiro</option>
                        <option value="pix">PIX</option>
                    </select>
                    <div id="moneyChange" style="display:none;">
                        <label for="changeNeeded">Precisa de troco?</label>
                        <select id="changeNeeded" onchange="handleChangeNeeded()">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                        <div id="changeAmountDiv" style="display:none;">
                            <label for="changeAmount">Troco para quanto?</label>
                            <input type="number" id="changeAmount" min="0" step="0.01">
                        </div>
                    </div>
                    <div id="pixInfo" style="display:none;">
                        <p>Chave PIX: 84 9 8873-1028</p>
                        <p>Após o envio do PIX, favor enviar o comprovante para o WhatsApp 84 9 8767-3202</p>
                    </div>
                </div>
                <button type="submit" class="btn" id="submitOrderBtn" style="display: none;">Fazer Pedido</button>
            </form>
            <div id="discountSection">
                <h3>Cupom de Desconto</h3>
                <input type="text" id="discountCode" placeholder="Digite o código do cupom">
                <button onclick="applyDiscount()">Aplicar Cupom</button>
                <p id="discountMessage"></p>
            </div>
            <div id="orderSummary"></div>
            <div id="loyaltyInfo" class="loyalty-info"></div>
            <div class="extras-suggestion">
                <h3>Deixe seu açaí mais delicioso e recheado com esses itens extras</h3>
                <div class="extra-items" id="extraItems">
                    <!-- Itens extras serão adicionados aqui via JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <div id="comboModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Monte seu Combo</h2>
            <div id="comboBuilder"></div>
        </div>
    </div>
    <div id="myOrdersModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Meus Pedidos</h2>
            <div id="myOrdersContent"></div>
        </div>
    </div>
    <div id="loyaltyProgramModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Programa Fidelidade</h2>
            <div id="loyaltyProgramContent"></div>
        </div>
    </div>
    <div id="loadingOverlay">
        <div>Carregando...</div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Mostrar overlay de carregamento
        document.getElementById('loadingOverlay').style.display = 'block';
        // Variáveis globais
window.cart = JSON.parse(localStorage.getItem('cart')) || [];
window.deliveryFee = 3.00;
window.customerInfo = {};
window.appliedDiscount = 0;
window.appliedCouponId = null;

// Obter IP do cliente
fetch('https://api.ipify.org?format=json')
    .then(response => response.json())
    .then(data => {
        window.clientIP = data.ip;
        console.log("IP do cliente:", window.clientIP);
    })
    .catch(error => console.error('Erro ao obter IP do cliente:', error));

// Função global para aplicar desconto
window.applyDiscount = function() {
    console.log("Iniciando applyDiscount");
    if (!window.db) {
        console.error("Firebase não está inicializado");
        alert("Erro ao aplicar cupom. Por favor, recarregue a página e tente novamente.");
        return;
    }
    const discountCode = document.getElementById('discountCode').value;
    const discountMessage = document.getElementById('discountMessage');
    
    window.db.collection('coupons')
        .where('code', '==', discountCode)
        .where('expirationDate', '>', new Date())
        .get()
        .then((querySnapshot) => {
            if (!querySnapshot.empty) {
                const coupon = querySnapshot.docs[0].data();
                const couponId = querySnapshot.docs[0].id;
                
                // Verificar se o cupom já foi usado por este cliente
                const usedBy = coupon.usedBy || [];
                const alreadyUsed = usedBy.some(usage => 
                    usage.phone === window.customerInfo.phone || usage.ip === window.clientIP
                );
                
                if (alreadyUsed) {
                    window.appliedDiscount = 0;
                    window.appliedCouponId = null;
                    discountMessage.textContent = 'Este cupom já foi utilizado por você.';
                    discountMessage.style.color = 'red';
                } else if (!coupon.customerPhone || coupon.customerPhone === window.customerInfo.phone) {
                    window.appliedDiscount = parseFloat(coupon.discount);
                    window.appliedCouponId = couponId;
                    discountMessage.textContent = `Cupom aplicado! Desconto de R$${window.appliedDiscount.toFixed(2)}`;
                    discountMessage.style.color = 'green';
                    console.log("Cupom aplicado:", window.appliedDiscount);
                } else {
                    window.appliedDiscount = 0;
                    window.appliedCouponId = null;
                    discountMessage.textContent = 'Este cupom é exclusivo para outro cliente.';
                    discountMessage.style.color = 'red';
                }
            } else {
                window.appliedDiscount = 0;
                window.appliedCouponId = null;
                discountMessage.textContent = 'Cupom inválido ou expirado';
                discountMessage.style.color = 'red';
            }
            console.log("Atualizando resumo do pedido");
            updateOrderSummaryDirectly();
        })
        .catch((error) => {
            console.error("Erro ao verificar cupom:", error);
            discountMessage.textContent = 'Erro ao verificar cupom. Tente novamente.';
            discountMessage.style.color = 'red';
            window.appliedDiscount = 0;
            window.appliedCouponId = null;
            console.log("Atualizando resumo do pedido após erro");
            updateOrderSummaryDirectly();
        });
}
        
function updateOrderSummaryDirectly() {
    console.log("Iniciando updateOrderSummaryDirectly");
    const orderSummary = document.getElementById('orderSummary');
    if (!orderSummary) {
        console.error("Elemento orderSummary não encontrado");
        return;
    }
    
    let summaryHTML = '<h3>Resumo do Pedido:</h3>';
    let subtotal = 0;
    
    // Exibir itens do carrinho
    window.cart.forEach(item => {
        if (!item.isExtra) {
            subtotal += item.totalPrice;
            summaryHTML += `
                <div class="cart-item">
                    <div class="cart-item-details">
                        <p><strong>${item.name}</strong> - R$ ${item.totalPrice.toFixed(2)}</p>
            `;
            if (item.acai1) {
                summaryHTML += `
                    <p>Açaí 1:</p>
                    <p class="indent">Sabores: ${item.acai1.flavors.join(', ')}</p>
                    <p class="indent">Acompanhamentos: ${item.acai1.accompaniments.join(', ')}</p>
                    <p>Açaí 2:</p>
                    <p class="indent">Sabores: ${item.acai2.flavors.join(', ')}</p>
                    <p class="indent">Acompanhamentos: ${item.acai2.accompaniments.join(', ')}</p>
                `;
            } else {
                if (item.accompaniments && item.accompaniments.length > 0) {
                    summaryHTML += `<p class="indent">Acompanhamentos: ${item.accompaniments.join(', ')}</p>`;
                }
            }
            if (item.extras && item.extras.length > 0) {
                summaryHTML += `<p class="indent">Extras: ${item.extras.join(', ')}</p>`;
            }
            summaryHTML += `
                    </div>
                </div>`;
        }
    });
    
    // Exibir itens extras
    const extraItems = window.cart.filter(item => item.isExtra);
    if (extraItems.length > 0) {
        summaryHTML += "<h4>Itens Extras Adicionais:</h4>";
        extraItems.forEach(item => {
            subtotal += item.totalPrice;
            summaryHTML += `<p class="indent">${item.name} - R$ ${item.totalPrice.toFixed(2)}</p>`;
        });
    }
    
    let discountedTotal = Math.max(0, subtotal - (window.appliedDiscount || 0));
    
    // Aplicar desconto de fidelidade, se aplicável
    let loyaltyDiscount = 0;
    if (window.customerInfo && window.customerInfo.orderCount === 9) { // 9 porque este será o 10º pedido
        loyaltyDiscount = subtotal * 0.5;
        summaryHTML += `<h4 style="color: green;">Parabéns! Você ganhou 50% de desconto neste pedido!</h4>`;
    }
    
    discountedTotal = Math.max(0, discountedTotal - loyaltyDiscount);
    const finalTotal = discountedTotal + window.deliveryFee;
    
    // Resumo final
    summaryHTML += `<hr>`;
    summaryHTML += `<h4>Subtotal: R$ ${subtotal.toFixed(2)}</h4>`;
    if (window.appliedDiscount > 0) {
        summaryHTML += `<h4>Desconto de cupom: R$ ${window.appliedDiscount.toFixed(2)}</h4>`;
    }
    if (loyaltyDiscount > 0) {
        summaryHTML += `<h4>Desconto de fidelidade: R$ ${loyaltyDiscount.toFixed(2)}</h4>`;
    }
    summaryHTML += `<h4>Taxa de Entrega: R$ ${window.deliveryFee.toFixed(2)}</h4>`;
    summaryHTML += `<h3>Total: R$ ${finalTotal.toFixed(2)}</h3>`;
    
    orderSummary.innerHTML = summaryHTML;
    
    console.log('Resumo final:', {
        subtotal,
        appliedDiscount: window.appliedDiscount,
        loyaltyDiscount,
        discountedTotal,
        deliveryFee: window.deliveryFee,
        finalTotal
    });
}

        document.addEventListener('DOMContentLoaded', function () {
            // Configuração do Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
                authDomain: "cabana-8d55e.firebaseapp.com",
                databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
                projectId: "cabana-8d55e",
                storageBucket: "cabana-8d55e.appspot.com",
                messagingSenderId: "706144237954",
                appId: "1:706144237954:web:345c10370972486afc779b",
                measurementId: "G-96Y337GYT8"
            };

                                  // Inicialize o Firebase
firebase.initializeApp(firebaseConfig);
window.db = firebase.firestore();
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
const deliveryFee = 3.00;
let customerInfo = {};
let savedAddresses = [];
let appliedDiscount = 0;
let appliedCouponId = null;

// Dados dos itens extras
const extraItems = [
    { name: "Ovomaltine", price: 1.99, image: "https://images.tcdn.com.br/img/img_prod/919170/ovomaltine_flocos_extra_crocante_750g_425_1_e9d3c08b8341c4e7818b1759c877a213.jpg" },
    { name: "Amendoim", price: 1.99, image: "https://cdn.entrypoint.directory/assets/39790/produtos/3053/xerem-amendoim-secundaria-relva-verde-500g.jpg" },
    { name: "Granola", price: 1.99, image: "https://jardimdaservas.com.br/wp-content/uploads/2023/05/GRANOLAAAIGUARANEMEL-1.jpg" },
    { name: "Chocoball", price: 1.99, image: "https://lojasantoantonio.vtexassets.com/arquivos/ids/156826/562-Choco-Power-Ball-Mini-Preto-e-Branco-500G-MAVALERIO.jpg?v=637254329101230000" },
    { name: "M&M", price: 1.99, image: "https://static.welban.com.br/public/welban/imagens/produtos/confete-de-chocolate-colorido-500g-chococandy-dori-64029a15a016e.jpg" },
    { name: "Côco Ralado", price: 1.99, image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_Mt3NOWlBbg-Yv0ttYPiXwNdMIxdh1aSuxJOIg50WN-1FOjiagSbr7MDjQf9OE0b2hnU&usqp=CAU" },
    { name: "Leite em pó", price: 1.99, image: "https://acougueamigos.com/cdn/shop/products/acougue-amigos_1_27.jpg?v=1615589403" },
    { name: "Leite condensado", price: 1.99, image: "https://static.escolakids.uol.com.br/conteudo_legenda/07795c263fc55bd57242ef71ae55cee8.jpg" },
    { name: "Calda de Morango", price: 1.99, image: "https://i.ytimg.com/vi/3K6gWHdjyUU/maxresdefault.jpg" },
    { name: "Calda de Chocolate", price: 1.99, image: "https://img.cybercook.com.br/receitas/53/calda-de-chocolate.jpeg" }
];

// Dados dos combos
const combos = [
    { name: "Combo 2 de 300ml", price: 20.00, maxAccompaniments: 3 },
    { name: "Combo 2 de 500ml", price: 26.99, maxAccompaniments: 4 },
    { name: "Combo 2 de 1 Litro", price: 49.99, maxAccompaniments: 8 }
];

// Dados dos sabores de açaí
const acaiFlavors = [
    "Açaí Tradicional", "Creme de Ninho", "Creme de Cupuaçu", "Creme de Ovomaltine",
    "Creme de Morango", "Creme de Maracujá", "Creme de Amendoim"
];

let currentCombo = null;
let selectedFlavors = [[], []];
let selectedAccompaniments = [[], []];
let selectedExtras = [];
let currentAcaiIndex = 0;

function hideHeaderAndCategories() {
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('categoriesContainer').style.display = 'none';
}

function showHeaderAndCategories() {
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('categoriesContainer').style.display = 'flex';
}

async function fetchProducts() {
    console.log("Iniciando fetchProducts");
    try {
        const snapshot = await window.db.collection('products').get();
        window.products = snapshot.docs.map(doc => {
            const product = { id: doc.id.toString(), ...doc.data() };
            console.log("Produto carregado:", JSON.stringify({ id: product.id, name: product.name, category: product.category }, null, 2));
            return product;
        });
        console.log("Total de produtos carregados:", window.products.length);
        displayProducts(window.products);
        updateCartCount();
    } catch (error) {
        console.error("Erro ao buscar produtos:", error);
        alert("Ocorreu um erro ao carregar os produtos. Por favor, recarregue a página.");
    }
}
            
async function fetchCategories() {
    const snapshot = await window.db.collection('categories').get();
    const categories = snapshot.docs.map(doc => doc.data().name);
    displayCategories(categories);
}

function displayCategories(categories) {
    const categoriesContainer = document.getElementById('categoriesContainer');
    categoriesContainer.innerHTML = categories.map(category => 
        `<button class="category-btn" onclick="filterByCategory('${category}')">${category}</button>`
    ).join('');
    const allButton = document.createElement('button');
    allButton.className = 'category-btn active';
    allButton.textContent = 'Todos';
    allButton.onclick = () => filterByCategory('all');
    categoriesContainer.insertBefore(allButton, categoriesContainer.firstChild);
}

window.filterByCategory = function(category) {
    console.log("Filtrando por categoria:", category);
    const buttons = document.querySelectorAll('.category-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    let filteredProducts;
    if (category === 'all') {
        filteredProducts = window.products;
    } else {
        filteredProducts = window.products.filter(product => {
            console.log(`Produto: ${product.name}, Categoria: ${product.category}, Comparando com: ${category}`);
            return product.category.toLowerCase() === category.toLowerCase();
        });
    }

    console.log(`Produtos filtrados para a categoria '${category}':`, filteredProducts);
    displayProducts(filteredProducts);
}

    window.searchProducts = function() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filteredProducts = window.products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.description.toLowerCase().includes(searchTerm)
    );
    displayProducts(filteredProducts);
}
            
    function displayProducts(productsToDisplay = products) {
    console.log("Iniciando displayProducts com", productsToDisplay.length, "produtos");
    const productGrid = document.getElementById('productGrid');
    if (productsToDisplay.length === 0) {
        productGrid.innerHTML = '<p>Nenhum produto encontrado nesta categoria.</p>';
    } else {
        productGrid.innerHTML = productsToDisplay.map(product => `
            <div class="product-card" onclick="openProductDetails('${product.id.toString()}')">
                <div class="product-info">
                    <h3 class="product-title">${product.name}</h3>
                    <p class="product-description">${product.description.substring(0, 50)}...</p>
                    <p class="product-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
                </div>
                <img src="${product.image}" alt="${product.name}" class="product-image">
            </div>
        `).join('');
    }
    console.log("Produtos renderizados:", productsToDisplay.map(p => ({ id: p.id, name: p.name, category: p.category })));
}

window.updateCartCount = function() {
    const cartCount = document.getElementById('cartCount');
    if (cartCount) {
        cartCount.textContent = window.cart.length;
    }
}

window.openProductDetails = function(productId) {
    console.log("Abrindo detalhes do produto com ID:", productId);
    hideHeaderAndCategories();
    
    console.log("Todos os produtos:", window.products.map(p => ({ id: p.id, name: p.name })));
    
    const product = window.products.find(p => p.id.toString() === productId.toString());
    console.log("Produto encontrado:", product);

    if (!product) {
        console.error("Produto não encontrado para o ID:", productId);
        alert("Desculpe, não foi possível encontrar os detalhes deste produto.");
        return;
    }

    const modal = document.getElementById('productModal');
    const modalContent = document.getElementById('modalContent');

    modalContent.innerHTML = `
        <h2>${product.name}</h2>
        <img src="${product.image}" alt="${product.name}" style="width:100%; max-height:300px; object-fit:cover;">
        <p>${product.description}</p>
        <p class="product-price">Preço: R$ ${parseFloat(product.price).toFixed(2)}</p>
        <div class="extras-list">
            <h3>Acompanhamentos (escolha de ${product.minAccompaniments} a ${product.maxAccompaniments}):</h3>
            <div class="checkbox-list" id="accompaniments">
                ${product.accompaniments.map((item, index) => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="acc${index}" name="accompaniment" value="${item}">
                        <label for="acc${index}">${item}</label>
                    </div>
                `).join('')}
            </div>
            <p id="accompanimentError" class="error-message"></p>
        </div>
        <div class="extras-list">
            <h3>Itens Extras:</h3>
            <div class="checkbox-list" id="extras">
                ${product.extras.map((item, index) => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="extra${index}" name="extra" value="${item.name}">
                        <label for="extra${index}">${item.name} - R$ ${parseFloat(item.price).toFixed(2)}</label>
                    </div>
                `).join('')}
            </div>
        </div>
        <button id="addToCartBtn" class="btn" onclick="addToCart('${product.id}')">Adicionar ao Carrinho</button>
    `;
    modal.style.display = "block";

    const accCheckboxes = document.querySelectorAll('#accompaniments input[type="checkbox"]');
    accCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => validateAccompaniments(product));
    });

    console.log("Modal de detalhes do produto aberto com sucesso");
}

function validateAccompaniments(product) {
    const checkedAccompaniments = document.querySelectorAll('#accompaniments input[type="checkbox"]:checked');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const errorMessage = document.getElementById('accompanimentError');
    if (checkedAccompaniments.length < product.minAccompaniments || checkedAccompaniments.length > product.maxAccompaniments) {
        addToCartBtn.disabled = true;
        errorMessage.textContent = `Selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos`;
    } else {
        addToCartBtn.disabled = false;
        errorMessage.textContent = '';
    }
}

window.addToCart = function(productId) {
    const product = window.products.find(p => p.id.toString() === productId.toString());
    if (!product) {
        console.error("Produto não encontrado");
        return;
    }

    const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
    const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);

    const cartItem = {
        id: Date.now(),
        productId: product.id,
        name: product.name,
        price: product.price,
        accompaniments: accompaniments,
        extras: extras,
        totalPrice: calculateTotalPrice(product, extras)
    };

    window.cart.push(cartItem);
    saveCartToLocalStorage();
    window.updateCartCount();
    window.openCart();
}

function saveCartToLocalStorage() {
    localStorage.setItem('cart', JSON.stringify(window.cart));
}

function loadCartFromLocalStorage() {
    const savedCart = localStorage.getItem('cart');
    window.cart = savedCart ? JSON.parse(savedCart) : [];
}

function calculateTotalPrice(product, selectedExtras) {
    let total = product.price;
    selectedExtras.forEach(extraName => {
        const extra = product.extras.find(e => e.name === extraName);
        if (extra) {
            total += extra.price;
        }
    });
    return total;
}

window.openCart = function() {
    console.log("Abrindo o carrinho");
    const cartModal = document.getElementById('cartModal');
    const cartContent = document.getElementById('cartContent');
    const cartTotal = document.getElementById('cartTotal');

    if (!cartModal || !cartContent || !cartTotal) {
        console.error("Elementos do carrinho não encontrados");
        return;
    }

    let cartHTML = '';
    let total = 0;

    window.cart.forEach(item => {
        total += item.totalPrice;
        cartHTML += `
            <div class="cart-item">
                <div class="cart-item-info">
                    <h3>${item.name}</h3>
                    <p>Preço: R$ ${item.totalPrice.toFixed(2)}</p>
                    ${item.accompaniments ? `<p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>` : ''}
                    ${item.extras ? `<p>Extras: ${item.extras.join(', ')}</p>` : ''}
                </div>
                <span class="cart-item-remove" onclick="window.removeFromCart(${item.id})">🗑️</span>
            </div>
        `;
    });

    cartContent.innerHTML = cartHTML;
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
    cartModal.style.display = "block";
}
            
window.continueShopping = function() {
    closeModal('cartModal');
}

window.removeFromCart = function(itemId) {
    console.log("Removendo item do carrinho:", itemId);
    window.cart = window.cart.filter(item => item.id !== itemId);
    saveCartToLocalStorage();
    window.updateCartCount();
    window.openCart(); // Reabrir o carrinho para atualizar a visualização
}

window.openCustomerIdentification = function() {
    hideHeaderAndCategories();
    closeModal('cartModal');
    const modal = document.getElementById('customerIdentificationModal');
    modal.style.display = "block";
    const phone = localStorage.getItem('customerPhone');
    if (phone) {
        document.getElementById('customerPhone').value = phone;
        document.getElementById('customerName').value = localStorage.getItem('customerName') || '';
        loadCustomerData(phone);
    }
}

function loadCustomerData(phone) {
    db.collection('customers').doc(phone).get().then((doc) => {
        if (doc.exists) {
            const data = doc.data();
            window.customerInfo = {
                name: data.name,
                phone: phone,
                addresses: data.addresses || [],
                orderCount: data.orderCount || 0
            };
            document.getElementById('customerName').value = data.name;
            savedAddresses = data.addresses || [];
            localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
            updateLoyaltyInfo(data.orderCount || 0);
        } else {
            window.customerInfo = { phone: phone, orderCount: 0 };
            updateLoyaltyInfo(0);
        }
    }).catch((error) => {
        console.log("Error getting customer data:", error);
        updateLoyaltyInfo(0);
    });
}

document.getElementById('customerIdentificationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const phone = document.getElementById('customerPhone').value;
    const name = document.getElementById('customerName').value;
    customerInfo = { phone, name };
    localStorage.setItem('customerPhone', phone);
    localStorage.setItem('customerName', name);
    db.collection('customers').doc(phone).set({
        name: name,
        addresses: savedAddresses
    }, { merge: true }).then(() => {
        closeModal('customerIdentificationModal');
        openCheckout();
    }).catch((error) => {
        console.error("Error saving customer data: ", error);
    });
});

function openCheckout() {
    const checkoutModal = document.getElementById('checkoutModal');
    loadSavedAddresses();
    updateOrderSummaryDirectly(); // Alterado de updateOrderSummary para updateOrderSummaryDirectly
    document.getElementById('paymentSection').style.display = 'none';
    document.getElementById('submitOrderBtn').style.display = 'none';
    checkoutModal.style.display = "block";
    displayExtraItems();
}

function loadSavedAddresses() {
    const select = document.getElementById('savedAddresses');
    select.innerHTML = '<option value="">Selecione um endereço salvo ou cadastre um novo</option>';
    savedAddresses.forEach((address, index) => {
        select.innerHTML += `<option value="${index}">${address.street}, ${address.number} - ${address.neighborhood}</option>`;
    });
}

window.handleSavedAddressChange = function() {
    const selectedIndex = document.getElementById('savedAddresses').value;
    if (selectedIndex !== "") {
        const address = savedAddresses[selectedIndex];
        document.getElementById('street').value = address.street;
        document.getElementById('number').value = address.number;
        document.getElementById('complement').value = address.complement || '';
        document.getElementById('neighborhood').value = address.neighborhood;
        document.getElementById('city').value = address.city;
        document.getElementById('state').value = address.state;

        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('submitOrderBtn').style.display = 'block';
    } else {
        document.getElementById('paymentSection').style.display = 'none';
        document.getElementById('submitOrderBtn').style.display = 'none';
    }
}

window.showNewAddressForm = function() {
    document.getElementById('newAddressForm').style.display = 'block';
}

window.saveNewAddress = function() {
    const newAddress = {
        street: document.getElementById('street').value,
        number: document.getElementById('number').value,
        complement: document.getElementById('complement').value,
        neighborhood: document.getElementById('neighborhood').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value
    };

    let missingFields = [];
    if (!newAddress.street) missingFields.push('Rua');
    if (!newAddress.number) missingFields.push('Número');
    if (!newAddress.neighborhood) missingFields.push('Bairro');
    if (!newAddress.city) missingFields.push('Cidade');
    if (!newAddress.state) missingFields.push('Estado');

    if (missingFields.length > 0) {
        alert(`Por favor, preencha os seguintes campos obrigatórios: ${missingFields.join(', ')}`);
        return;
    }
    savedAddresses.push(newAddress);
    localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));

    db.collection('customers').doc(customerInfo.phone).update({
        addresses: savedAddresses
    }).then(() => {
        loadSavedAddresses();
        alert('Novo endereço salvo com sucesso!');
        document.getElementById('newAddressForm').style.display = 'none';
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('submitOrderBtn').style.display = 'block';
    }).catch((error) => {
        console.error("Error updating addresses: ", error);
    });
}

window.handlePaymentChange = function() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    document.getElementById('moneyChange').style.display = paymentMethod === 'money' ? 'block' : 'none';
    document.getElementById('pixInfo').style.display = paymentMethod === 'pix' ? 'block' : 'none';
}

window.handleChangeNeeded = function() {
    const changeNeeded = document.getElementById('changeNeeded').value;
    document.getElementById('changeAmountDiv').style.display = changeNeeded === 'yes' ? 'block' : 'none';
}

function displayExtraItems() {
    const extraItemsContainer = document.getElementById('extraItems');
    extraItemsContainer.innerHTML = extraItems.map(item => 
        `<div class="extra-item" onclick="toggleExtraItem(this, '${item.name}')" data-id="${Date.now()}">
            <img src="${item.image}" alt="${item.name}">
            <p>${item.name}</p>
            <p>R$ ${item.price.toFixed(2)}</p>
        </div>`
    ).join('');
    
    // Marcar itens extras que já estão no carrinho
    window.cart.forEach(item => {
        if (item.isExtra) {
            const extraItem = document.querySelector(`.extra-item p:contains('${item.name}')`).closest('.extra-item');
            if (extraItem) {
                extraItem.classList.add('selected');
            }
        }
    });
}

document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const selectedAddressIndex = document.getElementById('savedAddresses').value;
    if (selectedAddressIndex === "") {
        alert("Por favor, selecione um endereço de entrega.");
        return;
    }
    const selectedAddress = savedAddresses[selectedAddressIndex];
    const paymentMethod = document.getElementById('paymentMethod').value;
    const changeNeeded = document.getElementById('changeNeeded').value;
    const changeAmount = document.getElementById('changeAmount').value;

    let subtotal = 0;
    let extrasFromProducts = new Set();
    let orderItems = window.cart.map(item => {
        subtotal += item.totalPrice;
        let itemDetails = {
            name: item.name,
            price: item.totalPrice
        };
        if (item.acai1) {
            itemDetails.acai1 = item.acai1;
            itemDetails.acai2 = item.acai2;
        } else {
            if (item.accompaniments) itemDetails.accompaniments = item.accompaniments;
        }
        if (item.extras) {
            itemDetails.extras = item.extras;
            item.extras.forEach(extra => extrasFromProducts.add(extra));
        }
        return itemDetails;
    });

    // Itens extras adicionais
    const selectedExtras = document.querySelectorAll('.extra-item.selected');
    let extrasTotal = 0;
    selectedExtras.forEach(item => {
        const itemName = item.querySelector('p').textContent;
        if (!extrasFromProducts.has(itemName)) {
            orderItems.push({
                name: itemName,
                price: 1.99,
                isExtra: true
            });
            extrasTotal += 1.99;
        }
    });

    subtotal += extrasTotal;
    let discountedTotal = Math.max(0, subtotal - window.appliedDiscount);
    let finalTotal = discountedTotal + window.deliveryFee;

    const order = {
        customerName: customerInfo.name,
        customerPhone: customerInfo.phone,
        address: selectedAddress,
        paymentMethod: paymentMethod,
        changeNeeded: changeNeeded,
        changeAmount: changeAmount,
        items: orderItems,
        subtotal: subtotal,
        extrasTotal: extrasTotal,
        appliedDiscount: window.appliedDiscount,
        appliedCouponId: window.appliedCouponId,
        deliveryFee: window.deliveryFee,
        total: finalTotal,
        status: 'preparing',
        createdAt: new Date()
    };

    db.collection('orders').add(order)
        .then((docRef) => {
            console.log('Pedido adicionado com sucesso!');
            window.orderId = docRef.id;
            updateCustomerOrderCount();
            showOrderConfirmation(order);
            startOrderStatusMonitoring();
        })
        .catch(error => {
            console.error('Erro ao adicionar pedido: ', error);
            alert('Ocorreu um erro ao finalizar o pedido. Por favor, tente novamente.');
        });
});

            function updateCustomerOrderCount() {
    db.collection('customers').doc(customerInfo.phone).get()
        .then((doc) => {
            let orderCount = doc.exists ? (doc.data().orderCount || 0) : 0;
            orderCount++;
            
            let updateData = { orderCount: orderCount };
            if (orderCount >= 10) {
                updateData.orderCount = 0; // Reinicia a contagem
            }
            
            return db.collection('customers').doc(customerInfo.phone).set(updateData, { merge: true });
        })
        .then(() => {
            console.log('Contagem de pedidos do cliente atualizada');
        })
        .catch(error => {
            console.error('Erro ao atualizar contagem de pedidos: ', error);
        });
}

    function clearCart() {
    window.cart = [];
    localStorage.setItem('cart', JSON.stringify(window.cart));
    updateCartCount();
}

window.resetOrderForm = function() {
    document.getElementById('checkoutForm').style.display = 'block';
    document.getElementById('orderSummary').innerHTML = '';
    document.getElementById('savedAddresses').value = '';
    document.getElementById('paymentMethod').value = 'card';
    document.getElementById('changeNeeded').value = 'no';
    document.getElementById('changeAmount').value = '';
    window.orderId = null;
    window.cart = [];
    localStorage.setItem('cart', JSON.stringify(window.cart));
    updateCartCount();
}

function showOrderConfirmation(order) {
    const orderSummary = document.getElementById('orderSummary');
    let summaryHTML = `
        <h3>Pedido Realizado com Sucesso!</h3>
        <p>Seu pedido foi recebido e está sendo preparado.</p>
        <div id="orderStatus" class="order-status status-preparing">Status: Preparando</div>
        <button id="whatsappButton" class="btn" onclick="window.redirectToWhatsApp()">
            <i class="fab fa-whatsapp"></i> Acompanhar pelo WhatsApp
        </button>
        <button id="newOrderButton" class="btn" onclick="window.resetOrderForm()">Novo Pedido</button>
        <h4>Resumo do Pedido:</h4>
    `;

    order.items.forEach(item => {
        summaryHTML += `
            <div class="cart-item">
                <div class="cart-item-details">
                    <p><strong>${item.name}</strong> - R$ ${item.price.toFixed(2)}</p>
        `;
        if (item.acai1) {
            summaryHTML += `
                <p>Açaí 1:</p>
                <p class="indent">Sabores: ${item.acai1.flavors.join(', ')}</p>
                <p class="indent">Acompanhamentos: ${item.acai1.accompaniments.join(', ')}</p>
                <p>Açaí 2:</p>
                <p class="indent">Sabores: ${item.acai2.flavors.join(', ')}</p>
                <p class="indent">Acompanhamentos: ${item.acai2.accompaniments.join(', ')}</p>
            `;
        } else if (item.accompaniments) {
            summaryHTML += `<p class="indent">Acompanhamentos: ${item.accompaniments.join(', ')}</p>`;
        }
        if (item.extras && item.extras.length > 0) {
            summaryHTML += `<p class="indent">Extras: ${item.extras.join(', ')}</p>`;
        }
        summaryHTML += `
                </div>
            </div>`;
    });

    summaryHTML += `
        <h4>Subtotal: R$ ${order.subtotal.toFixed(2)}</h4>
        <h4>Taxa de Entrega: R$ ${order.deliveryFee.toFixed(2)}</h4>
        <h3>Total: R$ ${order.total.toFixed(2)}</h3>
    `;

    orderSummary.innerHTML = summaryHTML;

    // Esconder o formulário de checkout
    document.getElementById('checkoutForm').style.display = 'none';
}
            
function startOrderStatusMonitoring() {
    if (!window.orderId) {
        console.error('ID do pedido não disponível');
        return;
    }

    db.collection('orders').doc(window.orderId)
        .onSnapshot((doc) => {
            if (doc.exists) {
                const order = doc.data();
                updateOrderStatus(order.status);
            }
        }, (error) => {
            console.error("Erro ao monitorar status do pedido:", error);
        });
}
            
// Função para atualizar o status do pedido na interface
function updateOrderStatus(status) {
    const statusElement = document.getElementById('orderStatus');
    if (statusElement) {
        statusElement.textContent = `Status: ${getStatusText(status)}`;
        statusElement.className = `order-status status-${status}`;
    }
}

// Função para obter o texto do status
function getStatusText(status) {
    const statusTexts = {
        'preparing': 'Preparando',
        'ready': 'Pronto para entrega',
        'delivered': 'Entregue'
    };
    return statusTexts[status] || 'Desconhecido';
}

// Função para redirecionar para o WhatsApp
// Adicione esta função ao escopo global
window.redirectToWhatsApp = function() {
    if (!window.orderId) {
        console.error('ID do pedido não disponível');
        return;
    }

    db.collection('orders').doc(window.orderId).get()
        .then((doc) => {
            if (doc.exists) {
                const order = doc.data();
                let message = composeWhatsAppMessage(order);
                window.open(`https://wa.me/5584987673202?text=${encodeURIComponent(message)}`, '_blank');
            } else {
                console.error('Pedido não encontrado');
            }
        })
        .catch((error) => {
            console.error('Erro ao buscar detalhes do pedido:', error);
        });
}

// Função para compor a mensagem do WhatsApp
function composeWhatsAppMessage(order) {
    let message = `Pedido #${order.id}\n`;
    message += `Nome: ${order.customerName}\n`;
    message += `Telefone: ${order.customerPhone}\n`;
    message += `Endereço: ${order.address.street}, ${order.address.number}, ${order.address.neighborhood}, ${order.address.city} - ${order.address.state}\n`;
    if (order.address.complement) {
        message += `Complemento: ${order.address.complement}\n`;
    }
    message += `Método de Pagamento: ${getPaymentMethodText(order.paymentMethod)}\n`;
    if (order.paymentMethod === 'money' && order.changeNeeded === 'yes') {
        message += `Troco para: R$ ${order.changeAmount}\n`;
    }

    message += `\nItens do Pedido:\n`;
    order.items.forEach(item => {
        message += `\n${item.name} - R$ ${item.price.toFixed(2)}`;
        if (item.acai1) {
            message += `\nAçaí 1: Sabores: ${item.acai1.flavors.join(', ')}, Acompanhamentos: ${item.acai1.accompaniments.join(', ')}`;
            message += `\nAçaí 2: Sabores: ${item.acai2.flavors.join(', ')}, Acompanhamentos: ${item.acai2.accompaniments.join(', ')}`;
        } else if (item.accompaniments) {
            message += `\nAcompanhamentos: ${item.accompaniments.join(', ')}`;
        }
        if (item.extras && item.extras.length > 0) {
            message += `\nExtras: ${item.extras.join(', ')}`;
        }
    });

    message += `\n\nSubtotal: R$ ${order.subtotal.toFixed(2)}`;
    if (order.appliedDiscount > 0) {
        message += `\nDesconto: R$ ${order.appliedDiscount.toFixed(2)}`;
    }
    message += `\nTaxa de Entrega: R$ ${order.deliveryFee.toFixed(2)}`;
    message += `\nTotal: R$ ${order.total.toFixed(2)}`;

    return message;
}

function getPaymentMethodText(method) {
    switch(method) {
        case 'money': return 'Dinheiro';
        case 'card': return 'Cartão na entrega';
        case 'pix': return 'PIX';
        default: return method;
    }
}

function getOrderNumberText(number) {
    const specialCases = ['primeiro', 'segundo', 'terceiro', 'quarto', 'quinto'];
    return specialCases[number - 1] || `${number}º`;
}

function updateLoyaltyInfo(orderCount) {
    const loyaltyInfo = document.getElementById('loyaltyInfo');
    loyaltyInfo.innerHTML = `
        <h3>Programa de Fidelidade</h3>
        <p>Você já realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
        ${orderCount >= 10 ? 
          '<p><strong>Parabéns!</strong> Você tem direito a 50% de desconto neste pedido! O desconto será aplicado assim que você finalizar este pedido.</p>' :
          `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para você ganhar 50% de desconto!</p>`
        }
        <p>Lembre-se: O pedido só será contabilizado após ser recebido por nossa loja no WhatsApp.</p>
    `;
}

window.openMyOrders = function() {
    hideHeaderAndCategories();
    const modal = document.getElementById('myOrdersModal');
    const content = document.getElementById('myOrdersContent');
    content.innerHTML = `
        <h3>Insira seu número de WhatsApp para ver seus pedidos:</h3>
        <input type="tel" id="orderPhoneInput" placeholder="WhatsApp (com DDD)" required>
        <button class="btn" onclick="fetchMyOrders()">Buscar Pedidos</button>
        <div id="ordersList"></div>
    `;
    modal.style.display = "block";
}

window.fetchMyOrders = function() {
    const phone = document.getElementById('orderPhoneInput').value;
    if (!phone) {
        alert("Por favor, insira seu número de WhatsApp.");
        return;
    }
    db.collection('orders')
        .where('customerPhone', '==', phone)
        .orderBy('createdAt', 'desc')
        .get()
        .then((querySnapshot) => {
            const ordersList = document.getElementById('ordersList');
            if (querySnapshot.empty) {
                ordersList.innerHTML = '<p>Nenhum pedido encontrado para este número.</p>';
            } else {
                let ordersHtml = '<h3>Seus Pedidos:</h3>';
                querySnapshot.forEach((doc) => {
                    const order = doc.data();
                    ordersHtml += `
                        <div class="order-item">
                            <p><strong>Data:</strong> ${order.createdAt.toDate().toLocaleString()}</p>
                            <p><strong>Total:</strong> R$ ${order.total.toFixed(2)}</p>
                            <p><strong>Detalhes do Pedido:</strong> ${order.items.map(item => {
                                if (item.acai1) {
                                    return `${item.name} (Açaí 1: ${item.acai1.flavors.join(', ')}, Açaí 2: ${item.acai2.flavors.join(', ')})`;
                                } else {
                                    return `${item.name} ${item.accompaniments ? `(${item.accompaniments.join(', ')})` : ''}${item.extras && item.extras.length > 0 ? ` + Extras: ${item.extras.join(', ')}` : ''}`;
                                }
                            }).join(', ')}</p>
                            <button class="btn" onclick="repeatOrder('${doc.id}')">Repetir Este Pedido</button>
                        </div>
                    `;
                });
                ordersList.innerHTML = ordersHtml;
            }
        })
        .catch((error) => {
            console.error("Erro ao buscar pedidos: ", error);
            alert("Ocorreu um erro ao buscar seus pedidos. Por favor, tente novamente.");
        });
}

window.repeatOrder = function(orderId) {
    db.collection('orders').doc(orderId).get()
        .then((doc) => {
            if (doc.exists) {
                const order = doc.data();
                // Adicionar cada item do pedido ao carrinho
                order.items.forEach(item => {
                    window.cart.push({
                        ...item,
                        id: Date.now() + Math.random() // Gera um novo ID único
                    });
                });
                
                // Salvar o carrinho atualizado
                saveCartToLocalStorage();
                
                // Atualizar a contagem do carrinho
                window.updateCartCount();
                
                alert("Pedido adicionado ao carrinho!");
                closeModal('myOrdersModal');
                window.openCart(); // Abre o carrinho para mostrar os itens adicionados
            } else {
                alert("Pedido não encontrado.");
            }
        })
        .catch((error) => {
            console.error("Erro ao repetir pedido: ", error);
            alert("Ocorreu um erro ao repetir o pedido. Por favor, tente novamente.");
        });
}

window.openLoyaltyProgram = function() {
    hideHeaderAndCategories();
    const modal = document.getElementById('loyaltyProgramModal');
    const content = document.getElementById('loyaltyProgramContent');
    content.innerHTML = `
        <h3>Programa de Fidelidade Cabana Açaí</h3>
        <p>Nosso programa de fidelidade é simples e recompensador:</p>
        <ul>
            <li>A cada 10 pedidos, você ganha 50% de desconto no próximo!</li>
            <li>Os pedidos são contabilizados dentro da janela do WhatsApp do cliente.</li>
            <li>Se você fizer pedidos com números de WhatsApp diferentes, os pontos de fidelidade serão somados no novo número que está utilizando para compra.</li>
        </ul>
        <p>Para verificar seus pontos de fidelidade, insira seu número de WhatsApp:</p>
        <input type="tel" id="loyaltyPhoneInput" placeholder="WhatsApp (com DDD)" required>
        <button class="btn" onclick="checkLoyaltyPoints()">Verificar Pontos</button>
        <div id="loyaltyPoints"></div>
    `;
    modal.style.display = "block";
}

window.checkLoyaltyPoints = function() {
    const phone = document.getElementById('loyaltyPhoneInput').value;
    if (!phone) {
        alert("Por favor, insira seu número de WhatsApp.");
        return;
    }
    db.collection('customers').doc(phone).get()
        .then((doc) => {
            const loyaltyPoints = document.getElementById('loyaltyPoints');
            if (doc.exists) {
                const orderCount = doc.data().orderCount || 0;
                loyaltyPoints.innerHTML = `
                    <p>Você já realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
                    ${orderCount >= 10 ? 
                        '<p><strong>Parabéns!</strong> Você tem direito a 50% de desconto no seu próximo pedido!</p>' :
                        `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para você ganhar 50% de desconto!</p>`
                    }
                `;
            } else {
                loyaltyPoints.innerHTML = '<p>Nenhum pedido encontrado para este número.</p>';
            }
        })
        .catch((error) => {
            console.error("Erro ao verificar pontos de fidelidade: ", error);
            alert("Ocorreu um erro ao verificar seus pontos. Por favor, tente novamente.");
        });
}

window.openComboBuilder = function() {
    hideHeaderAndCategories();
    const modal = document.getElementById('comboModal');
    const comboBuilder = document.getElementById('comboBuilder');
    comboBuilder.innerHTML = `
        <div class="combo-step">
            <h3>Escolha seu Combo:</h3>
            <div class="combo-options">
                ${combos.map(combo => 
                    `<div class="combo-option" onclick="selectCombo('${combo.name}')">
                        <h4>${combo.name}</h4>
                        <p>R$ ${combo.price.toFixed(2)}</p>
                        <p>Até ${combo.maxAccompaniments} acompanhamentos por açaí</p>
                    </div>`
                ).join('')}
            </div>
        </div>
        <div id="flavorSelection" style="display: none;"></div>
        <div id="accompanimentSelection" style="display: none;"></div>
        <div id="extraItemsSelection" style="display: none;"></div>
        <div id="comboSummary"></div>
        <button class="btn" onclick="addComboToCart()" style="display: none;">Adicionar ao Carrinho</button>
        <button class="btn" onclick="resetComboBuilder()">Voltar</button>
    `;
    modal.style.display = "block";
}

window.selectCombo = function(comboName) {
    currentCombo = combos.find(combo => combo.name === comboName);
    document.querySelectorAll('.combo-option').forEach(option => {
        option.classList.remove('selected');
        if (option.textContent.includes(comboName)) {
            option.classList.add('selected');
        }
    });
    currentAcaiIndex = 0;
    showFlavorSelection();
}

function showFlavorSelection() {
    const flavorSelection = document.getElementById('flavorSelection');
    flavorSelection.innerHTML = `
        <h3>Escolha até 2 sabores para o Açaí ${currentAcaiIndex + 1}:</h3>
        <div class="combo-items">
            ${acaiFlavors.map(flavor => 
                `<div class="combo-item" onclick="toggleFlavor('${flavor}')">
                    <p>${flavor}</p>
                </div>`
            ).join('')}
        </div>
        <button class="btn" onclick="showAccompanimentSelection()">Próximo</button>
    `;
    flavorSelection.style.display = 'block';
    document.getElementById('accompanimentSelection').style.display = 'none';
    updateFlavorSelection();
}

window.toggleFlavor = function(flavor) {
    const index = selectedFlavors[currentAcaiIndex].indexOf(flavor);
    if (index > -1) {
        selectedFlavors[currentAcaiIndex].splice(index, 1);
    } else if (selectedFlavors[currentAcaiIndex].length < 2) {
        selectedFlavors[currentAcaiIndex].push(flavor);
    } else {
        alert("Você só pode selecionar até 2 sabores por açaí.");
        return;
    }
    updateFlavorSelection();
}

function updateFlavorSelection() {
    document.querySelectorAll('#flavorSelection .combo-item').forEach(item => {
        const flavor = item.textContent.trim();
        if (selectedFlavors[currentAcaiIndex].includes(flavor)) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

window.showAccompanimentSelection = function() {
    if (selectedFlavors[currentAcaiIndex].length === 0) {
        alert("Por favor, selecione pelo menos um sabor.");
        return;
    }
    const accompanimentSelection = document.getElementById('accompanimentSelection');
    accompanimentSelection.innerHTML = `
        <h3>Escolha até ${currentCombo.maxAccompaniments} acompanhamentos para o Açaí ${currentAcaiIndex + 1}:</h3>
        <div class="combo-items">
            ${extraItems.map(item => 
                `<div class="combo-item" onclick="toggleAccompaniment('${item.name}')">
                    <img src="${item.image}" alt="${item.name}">
                    <p>${item.name}</p>
                </div>`
            ).join('')}
        </div>
        <button class="btn" onclick="nextAcai()">Próximo</button>
    `;
    accompanimentSelection.style.display = 'block';
    document.getElementById('flavorSelection').style.display = 'none';
    updateAccompanimentSelection();
}

window.toggleAccompaniment = function(accompaniment) {
    const index = selectedAccompaniments[currentAcaiIndex].indexOf(accompaniment);
    if (index > -1) {
        selectedAccompaniments[currentAcaiIndex].splice(index, 1);
    } else if (selectedAccompaniments[currentAcaiIndex].length < currentCombo.maxAccompaniments) {
        selectedAccompaniments[currentAcaiIndex].push(accompaniment);
    } else {
        alert(`Você só pode selecionar até ${currentCombo.maxAccompaniments} acompanhamentos por açaí.`);
        return;
    }
    updateAccompanimentSelection();
}

function updateAccompanimentSelection() {
    document.querySelectorAll('#accompanimentSelection .combo-item').forEach(item => {
        const accompaniment = item.querySelector('p').textContent.trim();
        if (selectedAccompaniments[currentAcaiIndex].includes(accompaniment)) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

window.nextAcai = function() {
    if (selectedAccompaniments[currentAcaiIndex].length === 0) {
        alert("Por favor, selecione pelo menos um acompanhamento.");
        return;
    }
    if (currentAcaiIndex === 0) {
        currentAcaiIndex = 1;
        document.getElementById('accompanimentSelection').style.display = 'none';
        showFlavorSelection();
    } else {
        showExtraItemsSelection();
    }
}

window.showExtraItemsSelection = function() {
    const extraItemsSelection = document.getElementById('extraItemsSelection');
    extraItemsSelection.innerHTML = `
        <h3>Escolha itens extras (R$ 1,99 cada):</h3>
        <div class="combo-items">
            ${extraItems.map(item => 
                `<div class="combo-item" onclick="toggleExtra('${item.name}')">
                    <img src="${item.image}" alt="${item.name}">
                    <p>${item.name}</p>
                    <p>R$ ${item.price.toFixed(2)}</p>
                </div>`
            ).join('')}
        </div>
        <button class="btn" onclick="finishCombo()">Finalizar Combo</button>
    `;
    extraItemsSelection.style.display = 'block';
    document.getElementById('accompanimentSelection').style.display = 'none';
}

            window.toggleExtraItem = function(element, itemName) {
    console.log("Toggling extra item:", itemName); // Log para debug
    element.classList.toggle('selected');
    
    // Atualizar o carrinho com o item extra
    let extraItemIndex = window.cart.findIndex(item => item.name === itemName && item.isExtra);
    
    if (element.classList.contains('selected')) {
        // Adicionar item extra ao carrinho se não existir
        if (extraItemIndex === -1) {
            window.cart.push({
                id: Date.now(),
                name: itemName,
                price: 1.99,
                isExtra: true,
                totalPrice: 1.99
            });
        }
    } else {
        // Remover item extra do carrinho se existir
        if (extraItemIndex !== -1) {
            window.cart.splice(extraItemIndex, 1);
        }
    }
    
    // Atualizar o localStorage
    localStorage.setItem('cart', JSON.stringify(window.cart));
    
    updateOrderSummaryDirectly();
}

window.toggleExtra = function(extra) {
    const index = selectedExtras.indexOf(extra);
    if (index > -1) {
        selectedExtras.splice(index, 1);
    } else {
        selectedExtras.push(extra);
    }
    updateExtraItemsSelection();
}

function updateExtraItemsSelection() {
    document.querySelectorAll('#extraItemsSelection .combo-item').forEach(item => {
        const extra = item.querySelector('p').textContent.trim();
        if (selectedExtras.includes(extra)) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

window.finishCombo = function() {
    updateComboSummary();
    document.querySelector('#comboModal .btn[onclick="addComboToCart()"]').style.display = 'block';
}

function updateComboSummary() {
    const comboSummary = document.getElementById('comboSummary');
    let total = currentCombo.price + (selectedExtras.length * 1.99);
    comboSummary.innerHTML = `
        <h3>Resumo do Combo:</h3>
        <p><strong>Combo:</strong> ${currentCombo.name}</p>
        <p><strong>Açaí 1:</strong></p>
        <p>Sabores: ${selectedFlavors[0].join(', ')}</p>
        <p>Acompanhamentos: ${selectedAccompaniments[0].join(', ')}</p>
        <p><strong>Açaí 2:</strong></p>
        <p>Sabores: ${selectedFlavors[1].join(', ')}</p>
        <p>Acompanhamentos: ${selectedAccompaniments[1].join(', ')}</p>
        <p><strong>Extras:</strong> ${selectedExtras.length > 0 ? selectedExtras.join(', ') : 'Nenhum'}</p>
        <p><strong>Total:</strong> R$ ${total.toFixed(2)}</p>
    `;
}

window.addComboToCart = function() {
    console.log("Iniciando addComboToCart");
    if (!currentCombo) {
        console.error("Nenhum combo selecionado");
        alert("Por favor, selecione um combo antes de adicionar ao carrinho.");
        return;
    }

    const comboItem = {
        id: Date.now(),
        name: currentCombo.name,
        price: currentCombo.price,
        acai1: {
            flavors: selectedFlavors[0],
            accompaniments: selectedAccompaniments[0]
        },
        acai2: {
            flavors: selectedFlavors[1],
            accompaniments: selectedAccompaniments[1]
        },
        extras: selectedExtras,
        totalPrice: currentCombo.price + (selectedExtras.length * 1.99)
    };

    console.log("Combo item criado:", comboItem);

    window.cart.push(comboItem);
    localStorage.setItem('cart', JSON.stringify(window.cart));

    console.log("Combo adicionado ao carrinho. Novo tamanho do carrinho:", window.cart.length);

    alert('Combo adicionado ao carrinho!');
    closeModal('comboModal');
    resetComboBuilder();
    window.updateCartCount();
    window.openCart();
}

window.resetComboBuilder = function() {
    currentCombo = null;
    selectedFlavors = [[], []];
    selectedAccompaniments = [[], []];
    selectedExtras = [];
    currentAcaiIndex = 0;
    document.getElementById('flavorSelection').style.display = 'none';
    document.getElementById('accompanimentSelection').style.display = 'none';
    document.getElementById('extraItemsSelection').style.display = 'none';
    document.getElementById('comboSummary').innerHTML = '';
    document.querySelector('#comboModal .btn[onclick="addComboToCart()"]').style.display = 'none';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
    showHeaderAndCategories();
}

document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
        closeModal(this.closest('.modal').id);
    }
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        closeModal(event.target.id);
    }
}

        fetchCategories();
        fetchProducts();
        document.getElementById('loadingOverlay').style.display = 'none';
    });
    console.log("Script finalizado com sucesso");
    </script>
    <script>
window.embeddedChatbotConfig = {
chatbotId: "PpgNSIgeYN1FCucFGP4w3",
domain: "www.chatbase.co"
}
</script>
<script
src="https://www.chatbase.co/embed.min.js"
chatbotId="PpgNSIgeYN1FCucFGP4w3"
domain="www.chatbase.co"
defer>
</script>
</body>
</html>
