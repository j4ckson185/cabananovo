<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabana A√ßa√≠</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a0e4e;
            --secondary-color: #8e44ad;
            --background-color: #f5f5f5;
            --text-color: #333;
            --accent-color: #e74c3c;
            --acai-purple: #4B0082;
            --acai-pink: #FF69B4;
            --acai-green: #32CD32;
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        header {
            background: linear-gradient(135deg, var(--acai-purple), var(--acai-pink));
            color: white;
            padding: 1em 0;
            text-align: center;
        }
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .logo {
            width: 150px;
            height: auto;
            margin-bottom: 10px;
        }
        .cart-icon {
            font-size: 24px;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
            color: white;
        }
        main {
            max-width: 1200px;
            margin: 2em auto;
            padding: 0 20px;
        }
        .categories, .product-grid {
            margin-bottom: 2em;
        }
        .category-btn {
            margin: 0 0.5em 0.5em 0;
            padding: 0.5em 1em;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .category-btn:hover, .category-btn.active {
            background-color: var(--primary-color);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2em;
        }
        .product-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .product-info {
            padding: 1em;
        }
        .product-title {
            margin: 0;
            font-size: 1.2em;
            color: var(--acai-purple);
        }
        .product-price {
            font-weight: bold;
            color: var(--acai-pink);
            margin-top: 0.5em;
        }
        .product-description {
            margin-top: 0.5em;
            font-size: 0.9em;
            color: #666;
        }
        .btn {
            display: inline-block;
            padding: 0.5em 1em;
            background-color: var(--acai-purple);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: var(--acai-pink);
        }
        .btn:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .extras-list {
            margin-top: 1em;
        }
        .extras-list h3 {
            margin-bottom: 0.5em;
            color: var(--acai-purple);
        }
        .extras-list ul {
            list-style-type: none;
            padding-left: 0;
        }
        .extras-list li {
            margin-bottom: 0.5em;
        }
        .checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        .checkbox-item input {
            margin-right: 5px;
        }
        #cartModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-remove {
            color: var(--accent-color);
            cursor: pointer;
        }
        .error-message {
            color: var(--accent-color);
            margin-top: 10px;
        }
        #customerIdentificationForm {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #customerIdentificationForm h2 {
            color: var(--acai-purple);
            margin-bottom: 20px;
        }
        #customerIdentificationForm label {
            display: block;
            margin-top: 10px;
            color: var(--acai-pink);
        }
        #customerIdentificationForm input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #customerIdentificationForm .btn {
            margin-top: 20px;
            width: 100%;
        }
        .input-icon {
            position: relative;
        }
        .input-icon i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--acai-pink);
        }
        .input-icon input {
            padding-left: 35px;
        }
        #checkoutForm {
            margin-top: 20px;
        }
        #checkoutForm label {
            display: block;
            margin-top: 10px;
            color: var(--acai-purple);
        }
        #checkoutForm input, #checkoutForm textarea, #checkoutForm select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }
        #orderSummary {
            margin-top: 20px;
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
        }
        .loyalty-info {
            background-color: #e8f5e9;
            border: 1px solid var(--acai-green);
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .required-field {
            color: var(--accent-color);
        }
        .extras-suggestion {
            background-color: #f0e6ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .extras-suggestion h3 {
            color: var(--acai-purple);
            margin-bottom: 15px;
            text-align: center;
        }
        .extra-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .extra-item {
            background-color: white;
            border: 2px solid var(--acai-pink);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .extra-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .extra-item p {
            margin: 5px 0;
            font-size: 0.9em;
            color: var(--acai-purple);
        }
        .extra-item.selected {
            background-color: #e6e6fa;
            border-color: var(--acai-purple);
            transform: scale(1.05);
        }
        #comboBuilderModal .modal-content {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }
        #comboBuilderChat {
            width: 60%;
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
        #comboDynamicSummary {
            width: 35%;
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        .combo-step {
            margin-bottom: 20px;
        }
        .combo-options, .flavor-options, .accompaniment-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .combo-option, .flavor-option, .accompaniment-option {
            background-color: #fff;
            border: 2px solid var(--acai-pink);
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .combo-option:hover, .flavor-option:hover, .accompaniment-option:hover,
        .combo-option.selected, .flavor-option.selected, .accompaniment-option.selected {
            background-color: #e6e6fa;
            border-color: var(--acai-purple);
            transform: scale(1.05);
        }
        .combo-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .combo-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        .combo-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .combo-item.selected {
            border-color: var(--acai-purple);
            background-color: #e6e6fa;
        }
        #comboSummary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        .user-options {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .user-options .btn {
            margin: 0 10px;
        }
        #monteCombo {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--acai-purple);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1000;
        }
        #userInput {
            width: 80%;
            padding: 10px;
            margin-right: 10px;
        }
        #sendMessage {
            width: 18%;
            padding: 10px;
        }
        .back-button {
            background-color: var(--acai-green);
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana A√ßa√≠ Logo" class="logo">
            <h1>Cabana A√ßa√≠</h1>
            <h4>Quarta √† Domingo</h4>
            <p>12:30h as 22:30h</p>
        </div>
<div class="cart-icon" onclick="openCart()">üõí</div>
    </header>
    <main>
        <div class="user-options">
            <button class="btn" onclick="openMyOrders()">Meus Pedidos</button>
            <button class="btn" onclick="openLoyaltyProgram()">Programa Fidelidade</button>
        </div>
        <div class="categories" id="categories"></div>
        <div class="product-grid" id="productGrid"></div>
    </main>
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Seu Carrinho</h2>
            <div id="cartContent"></div>
            <div id="cartTotal"></div>
            <button class="btn" onclick="openCustomerIdentification()">Finalizar Pedido</button>
            <button class="btn" onclick="continueShopping()">Continuar Comprando</button>
        </div>
    </div>
    <div id="customerIdentificationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
    <form id="customerIdentificationForm">
      <h2><i class="fas fa-user"></i> Identifique-se</h2>
      <div class="input-icon">
        <i class="fas fa-user"></i>
        <input type="text" id="customerName" placeholder="Nome Completo" required>
      </div>
      <div class="input-icon">
        <i class="fab fa-whatsapp"></i>
        <input type="tel" id="customerPhone" placeholder="WhatsApp (com DDD)" required>
      </div>
      <button type="submit" class="btn">Avan√ßar</button>
    </form>
        </div>
    </div>
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Finalizar Pedido</h2>
            <form id="checkoutForm">
                <div id="deliveryAddressSection">
                    <h3>Endere√ßo de Entrega</h3>
                    <select id="savedAddresses" onchange="handleSavedAddressChange()">
                        <option value="">Selecione um endere√ßo salvo ou cadastre um novo</option>
                    </select>
                    <button type="button" class="btn" onclick="showNewAddressForm()">Cadastrar Novo Endere√ßo</button>
                    <div id="newAddressForm" style="display: none;">
                        <label for="street">Rua: <span class="required-field">*</span></label>
                        <input type="text" id="street" required>
                        <label for="number">N√∫mero: <span class="required-field">*</span></label>
                        <input type="text" id="number" required>
                        <label for="complement">Complemento:</label>
                        <input type="text" id="complement">
                        <label for="neighborhood">Bairro: <span class="required-field">*</span></label>
                        <input type="text" id="neighborhood" required>
                        <label for="city">Cidade: <span class="required-field">*</span></label>
                        <input type="text" id="city" required>
                        <label for="state">Estado: <span class="required-field">*</span></label>
                        <input type="text" id="state" required>
                        <button type="button" class="btn" onclick="saveNewAddress()">Salvar Endere√ßo</button>
                    </div>
                </div>
                <div id="paymentSection" style="display: none;">
                    <label for="paymentMethod">M√©todo de Pagamento:</label>
                    <select id="paymentMethod" required onchange="handlePaymentChange()">
                        <option value="card">Cart√£o na entrega</option>
                        <option value="money">Dinheiro</option>
                        <option value="pix">PIX</option>
                    </select>
                    <div id="moneyChange" style="display:none;">
                        <label for="changeNeeded">Precisa de troco?</label>
                        <select id="changeNeeded" onchange="handleChangeNeeded()">
                            <option value="no">N√£o</option>
                            <option value="yes">Sim</option>
                        </select>
                        <div id="changeAmountDiv" style="display:none;">
                            <label for="changeAmount">Troco para quanto?</label>
                            <input type="number" id="changeAmount" min="0" step="0.01">
                        </div>
                    </div>
                    <div id="pixInfo" style="display:none;">
                        <p>Chave PIX: 84 9 8873-1028</p>
                        <p>Ap√≥s o envio do PIX, favor enviar o comprovante para o WhatsApp 84 9 8767-3202</p>
                    </div>
                </div>
                <button type="submit" class="btn" id="submitOrderBtn" style="display: none;">Fazer Pedido</button>
            </form>
            <div id="orderSummary"></div>
            <div id="loyaltyInfo" class="loyalty-info"></div>
            
            <div class="extras-suggestion">
                <h3>Deixe seu a√ßa√≠ mais delicioso e recheado com esses itens extras</h3>
                <div class="extra-items" id="extraItems">
                    <!-- Itens extras ser√£o adicionados aqui via JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <div id="myOrdersModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Meus Pedidos</h2>
            <div id="myOrdersContent"></div>
        </div>
    </div>
    <div id="loyaltyProgramModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Programa Fidelidade</h2>
            <div id="loyaltyProgramContent"></div>
        </div>
    </div>
    <div id="monteCombo" onclick="openComboBuilder()">
        Monte seu Combo üç®
    </div>
    <div id="comboBuilderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeComboBuilder()">&times;</span>
            <button class="back-button" onclick="goBackInComboBuilder()">Voltar</button>
            <div id="comboBuilderChat"></div>
            <div id="comboSummary">
                <h3>Detalhes do seu Combo</h3>
                <div id="comboDynamicSummary"></div>
            </div>
        </div>
        <input type="text" id="userInput" placeholder="Digite sua mensagem...">
        <button id="sendMessage" onclick="sendMessage()">Enviar</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
            authDomain: "cabana-8d55e.firebaseapp.com",
            databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
            projectId: "cabana-8d55e",
            storageBucket: "cabana-8d55e.appspot.com",
            messagingSenderId: "706144237954",
            appId: "1:706144237954:web:345c10370972486afc779b",
            measurementId: "G-96Y337GYT8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        const deliveryFee = 3.00;
        let customerInfo = {};
        let savedAddresses = [];

        // Dados dos itens extras
        const extraItems = [
            { name: "Ovomaltine", price: 1.99, image: "https://images.tcdn.com.br/img/img_prod/919170/ovomaltine_flocos_extra_crocante_750g_425_1_e9d3c08b8341c4e7818b1759c877a213.jpg" },
            { name: "Amendoim", price: 1.99, image: "https://cdn.entrypoint.directory/assets/39790/produtos/3053/xerem-amendoim-secundaria-relva-verde-500g.jpg" },
            { name: "Granola", price: 1.99, image: "https://jardimdaservas.com.br/wp-content/uploads/2023/05/GRANOLAAAIGUARANEMEL-1.jpg" },
            { name: "Chocoball", price: 1.99, image: "https://lojasantoantonio.vtexassets.com/arquivos/ids/156826/562-Choco-Power-Ball-Mini-Preto-e-Branco-500G-MAVALERIO.jpg?v=637254329101230000" },
            { name: "M&M", price: 1.99, image: "https://static.welban.com.br/public/welban/imagens/produtos/confete-de-chocolate-colorido-500g-chococandy-dori-64029a15a016e.jpg" },
            { name: "C√¥co Ralado", price: 1.99, image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_Mt3NOWlBbg-Yv0ttYPiXwNdMIxdh1aSuxJOIg50WN-1FOjiagSbr7MDjQf9OE0b2hnU&usqp=CAU" },
            { name: "Leite em p√≥", price: 1.99, image: "https://acougueamigos.com/cdn/shop/products/acougue-amigos_1_27.jpg?v=1615589403" },
            { name: "Leite condensado", price: 1.99, image: "https://static.escolakids.uol.com.br/conteudo_legenda/07795c263fc55bd57242ef71ae55cee8.jpg" },
            { name: "Calda de Morango", price: 1.99, image: "https://i.ytimg.com/vi/3K6gWHdjyUU/maxresdefault.jpg" },
            { name: "Calda de Chocolate", price: 1.99, image: "https://img.cybercook.com.br/receitas/53/calda-de-chocolate.jpeg" }
        ];

        // Dados dos combos
        const combos = [
            { name: "Combo 2 de 300ml", price: 20.00, maxAccompaniments: 3 },
            { name: "Combo 2 de 500ml", price: 26.99, maxAccompaniments: 4 },
            { name: "Combo 2 de 1 Litro", price: 49.99, maxAccompaniments: 8 }
        ];

        // Sabores de a√ßa√≠ e creme
        const flavors = [
            { name: "A√ßa√≠ Tradicional", type: "a√ßa√≠" },
            { name: "A√ßa√≠ com Guaran√°", type: "a√ßa√≠" },
            { name: "Creme de Ninho", type: "creme" },
            { name: "Creme de Ovomaltine", type: "creme" },
            { name: "Creme de Maracuj√°", type: "creme" },
            { name: "Creme de Amendoim", type: "creme" },
            { name: "Creme de Cupua√ßu", type: "creme" }
        ];

        async function fetchProducts() {
            const snapshot = await db.collection('products').get();
            products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            displayProducts(products);
        }

        async function fetchCategories() {
            const snapshot = await db.collection('categories').get();
            const categories = snapshot.docs.map(doc => doc.data().name);
            const categoriesContainer = document.getElementById('categories');
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category;
                button.onclick = () => filterByCategory(category);
                categoriesContainer.appendChild(button);
            });
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.onclick = () => filterByCategory('all');
            categoriesContainer.insertBefore(allButton, categoriesContainer.firstChild);
        }

        function filterByCategory(category) {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            const filteredProducts = category === 'all' ? products : products.filter(product => product.category === category);
            displayProducts(filteredProducts);
        }

        function displayProducts(productsToDisplay = products) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = productsToDisplay.map(product => `
                <div class="product-card" onclick="openProductDetails(${product.id})">
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
                        <p class="product-description">${product.description.substring(0, 100)}...</p>
                        <button class="btn" onclick="openProductDetails(${product.id}, event)">Ver Detalhes</button>
                    </div>
                </div>
            `).join('');
        }

window.openProductDetails = function(productId, event) {
            if (event) {
                event.stopPropagation();
            }
            const product = products.find(p => p.id === productId);
            const modal = document.getElementById('productModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h2>${product.name}</h2>
                <img src="${product.image}" alt="${product.name}" style="width:100%; max-height:300px; object-fit:cover;">
                <p>${product.description}</p>
                <p class="product-price">Pre√ßo: R$ ${parseFloat(product.price).toFixed(2)}</p>
                <div class="extras-list">
                    <h3>Acompanhamentos (escolha de ${product.minAccompaniments} a ${product.maxAccompaniments}):</h3>
                    <div class="checkbox-list" id="accompaniments">
                        ${product.accompaniments.map((item, index) => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="acc${index}" name="accompaniment" value="${item}">
                                <label for="acc${index}">${item}</label>
                            </div>
                        `).join('')}
                    </div>
                    <p id="accompanimentError" class="error-message"></p>
                </div>
                <div class="extras-list">
                    <h3>Itens Extras:</h3>
                    <div class="checkbox-list" id="extras">
                        ${product.extras.map((item, index) => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="extra${index}" name="extra" value="${item.name}">
                                <label for="extra${index}">${item.name} - R$ ${parseFloat(item.price).toFixed(2)}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button id="addToCartBtn" class="btn" onclick="addToCart(${product.id})">Adicionar ao Carrinho</button>
            `;
            modal.style.display = "block";
            // Adicionar valida√ß√£o para acompanhamentos
            const accCheckboxes = document.querySelectorAll('#accompaniments input[type="checkbox"]');
            accCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => validateAccompaniments(product));
            });
        }

        function validateAccompaniments(product) {
            const checkedAccompaniments = document.querySelectorAll('#accompaniments input[type="checkbox"]:checked');
            const addToCartBtn = document.getElementById('addToCartBtn');
            const errorMessage = document.getElementById('accompanimentError');
            if (checkedAccompaniments.length < product.minAccompaniments || checkedAccompaniments.length > product.maxAccompaniments) {
                addToCartBtn.disabled = true;
                errorMessage.textContent = `Selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos`;
            } else {
                addToCartBtn.disabled = false;
                errorMessage.textContent = '';
            }
        }

        window.addToCart = function(productId) {
            const product = products.find(p => p.id === productId);
            const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
            const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);
            if (accompaniments.length < product.minAccompaniments || accompaniments.length > product.maxAccompaniments) {
                alert(`Por favor, selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos.`);
                return;
            }
            const cartItem = {
                id: Date.now(),
                productId: product.id,
                name: product.name,
                price: product.price,
                accompaniments: accompaniments,
                extras: extras,
                totalPrice: calculateTotalPrice(product, extras)
            };
            cart.push(cartItem);
            localStorage.setItem('cart', JSON.stringify(cart));
            openCart();
        }

        function calculateTotalPrice(product, selectedExtras) {
            let total = product.price;
            selectedExtras.forEach(extraName => {
                const extra = product.extras.find(e => e.name === extraName);
                if (extra) {
                    total += extra.price;
                }
            });
            return total;
        }

        window.openCart = function() {
            const modal = document.getElementById('cartModal');
            const cartContent = document.getElementById('cartContent');
            const cartTotal = document.getElementById('cartTotal');
            cartContent.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h3>${item.name}</h3>
                        <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
                        <p>Extras: ${item.extras.join(', ')}</p>
                        <p>Pre√ßo: R$ ${item.totalPrice.toFixed(2)}</p>
                    </div>
                    <span class="cart-item-remove" onclick="removeFromCart(${item.id})">üóëÔ∏è</span>
                </div>
            `).join('');
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
            modal.style.display = "block";
        }

        window.continueShopping = function() {
            document.getElementById('cartModal').style.display = "none";
        }

        window.removeFromCart = function(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            localStorage.setItem('cart', JSON.stringify(cart));
            openCart();
        }

        window.openCustomerIdentification = function() {
            document.getElementById('cartModal').style.display = "none";
            const modal = document.getElementById('customerIdentificationModal');
            modal.style.display = "block";
            const phone = localStorage.getItem('customerPhone');
            if (phone) {
                document.getElementById('customerPhone').value = phone;
                document.getElementById('customerName').value = localStorage.getItem('customerName') || '';
                loadCustomerData(phone);
            }
        }

        function loadCustomerData(phone) {
            db.collection('customers').doc(phone).get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    customerInfo = {
                        name: data.name,
                        phone: phone,
                        addresses: data.addresses || []
                    };
                    document.getElementById('customerName').value = data.name;
                    savedAddresses = data.addresses || [];
                    localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
                    updateLoyaltyInfo(data.orderCount || 0);
                } else {
                    updateLoyaltyInfo(0);
                }
            }).catch((error) => {
                console.log("Error getting customer data:", error);
                updateLoyaltyInfo(0);
            });
        }

        document.getElementById('customerIdentificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const phone = document.getElementById('customerPhone').value;
            const name = document.getElementById('customerName').value;
            customerInfo = { phone, name };
            localStorage.setItem('customerPhone', phone);
            localStorage.setItem('customerName', name);
            db.collection('customers').doc(phone).set({
                name: name,
                addresses: savedAddresses
            }, { merge: true }).then(() => {
                document.getElementById('customerIdentificationModal').style.display = "none";
                openCheckout();
            }).catch((error) => {
                console.error("Error saving customer data: ", error);
            });
        });

        function openCheckout() {
            const checkoutModal = document.getElementById('checkoutModal');
            const orderSummary = document.getElementById('orderSummary');
            loadSavedAddresses();
            updateOrderSummary();
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('submitOrderBtn').style.display = 'none';
            checkoutModal.style.display = "block";
            displayExtraItems();
        }

        function loadSavedAddresses() {
            const select = document.getElementById('savedAddresses');
            select.innerHTML = '<option value="">Selecione um endere√ßo salvo ou cadastre um novo</option>';
            savedAddresses.forEach((address, index) => {
                select.innerHTML += `<option value="${index}">${address.street}, ${address.number} - ${address.neighborhood}</option>`;
            });
        }

        window.handleSavedAddressChange = function() {
            const selectedIndex = document.getElementById('savedAddresses').value;
            if (selectedIndex !== "") {
                const address = savedAddresses[selectedIndex];
                document.getElementById('street').value = address.street;
                document.getElementById('number').value = address.number;
                document.getElementById('complement').value = address.complement || '';
                document.getElementById('neighborhood').value = address.neighborhood;
                document.getElementById('city').value = address.city;
                document.getElementById('state').value = address.state;
                
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('submitOrderBtn').style.display = 'block';
            } else {
                document.getElementById('paymentSection').style.display = 'none';
                document.getElementById('submitOrderBtn').style.display = 'none';
            }
        }

        window.showNewAddressForm = function() {
            document.getElementById('newAddressForm').style.display = 'block';
        }

        window.saveNewAddress = function() {
            const newAddress = {
                street: document.getElementById('street').value,
                number: document.getElementById('number').value,
                complement: document.getElementById('complement').value,
                neighborhood: document.getElementById('neighborhood').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value
            };
            
            let missingFields = [];
            if (!newAddress.street) missingFields.push('Rua');
            if (!newAddress.number) missingFields.push('N√∫mero');
            if (!newAddress.neighborhood) missingFields.push('Bairro');
            if (!newAddress.city) missingFields.push('Cidade');
            if (!newAddress.state) missingFields.push('Estado');
            
            if (missingFields.length > 0) {
                alert(`Por favor, preencha os seguintes campos obrigat√≥rios: ${missingFields.join(', ')}`);
                return;
            }
            savedAddresses.push(newAddress);
            localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
            
            db.collection('customers').doc(customerInfo.phone).update({
                addresses: savedAddresses
            }).then(() => {
                loadSavedAddresses();
                alert('Novo endere√ßo salvo com sucesso!');
                document.getElementById('newAddressForm').style.display = 'none';
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('submitOrderBtn').style.display = 'block';
            }).catch((error) => {
                console.error("Error updating addresses: ", error);
            });
        }

        window.handlePaymentChange = function() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            document.getElementById('moneyChange').style.display = paymentMethod === 'money' ? 'block' : 'none';
            document.getElementById('pixInfo').style.display = paymentMethod === 'pix' ? 'block' : 'none';
        }

        window.handleChangeNeeded = function() {
            const changeNeeded = document.getElementById('changeNeeded').value;
            document.getElementById('changeAmountDiv').style.display = changeNeeded === 'yes' ? 'block' : 'none';
        }

        function displayExtraItems() {
            const extraItemsContainer = document.getElementById('extraItems');
            extraItemsContainer.innerHTML = extraItems.map(item => `
                <div class="extra-item" onclick="toggleExtraItem(this, '${item.name}')">
                    <img src="${item.image}" alt="${item.name}">
                    <p>${item.name}</p>
                    <p>R$ ${item.price.toFixed(2)}</p>
                </div>
            `).join('');
        }

        window.toggleExtraItem = function(element, itemName) {
            element.classList.toggle('selected');
            updateOrderSummary();
        }

        function updateOrderSummary() {
            const orderSummary = document.getElementById('orderSummary');
            let summaryHTML = '<h3>Resumo do Pedido:</h3>';
            let total = 0;
            
            cart.forEach(item => {
                summaryHTML += `
                    <p>${item.name} - R$ ${item.totalPrice.toFixed(2)}</p>
                    <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
                    <p>Extras: ${item.extras.join(', ')}</p>
                    <hr>
                `;
                total += item.totalPrice;
            });
            
            const selectedExtras = document.querySelectorAll('.extra-item.selected');
            let extrasTotal = 0;
            selectedExtras.forEach(item => {
                const itemName = item.querySelector('p').textContent;
                const itemPrice = 1.99;
                extrasTotal += itemPrice;
                summaryHTML += `<p>Extra: ${itemName} - R$ ${itemPrice.toFixed(2)}</p>`;
            });
            total += extrasTotal;
            summaryHTML += `<h4>Subtotal: R$ ${total.toFixed(2)}</h4>`;
            summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
            summaryHTML += `<h3>Total: R$ ${(total + deliveryFee).toFixed(2)}</h3>`;
            orderSummary.innerHTML = summaryHTML;
        }

        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedAddressIndex = document.getElementById('savedAddresses').value;
            if (selectedAddressIndex === "") {
                alert("Por favor, selecione um endere√ßo de entrega.");
                return;
            }
const selectedAddress = savedAddresses[selectedAddressIndex];
            const paymentMethod = document.getElementById('paymentMethod').value;
            const changeNeeded = document.getElementById('changeNeeded').value;
            const changeAmount = document.getElementById('changeAmount').value;
            let message = `Pedido confirmado!\n`;
            message += `Nome: ${customerInfo.name}\n`;
            message += `WhatsApp: ${customerInfo.phone}\n`;
            message += `Endere√ßo: ${selectedAddress.street}, ${selectedAddress.number}, ${selectedAddress.neighborhood}, ${selectedAddress.city} - ${selectedAddress.state}\n`;
            if (selectedAddress.complement) {
                message += `Complemento: ${selectedAddress.complement}\n`;
            }
            message += `M√©todo de Pagamento: ${getPaymentMethodText(paymentMethod)}\n`;
            if (paymentMethod === 'money') {
                message += `Precisa de troco: ${changeNeeded === 'yes' ? 'Sim' : 'N√£o'}\n`;
                if (changeNeeded === 'yes') {
                    message += `Troco para: R$ ${parseFloat(changeAmount).toFixed(2)}\n`;
                }
            }
            
            message += `\nItens do Pedido:\n`;
            cart.forEach(item => {
                message += `\n${item.name} - R$ ${item.totalPrice.toFixed(2)}`;
                if (item.accompaniments.length > 0) {
                    message += `\nAcompanhamentos: ${item.accompaniments.join(', ')}`;
                }
                if (item.extras.length > 0) {
                    message += `\nExtras: ${item.extras.join(', ')}`;
                }
            });
            
            const selectedExtras = document.querySelectorAll('.extra-item.selected');
            if (selectedExtras.length > 0) {
                message += "\n\nItens Extras Adicionais:";
                selectedExtras.forEach(item => {
                    const itemName = item.querySelector('p').textContent;
                    message += `\n- ${itemName} (R$ 1,99)`;
                });
            }
            
            const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            const extrasTotal = selectedExtras.length * 1.99;
            const total = subtotal + extrasTotal + deliveryFee;
            
            message += `\n\nSubtotal: R$ ${subtotal.toFixed(2)}`;
            message += `\nExtras Adicionais: R$ ${extrasTotal.toFixed(2)}`;
            message += `\nTaxa de Entrega: R$ ${deliveryFee.toFixed(2)}`;
            message += `\nTotal: R$ ${total.toFixed(2)}`;
            
            const order = {
                id: Date.now(),
                customerName: customerInfo.name,
                customerPhone: customerInfo.phone,
                address: selectedAddress,
                paymentMethod: paymentMethod,
                changeNeeded: changeNeeded,
                changeAmount: changeAmount,
                items: cart,
                extraItems: Array.from(selectedExtras).map(item => item.querySelector('p').textContent),
                subtotal: subtotal,
                extrasTotal: extrasTotal,
                deliveryFee: deliveryFee,
                total: total,
                status: 'preparing',
                createdAt: new Date()
            };
            db.collection('orders').add(order)
                .then(() => {
                    console.log('Pedido adicionado com sucesso!');
                    return db.collection('customers').doc(customerInfo.phone).get();
                })
                .then((doc) => {
                    let orderCount = 0;
                    if (doc.exists) {
                        orderCount = doc.data().orderCount || 0;
                    }
                    orderCount++;
                    
                    return db.collection('customers').doc(customerInfo.phone).set({
                        name: customerInfo.name,
                        orderCount: orderCount
                    }, { merge: true });
                })
                .then(() => {
                    return db.collection('customers').doc(customerInfo.phone).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        const orderCount = doc.data().orderCount;
                        message += `\n\nEste √© o ${getOrderNumberText(orderCount)} pedido do cliente.`;
                        if (orderCount >= 10) {
                            message += `\nCliente tem direito ao desconto de fidelidade!`;
                        } else {
                            message += `\nFaltam ${10 - orderCount} pedidos para o pr√≥ximo desconto de fidelidade.`;
                        }
                    }
                    window.location.href = `https://wa.me/5584987673202?text=${encodeURIComponent(message)}`;
                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    document.getElementById('paymentMethod').value = 'card';
                    handlePaymentChange();
                    document.getElementById('checkoutModal').style.display = "none";
                })
                .catch(error => {
                    console.error('Erro ao adicionar pedido: ', error);
                });
        });

        function getPaymentMethodText(method) {
            switch(method) {
                case 'money': return 'Dinheiro';
                case 'card': return 'Cart√£o na entrega';
                case 'pix': return 'PIX';
                default: return method;
            }
        }

        function getOrderNumberText(number) {
            const specialCases = ['primeiro', 'segundo', 'terceiro', 'quarto', 'quinto'];
            return specialCases[number - 1] || `${number}¬∫`;
        }

        function updateLoyaltyInfo(orderCount) {
            const loyaltyInfo = document.getElementById('loyaltyInfo');
            loyaltyInfo.innerHTML = `
                <h3>Programa de Fidelidade</h3>
                <p>Voc√™ j√° realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
                ${orderCount >= 10 ? 
                  '<p><strong>Parab√©ns!</strong> Voc√™ tem direito a 50% de desconto no seu pr√≥ximo pedido!</p>' :
                  `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para voc√™ ganhar 50% de desconto!</p>`
                }
                <p>Lembre-se: O pedido s√≥ ser√° contabilizado ap√≥s ser recebido por nossa loja no WhatsApp.</p>
            `;
        }

        window.openMyOrders = function() {
            const modal = document.getElementById('myOrdersModal');
            const content = document.getElementById('myOrdersContent');
            content.innerHTML = `
                <h3>Insira seu n√∫mero de WhatsApp para ver seus pedidos:</h3>
                <input type="tel" id="orderPhoneInput" placeholder="WhatsApp (com DDD)" required>
                <button class="btn" onclick="fetchMyOrders()">Buscar Pedidos</button>
                <div id="ordersList"></div>
            `;
            modal.style.display = "block";
        }

        window.fetchMyOrders = function() {
            const phone = document.getElementById('orderPhoneInput').value;
            if (!phone) {
                alert("Por favor, insira seu n√∫mero de WhatsApp.");
                return;
            }
            db.collection('orders')
                .where('customerPhone', '==', phone)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    const ordersList = document.getElementById('ordersList');
                    if (querySnapshot.empty) {
                        ordersList.innerHTML = '<p>Nenhum pedido encontrado para este n√∫mero.</p>';
                    } else {
                        let ordersHtml = '<h3>Seus Pedidos:</h3>';
                        querySnapshot.forEach((doc) => {
                            const order = doc.data();
                            ordersHtml += `
              <div class="order-item">
                <p><strong>Data:</strong> ${order.createdAt.toDate().toLocaleString()}</p>
                <p><strong>Total:</strong> R$ ${order.total.toFixed(2)}</p>
                <p><strong>Detalhes do Pedido:</strong> ${order.items.map(item => `${item.name} (${item.accompaniments.join(', ')})${item.extras.length > 0 ? ` + Extras: ${item.extras.join(', ')}` : ''}`).join(', ')}</p>
                <button class="btn" onclick="repeatOrder('${doc.id}')">Repetir Este Pedido</button>
              </div>
                            `;
                        });
                        ordersList.innerHTML = ordersHtml;
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar pedidos: ", error);
                    alert("Ocorreu um erro ao buscar seus pedidos. Por favor, tente novamente.");
                });
        }

        window.repeatOrder = function(orderId) {
            db.collection('orders').doc(orderId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const order = doc.data();
                        cart = order.items;
                        localStorage.setItem('cart', JSON.stringify(cart));
                        alert("Pedido adicionado ao carrinho!");
                        document.getElementById('myOrdersModal').style.display = "none";
                        openCart();
                    } else {
                        alert("Pedido n√£o encontrado.");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao repetir pedido: ", error);
                    alert("Ocorreu um erro ao repetir o pedido. Por favor, tente novamente.");
                });
        }

        window.openLoyaltyProgram = function() {
            const modal = document.getElementById('loyaltyProgramModal');
            const content = document.getElementById('loyaltyProgramContent');
            content.innerHTML = `
                <h3>Programa de Fidelidade Cabana A√ßa√≠</h3>
                <p>Nosso programa de fidelidade √© simples e recompensador:</p>
                <ul>
                    <li>A cada 10 pedidos, voc√™ ganha 50% de desconto no pr√≥ximo!</li>
                    <li>Os pedidos s√£o contabilizados dentro da janela do WhatsApp do cliente.</li>
                    <li>Se voc√™ fizer pedidos com n√∫meros de WhatsApp diferentes, os pontos de fidelidade ser√£o somados no novo n√∫mero que est√° utilizando para compra.</li>
                </ul>
                <p>Para verificar seus pontos de fidelidade, insira seu n√∫mero de WhatsApp:</p>
                <input type="tel" id="loyaltyPhoneInput" placeholder="WhatsApp (com DDD)" required>
                <button class="btn" onclick="checkLoyaltyPoints()">Verificar Pontos</button>
                <div id="loyaltyPoints"></div>
            `;
            modal.style.display = "block";
        }

        window.checkLoyaltyPoints = function() {
            const phone = document.getElementById('loyaltyPhoneInput').value;
            if (!phone) {
                alert("Por favor, insira seu n√∫mero de WhatsApp.");
                return;
            }
            db.collection('customers').doc(phone).get()
                .then((doc) => {
                    const loyaltyPoints = document.getElementById('loyaltyPoints');
                    if (doc.exists) {
                        const orderCount = doc.data().orderCount || 0;
                        loyaltyPoints.innerHTML = `
                            <p>Voc√™ j√° realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
                            ${orderCount >= 10 ? 
                                '<p><strong>Parab√©ns!</strong> Voc√™ tem direito a 50% de desconto no seu pr√≥ximo pedido!</p>' :
                                `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para voc√™ ganhar 50% de desconto!</p>`
                            }
                        `;
                    } else {
                        loyaltyPoints.innerHTML = '<p>Nenhum pedido encontrado para este n√∫mero.</p>';
                    }
                })
                .catch((error) => {
                    console.error("Erro ao verificar pontos de fidelidade: ", error);
                    alert("Ocorreu um erro ao verificar seus pontos. Por favor, tente novamente.");
                });
        }

        // Fun√ß√µes para o assistente de montagem de combo
        let currentCombo = null;
        let currentStep = 'combo';
        let currentAcai = 1;
        let comboHistory = [];

        window.openComboBuilder = function() {
            document.getElementById('comboBuilderModal').style.display = 'block';
            startComboBuilder();
        }

        window.closeComboBuilder = function() {
            document.getElementById('comboBuilderModal').style.display = 'none';
            resetComboBuilder();
        }

        function startComboBuilder() {
            updateAssistantChat("Ol√°! Vamos montar seu combo de a√ßa√≠? Escolha uma das op√ß√µes abaixo:");
            displayComboOptions();
        }

        function displayComboOptions() {
            const comboBuilder = document.getElementById('comboBuilderChat');
            comboBuilder.innerHTML += `
                <div class="combo-options">
                    ${combos.map(combo => `
                        <div class="combo-option" onclick="selectCombo('${combo.name}')">
                            <h3>${combo.name}</h3>
                            <p>R$ ${combo.price.toFixed(2)}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.selectCombo = function(comboName) {
            currentCombo = combos.find(combo => combo.name === comboName);
            currentCombo.acai1 = { flavors: [], accompaniments: [] };
            currentCombo.acai2 = { flavors: [], accompaniments: [] };
            currentStep = 'flavor';
            updateAssistantChat(`√ìtima escolha! Agora, vamos escolher os sabores para o primeiro a√ßa√≠ do ${currentCombo.name}.`);
            displayFlavorOptions();
            updateComboDynamicSummary();
            comboHistory.push('combo');
        }

        function displayFlavorOptions() {
            const comboBuilder = document.getElementById('comboBuilderChat');
            comboBuilder.innerHTML += `
                <div class="flavor-options">
                    ${flavors.map(flavor => `
                        <div class="flavor-option" onclick="selectFlavor('${flavor.name}')">
                            <p>${flavor.name}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

window.selectFlavor = function(flavorName) {
    if (currentAcai === 1) {
        currentCombo.acai1.flavors.push(flavorName);
    } else {
        currentCombo.acai2.flavors.push(flavorName);
    }

    updateAssistantChat(`Sabor ${flavorName} selecionado para o a√ßa√≠ ${currentAcai}.`);

    if ((currentAcai === 1 && currentCombo.acai1.flavors.length < 2) || 
        (currentAcai === 2 && currentCombo.acai2.flavors.length < 2)) {
        updateAssistantChat("Deseja escolher mais um sabor ou prosseguir para os acompanhamentos?");
        displayOptions(["Escolher outro sabor", "Prosseguir para acompanhamentos"]);
    } else {
        currentStep = 'accompaniment';
        displayAccompanimentOptions();
    }
    updateComboDynamicSummary();
    comboHistory.push('flavor');
}

function displayAccompanimentOptions() {
    updateAssistantChat(`Agora, vamos escolher os acompanhamentos para o a√ßa√≠ ${currentAcai}. Voc√™ pode escolher at√© ${currentCombo.maxAccompaniments}:`);
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="accompaniment-options">
            ${extraItems.map(acc => `
                <div class="accompaniment-option" onclick="selectAccompaniment('${acc.name}')">
                    <img src="${acc.image}" alt="${acc.name}">
                    <p>${acc.name}</p>
                </div>
            `).join('')}
        </div>
    `;
}

window.selectAccompaniment = function(accName) {
    if (currentAcai === 1) {
        if (currentCombo.acai1.accompaniments.length < currentCombo.maxAccompaniments) {
            currentCombo.acai1.accompaniments.push(accName);
            updateAssistantChat(`${accName} adicionado ao a√ßa√≠ 1.`);
        } else {
            updateAssistantChat(`Voc√™ j√° selecionou o m√°ximo de acompanhamentos para o a√ßa√≠ 1.`);
        }
    } else {
        if (currentCombo.acai2.accompaniments.length < currentCombo.maxAccompaniments) {
            currentCombo.acai2.accompaniments.push(accName);
            updateAssistantChat(`${accName} adicionado ao a√ßa√≠ 2.`);
        } else {
            updateAssistantChat(`Voc√™ j√° selecionou o m√°ximo de acompanhamentos para o a√ßa√≠ 2.`);
        }
    }

    if ((currentAcai === 1 && currentCombo.acai1.accompaniments.length === currentCombo.maxAccompaniments) ||
        (currentAcai === 2 && currentCombo.acai2.accompaniments.length === currentCombo.maxAccompaniments)) {
        if (currentAcai === 1) {
            currentAcai = 2;
            currentStep = 'flavor';
            updateAssistantChat("√ìtimo! Agora vamos escolher os sabores para o segundo a√ßa√≠.");
            displayFlavorOptions();
        } else {
            updateAssistantChat("Perfeito! Voc√™ completou seu combo. Deseja finalizar o pedido ou adicionar itens extras?");
            displayOptions(["Finalizar pedido", "Adicionar extras"]);
        }
    }
    updateComboDynamicSummary();
    comboHistory.push('accompaniment');
}

function displayOptions(options) {
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="options">
            ${options.map(option => `
                <button class="btn" onclick="handleOption('${option}')">${option}</button>
            `).join('')}
        </div>
    `;
}

function handleOption(option) {
    switch(option) {
        case "Escolher outro sabor":
            displayFlavorOptions();
            break;
        case "Prosseguir para acompanhamentos":
            currentStep = 'accompaniment';
            displayAccompanimentOptions();
            break;
        case "Finalizar pedido":
            finalizePedido();
            break;
        case "Adicionar extras":
            displayExtrasOptions();
            break;
    }
}

function displayExtrasOptions() {
    updateAssistantChat("Escolha os itens extras que deseja adicionar ao seu combo:");
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="extras-options">
            ${extraItems.map(extra => `
                <div class="extra-option" onclick="addExtra('${extra.name}')">
                    <img src="${extra.image}" alt="${extra.name}">
                    <p>${extra.name} - R$ 1,99</p>
                </div>
            `).join('')}
        </div>
        <button class="btn" onclick="finalizePedido()">Finalizar Pedido</button>
    `;
}

function addExtra(extraName) {
    if (!currentCombo.extras) {
        currentCombo.extras = [];
    }
    currentCombo.extras.push(extraName);
    updateAssistantChat(`${extraName} adicionado como extra.`);
    updateComboDynamicSummary();
    comboHistory.push('extras');
}

function finalizePedido() {
    updateAssistantChat("Seu combo est√° pronto! Aqui est√° o resumo final:");
    const summary = getComboSummary();
    updateAssistantChat(summary);
    updateAssistantChat("Deseja adicionar este combo ao carrinho?");
    displayOptions(["Adicionar ao Carrinho", "Montar Novo Combo"]);
}

function getComboSummary() {
    let summary = `${currentCombo.name}\n`;
    summary += `A√ßa√≠ 1: ${currentCombo.acai1.flavors.join(', ')}\n`;
    summary += `Acompanhamentos: ${currentCombo.acai1.accompaniments.join(', ')}\n`;
    summary += `A√ßa√≠ 2: ${currentCombo.acai2.flavors.join(', ')}\n`;
    summary += `Acompanhamentos: ${currentCombo.acai2.accompaniments.join(', ')}\n`;
    if (currentCombo.extras && currentCombo.extras.length > 0) {
        summary += `Itens Extras: ${currentCombo.extras.join(', ')}\n`;
    }
    const total = calculateComboTotal();
    summary += `Total: R$ ${total.toFixed(2)}`;
    return summary;
}

function calculateComboTotal() {
    let total = currentCombo.price;
    if (currentCombo.extras) {
        total += currentCombo.extras.length * 1.99;
    }
    return total;
}

function updateComboDynamicSummary() {
    const summaryDiv = document.getElementById('comboDynamicSummary');
    let summaryHTML = `<h4>${currentCombo.name}</h4>`;
    summaryHTML += `<p><strong>A√ßa√≠ 1:</strong> ${currentCombo.acai1.flavors.join(', ') || 'N√£o selecionado'}</p>`;
    summaryHTML += `<p><strong>Acompanhamentos 1:</strong> ${currentCombo.acai1.accompaniments.join(', ') || 'Nenhum'}</p>`;
    summaryHTML += `<p><strong>A√ßa√≠ 2:</strong> ${currentCombo.acai2.flavors.join(', ') || 'N√£o selecionado'}</p>`;
    summaryHTML += `<p><strong>Acompanhamentos 2:</strong> ${currentCombo.acai2.accompaniments.join(', ') || 'Nenhum'}</p>`;
    if (currentCombo.extras && currentCombo.extras.length > 0) {
        summaryHTML += `<p><strong>Extras:</strong> ${currentCombo.extras.join(', ')}</p>`;
    }
    summaryHTML += `<p><strong>Total:</strong> R$ ${calculateComboTotal().toFixed(2)}</p>`;
    summaryDiv.innerHTML = summaryHTML;
}

function addComboToCart() {
    const comboItem = {
        id: Date.now(),
        name: currentCombo.name,
        price: currentCombo.price,
        acai1: currentCombo.acai1,
        acai2: currentCombo.acai2,
        extras: currentCombo.extras || [],
        totalPrice: calculateComboTotal()
    };
    cart.push(comboItem);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateAssistantChat("Combo adicionado ao carrinho com sucesso!");
    openCart();
    resetComboBuilder();
}

function resetComboBuilder() {
    currentCombo = null;
    currentStep = 'combo';
    currentAcai = 1;
    comboHistory = [];
    document.getElementById('comboBuilderChat').innerHTML = '';
    document.getElementById('comboDynamicSummary').innerHTML = '';
    startComboBuilder();
}

function updateAssistantChat(message) {
    const chat = document.getElementById('comboBuilderChat');
    chat.innerHTML += `<p>${message}</p>`;
    chat.scrollTop = chat.scrollHeight;
}

function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    if (message) {
        updateAssistantChat(`Voc√™: ${message}`);
        respondToUserMessage(message);
        userInput.value = '';
    }
}

function respondToUserMessage(message) {
    const lowerMessage = message.toLowerCase();
    if (lowerMessage.includes('ol√°') || lowerMessage.includes('oi') || lowerMessage.includes('bom dia') || lowerMessage.includes('boa tarde') || lowerMessage.includes('boa noite')) {
        updateAssistantChat("Ol√°, tudo bem? Sou um rob√¥, mas irei te ajudar a escolher seu Combo, ok? :)");
    } else if (lowerMessage.includes('escolher')) {
        updateAssistantChat("Claro! Voc√™ pode escolher os acompanhamentos para cada a√ßa√≠ do seu combo. " + 
            "O n√∫mero m√°ximo de acompanhamentos varia de acordo com o tamanho do combo:\n" +
            "- Combo 2 de 300ml: at√© 3 acompanhamentos por a√ßa√≠\n" +
            "- Combo 2 de 500ml: at√© 4 acompanhamentos por a√ßa√≠\n" +
            "- Combo 2 de 1 Litro: at√© 8 acompanhamentos por a√ßa√≠\n" +
            "Voc√™ pode escolher apenas A√ßa√≠ puro ou A√ßa√≠ com Creme. Que tipo de combo voc√™ gostaria de montar?");
        displayComboOptions();
    } else if (lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor')) {
        updateAssistantChat("Os pre√ßos dos nossos combos s√£o:\n" +
            combos.map(combo => `${combo.name}: R$ ${combo.price.toFixed(2)}`).join('\n'));
    } else if (lowerMessage.includes('acompanhamento') || lowerMessage.includes('adicional')) {
        updateAssistantChat("Nossos acompanhamentos incluem: " + 
            extraItems.map(item => item.name).join(', ') + 
            ". O n√∫mero m√°ximo de acompanhamentos depende do tamanho do combo que voc√™ escolher.");
    } else if (lowerMessage.includes('extra')) {
        updateAssistantChat("Todos os itens extras custam R$ 1,99 cada. Voc√™ pode adicionar quantos quiser ao seu combo!");
    } else if (lowerMessage.includes('sabor')) {
        updateAssistantChat("Temos os seguintes sabores dispon√≠veis:\n" +
            flavors.map(f => f.name).join(', ') + "\n" +
            "Voc√™ pode escolher at√© 2 op√ß√µes de sabores para cada a√ßa√≠ do seu combo.");
    } else if (lowerMessage.includes('creme')) {
        updateAssistantChat("Sim, voc√™ pode escolher apenas creme se preferir! Temos os seguintes sabores de creme dispon√≠veis: " + 
            flavors.filter(f => f.type === 'creme').map(f => f.name).join(', ') + 
            ". Voc√™ pode escolher at√© 2 op√ß√µes de sabores para cada a√ßa√≠ do seu combo.");
    } else if (lowerMessage.includes('ajuda') || lowerMessage.includes('como')) {
        updateAssistantChat("Para montar seu combo, siga estas etapas:\n" +
            "1. Escolha o tamanho do combo\n" +
            "2. Selecione o sabor para cada a√ßa√≠ (at√© 2 op√ß√µes)\n" +
            "3. Escolha os acompanhamentos para cada a√ßa√≠\n" +
            "4. Adicione itens extras se desejar\n" +
            "5. Finalize seu combo e adicione ao carrinho\n" +
            "Se tiver d√∫vidas espec√≠ficas, √© s√≥ perguntar!");
    } else {
        updateAssistantChat("Desculpe, n√£o entendi sua pergunta. Para obter ajuda sobre assuntos espec√≠ficos, voc√™ pode perguntar sobre pre√ßos, sabores, acompanhamentos, itens extras ou como montar seu combo. Se precisar de mais assist√™ncia, por favor, entre em contato com nosso suporte atrav√©s do chat no √≠cone flutuante do card√°pio digital.");
    }
}

function goBackInComboBuilder() {
    if (comboHistory.length > 1) {
        comboHistory.pop(); // Remove o passo atual
        const lastStep = comboHistory[comboHistory.length - 1];
        switch (lastStep) {
            case 'combo':
                resetComboBuilder();
                break;
            case 'flavor':
                currentStep = 'flavor';
                if (currentAcai === 2) {
                    currentAcai = 1;
                }
                currentCombo.acai1.flavors = [];
                currentCombo.acai2.flavors = [];
                displayFlavorOptions();
                break;
            case 'accompaniment':
                currentStep = 'accompaniment';
                if (currentAcai === 2) {
                    currentCombo.acai2.accompaniments = [];
                } else {
                    currentCombo.acai1.accompaniments = [];
                }
                displayAccompanimentOptions();
                break;
            case 'extras':
                currentCombo.extras = [];
                displayExtrasOptions();
                break;
        }
        updateComboDynamicSummary();
    } else {
        updateAssistantChat("Voc√™ j√° est√° no in√≠cio do processo de montagem do combo.");
    }
}

document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
        this.closest('.modal').style.display = "none";
    }
});

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = "none";
    });
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        closeAllModals();
    }
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function () {
    fetchCategories();
    fetchProducts();
    loadDataFromLocalStorage();
    updateCartIcon();
});

function loadDataFromLocalStorage() {
    const storedCart = localStorage.getItem('cart');
    if (storedCart) {
        cart = JSON.parse(storedCart);
    }

    const storedCustomerInfo = localStorage.getItem('customerInfo');
    if (storedCustomerInfo) {
        customerInfo = JSON.parse(storedCustomerInfo);
    }

    const storedSavedAddresses = localStorage.getItem('savedAddresses');
    if (storedSavedAddresses) {
        savedAddresses = JSON.parse(storedSavedAddresses);
    }
}

function saveDataToLocalStorage() {
    localStorage.setItem('cart', JSON.stringify(cart));
    localStorage.setItem('customerInfo', JSON.stringify(customerInfo));
    localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
}

function updateLocalStorage() {
    saveDataToLocalStorage();
    updateCartIcon();
}

window.addToCart = function(productId) {
    const product = products.find(p => p.id === productId);
    const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
    const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);
    if (accompaniments.length < product.minAccompaniments || accompaniments.length > product.maxAccompaniments) {
        alert(`Por favor, selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos.`);
        return;
    }
    const cartItem = {
        id: Date.now(),
        productId: product.id,
        name: product.name,
        price: product.price,
        accompaniments: accompaniments,
        extras: extras,
        totalPrice: calculateTotalPrice(product, extras)
    };
    cart.push(cartItem);
    updateLocalStorage();
    openCart();
}

window.removeFromCart = function(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    updateLocalStorage();
    openCart();
}

function updateCartIcon() {
    const cartIconElement = document.querySelector('.cart-icon');
    if (cart.length > 0) {
        cartIconElement.textContent = `üõí (${cart.length})`;
    } else {
        cartIconElement.textContent = 'üõí';
    }
}

function updateCart() {
    updateCartIcon();
    updateLocalStorage();
}

window.openCart = function() {
    const modal = document.getElementById('cartModal');
    const cartContent = document.getElementById('cartContent');
    const cartTotal = document.getElementById('cartTotal');
    cartContent.innerHTML = cart.map(item => `
        <div class="cart-item">
            <div class="cart-item-info">
                <h3>${item.name}</h3>
                <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
                <p>Extras: ${item.extras.join(', ')}</p>
                <p>Pre√ßo: R$ ${item.totalPrice.toFixed(2)}</p>
            </div>
            <span class="cart-item-remove" onclick="removeFromCart(${item.id})">üóëÔ∏è</span>
        </div>
    `).join('');
    const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
    modal.style.display = "block";
}

window.continueShopping = function() {
    document.getElementById('cartModal').style.display = "none";
}

window.openCustomerIdentification = function() {
    document.getElementById('cartModal').style.display = "none";
    const modal = document.getElementById('customerIdentificationModal');
    modal.style.display = "block";
    const phone = localStorage.getItem('customerPhone');
    if (phone) {
        document.getElementById('customerPhone').value = phone;
        document.getElementById('customerName').value = localStorage.getItem('customerName') || '';
        loadCustomerData(phone);
    }
}

document.getElementById('customerIdentificationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const phone = document.getElementById('customerPhone').value;
    const name = document.getElementById('customerName').value;
    customerInfo = { phone, name };
    localStorage.setItem('customerPhone', phone);
    localStorage.setItem('customerName', name);
    db.collection('customers').doc(phone).set({
        name: name,
        addresses: savedAddresses
    }, { merge: true }).then(() => {
        document.getElementById('customerIdentificationModal').style.display = "none";
        openCheckout();
    }).catch((error) => {
        console.error("Error saving customer data: ", error);
    });
});

function openCheckout() {
    const checkoutModal = document.getElementById('checkoutModal');
    const orderSummary = document.getElementById('orderSummary');
    loadSavedAddresses();
    updateOrderSummary();
    document.getElementById('paymentSection').style.display = 'none';
    document.getElementById('submitOrderBtn').style.display = 'none';
    checkoutModal.style.display = "block";
    displayExtraItems();
}

document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();
    // ... (c√≥digo existente para processar o pedido)
    updateLocalStorage();
});

window.openComboBuilder = function() {
    document.getElementById('comboBuilderModal').style.display = 'block';
    startComboBuilder();
}

window.closeComboBuilder = function() {
    document.getElementById('comboBuilderModal').style.display = 'none';
    resetComboBuilder();
}

function startComboBuilder() {
    updateAssistantChat("Ol√°! Vamos montar seu combo de a√ßa√≠? Escolha uma das op√ß√µes abaixo:");
    displayComboOptions();
}

function displayComboOptions() {
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="combo-options">
            ${combos.map(combo => `
                <div class="combo-option" onclick="selectCombo('${combo.name}')">
                    <h3>${combo.name}</h3>
                    <p>R$ ${combo.price.toFixed(2)}</p>
                </div>
            `).join('')}
        </div>
    `;
}

window.selectCombo = function(comboName) {
    currentCombo = combos.find(combo => combo.name === comboName);
    currentCombo.acai1 = { flavors: [], accompaniments: [] };
    currentCombo.acai2 = { flavors: [], accompaniments: [] };
    currentStep = 'flavor';
    updateAssistantChat(`√ìtima escolha! Agora, vamos escolher os sabores para o primeiro a√ßa√≠ do ${currentCombo.name}.`);
    displayFlavorOptions();
    updateComboDynamicSummary();
    comboHistory.push('combo');
}

function displayFlavorOptions() {
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="flavor-options">
            ${flavors.map(flavor => `
                <div class="flavor-option" onclick="selectFlavor('${flavor.name}')">
                    <p>${flavor.name}</p>
                </div>
            `).join('')}
        </div>
    `;
}

window.selectFlavor = function(flavorName) {
    if (currentAcai === 1) {
        currentCombo.acai1.flavors.push(flavorName);
    } else {
        currentCombo.acai2.flavors.push(flavorName);
    }

    updateAssistantChat(`Sabor ${flavorName} selecionado para o a√ßa√≠ ${currentAcai}.`);

    if ((currentAcai === 1 && currentCombo.acai1.flavors.length < 2) || 
        (currentAcai === 2 && currentCombo.acai2.flavors.length < 2)) {
        updateAssistantChat("Deseja escolher mais um sabor ou prosseguir para os acompanhamentos?");
        displayOptions(["Escolher outro sabor", "Prosseguir para acompanhamentos"]);
    } else {
        currentStep = 'accompaniment';
        displayAccompanimentOptions();
    }
    updateComboDynamicSummary();
    comboHistory.push('flavor');
}

function displayAccompanimentOptions() {
    updateAssistantChat(`Agora, vamos escolher os acompanhamentos para o a√ßa√≠ ${currentAcai}. Voc√™ pode escolher at√© ${currentCombo.maxAccompaniments}:`);
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="accompaniment-options">
            ${extraItems.map(acc => `
                <div class="accompaniment-option" onclick="selectAccompaniment('${acc.name}')">
                    <img src="${acc.image}" alt="${acc.name}">
                    <p>${acc.name}</p>
                </div>
            `).join('')}
        </div>
    `;
}

window.selectAccompaniment = function(accName) {
    if (currentAcai === 1) {
        if (currentCombo.acai1.accompaniments.length < currentCombo.maxAccompaniments) {
            currentCombo.acai1.accompaniments.push(accName);
            updateAssistantChat(`${accName} adicionado ao a√ßa√≠ 1.`);
        } else {
            updateAssistantChat(`Voc√™ j√° selecionou o m√°ximo de acompanhamentos para o a√ßa√≠ 1.`);
        }
    } else {
        if (currentCombo.acai2.accompaniments.length < currentCombo.maxAccompaniments) {
            currentCombo.acai2.accompaniments.push(accName);
            updateAssistantChat(`${accName} adicionado ao a√ßa√≠ 2.`);
        } else {
            updateAssistantChat(`Voc√™ j√° selecionado o m√°ximo de acompanhamentos para o a√ßa√≠ 2.`);
        }
    }

    if ((currentAcai === 1 && currentCombo.acai1.accompaniments.length === currentCombo.maxAccompaniments) ||
        (currentAcai === 2 && currentCombo.acai2.accompaniments.length === currentCombo.maxAccompaniments)) {
        if (currentAcai === 1) {
            currentAcai = 2;
            currentStep = 'flavor';
            updateAssistantChat("√ìtimo! Agora vamos escolher os sabores para o segundo a√ßa√≠.");
            displayFlavorOptions();
        } else {
            updateAssistantChat("Perfeito! Voc√™ completou seu combo. Deseja finalizar o pedido ou adicionar itens extras?");
            displayOptions(["Finalizar pedido", "Adicionar extras"]);
        }
    }
    updateComboDynamicSummary();
    comboHistory.push('accompaniment');
}

function displayOptions(options) {
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="options">
            ${options.map(option => `
                <button class="btn" onclick="handleOption('${option}')">${option}</button>
            `).join('')}
        </div>
    `;
}

function handleOption(option) {
    switch(option) {
        case "Escolher outro sabor":
            displayFlavorOptions();
            break;
        case "Prosseguir para acompanhamentos":
            currentStep = 'accompaniment';
            displayAccompanimentOptions();
            break;
        case "Finalizar pedido":
            finalizePedido();
            break;
        case "Adicionar extras":
            displayExtrasOptions();
            break;
    }
}

function displayExtrasOptions() {
    updateAssistantChat("Escolha os itens extras que deseja adicionar ao seu combo:");
    const comboBuilder = document.getElementById('comboBuilderChat');
    comboBuilder.innerHTML += `
        <div class="extras-options">
            ${extraItems.map(extra => `
                <div class="extra-option" onclick="addExtra('${extra.name}')">
                    <img src="${extra.image}" alt="${extra.name}">
                    <p>${extra.name} - R$ 1,99</p>
                </div>
            `).join('')}
        </div>
        <button class="btn" onclick="finalizePedido()">Finalizar Pedido</button>
    `;
}

function addExtra(extraName) {
    if (!currentCombo.extras) {
        currentCombo.extras = [];
    }
    currentCombo.extras.push(extraName);
    updateAssistantChat(`${extraName} adicionado como extra.`);
    updateComboDynamicSummary();
    comboHistory.push('extras');
}

function finalizePedido() {
    updateAssistantChat("Seu combo est√° pronto! Aqui est√° o resumo final:");
    const summary = getComboSummary();
    updateAssistantChat(summary);
    updateAssistantChat("Deseja adicionar este combo ao carrinho?");
    displayOptions(["Adicionar ao Carrinho", "Montar Novo Combo"]);
}

function getComboSummary() {
    let summary = `${currentCombo.name}\n`;
    summary += `A√ßa√≠ 1: ${currentCombo.acai1.flavors.join(', ')}\n`;
    summary += `Acompanhamentos: ${currentCombo.acai1.accompaniments.join(', ')}\n`;
    summary += `A√ßa√≠ 2: ${currentCombo.acai2.flavors.join(', ')}\n`;
    summary += `Acompanhamentos: ${currentCombo.acai2.accompaniments.join(', ')}\n`;
    if (currentCombo.extras && currentCombo.extras.length > 0) {
        summary += `Itens Extras: ${currentCombo.extras.join(', ')}\n`;
    }
    const total = calculateComboTotal();
    summary += `Total: R$ ${total.toFixed(2)}`;
    return summary;
}

function calculateComboTotal() {
    let total = currentCombo.price;
    if (currentCombo.extras) {
        total += currentCombo.extras.length * 1.99;
    }
    return total;
}

function updateComboDynamicSummary() {
    const summaryDiv = document.getElementById('comboDynamicSummary');
    let summaryHTML = `<h4>${currentCombo.name}</h4>`;
    summaryHTML += `<p><strong>A√ßa√≠ 1:</strong> ${currentCombo.acai1.flavors.join(', ') || 'N√£o selecionado'}</p>`;
    summaryHTML += `<p><strong>Acompanhamentos 1:</strong> ${currentCombo.acai1.accompaniments.join(', ') || 'Nenhum'}</p>`;
    summaryHTML += `<p><strong>A√ßa√≠ 2:</strong> ${currentCombo.acai2.flavors.join(', ') || 'N√£o selecionado'}</p>`;
    summaryHTML += `<p><strong>Acompanhamentos 2:</strong> ${currentCombo.acai2.accompaniments.join(', ') || 'Nenhum'}</p>`;
    if (currentCombo.extras && currentCombo.extras.length > 0) {
        summaryHTML += `<p><strong>Extras:</strong> ${currentCombo.extras.join(', ')}</p>`;
    }
    summaryHTML += `<p><strong>Total:</strong> R$ ${calculateComboTotal().toFixed(2)}</p>`;
    summaryDiv.innerHTML = summaryHTML;
}

function addComboToCart() {
    const comboItem = {
        id: Date.now(),
        name: currentCombo.name,
        price: currentCombo.price,
        acai1: currentCombo.acai1,
        acai2: currentCombo.acai2,
        extras: currentCombo.extras || [],
        totalPrice: calculateComboTotal()
    };
    cart.push(comboItem);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateAssistantChat("Combo adicionado ao carrinho com sucesso!");
    openCart();
    resetComboBuilder();
}

function resetComboBuilder() {
    currentCombo = null;
    currentStep = 'combo';
    currentAcai = 1;
    comboHistory = [];
    document.getElementById('comboBuilderChat').innerHTML = '';
    document.getElementById('comboDynamicSummary').innerHTML = '';
    startComboBuilder();
}

function updateAssistantChat(message) {
    const chat = document.getElementById('comboBuilderChat');
    chat.innerHTML += `<p>${message}</p>`;
    chat.scrollTop = chat.scrollHeight;
}

function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    if (message) {
        updateAssistantChat(`Voc√™: ${message}`);
        respondToUserMessage(message);
        userInput.value = '';
    }
}

function respondToUserMessage(message) {
    const lowerMessage = message.toLowerCase();
    if (lowerMessage.includes('ol√°') || lowerMessage.includes('oi') || lowerMessage.includes('bom dia') || lowerMessage.includes('boa tarde') || lowerMessage.includes('boa noite')) {
        updateAssistantChat("Ol√°, tudo bem? Sou um rob√¥, mas irei te ajudar a escolher seu Combo, ok? :)");
    } else if (lowerMessage.includes('escolher')) {
        updateAssistantChat("Claro! Voc√™ pode escolher os acompanhamentos para cada a√ßa√≠ do seu combo. " + 
            "O n√∫mero m√°ximo de acompanhamentos varia de acordo com o tamanho do combo:\n" +
            "- Combo 2 de 300ml: at√© 3 acompanhamentos por a√ßa√≠\n" +
            "- Combo 2 de 500ml: at√© 4 acompanhamentos por a√ßa√≠\n" +
            "- Combo 2 de 1 Litro: at√© 8 acompanhamentos por a√ßa√≠\n" +
            "Voc√™ pode escolher apenas A√ßa√≠ puro ou A√ßa√≠ com Creme. Que tipo de combo voc√™ gostaria de montar?");
        displayComboOptions();
    } else if (lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor')) {
        updateAssistantChat("Os pre√ßos dos nossos combos s√£o:\n" +
            combos.map(combo => `${combo.name}: R$ ${combo.price.toFixed(2)}`).join('\n'));
    } else if (lowerMessage.includes('acompanhamento') || lowerMessage.includes('adicional')) {
        updateAssistantChat("Nossos acompanhamentos incluem: " + 
            extraItems.map(item => item.name).join(', ') + 
            ". O n√∫mero m√°ximo de acompanhamentos depende do tamanho do combo que voc√™ escolher.");
    } else if (lowerMessage.includes('extra')) {
        updateAssistantChat("Todos os itens extras custam R$ 1,99 cada. Voc√™ pode adicionar quantos quiser ao seu combo!");
    } else if (lowerMessage.includes('sabor')) {
        updateAssistantChat("Temos os seguintes sabores dispon√≠veis:\n" +
            flavors.map(f => f.name).join(', ') + "\n" +
            "Voc√™ pode escolher at√© 2 op√ß√µes de sabores para cada a√ßa√≠ do seu combo.");
    } else if (lowerMessage.includes('creme')) {
        updateAssistantChat("Sim, voc√™ pode escolher apenas creme se preferir! Temos os seguintes sabores de creme dispon√≠veis: " + 
            flavors.filter(f => f.type === 'creme').map(f => f.name).join(', ') + 
            ". Voc√™ pode escolher at√© 2 op√ß√µes de sabores para cada a√ßa√≠ do seu combo.");
    } else if (lowerMessage.includes('ajuda') || lowerMessage.includes('como')) {
        updateAssistantChat("Para montar seu combo, siga estas etapas:\n" +
            "1. Escolha o tamanho do combo\n" +
            "2. Selecione o sabor para cada a√ßa√≠ (at√© 2 op√ß√µes)\n" +
            "3. Escolha os acompanhamentos para cada a√ßa√≠\n" +
            "4. Adicione itens extras se desejar\n" +
            "5. Finalize seu combo e adicione ao carrinho\n" +
            "Se tiver d√∫vidas espec√≠ficas, √© s√≥ perguntar!");
    } else {
        updateAssistantChat("Desculpe, n√£o entendi sua pergunta. Para obter ajuda sobre assuntos espec√≠ficos, voc√™ pode perguntar sobre pre√ßos, sabores, acompanhamentos, itens extras ou como montar seu combo. Se precisar de mais assist√™ncia, por favor, entre em contato com nosso suporte atrav√©s do chat no √≠cone flutuante do card√°pio digital.");
    }
}

function goBackInComboBuilder() {
    if (comboHistory.length > 1) {
        comboHistory.pop(); // Remove o passo atual
        const lastStep = comboHistory[comboHistory.length - 1];
        switch (lastStep) {
            case 'combo':
                resetComboBuilder();
                break;
            case 'flavor':
                currentStep = 'flavor';
                if (currentAcai === 2) {
                    currentAcai = 1;
                }
                currentCombo.acai1.flavors = [];
                currentCombo.acai2.flavors = [];
                displayFlavorOptions();
                break;
            case 'accompaniment':
                currentStep = 'accompaniment';
                if (currentAcai === 2) {
                    currentCombo.acai2.accompaniments = [];
                } else {
                    currentCombo.acai1.accompaniments = [];
                }
                displayAccompanimentOptions();
                break;
            case 'extras':
                currentCombo.extras = [];
                displayExtrasOptions();
                break;
        }
        updateComboDynamicSummary();
    } else {
        updateAssistantChat("Voc√™ j√° est√° no in√≠cio do processo de montagem do combo.");
    }
}

// Event Listeners
document.getElementById('monteCombo').addEventListener('click', openComboBuilder);
document.querySelector('.back-button').addEventListener('click', goBackInComboBuilder);
document.getElementById('sendMessage').addEventListener('click', sendMessage);

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function () {
    fetchCategories();
    fetchProducts();
    loadDataFromLocalStorage();
    updateCartIcon();
});

console.log('Script carregado e pronto para uso!');
    </script>
</body>
</html>
