<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cabana A√ßa√≠</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
<style>
:root {
  --primary-color: #4a0e4e;
  --secondary-color: #8e44ad;
  --background-color: #f5f5f5;
  --text-color: #333;
  --accent-color: #e74c3c;
}
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  background-color: var(--background-color);
  color: var(--text-color);
}
header {
  background-color: var(--primary-color);
  color: white;
  padding: 1em 0;
  text-align: center;
}
.header-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}
.logo {
  width: 150px;
  height: auto;
  margin-bottom: 10px;
}
.cart-icon {
  font-size: 24px;
  cursor: pointer;
  position: absolute;
  right: 20px;
  top: 20px;
}
main {
  max-width: 1200px;
  margin: 2em auto;
  padding: 0 20px;
}
.user-options {
  display: flex;
  justify-content: center;
  margin-bottom: 1em;
}
.user-options .btn {
  margin: 0 0.5em;
}
.categories, .product-grid {
  margin-bottom: 2em;
}
.category-btn {
  margin: 0 0.5em 0.5em 0;
  padding: 0.5em 1em;
  background-color: var(--secondary-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.category-btn:hover {
  background-color: var(--primary-color);
}
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 2em;
}
.product-card {
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: transform 0.3s ease;
  cursor: pointer;
}
.product-card:hover {
  transform: translateY(-5px);
}
.product-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}
.product-info {
  padding: 1em;
}
.product-title {
  margin: 0;
  font-size: 1.2em;
  color: var(--primary-color);
}
.product-price {
  font-weight: bold;
  color: var(--secondary-color);
  margin-top: 0.5em;
}
.product-description {
  margin-top: 0.5em;
  font-size: 0.9em;
  color: #666;
}
.btn {
  display: inline-block;
  padding: 0.5em 1em;
  background-color: var(--primary-color);
  color: white;
  text-decoration: none;
  border-radius: 4px;
  transition: background-color 0.3s ease;
  border: none;
  cursor: pointer;
}
.btn:hover {
  background-color: var(--secondary-color);
}
.btn:disabled {
  background-color: #cccccc;
  color: #666666;
  cursor: not-allowed;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}
.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 600px;
  border-radius: 8px;
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
.extras-list {
  margin-top: 1em;
}
.extras-list h3 {
  margin-bottom: 0.5em;
}
.extras-list ul {
  list-style-type: none;
  padding-left: 0;
}
.extras-list li {
  margin-bottom: 0.5em;
}
.checkbox-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.checkbox-item {
  display: flex;
  align-items: center;
}
.checkbox-item input {
  margin-right: 5px;
}
#cartModal .modal-content {
  max-height: 80vh;
  overflow-y: auto;
}
.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #ddd;
}
.cart-item-info {
  flex-grow: 1;
}
.cart-item-remove {
  color: red;
  cursor: pointer;
}
.error-message {
  color: red;
  margin-top: 10px;
}
#customerIdentificationForm {
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
#customerIdentificationForm h2 {
  color: var(--primary-color);
  margin-bottom: 20px;
}
#customerIdentificationForm label {
  display: block;
  margin-top: 10px;
  color: var(--secondary-color);
}
#customerIdentificationForm input {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
}
#customerIdentificationForm .btn {
  margin-top: 20px;
  width: 100%;
}
.input-icon {
  position: relative;
}
.input-icon i {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--secondary-color);
}
.input-icon input {
  padding-left: 35px;
  text-align: center;
}
#checkoutForm {
  margin-top: 20px;
}
#checkoutForm label {
  display: block;
  margin-top: 10px;
}
#checkoutForm input, #checkoutForm textarea, #checkoutForm select {
  width: 100%;
  padding: 5px;
  margin-top: 5px;
}
#orderSummary {
  margin-top: 20px;
}
.loyalty-info {
  background-color: #e8f5e9;
  border: 1px solid #4caf50;
  border-radius: 4px;
  padding: 10px;
  margin-top: 10px;
}
.required-field {
  color: red;
}
#myOrdersModal .modal-content {
  max-width: 800px;
}
.order-list {
  list-style-type: none;
  padding: 0;
}
.order-item {
  background-color: #f9f9f9;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 4px;
}
.loyalty-rules {
  background-color: #f0f0f0;
  border: 1px solid #ddd;
  padding: 15px;
  margin-top: 15px;
  border-radius: 4px;
}
</style>
</head>
<body>
<header>
  <div class="header-content">
    <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana A√ßa√≠ Logo" class="logo">
    <h1>Cabana A√ßa√≠</h1>
    <h4>Quarta √† Domingo</h4>
    12:30h as 22:30h
  </div>
  <div class="cart-icon" onclick="openCart()">üõí</div>
</header>
<main>
  <div class="user-options">
    <button class="btn" onclick="openMyOrders()">Meus Pedidos</button>
    <button class="btn" onclick="showLoyaltyRules()">Programa Fidelidade</button>
  </div>
  <div class="categories" id="categories"></div>
  <div class="product-grid" id="productGrid"></div>
</main>
<div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalContent"></div>
  </div>
</div>
<div id="cartModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Seu Carrinho</h2>
    <div id="cartContent"></div>
    <div id="cartTotal"></div>
    <button class="btn" onclick="openCustomerIdentification()">Finalizar Pedido</button>
    <button class="btn" onclick="continueShopping()">Continuar Comprando</button>
  </div>
</div>
<div id="customerIdentificationModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="customerIdentificationForm">
      <h2><i class="fas fa-user"></i> Identifica√ß√£o do Cliente</h2>
      <div class="input-icon">
        <i class="fas fa-user"></i>
        <input type="text" id="customerName" placeholder="Nome Completo" required>
      </div>
      <div class="input-icon">
        <i class="fab fa-whatsapp"></i>
        <input type="tel" id="customerPhone" placeholder="WhatsApp (com DDD)" required>
      </div>
      <button type="submit" class="btn">Avan√ßar</button>
    </form>
  </div>
</div>
<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Finalizar Pedido</h2>
    <form id="checkoutForm">
      <div id="deliveryAddressSection">
        <h3>Endere√ßo de Entrega</h3>
        <select id="savedAddresses" onchange="handleSavedAddressChange()">
          <option value="">Selecione um endere√ßo salvo ou cadastre um novo</option>
        </select>
        <button type="button" class="btn" onclick="showNewAddressForm()">Cadastrar Novo Endere√ßo</button>
        <div id="newAddressForm" style="display: none;">
          <label for="street">Rua: <span class="required-field">*</span></label>
          <input type="text" id="street" required>
          <label for="number">N√∫mero: <span class="required-field">*</span></label>
          <input type="text" id="number" required>
          <label for="complement">Complemento:</label>
          <input type="text" id="complement">
          <label for="neighborhood">Bairro: <span class="required-field">*</span></label>
          <input type="text" id="neighborhood" required>
          <label for="city">Cidade: <span class="required-field">*</span></label>
          <input type="text" id="city" required>
          <label for="state">Estado: <span class="required-field">*</span></label>
          <input type="text" id="state" required>
          <button type="button" class="btn" onclick="saveNewAddress()">Salvar Endere√ßo</button>
        </div>
      </div>
      <div id="paymentSection" style="display: none;">
        <label for="paymentMethod">M√©todo de Pagamento:</label>
        <select id="paymentMethod" required onchange="handlePaymentChange()">
          <option value="card">Cart√£o na entrega</option>
          <option value="money">Dinheiro</option>
          <option value="pix">PIX</option>
        </select>
        <div id="moneyChange" style="display:none;">
          <label for="changeNeeded">Precisa de troco?</label>
          <select id="changeNeeded" onchange="handleChangeNeeded()">
            <option value="no">N√£o</option>
            <option value="yes">Sim</option>
          </select>
          <div id="changeAmountDiv" style="display:none;">
            <label for="changeAmount">Troco para quanto?</label>
            <input type="number" id="changeAmount" min="0" step="0.01">
          </div>
        </div>
        <div id="pixInfo" style="display:none;">
          <p>Chave PIX: 84 9 8873-1028</p>
          <p>Ap√≥s o envio do PIX, favor enviar o comprovante para o WhatsApp 84 9 8767-3202</p>
        </div>
      </div>
      <button type="submit" class="btn" id="submitOrderBtn" style="display: none;">Fazer Pedido</button>
    </form>
    <div id="orderSummary"></div>
    <div id="loyaltyInfo" class="loyalty-info"></div>
  </div>
</div>
<div id="loyaltyRulesModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Programa de Fidelidade</h2>
    <ul>
      <li>Os pedidos s√≥ ser√£o contabilizados ap√≥s serem recebidos pela loja no WhatsApp 84 9 8767-3202, que √© o whatsapp que voc√™ ser√° redirecionado ap√≥s finalizar o pedido aqui em nosso card√°pio digital.</li>
      <li>Os pedidos ser√£o contabilizados dentro da janela da conversa do WhatsApp com o cliente.</li>
      <li>Se o mesmo cliente fizer pedidos com n√∫meros de WhatsApp diferentes, os pontos Fidelidade ser√£o contabilizados no novo n√∫mero que o cliente est√° utilizando para compra com uma contagem diferente.</li>
      <li>Voc√™ ser√° encaminhado com os detalhes do pedido para o WhatsApp da loja ap√≥s finalizar o pedido.</li>
      <li>Ap√≥s 10 pedidos pagos e finalizados, voc√™ ter√° direito a 50% de desconto em um pedido que inclua A√ßa√≠ ou Creme 1 Litro ou qualquer Combo.</li>
      <li>Pedidos cancelados n√£o s√£o contabilizados.</li>
      <li>Caso voc√™ cancele um pedido pelo WhatsApp, a loja far√° a subtra√ß√£o dos pontos do seu programa de fidelidade.</li>
    </ul>
  </div>
</div>
<div id="myOrdersModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Meus Pedidos</h2>
    <div id="ordersList"></div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
  window.embeddedChatbotConfig = {
    chatbotId: "PpgNSIgeYN1FCucFGP4w3",
    domain: "www.chatbase.co"
  }
</script>
<script
  src="https://www.chatbase.co/embed.min.js"
  chatbotId="PpgNSIgeYN1FCucFGP4w3"
  domain="www.chatbase.co"
  defer>
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
      authDomain: "cabana-8d55e.firebaseapp.com",
      databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
      projectId: "cabana-8d55e",
      storageBucket: "cabana-8d55e.appspot.com",
      messagingSenderId: "706144237954",
      appId: "1:706144237954:web:345c10370972486afc779b",
      measurementId: "G-96Y337GYT8"
    };
    // Inicialize o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let products = [];
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const deliveryFee = 3.00;
    let customerInfo = {};
    let savedAddresses = [];

    async function fetchProducts() {
      const snapshot = await db.collection('products').get();
      products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      displayProducts(products);
    }

    async function fetchCategories() {
      const snapshot = await db.collection('categories').get();
      const categories = snapshot.docs.map(doc => doc.data().name);
      const categoriesContainer = document.getElementById('categories');
      categoriesContainer.innerHTML = `
        <button class="btn" onclick="openMyOrders()">Meus Pedidos</button>
        <button class="btn" onclick="showLoyaltyRules()">Programa Fidelidade</button>
        <button class="category-btn" data-category="all">Todos</button>
        ${categories.map(category => `
          <button class="category-btn" data-category="${category}">${category}</button>
        `).join('')}
      `;
    }

    function filterByCategory(category) {
      const filteredProducts = category === 'all' ? products : products.filter(product => product.category === category);
      displayProducts(filteredProducts);
    }

    function displayProducts(productsToDisplay = products) {
      const productGrid = document.getElementById('productGrid');
      productGrid.innerHTML = productsToDisplay.map(product => `
        <div class="product-card" onclick="openProductDetails(${product.id})">
          <img src="${product.image}" alt="${product.name}" class="product-image">
          <div class="product-info">
            <h3 class="product-title">${product.name}</h3>
            <p class="product-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
            <p class="product-description">${product.description.substring(0, 100)}...</p>
            <button class="btn" onclick="openProductDetails(${product.id}, event)">Ver Detalhes</button>
          </div>
        </div>
      `).join('');
    }

    window.openProductDetails = function(productId, event) {
      if (event) {
        event.stopPropagation();
      }
      const product = products.find(p => p.id === productId);
      const modal = document.getElementById('productModal');
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <h2>${product.name}</h2>
        <img src="${product.image}" alt="${product.name}" style="width:100%; max-height:300px; object-fit:cover;">
        <p>${product.description}</p>
        <p class="product-price">Pre√ßo: R$ ${parseFloat(product.price).toFixed(2)}</p>
        <div class="extras-list">
          <h3>Acompanhamentos (escolha de ${product.minAccompaniments} a ${product.maxAccompaniments}):</h3>
          <div class="checkbox-list" id="accompaniments">
            ${product.accompaniments.map((item, index) => `
              <div class="checkbox-item">
                <input type="checkbox" id="acc${index}" name="accompaniment" value="${item}">
                <label for="acc${index}">${item}</label>
              </div>
            `).join('')}
          </div>
          <p id="accompanimentError" class="error-message"></p>
        </div>
        <div class="extras-list">
          <h3>Itens Extras:</h3>
          <div class="checkbox-list" id="extras">
            ${product.extras.map((item, index) => `
              <div class="checkbox-item">
                <input type="checkbox" id="extra${index}" name="extra" value="${item.name}">
                <label for="extra${index}">${item.name} - R$ ${parseFloat(item.price).toFixed(2)}</label>
              </div>
            `).join('')}
          </div>
        </div>
        <button id="addToCartBtn" class="btn" onclick="addToCart(${product.id})">Adicionar ao Carrinho</button>
      `;
      modal.style.display = "block";
      // Adicionar valida√ß√£o para acompanhamentos
      const accCheckboxes = document.querySelectorAll('#accompaniments input[type="checkbox"]');
      accCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => validateAccompaniments(product));
      });
    }

    function validateAccompaniments(product) {
      const checkedAccompaniments = document.querySelectorAll('#accompaniments input[type="checkbox"]:checked');
      const addToCartBtn = document.getElementById('addToCartBtn');
      const errorMessage = document.getElementById('accompanimentError');
      if (checkedAccompaniments.length < product.minAccompaniments || checkedAccompaniments.length > product.maxAccompaniments) {
        addToCartBtn.disabled = true;
        errorMessage.textContent = `Selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos`;
      } else {
        addToCartBtn.disabled = false;
        errorMessage.textContent = '';
      }
    }

    window.addToCart = function(productId) {
      const product = products.find(p => p.id === productId);
      const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
      const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);
      if (accompaniments.length < product.minAccompaniments || accompaniments.length > product.maxAccompaniments) {
        alert(`Por favor, selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos.`);
        return;
      }
      const cartItem = {
        id: Date.now(),
        productId: product.id,
        name: product.name,
        price: product.price,
        accompaniments: accompaniments,
        extras: extras,
        totalPrice: calculateTotalPrice(product, extras)
      };
      cart.push(cartItem);
      localStorage.setItem('cart', JSON.stringify(cart));
      openCart(); // Abre o carrinho ap√≥s adicionar o produto
    }

    function calculateTotalPrice(product, selectedExtras) {
      let total = product.price;
      selectedExtras.forEach(extraName => {
        const extra = product.extras.find(e => e.name === extraName);
        if (extra) {
          total += extra.price;
        }
      });
      return total;
    }

    window.openCart = function() {
      const modal = document.getElementById('cartModal');
      const cartContent = document.getElementById('cartContent');
      const cartTotal = document.getElementById('cartTotal');
      cartContent.innerHTML = cart.map(item => `
        <div class="cart-item">
          <div class="cart-item-info">
            <h3>${item.name}</h3>
            <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
            <p>Extras: ${item.extras.join(', ')}</p>
            <p>Pre√ßo: R$ ${item.totalPrice.toFixed(2)}</p>
          </div>
          <span class="cart-item-remove" onclick="removeFromCart(${item.id})">üóëÔ∏è</span>
        </div>
      `).join('');
      const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
      modal.style.display = "block";
    }

    window.continueShopping = function() {
      document.getElementById('cartModal').style.display = "none";
    }

    window.removeFromCart = function(itemId) {
      cart = cart.filter(item => item.id !== itemId);
      localStorage.setItem('cart', JSON.stringify(cart));
      openCart(); // Atualiza a exibi√ß√£o do carrinho
    }

    window.openCustomerIdentification = function() {
      document.getElementById('cartModal').style.display = "none";
      const modal = document.getElementById('customerIdentificationModal');
      modal.style.display = "block";

      // Preencher informa√ß√µes do cliente se j√° existirem
      const phone = localStorage.getItem('customerPhone');
      if (phone) {
        document.getElementById('customerPhone').value = phone;
        document.getElementById('customerName').value = localStorage.getItem('customerName') || '';
        loadCustomerData(phone);
      }
    }

    function loadCustomerData(phone) {
      db.collection('customers').doc(phone).get().then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          customerInfo = {
            name: data.name,
            phone: phone,
            addresses: data.addresses || []
          };
          document.getElementById('customerName').value = data.name;
          savedAddresses = data.addresses || [];
          localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
          updateLoyaltyInfo(data.orderCount || 0);
        } else {
          updateLoyaltyInfo(0);
        }
      }).catch((error) => {
        console.log("Error getting customer data:", error);
        updateLoyaltyInfo(0);
      });
    }

    document.getElementById('customerIdentificationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const phone = document.getElementById('customerPhone').value;
      const name = document.getElementById('customerName').value;

      customerInfo = { phone, name };

      // Salvar informa√ß√µes do cliente
      localStorage.setItem('customerPhone', phone);
      localStorage.setItem('customerName', name);

      // Salvar ou atualizar informa√ß√µes do cliente no Firestore
      db.collection('customers').doc(phone).set({
        name: name,
        addresses: savedAddresses
      }, { merge: true }).then(() => {
        // Fechar modal de identifica√ß√£o e abrir modal de checkout
        document.getElementById('customerIdentificationModal').style.display = "none";
        openCheckout();
      }).catch((error) => {
        console.error("Error saving customer data: ", error);
      });
    });

    function openCheckout() {
      const checkoutModal = document.getElementById('checkoutModal');
      const orderSummary = document.getElementById('orderSummary');

      // Carregar endere√ßos salvos
      loadSavedAddresses();

      // Exibir resumo do pedido
      let summaryHTML = '<h3>Resumo do Pedido:</h3>';
      let total = 0;
      cart.forEach(item => {
        summaryHTML += `
          <p>${item.name} - R$ ${item.totalPrice.toFixed(2)}</p>
          <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
          <p>Extras: ${item.extras.join(', ')}</p>
          <hr>
        `;
        total += item.totalPrice;
      });
      summaryHTML += `<h4>Subtotal: R$ ${total.toFixed(2)}</h4>`;
      summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
      summaryHTML += `<h3>Total: R$ ${(total + deliveryFee).toFixed(2)}</h3>`;
      orderSummary.innerHTML = summaryHTML;

      // Desabilitar op√ß√µes de pagamento e bot√£o de finalizar pedido
      document.getElementById('paymentSection').style.display = 'none';
      document.getElementById('submitOrderBtn').style.display = 'none';

      // Exibir o modal de checkout
      checkoutModal.style.display = "block";
    }

    function loadSavedAddresses() {
      const select = document.getElementById('savedAddresses');
      select.innerHTML = '<option value="">Selecione um endere√ßo salvo ou cadastre um novo</option>';
      savedAddresses.forEach((address, index) => {
        select.innerHTML += `<option value="${index}">${address.street}, ${address.number} - ${address.neighborhood}</option>`;
      });
    }

    window.handleSavedAddressChange = function() {
      const selectedIndex = document.getElementById('savedAddresses').value;
      if (selectedIndex !== "") {
        const address = savedAddresses[selectedIndex];
        document.getElementById('street').value = address.street;
        document.getElementById('number').value = address.number;
        document.getElementById('complement').value = address.complement || '';
        document.getElementById('neighborhood').value = address.neighborhood;
        document.getElementById('city').value = address.city;
        document.getElementById('state').value = address.state;
        
        // Habilitar op√ß√µes de pagamento e bot√£o de finalizar pedido
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('submitOrderBtn').style.display = 'block';
      } else {
        // Desabilitar op√ß√µes de pagamento e bot√£o de finalizar pedido
        document.getElementById('paymentSection').style.display = 'none';
        document.getElementById('submitOrderBtn').style.display = 'none';
      }
    }

    window.showNewAddressForm = function() {
      document.getElementById('newAddressForm').style.display = 'block';
    }

    window.saveNewAddress = function() {
      const newAddress = {
        street: document.getElementById('street').value,
        number: document.getElementById('number').value,
        complement: document.getElementById('complement').value,
        neighborhood: document.getElementById('neighborhood').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value
      };
      
      let missingFields = [];
      if (!newAddress.street) missingFields.push('Rua');
      if (!newAddress.number) missingFields.push('N√∫mero');
      if (!newAddress.neighborhood) missingFields.push('Bairro');
      if (!newAddress.city) missingFields.push('Cidade');
      if (!newAddress.state) missingFields.push('Estado');
      
      if (missingFields.length > 0) {
        alert(`Por favor, preencha os seguintes campos obrigat√≥rios: ${missingFields.join(', ')}`);
        return;
      }

      savedAddresses.push(newAddress);
      localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
      
      // Atualizar endere√ßos no Firestore
      db.collection('customers').doc(customerInfo.phone).update({
        addresses: savedAddresses
      }).then(() => {
        loadSavedAddresses();
        alert('Novo endere√ßo salvo com sucesso!');
        document.getElementById('newAddressForm').style.display = 'none';
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('submitOrderBtn').style.display = 'block';
      }).catch((error) => {
        console.error("Error updating addresses: ", error);
      });
    }

    window.handlePaymentChange = function() {
      const paymentMethod = document.getElementById('paymentMethod').value;
      document.getElementById('moneyChange').style.display = paymentMethod === 'money' ? 'block' : 'none';
      document.getElementById('pixInfo').style.display = paymentMethod === 'pix' ? 'block' : 'none';
    }

    window.handleChangeNeeded = function() {
      const changeNeeded = document.getElementById('changeNeeded').value;
      document.getElementById('changeAmountDiv').style.display = changeNeeded === 'yes' ? 'block' : 'none';
    }

    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const selectedAddressIndex = document.getElementById('savedAddresses').value;
      if (selectedAddressIndex === "") {
        alert("Por favor, selecione um endere√ßo de entrega.");
        return;
      }
      const selectedAddress = savedAddresses[selectedAddressIndex];
      const paymentMethod = document.getElementById('paymentMethod').value;
      const changeNeeded = document.getElementById('changeNeeded').value;
      const changeAmount = document.getElementById('changeAmount').value;

      // Construir mensagem de WhatsApp
      let message = `Pedido confirmado!\n`;
      message += `Nome: ${customerInfo.name}\n`;
      message += `WhatsApp: ${customerInfo.phone}\n`;
      message += `Endere√ßo: ${selectedAddress.street}, ${selectedAddress.number}, ${selectedAddress.neighborhood}, ${selectedAddress.city} - ${selectedAddress.state}\n`;
      if (selectedAddress.complement) {
        message += `Complemento: ${selectedAddress.complement}\n`;
      }
      message += `M√©todo de Pagamento: ${getPaymentMethodText(paymentMethod)}\n`;
      if (paymentMethod === 'money') {
        message += `Precisa de troco: ${changeNeeded === 'yes' ? 'Sim' : 'N√£o'}\n`;
        if (changeNeeded === 'yes') {
          message += `Troco para: R$ ${parseFloat(changeAmount).toFixed(2)}\n`;
        }
      }
      
      // Adicionar itens do pedido √† mensagem
      message += `\nItens do Pedido:\n`;
      cart.forEach(item => {
        message += `\n${item.name} - R$ ${item.totalPrice.toFixed(2)}`;
        if (item.accompaniments.length > 0) {
          message += `\nAcompanhamentos: ${item.accompaniments.join(', ')}`;
        }
        if (item.extras.length > 0) {
          message += `\nExtras: ${item.extras.join(', ')}`;
        }
      });
      
      message += `\n\nSubtotal: R$ ${cart.reduce((sum, item) => sum + item.totalPrice, 0).toFixed(2)}`;
      message += `\nTaxa de Entrega: R$ ${deliveryFee.toFixed(2)}`;
      message += `\nTotal: R$ ${(cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee).toFixed(2)}`;
      
      // Enviar pedido para o gestor de pedidos
      const order = {
        id: Date.now(),
        customerName: customerInfo.name,
        customerPhone: customerInfo.phone,
        address: selectedAddress,
        paymentMethod: paymentMethod,
        changeNeeded: changeNeeded,
        changeAmount: changeAmount,
        items: cart,
        subtotal: cart.reduce((sum, item) => sum + item.totalPrice, 0),
        deliveryFee: deliveryFee,
        total: cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee,
        status: 'preparing',
        createdAt: new Date()
      };

      // Adicionar pedido ao Firestore
      db.collection('orders').add(order)
        .then(() => {
          console.log('Pedido adicionado com sucesso!');
          // Atualizar a contagem de pedidos do cliente
          return db.collection('customers').doc(customerInfo.phone).get();
        })
        .then((doc) => {
          let orderCount = 0;
          if (doc.exists) {
            orderCount = doc.data().orderCount || 0;
          }
          orderCount++;
          
          return db.collection('customers').doc(customerInfo.phone).set({
            name: customerInfo.name,
            orderCount: orderCount
          }, { merge: true });
        })
        .then(() => {
          // Buscar a contagem atualizada de pedidos
          return db.collection('customers').doc(customerInfo.phone).get();
        })
        .then((doc) => {
          if (doc.exists) {
            const orderCount = doc.data().orderCount;
            // Adicionar informa√ß√£o sobre o programa de fidelidade
            message += `\n\nEste √© o ${getOrderNumberText(orderCount)} pedido do cliente.`;
            if (orderCount >= 10) {
              message += `\nCliente tem direito ao desconto de fidelidade!`;
            } else {
              message += `\nFaltam ${10 - orderCount} pedidos para o pr√≥ximo desconto de fidelidade.`;
            }
          }

          // Redirecionar para o WhatsApp
          window.location.href = `https://wa.me/5584987673202?text=${encodeURIComponent(message)}`;

          // Limpar o carrinho e redefinir a forma de pagamento ap√≥s a confirma√ß√£o do pedido
          cart = [];
          localStorage.setItem('cart', JSON.stringify(cart));
          document.getElementById('paymentMethod').value = 'card';
          handlePaymentChange();

          // Fechar o modal de checkout
          document.getElementById('checkoutModal').style.display = "none";
        })
        .catch(error => {
          console.error('Erro ao adicionar pedido: ', error);
        });
    });

    // Fun√ß√µes auxiliares
    function getPaymentMethodText(method) {
      switch(method) {
        case 'money': return 'Dinheiro';
        case 'card': return 'Cart√£o na entrega';
        case 'pix': return 'PIX';
        default: return method;
      }
    }

    function getOrderNumberText(number) {
      const specialCases = ['primeiro', 'segundo', 'terceiro', 'quarto', 'quinto'];
      return specialCases[number - 1] || `${number}¬∫`;
    }

    // Fun√ß√£o para mostrar as regras do programa de fidelidade
    window.showLoyaltyRules = function() {
      const modal = document.getElementById('loyaltyRulesModal');
      modal.style.display = 'block';
    }

    // Fun√ß√£o para abrir o modal "Meus Pedidos"
    window.openMyOrders = function() {
      const phone = prompt("Por favor, digite seu n√∫mero de WhatsApp com DDD:");
      if (phone) {
        db.collection('orders').where('customerPhone', '==', phone).get()
          .then((querySnapshot) => {
            let ordersHTML = '<h2>Meus Pedidos</h2>';
            if (querySnapshot.empty) {
              ordersHTML += '<p>Voc√™ ainda n√£o fez nenhum pedido.</p>';
            } else {
              ordersHTML += '<ul class="order-list">';
              querySnapshot.forEach((doc) => {
                const order = doc.data();
                ordersHTML += `
                  <li class="order-item">
                    <p><strong>Data:</strong> ${order.createdAt.toDate().toLocaleString()}</p>
                    <p><strong>Total:</strong> R$ ${order.total.toFixed(2)}</p>
                    <p><strong>Detalhes do Pedido:</strong> ${order.items.map(item => `${item.name} (${item.accompaniments.join(', ')})${item.extras.length > 0 ? ` + Extras: ${item.extras.join(', ')}` : ''}`).join(', ')}</p>
                    <button class="btn" onclick="repeatOrder('${doc.id}')">Repetir Este Pedido</button>
                  </li>
                `;
              });
              ordersHTML += '</ul>';
            }
            document.getElementById('ordersList').innerHTML = ordersHTML;
            document.getElementById('myOrdersModal').style.display = 'block';
          })
          .catch((error) => {
            console.log("Erro ao buscar pedidos:", error);
          });
      }
    }

    window.repeatOrder = function(orderId) {
      db.collection('orders').doc(orderId).get()
        .then((doc) => {
          if (doc.exists) {
            const order = doc.data();
            cart = order.items;
            localStorage.setItem('cart', JSON.stringify(cart));
            openCart();
          }
        })
        .catch((error) => {
          console.log("Erro ao repetir pedido:", error);
        });
    }

    // Adicionando a fun√ß√£o de fechar para todos os modais
    document.querySelectorAll('.close').forEach(closeBtn => {
      closeBtn.onclick = function() {
        this.closest('.modal').style.display = "none";
      }
    });

    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = "none";
      });
    }

    // Fecha o modal quando o usu√°rio clica fora dele
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        closeAllModals();
      }
    }

    // Inicializa a exibi√ß√£o de categorias e produtos
    fetchCategories();
    fetchProducts();

    document.getElementById('categories').addEventListener('click', function(event) {
      if (event.target.classList.contains('category-btn')) {
        const category = event.target.getAttribute('data-category');
        filterByCategory(category);
      }
    });

    // Fun√ß√£o para carregar os dados do cliente
    function loadCustomerData(phone) {
      db.collection('customers').doc(phone).get()
        .then((doc) => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById('customerName').value = data.name;
            savedAddresses = data.addresses || [];
            loadSavedAddresses();
            updateLoyaltyInfo(data.orderCount || 0);
          } else {
            updateLoyaltyInfo(0);
          }
        })
        .catch((error) => {
          console.log("Erro ao carregar dados do cliente:", error);
        });
    }

    // Atualizar a fun√ß√£o de identifica√ß√£o do cliente
    document.getElementById('customerPhone').addEventListener('blur', function() {
      const phone = this.value;
      if (phone) {
        loadCustomerData(phone);
      }
    });

    // Fun√ß√£o para atualizar as informa√ß√µes de fidelidade
    function updateLoyaltyInfo(orderCount) {
      const loyaltyInfo = document.getElementById('loyaltyInfo');
      loyaltyInfo.innerHTML = `
        <h3>Programa de Fidelidade</h3>
        <p>Voc√™ j√° realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
        ${orderCount >= 10 ? 
          '<p><strong>Parab√©ns!</strong> Voc√™ tem direito a 50% de desconto no seu pr√≥ximo pedido de A√ßa√≠ ou Creme 1 Litro ou qualquer Combo!</p>' :
          `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para voc√™ ganhar 50% de desconto em um A√ßa√≠ ou Creme 1 Litro ou qualquer Combo!</p>`
        }
        <p>Lembre-se: O pedido s√≥ ser√° contabilizado ap√≥s ser recebido por nossa loja no WhatsApp.</p>
      `;
    }
  });
</script>
</body>
</html>
