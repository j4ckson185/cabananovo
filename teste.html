<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabana A√ßa√≠</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a0e4e;
            --secondary-color: #8e44ad;
            --background-color: #f5f5f5;
            --text-color: #333;
            --accent-color: #e74c3c;
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1em 0;
            text-align: center;
        }
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .logo {
            width: 150px;
            height: auto;
            margin-bottom: 10px;
        }
        .cart-icon {
            font-size: 24px;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        main {
            max-width: 1200px;
            margin: 2em auto;
            padding: 0 20px;
        }
        .categories, .product-grid {
            margin-bottom: 2em;
        }
        .category-btn {
            margin: 0 0.5em 0.5em 0;
            padding: 0.5em 1em;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .category-btn:hover, .category-btn.active {
            background-color: var(--primary-color);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2em;
        }
        .product-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .product-info {
            padding: 1em;
        }
        .product-title {
            margin: 0;
            font-size: 1.2em;
            color: var(--primary-color);
        }
        .product-price {
            font-weight: bold;
            color: var(--secondary-color);
            margin-top: 0.5em;
        }
        .product-description {
            margin-top: 0.5em;
            font-size: 0.9em;
            color: #666;
        }
        .btn {
            display: inline-block;
            padding: 0.5em 1em;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: var(--secondary-color);
        }
        .btn:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .extras-list {
            margin-top: 1em;
        }
        .extras-list h3 {
            margin-bottom: 0.5em;
        }
        .extras-list ul {
            list-style-type: none;
            padding-left: 0;
        }
        .extras-list li {
            margin-bottom: 0.5em;
        }
        .checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        .checkbox-item input {
            margin-right: 5px;
        }
        #cartModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
.user-options {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}

#cartIcon {
    position: relative;
    padding: 10px 20px;
    background-color: #4a0e4e;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

.cart-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: red;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 12px;
    min-width: 20px;
    text-align: center;
}
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-remove {
            color: red;
            cursor: pointer;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        #customerIdentificationForm {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #customerIdentificationForm h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        #customerIdentificationForm label {
            display: block;
            margin-top: 10px;
            color: var(--secondary-color);
        }
        #customerIdentificationForm input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #customerIdentificationForm .btn {
            margin-top: 20px;
            width: 100%;
        }
        .input-icon {
            position: relative;
        }
        .input-icon i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }
        .input-icon input {
            padding-left: 35px;
            text-align: center;
        }
        #checkoutForm {
            margin-top: 20px;
        }
        #checkoutForm label {
            display: block;
            margin-top: 10px;
        }
        #checkoutForm input, #checkoutForm textarea, #checkoutForm select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }
        #orderSummary {
            margin-top: 20px;
        }
        .loyalty-info {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .required-field {
            color: red;
        }
        .extras-suggestion {
            background-color: #f0e6ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .extras-suggestion h3 {
            color: #4a0e4e;
            margin-bottom: 15px;
            text-align: center;
        }
        .extra-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .extra-item {
            background-color: white;
            border: 2px solid #8e44ad;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .extra-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .extra-item p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .extra-item.selected {
            background-color: #e6e6fa;
            border-color: #4a0e4e;
            transform: scale(1.05);
        }
        #comboModal .modal-content {
            max-width: 800px;
        }
        .combo-step {
            margin-bottom: 20px;
        }
        .combo-options {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .combo-option {
            background-color: #fff;
            border: 2px solid #8e44ad;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .combo-option:hover, .combo-option.selected {
            background-color: #e6e6fa;
            border-color: #4a0e4e;
            transform: scale(1.05);
        }
        .combo-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .combo-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        .combo-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .combo-item.selected {
            border-color: #4a0e4e;
            background-color: #e6e6fa;
        }
        #comboSummary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        .user-options {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .user-options .btn {
            margin: 0 10px;
        }
        #orderSummary {
            text-align: center;
        }
        #orderSummary p {
            margin: 5px 0;
        }
        #orderSummary hr {
            margin: 10px 0;
            border: none;
            border-top: 1px solid #ddd;
        }
                #whatsappModal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        #whatsappModal .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
        }

        #whatsappModal h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #whatsappModal input[type="tel"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #whatsappModal .btn {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana A√ßa√≠ Logo" class="logo">
            <h1>Cabana A√ßa√≠</h1>
            <h4>Quarta √† Domingo</h4>
            <p>12:30h as 22:30h</p>
        </div>
        <div class="cart-icon" onclick="openCart()">üõí</div>
    </header>
    <main>
        <div class="user-options">
            <button class="btn" onclick="openMyOrders()">Meus Pedidos</button>
            <button class="btn" onclick="openLoyaltyProgram()">Programa Fidelidade</button>
            <button class="btn" onclick="openComboBuilder()">Montar Combo</button>
            <button class="btn" id="cartIcon" onclick="openCart()">Meu Carrinho <span class="cart-count"></span></button>
        </div>
        <div class="categories" id="categories"></div>
        <div class="product-grid" id="productGrid"></div>
    </main>
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Seu Carrinho</h2>
            <div id="cartContent"></div>
            <div id="cartTotal"></div>
            <button class="btn" onclick="openCustomerIdentification()">Finalizar Pedido</button>
            <button class="btn" onclick="continueShopping()">Continuar Comprando</button>
        </div>
    </div>
    <div id="customerIdentificationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
    <form id="customerIdentificationForm">
      <h2><i class="fas fa-user"></i> Identifique-se</h2>
      <div class="input-icon">
        <i class="fas fa-user"></i>
        <input type="text" id="customerName" placeholder="Nome Completo" required>
      </div>
      <div class="input-icon">
        <i class="fab fa-whatsapp"></i>
        <input type="tel" id="customerPhone" placeholder="WhatsApp (com DDD)" required>
      </div>
      <button type="submit" class="btn">Avan√ßar</button>
    </form>
        </div>
    </div>
<div id="checkoutModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Finalizar Pedido</h2>
        <form id="checkoutForm">
            <div id="deliveryAddressSection">
                <h3>Endere√ßo de Entrega</h3>
                <select id="savedAddresses" onchange="handleSavedAddressChange()">
                    <option value="">Selecione um endere√ßo salvo ou cadastre um novo</option>
                </select>
                <button type="button" class="btn" onclick="showNewAddressForm()">Cadastrar Novo Endere√ßo</button>
                <div id="newAddressForm" style="display: none;">
                    <label for="street">Rua: <span class="required-field">*</span></label>
                    <input type="text" id="street" required>
                    <label for="number">N√∫mero: <span class="required-field">*</span></label>
                    <input type="text" id="number" required>
                    <label for="complement">Complemento:</label>
                    <input type="text" id="complement">
                    <label for="neighborhood">Bairro: <span class="required-field">*</span></label>
                    <input type="text" id="neighborhood" required>
                    <label for="city">Cidade: <span class="required-field">*</span></label>
                    <input type="text" id="city" required>
                    <label for="state">Estado: <span class="required-field">*</span></label>
                    <input type="text" id="state" required>
                    <button type="button" class="btn" onclick="saveNewAddress()">Salvar Endere√ßo</button>
                </div>
            </div>
            <div id="paymentSection" style="display: none;">
                <label for="paymentMethod">M√©todo de Pagamento:</label>
                <select id="paymentMethod" required onchange="handlePaymentChange()">
                    <option value="card">Cart√£o na entrega</option>
                    <option value="money">Dinheiro</option>
                    <option value="pix">PIX</option>
                </select>
                <div id="moneyChange" style="display:none;">
                    <label for="changeNeeded">Precisa de troco?</label>
                    <select id="changeNeeded" onchange="handleChangeNeeded()">
                        <option value="no">N√£o</option>
                        <option value="yes">Sim</option>
                    </select>
                    <div id="changeAmountDiv" style="display:none;">
                        <label for="changeAmount">Troco para quanto?</label>
                        <input type="number" id="changeAmount" min="0" step="0.01">
                    </div>
                </div>
                <div id="pixInfo" style="display:none;">
                    <p>Chave PIX: 84 9 8873-1028</p>
                    <p>Ap√≥s o envio do PIX, favor enviar o comprovante para o WhatsApp 84 9 8767-3202</p>
                </div>
            </div>
            <button type="submit" class="btn" id="submitOrderBtn" style="display: none;">Fazer Pedido</button>
        </form>
        <div id="orderSummary"></div>
        <div id="loyaltyInfo" class="loyalty-info"></div>
        
        <div class="extras-suggestion">
            <h3>Deixe seu a√ßa√≠ mais delicioso e recheado com esses itens extras</h3>
            <div class="extra-items" id="extraItems">
                <!-- Itens extras ser√£o adicionados aqui via JavaScript -->
            </div>
        </div>
    </div>
</div>
    
<div id="comboModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Monte seu Combo</h2>
        <div id="comboBuilder"></div>
    </div>
</div>
<div id="myOrdersModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Meus Pedidos</h2>
        <div id="myOrdersContent"></div>
    </div>
</div>
<div id="loyaltyProgramModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Programa Fidelidade</h2>
        <div id="loyaltyProgramContent"></div>
    </div>
</div>

    <!-- Novo modal para solicitar o n√∫mero de WhatsApp -->
    <div id="whatsappModal" class="modal">
        <div class="modal-content">
            <h2>Bem-vindo ao Cabana A√ßa√≠!</h2>
            <p>Por favor, informe seu n√∫mero de WhatsApp para facilitar a finaliza√ß√£o do seu pedido:</p>
            <input type="tel" id="whatsappInput" placeholder="Ex: 84999999999" required>
            <button class="btn" onclick="saveWhatsapp()">Continuar</button>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
    window.embeddedChatbotConfig = {
        chatbotId: "PpgNSIgeYN1FCucFGP4w3",
        domain: "www.chatbase.co"
    }
</script>
<script
    src="https://www.chatbase.co/embed.min.js"
    chatbotId="PpgNSIgeYN1FCucFGP4w3"
    domain="www.chatbase.co"
    defer>
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
            authDomain: "cabana-8d55e.firebaseapp.com",
            databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
            projectId: "cabana-8d55e",
            storageBucket: "cabana-8d55e.appspot.com",
            messagingSenderId: "706144237954",
            appId: "1:706144237954:web:345c10370972486afc779b",
            measurementId: "G-96Y337GYT8"
        };
        // Inicialize o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        const deliveryFee = 3.00;
        let customerInfo = {};
        let savedAddresses = [];
        // Dados dos itens extras
        const extraItems = [
            { name: "Ovomaltine", price: 1.99, image: "https://images.tcdn.com.br/img/img_prod/919170/ovomaltine_flocos_extra_crocante_750g_425_1_e9d3c08b8341c4e7818b1759c877a213.jpg" },
            { name: "Amendoim", price: 1.99, image: "https://cdn.entrypoint.directory/assets/39790/produtos/3053/xerem-amendoim-secundaria-relva-verde-500g.jpg" },
            { name: "Granola", price: 1.99, image: "https://jardimdaservas.com.br/wp-content/uploads/2023/05/GRANOLAAAIGUARANEMEL-1.jpg" },
            { name: "Chocoball", price: 1.99, image: "https://lojasantoantonio.vtexassets.com/arquivos/ids/156826/562-Choco-Power-Ball-Mini-Preto-e-Branco-500G-MAVALERIO.jpg?v=637254329101230000" },
            { name: "M&M", price: 1.99, image: "https://static.welban.com.br/public/welban/imagens/produtos/confete-de-chocolate-colorido-500g-chococandy-dori-64029a15a016e.jpg" },
            { name: "C√¥co Ralado", price: 1.99, image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_Mt3NOWlBbg-Yv0ttYPiXwNdMIxdh1aSuxJOIg50WN-1FOjiagSbr7MDjQf9OE0b2hnU&usqp=CAU" },
            { name: "Leite em p√≥", price: 1.99, image: "https://acougueamigos.com/cdn/shop/products/acougue-amigos_1_27.jpg?v=1615589403" },
            { name: "Leite condensado", price: 1.99, image: "https://static.escolakids.uol.com.br/conteudo_legenda/07795c263fc55bd57242ef71ae55cee8.jpg" },
            { name: "Calda de Morango", price: 1.99, image: "https://i.ytimg.com/vi/3K6gWHdjyUU/maxresdefault.jpg" },
            { name: "Calda de Chocolate", price: 1.99, image: "https://img.cybercook.com.br/receitas/53/calda-de-chocolate.jpeg" }
        ];

        // Dados dos combos
        const combos = [
            { name: "Combo 2 de 300ml", price: 20.00, maxAccompaniments: 3 },
            { name: "Combo 2 de 500ml", price: 26.99, maxAccompaniments: 4 },
            { name: "Combo 2 de 1 Litro", price: 49.99, maxAccompaniments: 8 }
        ];

        // Dados dos sabores de a√ßa√≠
        const acaiFlavors = [
            "A√ßa√≠ Tradicional", "Creme de Ninho", "Creme de Cupua√ßu", "Creme de Ovomaltine",
            "Creme de Morango", "Creme de Maracuj√°", "Creme de Amendoim"
        ];

        let currentCombo = null;
        let selectedFlavors = [[], []];
        let selectedAccompaniments = [[], []];
        let selectedExtras = [];
        let currentAcaiIndex = 0;

        async function fetchProducts() {
            const snapshot = await db.collection('products').get();
            products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            displayProducts(products);
        }

        async function fetchCategories() {
            const snapshot = await db.collection('categories').get();
            const categories = snapshot.docs.map(doc => doc.data().name);
            const categoriesContainer = document.getElementById('categories');
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category;
                button.onclick = () => filterByCategory(category);
                categoriesContainer.appendChild(button);
            });
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.onclick = () => filterByCategory('all');
            categoriesContainer.insertBefore(allButton, categoriesContainer.firstChild);
        }

        function filterByCategory(category) {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            const filteredProducts = category === 'all' ? products : products.filter(product => product.category === category);
            displayProducts(filteredProducts);
        }

        function displayProducts(productsToDisplay = products) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = productsToDisplay.map(product => `
                <div class="product-card" onclick="openProductDetails(${product.id})">
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
                        <p class="product-description">${product.description.substring(0, 100)}...</p>
                        <button class="btn" onclick="openProductDetails(${product.id}, event)">Ver Detalhes</button>
                    </div>
                </div>
            `).join('');
        }

        window.openProductDetails = function(productId, event) {
            if (event) {
                event.stopPropagation();
            }
            const product = products.find(p => p.id === productId);
            const modal = document.getElementById('productModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h2>${product.name}</h2>
                <img src="${product.image}" alt="${product.name}" style="width:100%; max-height:300px; object-fit:cover;">
                <p>${product.description}</p>
                <p class="product-price">Pre√ßo: R$ ${parseFloat(product.price).toFixed(2)}</p>
                <div class="extras-list">
                    <h3>Acompanhamentos (escolha de ${product.minAccompaniments} a ${product.maxAccompaniments}):</h3>
                    <div class="checkbox-list" id="accompaniments">
                        ${product.accompaniments.map((item, index) => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="acc${index}" name="accompaniment" value="${item}">
                                <label for="acc${index}">${item}</label>
                            </div>
                        `).join('')}
                    </div>
                    <p id="accompanimentError" class="error-message"></p>
                </div>
                <div class="extras-list">
                    <h3>Itens Extras:</h3>
                    <div class="checkbox-list" id="extras">
                        ${product.extras.map((item, index) => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="extra${index}" name="extra" value="${item.name}">
                                <label for="extra${index}">${item.name} - R$ ${parseFloat(item.price).toFixed(2)}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button id="addToCartBtn" class="btn" onclick="addToCart(${product.id})">Adicionar ao Carrinho</button>
            `;
            modal.style.display = "block";
            // Adicionar valida√ß√£o para acompanhamentos
            const accCheckboxes = document.querySelectorAll('#accompaniments input[type="checkbox"]');
            accCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => validateAccompaniments(product));
            });
        }

function validateAccompaniments(product) {
        const checkedAccompaniments = document.querySelectorAll('#accompaniments input[type="checkbox"]:checked');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const errorMessage = document.getElementById('accompanimentError');
        if (checkedAccompaniments.length < product.minAccompaniments || checkedAccompaniments.length > product.maxAccompaniments) {
            addToCartBtn.disabled = true;
            errorMessage.textContent = `Selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos`;
        } else {
            addToCartBtn.disabled = false;
            errorMessage.textContent = '';
        }
    }

window.addToCart = function(productId) {
    const product = products.find(p => p.id === productId);
    const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
    const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);

    if (accompaniments.length < product.minAccompaniments || accompaniments.length > product.maxAccompaniments) {
        alert(`Por favor, selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos.`);
        return;
    }

    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    let cart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];

    const cartItem = {
        id: Date.now().toString(),
        productId: product.id,
        title: product.name,
        sabores: product.name,
        tamanho: product.size || 'Padr√£o',
        acompanhamentos: accompaniments,
        extras: extras,
        total: calculateTotalPrice(product, extras)
    };

    cart.push(cartItem);
    localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(cart));
    
    console.log('Item adicionado ao carrinho:', cartItem);

    document.getElementById('productModal').style.display = "none";
    openCart();
    updateCartIcon();
}

function calculateTotalPrice(product, selectedExtras) {
    let total = product.price;
    selectedExtras.forEach(extraName => {
        const extra = product.extras.find(e => e.name === extraName);
        if (extra) {
            total += extra.price;
        }
    });
    return parseFloat(total.toFixed(2));
}

                // Novas vari√°veis e fun√ß√µes para integra√ß√£o com Chatbase
          // Mantenha um controle dos pedidos processados
let processedOrders = JSON.parse(localStorage.getItem('processedOrders')) || {};

        function formatDate(date) {
    return date.toISOString().split('T')[0]; // Retorna apenas a parte da data (YYYY-MM-DD)
}

let lastFetchTime = 0;
const fetchInterval = 60000; // 1 minuto

function fetchChatbotConversations() {
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    if (!currentUserWhatsapp) return;

    const apiKey = '6564b636-1a71-4a0f-9863-7c87e586384a';
    const chatbotId = 'PpgNSIgeYN1FCucFGP4w3';
    
    const endDate = new Date().toISOString().split('T')[0];
    const startDate = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // 24 horas atr√°s
    
    const url = `https://www.chatbase.co/api/v1/get-conversations?chatbotId=${chatbotId}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}&page=1&size=20`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados recebidos da API:', data);
        if (data && data.data && Array.isArray(data.data)) {
            processConversations(data.data, currentUserWhatsapp);
        } else {
            console.log('Nenhuma conversa nova encontrada');
        }
    })
    .catch(error => {
        console.error('Erro ao buscar conversas:', error);
        console.log('URL da requisi√ß√£o:', url);
    });
}

        
function processConversations(conversations, currentUserWhatsapp) {
    const processedOrders = JSON.parse(localStorage.getItem('processedOrders') || '{}');
    let newOrdersAdded = false;

    conversations.forEach(conversation => {
        if (conversation.messages && Array.isArray(conversation.messages)) {
            conversation.messages.forEach(message => {
                if (message.role === 'user') {
                    const orderDetails = extractOrderFromMessage(message.content);
                    if (orderDetails && orderDetails.whatsapp === currentUserWhatsapp) {
                        const orderId = orderDetails.id || message.id || Date.now().toString();
                        if (!processedOrders[orderId]) {
                            addOrderToCart(orderDetails);
                            processedOrders[orderId] = true;
                            newOrdersAdded = true;
                        }
                    }
                }
            });
        }
    });
    
    localStorage.setItem('processedOrders', JSON.stringify(processedOrders));

    if (newOrdersAdded) {
        updateCartIcon();
    }
}

function updateCartIcon() {
    const cartIcon = document.getElementById('cartIcon');
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    const userCart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    const cartCount = document.querySelector('.cart-count');
    if (userCart.length > 0) {
        if (!cartCount) {
            const countSpan = document.createElement('span');
            countSpan.className = 'cart-count';
            cartIcon.appendChild(countSpan);
        }
        document.querySelector('.cart-count').textContent = userCart.length;
    } else if (cartCount) {
        cartCount.remove();
    }
}
        
// Fun√ß√£o para verificar se o pedido √© novo ou se o hor√°rio √© diferente
function isOrderNew(orderId, whatsappNumber) {
    const lastProcessedTime = processedOrders[whatsappNumber][orderId];
    const currentTime = new Date().getTime();
    const timeDifference = currentTime - lastProcessedTime;

    // Define um intervalo de 1 minuto para considerar o pedido como novo (60000 milissegundos)
    const threshold = 60000;

    // Retorna verdadeiro apenas se o pedido √© novo ou o tempo for superior ao limite
    return !lastProcessedTime || timeDifference > threshold;
}
        
function extractOrderFromMessage(message) {
    console.log('Extraindo pedido da mensagem:', message);
    const orderDetails = {
        id: Date.now().toString(),
        sabores: extractDetail(message, 'Sabores'),
        tamanho: extractDetail(message, 'Tamanho'),
        acompanhamentos: extractDetail(message, 'Acompanhamentos'),
        extras: extractDetail(message, 'Extras'),
        total: extractDetail(message, 'Total'),
        whatsapp: extractDetail(message, 'Whatsapp')
    };

    if (orderDetails.sabores && orderDetails.tamanho && orderDetails.total && orderDetails.whatsapp) {
        console.log('Detalhes do pedido extra√≠dos:', orderDetails);
        return orderDetails;
    }
    return null;
}

function extractDetail(text, label) {
    const regex = new RegExp(`${label}:?\\s*(.+)`, 'i');
    const match = text.match(regex);
    return match ? match[1].trim() : '';
}

function addOrderToCart(orderDetails) {
    const cartKey = `cart_${orderDetails.whatsapp}`;
    let cart = JSON.parse(localStorage.getItem(cartKey)) || [];
    
    // Verifica se o item foi previamente removido
    const removedItemsList = removedItems[orderDetails.whatsapp] || [];
    const wasRemoved = removedItemsList.some(item => 
        item.sabores === orderDetails.sabores && 
        item.tamanho === orderDetails.tamanho && 
        item.total === orderDetails.total
    );

    if (wasRemoved) {
        console.log(`Item previamente removido, n√£o ser√° adicionado novamente: ${orderDetails.sabores} ${orderDetails.tamanho}`);
        return;
    }
    
    const existingOrderIndex = cart.findIndex(item => 
        item.sabores === orderDetails.sabores && 
        item.tamanho === orderDetails.tamanho && 
        item.total === orderDetails.total
    );
    
    if (existingOrderIndex === -1) {
        cart.push({
            id: orderDetails.id || Date.now().toString(),
            title: `${orderDetails.sabores} ${orderDetails.tamanho}`,
            sabores: orderDetails.sabores,
            tamanho: orderDetails.tamanho,
            acompanhamentos: orderDetails.acompanhamentos,
            extras: orderDetails.extras,
            total: orderDetails.total
        });
        localStorage.setItem(cartKey, JSON.stringify(cart));
        console.log(`Novo pedido adicionado ao carrinho para o WhatsApp: ${orderDetails.whatsapp}`);
    } else {
        console.log(`Pedido j√° existe no carrinho para o WhatsApp: ${orderDetails.whatsapp}`);
    }
}
        
            // Fun√ß√£o para solicitar o n√∫mero de WhatsApp
            function requestWhatsapp() {
                document.getElementById('whatsappModal').style.display = 'block';
            }

            // Fun√ß√£o para salvar o n√∫mero de WhatsApp
// Fun√ß√£o para salvar o n√∫mero de WhatsApp
window.saveWhatsapp = function() {
    const whatsapp = document.getElementById('whatsappInput').value;
    if (whatsapp) {
        localStorage.setItem('currentUserWhatsapp', whatsapp);
        localStorage.setItem('processedOrders', JSON.stringify({})); // Reseta os pedidos processados
        document.getElementById('whatsappModal').style.display = 'none';
        startPeriodicCheck(); // Inicia a verifica√ß√£o peri√≥dica
    } else {
        alert("Por favor, insira um n√∫mero de WhatsApp v√°lido.");
    }
};

function startPeriodicCheck() {
    fetchChatbotConversations(); // Verifica imediatamente
    setInterval(fetchChatbotConversations, 10000); // Verifica a cada 10 segundos
}

// Adicione esta fun√ß√£o para verificar novos pedidos
function checkForNewOrders(whatsapp) {
    fetchChatbotConversations();
    const userCart = JSON.parse(localStorage.getItem(`cart_${whatsapp}`)) || [];
    if (userCart.length > 0) {
        alert(`Novo pedido adicionado ao carrinho para o WhatsApp: ${whatsapp}`);
        // Limpa o carrinho ap√≥s o alerta para evitar alertas repetidos
        localStorage.setItem(`cart_${whatsapp}`, JSON.stringify([]));
    }
}
        
window.openCart = function() {
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    if (!currentUserWhatsapp) {
        alert("Por favor, identifique-se primeiro com seu n√∫mero de WhatsApp.");
        return;
    }
    const userCart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    const modal = document.getElementById('cartModal');
    const cartContent = document.getElementById('cartContent');
    const cartTotal = document.getElementById('cartTotal');

    console.log('Carrinho atual:', userCart); // Para debug

    cartContent.innerHTML = userCart.map(item => {
        if (item.isCombo) {
            // Exibi√ß√£o especial para combos
            return `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h3>${item.title}</h3>
                        <p><strong>A√ßa√≠ 1:</strong></p>
                        <p>Sabores: ${item.acai1.flavors.join(', ')}</p>
                        <p>Acompanhamentos: ${item.acai1.accompaniments.join(', ')}</p>
                        <p><strong>A√ßa√≠ 2:</strong></p>
                        <p>Sabores: ${item.acai2.flavors.join(', ')}</p>
                        <p>Acompanhamentos: ${item.acai2.accompaniments.join(', ')}</p>
                        ${item.extras.length > 0 ? `<p>Extras: ${item.extras.join(', ')}</p>` : ''}
                        <p>Total: R$ ${item.total.toFixed(2)}</p>
                    </div>
                    <span class="cart-item-remove" onclick="removeFromCart('${item.id}')">üóëÔ∏è</span>
                </div>
            `;
        } else {
            // Exibi√ß√£o padr√£o para outros itens
            const acompanhamentos = Array.isArray(item.acompanhamentos) 
                ? item.acompanhamentos.join(', ') 
                : item.acompanhamentos;
            
            const extras = Array.isArray(item.extras) 
                ? item.extras.join(', ') 
                : item.extras;

            return `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h3>${item.title}</h3>
                        <p>Sabores: ${item.sabores}</p>
                        <p>Tamanho: ${item.tamanho}</p>
                        <p>Acompanhamentos: ${acompanhamentos}</p>
                        ${extras ? `<p>Extras: ${extras}</p>` : ''}
                        <p>Total: R$ ${typeof item.total === 'number' ? item.total.toFixed(2) : item.total}</p>
                    </div>
                    <span class="cart-item-remove" onclick="removeFromCart('${item.id}')">üóëÔ∏è</span>
                </div>
            `;
        }
    }).join('');

    const total = userCart.reduce((sum, item) => sum + (typeof item.total === 'number' ? item.total : parseFloat(item.total.replace('R$', '').trim() || 0)), 0);
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
    modal.style.display = "block";
}

                   // Solicitar o WhatsApp ao carregar a p√°gina
            requestWhatsapp();

    window.continueShopping = function() {
        document.getElementById('cartModal').style.display = "none";
    }

// Adicione esta vari√°vel no escopo global do seu script
let removedItems = JSON.parse(localStorage.getItem('removedItems') || '{}');

window.removeFromCart = function(itemId) {
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    let userCart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    console.log('Removendo item:', itemId);
    console.log('Carrinho antes:', userCart);

    // Filtra o item para remover
    userCart = userCart.filter(item => item.id != itemId); // Usando != em vez de !==

    console.log('Carrinho depois:', userCart);
    
    // Atualiza o carrinho no localStorage
    localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(userCart));
    
    // Atualiza a exibi√ß√£o do carrinho
    openCart();
    
    // Atualiza o √≠cone do carrinho
    updateCartIcon();
};
        
window.openCustomerIdentification = function() {
    document.getElementById('cartModal').style.display = "none";
    const modal = document.getElementById('customerIdentificationModal');
    modal.style.display = "block";
    const whatsapp = localStorage.getItem('currentUserWhatsapp');
    if (whatsapp) {
        document.getElementById('customerPhone').value = whatsapp;
        document.getElementById('customerName').value = localStorage.getItem('customerName') || '';
        loadCustomerData(whatsapp);
    }
    
    // Remova qualquer observa√ß√£o existente antes de adicionar uma nova
    const existingObservation = document.getElementById('customerObservation');
    if (existingObservation) {
        existingObservation.remove();
    }
    
    // Adiciona a observa√ß√£o
    const observationDiv = document.createElement('div');
    observationDiv.id = 'customerObservation';
    observationDiv.innerHTML = '<p><strong>Observa√ß√£o:</strong> Os pedidos que voc√™ fizer em nossa loja, voc√™ ter√° acesso atrav√©s deste n√∫mero de WhatsApp informado, assim voc√™ poder√° acess√°-los atrav√©s do bot√£o Meus Pedidos na tela inicial do card√°pio.</p>';
    document.getElementById('customerIdentificationForm').appendChild(observationDiv);
}

    function loadCustomerData(phone) {
        db.collection('customers').doc(phone).get().then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                customerInfo = {
                    name: data.name,
                    phone: phone,
                    addresses: data.addresses || []
                };
                document.getElementById('customerName').value = data.name;
                savedAddresses = data.addresses || [];
                localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
                updateLoyaltyInfo(data.orderCount || 0);
            } else {
                updateLoyaltyInfo(0);
            }
        }).catch((error) => {
            console.log("Error getting customer data:", error);
            updateLoyaltyInfo(0);
        });
    }

document.getElementById('customerIdentificationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const phone = document.getElementById('customerPhone').value;
    const name = document.getElementById('customerName').value;
    customerInfo = { phone, name };
    localStorage.setItem('customerPhone', phone);
    localStorage.setItem('customerName', name);
    localStorage.setItem('currentUserWhatsapp', phone); // Adicionando esta linha

    db.collection('customers').doc(phone).set({
        name: name,
        addresses: savedAddresses
    }, { merge: true }).then(() => {
        document.getElementById('customerIdentificationModal').style.display = "none";
        try {
            openCheckout();
        } catch (error) {
            console.error("Erro ao abrir checkout:", error);
            alert("Ocorreu um erro ao abrir a p√°gina de checkout. Por favor, tente novamente.");
        }
    }).catch((error) => {
        console.error("Error saving customer data: ", error);
        alert("Ocorreu um erro ao salvar os dados do cliente. Por favor, tente novamente.");
    });
});

function openCheckout() {
    console.log('Iniciando openCheckout');
    cleanupCart();
    const checkoutModal = document.getElementById('checkoutModal');
    loadSavedAddresses();
    try {
        updateOrderSummary();
    } catch (error) {
        console.error('Erro ao atualizar o resumo do pedido:', error);
        alert('Ocorreu um erro ao carregar o resumo do pedido. Por favor, tente novamente.');
        return;
    }
    document.getElementById('paymentSection').style.display = 'block';
    document.getElementById('submitOrderBtn').style.display = 'block';
    checkoutModal.style.display = "block";
    displayExtraItems();
    console.log('Checkout aberto com sucesso');
}

    function loadSavedAddresses() {
        const select = document.getElementById('savedAddresses');
        select.innerHTML = '<option value="">Selecione um endere√ßo salvo ou cadastre um novo</option>';
        savedAddresses.forEach((address, index) => {
            select.innerHTML += `<option value="${index}">${address.street}, ${address.number} - ${address.neighborhood}</option>`;
        });
    }

    window.handleSavedAddressChange = function() {
        const selectedIndex = document.getElementById('savedAddresses').value;
        if (selectedIndex !== "") {
            const address = savedAddresses[selectedIndex];
            document.getElementById('street').value = address.street;
            document.getElementById('number').value = address.number;
            document.getElementById('complement').value = address.complement || '';
            document.getElementById('neighborhood').value = address.neighborhood;
            document.getElementById('city').value = address.city;
            document.getElementById('state').value = address.state;
            
            document.getElementById('paymentSection').style.display = 'block';
            document.getElementById('submitOrderBtn').style.display = 'block';
        } else {
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('submitOrderBtn').style.display = 'none';
        }
    }

    window.showNewAddressForm = function() {
        document.getElementById('newAddressForm').style.display = 'block';
    }

    window.saveNewAddress = function() {
        const newAddress = {
            street: document.getElementById('street').value,
            number: document.getElementById('number').value,
            complement: document.getElementById('complement').value,
            neighborhood: document.getElementById('neighborhood').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value
        };
        
        let missingFields = [];
        if (!newAddress.street) missingFields.push('Rua');
        if (!newAddress.number) missingFields.push('N√∫mero');
        if (!newAddress.neighborhood) missingFields.push('Bairro');
        if (!newAddress.city) missingFields.push('Cidade');
        if (!newAddress.state) missingFields.push('Estado');
        
        if (missingFields.length > 0) {
            alert(`Por favor, preencha os seguintes campos obrigat√≥rios: ${missingFields.join(', ')}`);
            return;
        }
        savedAddresses.push(newAddress);
        localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
        
        db.collection('customers').doc(customerInfo.phone).update({
            addresses: savedAddresses
        }).then(() => {
            loadSavedAddresses();
            alert('Novo endere√ßo salvo com sucesso!');
            document.getElementById('newAddressForm').style.display = 'none';
            document.getElementById('paymentSection').style.display = 'block';
            document.getElementById('submitOrderBtn').style.display = 'block';
        }).catch((error) => {
            console.error("Error updating addresses: ", error);
        });
    }

    window.handlePaymentChange = function() {
        const paymentMethod = document.getElementById('paymentMethod').value;
        document.getElementById('moneyChange').style.display = paymentMethod === 'money' ? 'block' : 'none';
        document.getElementById('pixInfo').style.display = paymentMethod === 'pix' ? 'block' : 'none';
        updateOrderSummary();
    }

    window.handleChangeNeeded = function() {
        const changeNeeded = document.getElementById('changeNeeded').value;
        document.getElementById('changeAmountDiv').style.display = changeNeeded === 'yes' ? 'block' : 'none';
    }

function displayExtraItems() {
    const extraItemsContainer = document.getElementById('extraItems');
    extraItemsContainer.innerHTML = extraItems.map(item => `
        <div class="extra-item" onclick="toggleExtraItem(this, '${item.name}')">
            <img src="${item.image}" alt="${item.name}">
            <p>${item.name}</p>
            <p>R$ ${item.price.toFixed(2)}</p>
        </div>
    `).join('');
}
        
window.toggleExtraItem = function(element, itemName) {
    element.classList.toggle('selected');
    updateOrderSummaryWithExtras();
}

function updateOrderSummaryWithExtras() {
    const orderSummary = document.getElementById('orderSummary');
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    const userCart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    let summaryHTML = '<h3>Resumo do Pedido:</h3>';
    let subtotal = 0;
    
    userCart.forEach(item => {
        summaryHTML += `
            <div>
                <p><strong>${item.title}</strong></p>
                <p>Sabores: ${item.sabores}</p>
                <p>Tamanho: ${item.tamanho}</p>
                <p>Acompanhamentos: ${item.acompanhamentos}</p>
                ${item.extras ? `<p>Extras: ${item.extras}</p>` : ''}
                <p>Subtotal: ${item.total}</p>
            </div>
            <hr>
        `;
        subtotal += parseFloat(item.total.replace('R$', '').trim() || 0);
    });
    
    const selectedExtras = document.querySelectorAll('.extra-item.selected');
    let extrasTotal = selectedExtras.length * 1.99;
    
    selectedExtras.forEach(item => {
        const itemName = item.querySelector('p').textContent;
        summaryHTML += `<p>Extra: ${itemName} - R$ 1,99</p>`;
    });

    const total = subtotal + extrasTotal + deliveryFee;

    summaryHTML += `<h4>Subtotal: R$ ${subtotal.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Total dos extras: R$ ${extrasTotal.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
    summaryHTML += `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
    orderSummary.innerHTML = summaryHTML;
}

    function updateCartWithExtras(selectedExtras) {
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    let cart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    // Atualiza os extras para cada item no carrinho
    cart = cart.map(item => {
        item.extras = Array.from(selectedExtras).map(extra => extra.querySelector('p').textContent);
        item.total = (parseFloat(item.total.replace('R$', '').trim() || 0) + item.extras.length * 1.99).toFixed(2);
        return item;
    });

    localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(cart));
}
        
function updateOrderSummary() {
    console.log('Iniciando updateOrderSummary');
    const orderSummary = document.getElementById('orderSummary');
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    const userCart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    console.log('Conte√∫do do carrinho:', JSON.stringify(userCart, null, 2));

    let summaryHTML = '<h3>Resumo do Pedido:</h3>';
    let subtotal = 0;
    
    userCart.forEach(item => {
        console.log('Processando item:', item);
        let itemTotal = 0;

        if (typeof item.total === 'number') {
            itemTotal = item.total;
        } else if (typeof item.total === 'string') {
            itemTotal = parseFloat(item.total.replace(/[^\d.-]/g, '')) || 0;
        } else {
            console.warn('Tipo de total n√£o reconhecido:', typeof item.total, item.total);
            itemTotal = 0;
        }

        if (item.isCombo) {
            summaryHTML += `
                <div>
                    <p><strong>${item.title || 'Combo'}</strong></p>
                    <p>A√ßa√≠ 1:</p>
                    <p>Sabores: ${item.acai1?.flavors?.join(', ') || 'N√£o especificado'}</p>
                    <p>Acompanhamentos: ${item.acai1?.accompaniments?.join(', ') || 'Nenhum'}</p>
                    <p>A√ßa√≠ 2:</p>
                    <p>Sabores: ${item.acai2?.flavors?.join(', ') || 'N√£o especificado'}</p>
                    <p>Acompanhamentos: ${item.acai2?.accompaniments?.join(', ') || 'Nenhum'}</p>
                    ${item.extras && item.extras.length > 0 ? `<p>Extras: ${item.extras.join(', ')}</p>` : ''}
                    <p>Subtotal: R$ ${itemTotal.toFixed(2)}</p>
                </div>
                <hr>
            `;
        } else {
            summaryHTML += `
                <div>
                    <p><strong>${item.title || 'Item'}</strong></p>
                    <p>Sabores: ${item.sabores || 'N√£o especificado'}</p>
                    <p>Tamanho: ${item.tamanho || 'N√£o especificado'}</p>
                    <p>Acompanhamentos: ${Array.isArray(item.acompanhamentos) ? item.acompanhamentos.join(', ') : (item.acompanhamentos || 'Nenhum')}</p>
                    ${item.extras && item.extras.length ? `<p>Extras: ${Array.isArray(item.extras) ? item.extras.join(', ') : item.extras}</p>` : ''}
                    <p>Subtotal: R$ ${itemTotal.toFixed(2)}</p>
                </div>
                <hr>
            `;
        }
        subtotal += itemTotal;
    });
    
    const selectedExtras = document.querySelectorAll('.extra-item.selected');
    let extrasTotal = selectedExtras.length * 1.99;
    
    selectedExtras.forEach(item => {
        const itemName = item.querySelector('p').textContent;
        summaryHTML += `<p>Extra: ${itemName} - R$ 1,99</p>`;
    });

    const total = subtotal + extrasTotal + deliveryFee;

    summaryHTML += `<h4>Subtotal dos itens: R$ ${subtotal.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Total dos extras: R$ ${extrasTotal.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
    summaryHTML += `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
    orderSummary.innerHTML = summaryHTML;

    console.log('Resumo do pedido atualizado');
}

// Fun√ß√£o para lidar com a sele√ß√£o de itens extras
window.toggleExtraItem = function(element, itemName) {
    element.classList.toggle('selected');
    updateOrderSummaryWithExtras();
}

document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const selectedAddressIndex = document.getElementById('savedAddresses').value;
    if (selectedAddressIndex === "") {
        alert("Por favor, selecione um endere√ßo de entrega.");
        return;
    }
    const selectedAddress = savedAddresses[selectedAddressIndex];
    const paymentMethod = document.getElementById('paymentMethod').value;
    const changeNeeded = document.getElementById('changeNeeded').value;
    const changeAmount = document.getElementById('changeAmount').value;

    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    const cart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];

    let message = `Pedido confirmado!\n`;
    message += `Nome: ${customerInfo.name}\n`;
    message += `WhatsApp: ${customerInfo.phone}\n`;
    message += `Endere√ßo: ${selectedAddress.street}, ${selectedAddress.number}, ${selectedAddress.neighborhood}, ${selectedAddress.city} - ${selectedAddress.state}\n`;
    if (selectedAddress.complement) {
        message += `Complemento: ${selectedAddress.complement}\n`;
    }
    message += `M√©todo de Pagamento: ${getPaymentMethodText(paymentMethod)}\n`;
    if (paymentMethod === 'money') {
        message += `Precisa de troco: ${changeNeeded === 'yes' ? 'Sim' : 'N√£o'}\n`;
        if (changeNeeded === 'yes') {
            message += `Troco para: R$ ${parseFloat(changeAmount).toFixed(2)}\n`;
        }
    }
    
    message += `\nItens do Pedido:\n`;
    let total = 0;
    cart.forEach(item => {
        message += `\n${item.title} - R$ ${item.total}`;
        message += `\nSabores: ${item.sabores}`;
        message += `\nAcompanhamentos: ${item.acompanhamentos}`;
        if (item.extras && item.extras.length > 0) {
            message += `\nExtras: ${item.extras.join(', ')}`;
        }
        total += parseFloat(item.total.replace('R$', '').trim());
    });

    const selectedExtras = document.querySelectorAll('.extra-item.selected');
    let extrasTotal = 0;
    if (selectedExtras.length > 0) {
        message += "\n\nItens Extras Adicionais:";
        selectedExtras.forEach(item => {
            const itemName = item.querySelector('p').textContent;
            message += `\n- ${itemName} (R$ 1,99)`;
            extrasTotal += 1.99;
        });
    }
    
    total += extrasTotal;
    
    message += `\n\nSubtotal: R$ ${total.toFixed(2)}`;
    message += `\nExtras Adicionais: R$ ${extrasTotal.toFixed(2)}`;
    message += `\nTaxa de Entrega: R$ ${deliveryFee.toFixed(2)}`;
    message += `\nTotal: R$ ${(total + deliveryFee).toFixed(2)}`;
    
    const order = {
        id: Date.now(),
        customerName: customerInfo.name,
        customerPhone: customerInfo.phone,
        address: selectedAddress,
        paymentMethod: paymentMethod,
        changeNeeded: changeNeeded,
        changeAmount: changeAmount,
        items: cart,
        extraItems: Array.from(selectedExtras).map(item => item.querySelector('p').textContent),
        subtotal: total,
        extrasTotal: extrasTotal,
        deliveryFee: deliveryFee,
        total: total + deliveryFee,
        status: 'preparing',
        createdAt: new Date()
    };

    db.collection('orders').add(order)
        .then(() => {
            console.log('Pedido adicionado com sucesso!');
            return db.collection('customers').doc(customerInfo.phone).get();
        })
        .then((doc) => {
            let orderCount = 0;
            if (doc.exists) {
                orderCount = doc.data().orderCount || 0;
            }
            orderCount++;
            
            return db.collection('customers').doc(customerInfo.phone).set({
                name: customerInfo.name,
                orderCount: orderCount
            }, { merge: true });
        })
        .then(() => {
            return db.collection('customers').doc(customerInfo.phone).get();
        })
        .then((doc) => {
            if (doc.exists) {
                const orderCount = doc.data().orderCount;
                message += `\n\nEste √© o ${getOrderNumberText(orderCount)} pedido do cliente.`;
                if (orderCount >= 10) {
                    message += `\nCliente tem direito ao desconto de fidelidade!`;
                } else {
                    message += `\nFaltam ${10 - orderCount} pedidos para o pr√≥ximo desconto de fidelidade.`;
                }
            }
            window.location.href = `https://wa.me/5584987673202?text=${encodeURIComponent(message)}`;
            cart = [];
            localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(cart));
            document.getElementById('paymentMethod').value = 'card';
            handlePaymentChange();
            document.getElementById('checkoutModal').style.display = "none";
        })
        .catch(error => {
            console.error('Erro ao adicionar pedido: ', error);
        });
});

    function getPaymentMethodText(method) {
        switch(method) {
            case 'money': return 'Dinheiro';
            case 'card': return 'Cart√£o na entrega';
            case 'pix': return 'PIX';
            default: return method;
        }
    }

    function getOrderNumberText(number) {
        const specialCases = ['primeiro', 'segundo', 'terceiro', 'quarto', 'quinto'];
        return specialCases[number - 1] || `${number}¬∫`;
    }

    function updateLoyaltyInfo(orderCount) {
        const loyaltyInfo = document.getElementById('loyaltyInfo');
        loyaltyInfo.innerHTML = `
            <h3>Programa de Fidelidade</h3>
            <p>Voc√™ j√° realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
            ${orderCount >= 10 ? 
              '<p><strong>Parab√©ns!</strong> Voc√™ tem direito a 50% de desconto no seu pr√≥ximo pedido!</p>' :
              `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para voc√™ ganhar 50% de desconto!</p>`
            }
            <p>Lembre-se: O pedido s√≥ ser√° contabilizado ap√≥s ser recebido por nossa loja no WhatsApp.</p>
        `;
    }

    window.openMyOrders = function() {
        const modal = document.getElementById('myOrdersModal');
        const content = document.getElementById('myOrdersContent');
        content.innerHTML = `
            <h3>Insira seu n√∫mero de WhatsApp para ver seus pedidos:</h3>
            <input type="tel" id="orderPhoneInput" placeholder="WhatsApp (com DDD)" required>
            <button class="btn" onclick="fetchMyOrders()">Buscar Pedidos</button>
            <div id="ordersList"></div>
        `;
        modal.style.display = "block";
    }

window.fetchMyOrders = function() {
    const phone = document.getElementById('orderPhoneInput').value;
    if (!phone) {
        alert("Por favor, insira seu n√∫mero de WhatsApp.");
        return;
    }
    db.collection('orders')
        .where('customerPhone', '==', phone)
        .orderBy('createdAt', 'desc')
        .get()
        .then((querySnapshot) => {
            const ordersList = document.getElementById('ordersList');
            if (querySnapshot.empty) {
                ordersList.innerHTML = '<p>Nenhum pedido encontrado para este n√∫mero.</p>';
            } else {
                let ordersHtml = '<h3>Seus Pedidos:</h3>';
                querySnapshot.forEach((doc) => {
                    const order = doc.data();
                    ordersHtml += `
                        <div class="order-item">
                            <p><strong>Data:</strong> ${order.createdAt.toDate().toLocaleString()}</p>
                            <p><strong>Total:</strong> R$ ${order.total.toFixed(2)}</p>
                            <p><strong>Detalhes do Pedido:</strong></p>
                            <ul>
                                ${order.items.map(item => `
                                    <li>
                                        ${item.title} - R$ ${parseFloat(item.total).toFixed(2)}
                                        <br>Sabores: ${item.sabores}
                                        <br>Tamanho: ${item.tamanho}
                                        <br>Acompanhamentos: ${item.acompanhamentos}
                                        ${item.extras && item.extras.length ? `<br>Extras: ${item.extras.join(', ')}` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                            ${order.extraItems && order.extraItems.length ? `
                                <p><strong>Itens Extras Adicionais:</strong></p>
                                <ul>
                                    ${order.extraItems.map(extra => `<li>${extra}</li>`).join('')}
                                </ul>
                            ` : ''}
                            <p><strong>Subtotal:</strong> R$ ${order.subtotal.toFixed(2)}</p>
                            <p><strong>Taxa de Entrega:</strong> R$ ${order.deliveryFee.toFixed(2)}</p>
                            <button class="btn" onclick="repeatOrder('${doc.id}')">Repetir Este Pedido</button>
                        </div>
                    `;
                });
                ordersList.innerHTML = ordersHtml;
            }
        })
        .catch((error) => {
            console.error("Erro ao buscar pedidos: ", error);
            alert("Ocorreu um erro ao buscar seus pedidos. Por favor, tente novamente.");
        });
}

window.repeatOrder = function(orderId) {
    db.collection('orders').doc(orderId).get()
        .then((doc) => {
            if (doc.exists) {
                const order = doc.data();
                const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
                let cart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
                
                // Adiciona os itens do pedido ao carrinho
                order.items.forEach(item => {
                    cart.push({
                        id: Date.now() + Math.random(), // Gera um ID √∫nico
                        title: item.title,
                        sabores: item.sabores,
                        tamanho: item.tamanho,
                        acompanhamentos: Array.isArray(item.acompanhamentos) ? item.acompanhamentos : [item.acompanhamentos],
                        extras: Array.isArray(item.extras) ? item.extras : (item.extras ? [item.extras] : []),
                        total: item.total
                    });
                });

                // Salva o carrinho atualizado
                localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(cart));

                alert("Pedido adicionado ao carrinho!");
                document.getElementById('myOrdersModal').style.display = "none";
                updateCartIcon(); // Atualiza o √≠cone do carrinho
                openCart(); // Abre o carrinho imediatamente
            } else {
                alert("Pedido n√£o encontrado.");
            }
        })
        .catch((error) => {
            console.error("Erro ao repetir pedido: ", error);
            alert("Ocorreu um erro ao repetir o pedido. Por favor, tente novamente.");
        });
}

    window.openLoyaltyProgram = function() {
        const modal = document.getElementById('loyaltyProgramModal');
        const content = document.getElementById('loyaltyProgramContent');
        content.innerHTML = `
            <h3>Programa de Fidelidade Cabana A√ßa√≠</h3>
            <p>Nosso programa de fidelidade √© simples e recompensador:</p>
            <ul>
                <li>A cada 10 pedidos, voc√™ ganha 50% de desconto no pr√≥ximo!</li>
                <li>Os pedidos s√£o contabilizados dentro da janela do WhatsApp do cliente.</li>
                <li>Se voc√™ fizer pedidos com n√∫meros de WhatsApp diferentes, os pontos de fidelidade ser√£o somados no novo n√∫mero que est√° utilizando para compra.</li>
            </ul>
            <p>Para verificar seus pontos de fidelidade, insira seu n√∫mero de WhatsApp:</p>
            <input type="tel" id="loyaltyPhoneInput" placeholder="WhatsApp (com DDD)" required>
            <button class="btn" onclick="checkLoyaltyPoints()">Verificar Pontos</button>
            <div id="loyaltyPoints"></div>
        `;
        modal.style.display = "block";
    }

    window.checkLoyaltyPoints = function() {
        const phone = document.getElementById('loyaltyPhoneInput').value;
        if (!phone) {
            alert("Por favor, insira seu n√∫mero de WhatsApp.");
            return;
        }
        db.collection('customers').doc(phone).get()
            .then((doc) => {
                const loyaltyPoints = document.getElementById('loyaltyPoints');
                if (doc.exists) {
                    const orderCount = doc.data().orderCount || 0;
                    loyaltyPoints.innerHTML = `
                        <p>Voc√™ j√° realizou ${orderCount} ${orderCount === 1 ? 'pedido' : 'pedidos'}.</p>
                        ${orderCount >= 10 ? 
                            '<p><strong>Parab√©ns!</strong> Voc√™ tem direito a 50% de desconto no seu pr√≥ximo pedido!</p>' :
                            `<p>Faltam ${10 - orderCount} ${10 - orderCount === 1 ? 'pedido' : 'pedidos'} para voc√™ ganhar 50% de desconto!</p>`
                        }
                    `;
                } else {
                    loyaltyPoints.innerHTML = '<p>Nenhum pedido encontrado para este n√∫mero.</p>';
                }
            })
            .catch((error) => {
                console.error("Erro ao verificar pontos de fidelidade: ", error);
                alert("Ocorreu um erro ao verificar seus pontos. Por favor, tente novamente.");
            });
    }

    // Fun√ß√µes para o sistema de montagem de combos
    window.openComboBuilder = function() {
        const modal = document.getElementById('comboModal');
        const comboBuilder = document.getElementById('comboBuilder');
        comboBuilder.innerHTML = `
            <div class="combo-step">
                <h3>Escolha seu Combo:</h3>
                <div class="combo-options">
                    ${combos.map(combo => `
                        <div class="combo-option" onclick="selectCombo('${combo.name}')">
                            <h4>${combo.name}</h4>
                            <p>R$ ${combo.price.toFixed(2)}</p>
                            <p>At√© ${combo.maxAccompaniments} acompanhamentos por a√ßa√≠</p>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div id="flavorSelection" style="display: none;"></div>
            <div id="accompanimentSelection" style="display: none;"></div>
            <div id="extraItemsSelection" style="display: none;"></div>
            <div id="comboSummary"></div>
            <button class="btn" onclick="addComboToCart()" style="display: none;">Adicionar ao Carrinho</button>
            <button class="btn" onclick="resetComboBuilder()">Voltar</button>
        `;
        modal.style.display = "block";
    }

    window.selectCombo = function(comboName) {
        currentCombo = combos.find(combo => combo.name === comboName);
        document.querySelectorAll('.combo-option').forEach(option => {
            option.classList.remove('selected');
            if (option.textContent.includes(comboName)) {
                option.classList.add('selected');
            }
        });
        currentAcaiIndex = 0;
        showFlavorSelection();
    }

function showFlavorSelection() {
    const flavorSelection = document.getElementById('flavorSelection');
    flavorSelection.innerHTML = `
        <h3>Escolha at√© 2 sabores para o A√ßa√≠ ${currentAcaiIndex + 1}:</h3>
        <div class="combo-items">
            ${acaiFlavors.map(flavor => `
                <div class="combo-item" onclick="toggleFlavor('${flavor}')">
                    <p>${flavor}</p>
                </div>
            `).join('')}
        </div>
        <button class="btn" onclick="showAccompanimentSelection()">Pr√≥ximo</button>
    `;
    flavorSelection.style.display = 'block';
    document.getElementById('accompanimentSelection').style.display = 'none';
    updateFlavorSelection();
}

    window.toggleFlavor = function(flavor) {
        const index = selectedFlavors[currentAcaiIndex].indexOf(flavor);
        if (index > -1) {
            selectedFlavors[currentAcaiIndex].splice(index, 1);
        } else if (selectedFlavors[currentAcaiIndex].length < 2) {
            selectedFlavors[currentAcaiIndex].push(flavor);
        } else {
            alert("Voc√™ s√≥ pode selecionar at√© 2 sabores por a√ßa√≠.");
            return;
        }
        updateFlavorSelection();
    }

function updateFlavorSelection() {
        document.querySelectorAll('#flavorSelection .combo-item').forEach(item => {
            const flavor = item.textContent.trim();
            if (selectedFlavors[currentAcaiIndex].includes(flavor)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

window.showAccompanimentSelection = function() {
    if (selectedFlavors[currentAcaiIndex].length === 0) {
        alert("Por favor, selecione pelo menos um sabor.");
        return;
    }
    const accompanimentSelection = document.getElementById('accompanimentSelection');
    accompanimentSelection.innerHTML = `
        <h3>Escolha at√© ${currentCombo.maxAccompaniments} acompanhamentos para o A√ßa√≠ ${currentAcaiIndex + 1}:</h3>
        <div class="combo-items">
            ${extraItems.map(item => `
                <div class="combo-item" onclick="toggleAccompaniment('${item.name}')">
                    <img src="${item.image}" alt="${item.name}">
                    <p>${item.name}</p>
                </div>
            `).join('')}
        </div>
        <button class="btn" onclick="nextAcai()">Pr√≥ximo</button>
    `;
    accompanimentSelection.style.display = 'block';
    document.getElementById('flavorSelection').style.display = 'none';
    updateAccompanimentSelection();
}

    window.toggleAccompaniment = function(accompaniment) {
        const index = selectedAccompaniments[currentAcaiIndex].indexOf(accompaniment);
        if (index > -1) {
            selectedAccompaniments[currentAcaiIndex].splice(index, 1);
        } else if (selectedAccompaniments[currentAcaiIndex].length < currentCombo.maxAccompaniments) {
            selectedAccompaniments[currentAcaiIndex].push(accompaniment);
        } else {
            alert(`Voc√™ s√≥ pode selecionar at√© ${currentCombo.maxAccompaniments} acompanhamentos por a√ßa√≠.`);
            return;
        }
        updateAccompanimentSelection();
    }

    function updateAccompanimentSelection() {
        document.querySelectorAll('#accompanimentSelection .combo-item').forEach(item => {
            const accompaniment = item.querySelector('p').textContent.trim();
            if (selectedAccompaniments[currentAcaiIndex].includes(accompaniment)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

window.nextAcai = function() {
    if (selectedAccompaniments[currentAcaiIndex].length === 0) {
        alert("Por favor, selecione pelo menos um acompanhamento.");
        return;
    }
    if (currentAcaiIndex === 0) {
        currentAcaiIndex = 1;
        document.getElementById('accompanimentSelection').style.display = 'none';
        showFlavorSelection();
    } else {
        showExtraItemsSelection();
    }
}

    window.showExtraItemsSelection = function() {
        const extraItemsSelection = document.getElementById('extraItemsSelection');
        extraItemsSelection.innerHTML = `
            <h3>Escolha itens extras (R$ 1,99 cada):</h3>
            <div class="combo-items">
                ${extraItems.map(item => `
                    <div class="combo-item" onclick="toggleExtra('${item.name}')">
                        <img src="${item.image}" alt="${item.name}">
                        <p>${item.name}</p>
                        <p>R$ ${item.price.toFixed(2)}</p>
                    </div>
                `).join('')}
            </div>
            <button class="btn" onclick="finishCombo()">Finalizar Combo</button>
        `;
        extraItemsSelection.style.display = 'block';
        document.getElementById('accompanimentSelection').style.display = 'none';
    }

    window.toggleExtra = function(extra) {
        const index = selectedExtras.indexOf(extra);
        if (index > -1) {
            selectedExtras.splice(index, 1);
        } else {
            selectedExtras.push(extra);
        }
        updateExtraItemsSelection();
    }

    function updateExtraItemsSelection() {
        document.querySelectorAll('#extraItemsSelection .combo-item').forEach(item => {
            const extra = item.querySelector('p').textContent.trim();
            if (selectedExtras.includes(extra)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

window.finishCombo = function() {
    updateComboSummary();
    document.querySelector('#comboModal .btn[onclick="addComboToCart()"]').style.display = 'block';
}

function updateComboSummary() {
    const comboSummary = document.getElementById('comboSummary');
    let total = currentCombo.price + (selectedExtras.length * 1.99);
    comboSummary.innerHTML = `
        <h3>Resumo do Combo:</h3>
        <p><strong>Combo:</strong> ${currentCombo.name}</p>
        <p><strong>A√ßa√≠ 1:</strong></p>
        <p>Sabores: ${selectedFlavors[0].join(', ')}</p>
        <p>Acompanhamentos: ${selectedAccompaniments[0].join(', ')}</p>
        <p><strong>A√ßa√≠ 2:</strong></p>
        <p>Sabores: ${selectedFlavors[1].join(', ')}</p>
        <p>Acompanhamentos: ${selectedAccompaniments[1].join(', ')}</p>
        <p><strong>Extras:</strong> ${selectedExtras.length > 0 ? selectedExtras.join(', ') : 'Nenhum'}</p>
        <p><strong>Total:</strong> R$ ${total.toFixed(2)}</p>
    `;
}

function cleanupCart() {
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    let cart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    cart = cart.filter(item => {
        if (typeof item.total === 'number') {
            return true;
        } else if (typeof item.total === 'string') {
            item.total = parseFloat(item.total.replace(/[^\d.-]/g, '')) || 0;
            return true;
        } else {
            console.warn('Item removido do carrinho devido a total inv√°lido:', item);
            return false;
        }
    });

    localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(cart));
    console.log('Carrinho limpo:', cart);
}
        
function updateOrderSummary() {
    console.log('Iniciando updateOrderSummary');
    const orderSummary = document.getElementById('orderSummary');
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    const userCart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];
    
    console.log('Conte√∫do do carrinho:', JSON.stringify(userCart, null, 2));

    let summaryHTML = '<h3>Resumo do Pedido:</h3>';
    let subtotal = 0;
    
    userCart.forEach(item => {
        console.log('Processando item:', item);
        let itemTotal = 0;

        if (typeof item.total === 'number') {
            itemTotal = item.total;
        } else if (typeof item.total === 'string') {
            itemTotal = parseFloat(item.total.replace(/[^\d.-]/g, '')) || 0;
        } else {
            console.warn('Tipo de total n√£o reconhecido:', typeof item.total, item.total);
            itemTotal = 0;
        }

        if (item.isCombo) {
            summaryHTML += `
                <div>
                    <p><strong>${item.title || 'Combo'}</strong></p>
                    <p>A√ßa√≠ 1:</p>
                    <p>Sabores: ${item.acai1?.flavors?.join(', ') || 'N√£o especificado'}</p>
                    <p>Acompanhamentos: ${item.acai1?.accompaniments?.join(', ') || 'Nenhum'}</p>
                    <p>A√ßa√≠ 2:</p>
                    <p>Sabores: ${item.acai2?.flavors?.join(', ') || 'N√£o especificado'}</p>
                    <p>Acompanhamentos: ${item.acai2?.accompaniments?.join(', ') || 'Nenhum'}</p>
                    ${item.extras && item.extras.length > 0 ? `<p>Extras: ${item.extras.join(', ')}</p>` : ''}
                    <p>Subtotal: R$ ${itemTotal.toFixed(2)}</p>
                </div>
                <hr>
            `;
        } else {
            summaryHTML += `
                <div>
                    <p><strong>${item.title || 'Item'}</strong></p>
                    <p>Sabores: ${item.sabores || 'N√£o especificado'}</p>
                    <p>Tamanho: ${item.tamanho || 'N√£o especificado'}</p>
                    <p>Acompanhamentos: ${Array.isArray(item.acompanhamentos) ? item.acompanhamentos.join(', ') : (item.acompanhamentos || 'Nenhum')}</p>
                    ${item.extras && item.extras.length ? `<p>Extras: ${Array.isArray(item.extras) ? item.extras.join(', ') : item.extras}</p>` : ''}
                    <p>Subtotal: R$ ${itemTotal.toFixed(2)}</p>
                </div>
                <hr>
            `;
        }
        subtotal += itemTotal;
    });
    
    const selectedExtras = document.querySelectorAll('.extra-item.selected');
    let extrasTotal = selectedExtras.length * 1.99;
    
    selectedExtras.forEach(item => {
        const itemName = item.querySelector('p').textContent;
        summaryHTML += `<p>Extra: ${itemName} - R$ 1,99</p>`;
    });

    const total = subtotal + extrasTotal + deliveryFee;

    summaryHTML += `<h4>Subtotal dos itens: R$ ${subtotal.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Total dos extras: R$ ${extrasTotal.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
    summaryHTML += `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
    orderSummary.innerHTML = summaryHTML;

    console.log('Resumo do pedido atualizado');
}

window.addComboToCart = function() {
    const currentUserWhatsapp = localStorage.getItem('currentUserWhatsapp');
    let cart = JSON.parse(localStorage.getItem(`cart_${currentUserWhatsapp}`)) || [];

    const comboTotal = currentCombo.price + (selectedExtras.length * 1.99);

    const comboItem = {
        id: Date.now().toString(),
        isCombo: true,
        title: currentCombo.name,
        acai1: {
            flavors: selectedFlavors[0],
            accompaniments: selectedAccompaniments[0]
        },
        acai2: {
            flavors: selectedFlavors[1],
            accompaniments: selectedAccompaniments[1]
        },
        extras: selectedExtras,
        total: parseFloat(comboTotal.toFixed(2))
    };

    cart.push(comboItem);
    localStorage.setItem(`cart_${currentUserWhatsapp}`, JSON.stringify(cart));

    console.log('Combo adicionado ao carrinho:', comboItem);

    alert('Combo adicionado ao carrinho!');
    document.getElementById('comboModal').style.display = 'none';
    resetComboBuilder();
    updateCartIcon();
    openCart();
}

    window.resetComboBuilder = function() {
        currentCombo = null;
        selectedFlavors = [[], []];
        selectedAccompaniments = [[], []];
        selectedExtras = [];
        currentAcaiIndex = 0;
        document.getElementById('flavorSelection').style.display = 'none';
        document.getElementById('accompanimentSelection').style.display = 'none';
        document.getElementById('extraItemsSelection').style.display = 'none';
        document.getElementById('comboSummary').innerHTML = '';
        document.querySelector('#comboModal .btn[onclick="addComboToCart()"]').style.display = 'none';
    }

    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.onclick = function() {
            this.closest('.modal').style.display = "none";
        }
    });

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = "none";
        });
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            closeAllModals();
        }
    }

    fetchCategories();
    fetchProducts();
});
</script>
</body>
</html>
