const firebaseConfig = {
    apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
    authDomain: "cabana-8d55e.firebaseapp.com",
    databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
    projectId: "cabana-8d55e",
    storageBucket: "cabana-8d55e.appspot.com",
    messagingSenderId: "706144237954",
    appId: "1:706144237954:web:345c10370972486afc779b",
    measurementId: "G-96Y337GYT8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let categories = [];
let products = [];
let customers = [];
let editingProductId = null;

async function fetchCategories() {
    const snapshot = await db.collection('categories').get();
    categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateCategoriesList();
    updateCategorySelect();
}

async function fetchProducts() {
    const snapshot = await db.collection('products').get();
    products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateProductsList();
}

async function fetchCustomers() {
    const snapshot = await db.collection('customers').get();
    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateCustomersList();
}

async function fetchHours() {
    const doc = await db.collection('settings').doc('hours').get();
    if (doc.exists) {
        const hours = doc.data();
        for (const day in hours) {
            if (hours.hasOwnProperty(day)) {
                document.getElementById(day).value = hours[day];
            }
        }
    }
}

document.getElementById('hoursForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const hours = {
        mondayOpen: document.getElementById('mondayOpen').value,
        mondayClose: document.getElementById('mondayClose').value,
        tuesdayOpen: document.getElementById('tuesdayOpen').value,
        tuesdayClose: document.getElementById('tuesdayClose').value,
        wednesdayOpen: document.getElementById('wednesdayOpen').value,
        wednesdayClose: document.getElementById('wednesdayClose').value,
        thursdayOpen: document.getElementById('thursdayOpen').value,
        thursdayClose: document.getElementById('thursdayClose').value,
        fridayOpen: document.getElementById('fridayOpen').value,
        fridayClose: document.getElementById('fridayClose').value,
        saturdayOpen: document.getElementById('saturdayOpen').value,
        saturdayClose: document.getElementById('saturdayClose').value,
        sundayOpen: document.getElementById('sundayOpen').value,
        sundayClose: document.getElementById('sundayClose').value,
    };
    await db.collection('settings').doc('hours').set(hours);
    alert('Horários de funcionamento salvos com sucesso!');
});

function addExtraItem() {
    const extrasContainer = document.getElementById('extrasContainer');
    const extraDiv = document.createElement('div');
    extraDiv.innerHTML = `
        <input type="text" placeholder="Nome do Item Extra" required>
        <input type="number" placeholder="Preço do Item Extra" step="0.01" required>
        <button type="button" onclick="this.parentElement.remove()">Remover</button>
    `;
    extrasContainer.appendChild(extraDiv);
}

document.getElementById('addCategoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const categoryName = document.getElementById('categoryName').value;
    await db.collection('categories').add({ name: categoryName });
    alert('Categoria adicionada com sucesso!');
    fetchCategories();
});

document.getElementById('addProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const product = {
        name: document.getElementById('productName').value,
        price: parseFloat(document.getElementById('productPrice').value),
        category: document.getElementById('productCategory').value,
        description: document.getElementById('productDescription').value,
        image: document.getElementById('productImage').value,
        minAccompaniments: parseInt(document.getElementById('minAccompaniments').value),
        maxAccompaniments: parseInt(document.getElementById('maxAccompaniments').value),
        accompaniments: document.getElementById('accompaniments').value.split('\n'),
        extras: Array.from(document.getElementById('extrasContainer').children).map(div => ({
            name: div.children[0].value,
            price: parseFloat(div.children[1].value)
        }))
    };

    if (editingProductId) {
        await db.collection('products').doc(editingProductId).update(product);
        editingProductId = null;
    } else {
        await db.collection('products').add(product);
    }

    alert(editingProductId ? 'Produto atualizado com sucesso!' : 'Produto adicionado com sucesso!');
    this.reset();
    document.getElementById('extrasContainer').innerHTML = '';
    addExtraItem();
    fetchProducts();
});

function updateCategoriesList() {
    const categoriesList = document.getElementById('categoriesList');
    categoriesList.innerHTML = categories.map(category => `
        <div class="category-item">
            ${category.name}
            <button class="delete-btn" onclick="deleteCategory('${category.id}')">Deletar</button>
        </div>
    `).join('');
}

function updateCategorySelect() {
    const categorySelect = document.getElementById('productCategory');
    categorySelect.innerHTML = categories.map(category => `
        <option value="${category.name}">${category.name}</option>
    `).join('');
}

function updateProductsList() {
    const productsList = document.getElementById('productsList');
    productsList.innerHTML = products.map(product => `
        <div class="product-item">
            <h3>${product.name}</h3>
            <p>Preço: R$ ${product.price.toFixed(2)}</p>
            <p>Categoria: ${product.category}</p>
            <button class="edit-btn" onclick="editProduct('${product.id}')">Editar</button>
            <button class="delete-btn" onclick="deleteProduct('${product.id}')">Deletar</button>
        </div>
    `).join('');
}

function updateCustomersList() {
    const customersList = document.getElementById('customersList');
    customersList.innerHTML = customers.map(customer => `
        <div class="customer-item">
            <h3>${customer.name}</h3>
            <p>WhatsApp: ${customer.phone}</p>
            <p>Pontos Fidelidade: ${customer.orderCount || 0}</p>
            <input type="number" id="loyaltyPoints-${customer.id}" value="${customer.orderCount || 0}">
            <button onclick="updateLoyaltyPoints('${customer.id}')">Atualizar Pontos</button>
        </div>
    `).join('');
}

async function deleteCategory(categoryId) {
    if (confirm('Tem certeza que deseja deletar esta categoria?')) {
        await db.collection('categories').doc(categoryId).delete();
        fetchCategories();
    }
}

async function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        document.getElementById('productName').value = product.name;
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productDescription').value = product.description;
        document.getElementById('productImage').value = product.image;
        document.getElementById('minAccompaniments').value = product.minAccompaniments;
        document.getElementById('maxAccompaniments').value = product.maxAccompaniments;
        document.getElementById('accompaniments').value = product.accompaniments.join('\n');
        
        const extrasContainer = document.getElementById('extrasContainer');
        extrasContainer.innerHTML = '';
        product.extras.forEach(extra => {
            const extraDiv = document.createElement('div');
            extraDiv.innerHTML = `
                <input type="text" value="${extra.name}" required>
                <input type="number" value="${extra.price}" step="0.01" required>
                <button type="button" onclick="this.parentElement.remove()">Remover</button>
            `;
            extrasContainer.appendChild(extraDiv);
        });
        editingProductId = productId;
    }
}

async function deleteProduct(productId) {
    if (confirm('Tem certeza que deseja deletar este produto?')) {
        await db.collection('products').doc(productId).delete();
        fetchProducts();
    }
}

async function updateLoyaltyPoints(customerId) {
    const newPoints = prompt("Digite a nova pontuação de fidelidade:");
    if (newPoints !== null) {
        try {
            await db.collection('customers').doc(customerId).update({
                orderCount: parseInt(newPoints)
            });
            alert("Pontuação atualizada com sucesso!");
            fetchCustomers();
        } catch (error) {
            console.error("Erro ao atualizar pontuação:", error);
            alert("Erro ao atualizar pontuação. Por favor, tente novamente.");
        }
    }
}

function updateCustomersList(customers) {
    const customersList = document.getElementById('customersList');
    customersList.innerHTML = customers.map(customer => `
        <div class="customer-item">
            <p><strong>Nome:</strong> ${customer.name}</p>
            <p><strong>WhatsApp:</strong> ${customer.phone}</p>
            <p><strong>Pontos Fidelidade:</strong> ${customer.orderCount || 0}</p>
            <button onclick="updateLoyaltyPoints('${customer.id}')">Alterar Pontuação</button>
        </div>
    `).join('');
}

async function fetchCustomers() {
    try {
        const snapshot = await db.collection('customers').get();
        const customers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        updateCustomersList(customers);
    } catch (error) {
        console.error("Erro ao buscar clientes:", error);
    }
}

// Inicialização
fetchCategories();
fetchProducts();
fetchHours();
fetchCustomers();

// Verificar status da loja
function checkStoreStatus() {
    const now = new Date();
    const day = now.getDay();
    const time = now.getHours() * 60 + now.getMinutes();

    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDay = days[day];

    db.collection('settings').doc('hours').get().then((doc) => {
        if (doc.exists) {
            const hours = doc.data();
            const openTime = timeToMinutes(hours[currentDay + 'Open']);
            const closeTime = timeToMinutes(hours[currentDay + 'Close']);

            const isOpen = time >= openTime && time < closeTime;
            updateStoreStatus(isOpen);
        }
    }).catch((error) => {
        console.error("Erro ao verificar status da loja:", error);
    });
}

function timeToMinutes(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

function updateStoreStatus(isOpen) {
    const statusElement = document.createElement('div');
    statusElement.id = 'storeStatus';
    statusElement.textContent = isOpen ? 'ABERTA' : 'FECHADA';
    statusElement.style.backgroundColor = isOpen ? '#4CAF50' : '#f44336';
    statusElement.style.color = 'white';
    statusElement.style.padding = '10px';
    statusElement.style.textAlign = 'center';
    statusElement.style.fontWeight = 'bold';

    const header = document.querySelector('header');
    const existingStatus = document.getElementById('storeStatus');
    if (existingStatus) {
        header.removeChild(existingStatus);
    }
    header.appendChild(statusElement);
}

// Verificar status da loja a cada minuto
setInterval(checkStoreStatus, 60000);
checkStoreStatus(); // Verificar imediatamente ao carregar a página
