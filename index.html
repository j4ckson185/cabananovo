<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cabana A√ßa√≠</title>
<style>
:root {
  --primary-color: #4a0e4e;
  --secondary-color: #8e44ad;
  --background-color: #f5f5f5;
  --text-color: #333;
}
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  background-color: var(--background-color);
  color: var(--text-color);
}
header {
  background-color: var(--primary-color);
  color: white;
  padding: 1em 0;
  text-align: center;
}
.header-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}
.logo {
  width: 150px;
  height: auto;
  margin-bottom: 10px;
}
.cart-icon {
  font-size: 24px;
  cursor: pointer;
  position: absolute;
  right: 20px;
  top: 20px;
}
main {
  max-width: 1200px;
  margin: 2em auto;
  padding: 0 20px;
}
.categories, .product-grid {
  margin-bottom: 2em;
}
.category-btn {
  margin: 0 0.5em 0.5em 0;
  padding: 0.5em 1em;
  background-color: var(--secondary-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.category-btn:hover {
  background-color: var(--primary-color);
}
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 2em;
}
.product-card {
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: transform 0.3s ease;
  cursor: pointer;
}
.product-card:hover {
  transform: translateY(-5px);
}
.product-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}
.product-info {
  padding: 1em;
}
.product-title {
  margin: 0;
  font-size: 1.2em;
  color: var(--primary-color);
}
.product-price {
  font-weight: bold;
  color: var(--secondary-color);
  margin-top: 0.5em;
}
.product-description {
  margin-top: 0.5em;
  font-size: 0.9em;
  color: #666;
}
.btn {
  display: inline-block;
  padding: 0.5em 1em;
  background-color: var(--primary-color);
  color: white;
  text-decoration: none;
  border-radius: 4px;
  transition: background-color 0.3s ease;
  border: none;
  cursor: pointer;
}
.btn:hover {
  background-color: var(--secondary-color);
}
.btn:disabled {
  background-color: #cccccc;
  color: #666666;
  cursor: not-allowed;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}
.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 600px;
  border-radius: 8px;
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
.extras-list {
  margin-top: 1em;
}
.extras-list h3 {
  margin-bottom: 0.5em;
}
.extras-list ul {
  list-style-type: none;
  padding-left: 0;
}
.extras-list li {
  margin-bottom: 0.5em;
}
.checkbox-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.checkbox-item {
  display: flex;
  align-items: center;
}
.checkbox-item input {
  margin-right: 5px;
}
#cartModal .modal-content {
  max-height: 80vh;
  overflow-y: auto;
}
.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #ddd;
}
.cart-item-info {
  flex-grow: 1;
}
.cart-item-remove {
  color: red;
  cursor: pointer;
}
.error-message {
  color: red;
  margin-top: 10px;
}
#checkoutForm {
  margin-top: 20px;
}
#checkoutForm label {
  display: block;
  margin-top: 10px;
}
#checkoutForm input, #checkoutForm textarea {
  width: 100%;
  padding: 5px;
  margin-top: 5px;
}
#orderSummary {
  margin-top: 20px;
}
</style>
</head>
<body>
<header>
  <div class="header-content">
    <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana A√ßa√≠ Logo" class="logo">
    <h1>Cabana A√ßa√≠</h1>
  </div>
  <div class="cart-icon" onclick="openCart()">üõí</div>
</header>
<main>
  <div class="categories" id="categories"></div>
  <div class="product-grid" id="productGrid"></div>
</main>

<div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalContent"></div>
  </div>
</div>

<div id="cartModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Seu Carrinho</h2>
    <div id="cartContent"></div>
    <div id="cartTotal"></div>
    <button class="btn" onclick="openCheckout()">Finalizar Pedido</button>
    <button class="btn" onclick="continueShopping()">Continuar Comprando</button>
  </div>
</div>

<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Finalizar Pedido</h2>
    <form id="checkoutForm">
      <label for="name">Nome:</label>
      <input type="text" id="name" required>

      <label for="address">Endere√ßo:</label>
      <textarea id="address" required></textarea>

      <label for="phone">Telefone:</label>
      <input type="tel" id="phone" required>

      <label for="paymentMethod">M√©todo de Pagamento:</label>
      <select id="paymentMethod" required onchange="handlePaymentChange()">
        <option value="card" selected>Cart√£o</option>
        <option value="cash">Dinheiro</option>
        <option value="pix">PIX</option>
      </select>

      <div id="cashInfo" style="display:none; margin-top: 10px;">
        <label for="changeNeeded">Precisa de troco?</label>
        <select id="changeNeeded" onchange="handleChangeNeeded()">
          <option value="no" selected>N√£o</option>
          <option value="yes">Sim</option>
        </select>
        <div id="changeAmountDiv" style="display:none; margin-top: 10px;">
          <label for="changeAmount">Quanto de troco?</label>
          <input type="number" id="changeAmount" min="0" step="0.01">
        </div>
      </div>

      <div id="pixInfo" style="display:none; margin-top: 10px;">
        <p>Chave PIX: 84 9 8873-1028</p>
        <p>Ap√≥s o envio do PIX, favor enviar o comprovante para o WhatsApp 84 9 8873-1028</p>
      </div>

      <button type="submit" class="btn">Confirmar Pedido</button>
    </form>
    <div id="orderSummary"></div>
  </div>
</div>

<script>
  console.log('Script index carregado');

  // Carrega os produtos do localStorage
  const products = JSON.parse(localStorage.getItem('products')) || [];
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const deliveryFee = 3.00;

  console.log('Produtos:', products);
  console.log('Carrinho:', cart);

  function getUniqueCategories() {
    return [...new Set(products.map(product => product.category))];
  }

  function displayCategories() {
    const categoriesContainer = document.getElementById('categories');
    const categories = getUniqueCategories();
    categoriesContainer.innerHTML = categories.map(category => `
      <button class="category-btn" onclick="filterByCategory('${category}')">${category}</button>
    `).join('');
    categoriesContainer.innerHTML = `<button class="category-btn" onclick="filterByCategory('all')">Todos</button>` + categoriesContainer.innerHTML;
  }

  function filterByCategory(category) {
    const filteredProducts = category === 'all' ? products : products.filter(product => product.category === category);
    displayProducts(filteredProducts);
  }

  function displayProducts(productsToDisplay = products) {
    const productGrid = document.getElementById('productGrid');
    productGrid.innerHTML = productsToDisplay.map(product => `
      <div class="product-card" onclick="openProductDetails(${product.id})">
        <img src="${product.image}" alt="${product.name}" class="product-image">
        <div class="product-info">
          <h3 class="product-title">${product.name}</h3>
          <p class="product-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
          <p class="product-description">${product.description.substring(0, 100)}...</p>
          <button class="btn" onclick="openProductDetails(${product.id}, event)">Ver Detalhes</button>
        </div>
      </div>
    `).join('');
  }

  function openProductDetails(productId, event) {
    if (event) {
      event.stopPropagation();
    }
    const product = products.find(p => p.id === productId);
    const modal = document.getElementById('productModal');
    const modalContent = document.getElementById('modalContent');

    modalContent.innerHTML = `
      <h2>${product.name}</h2>
      <img src="${product.image}" alt="${product.name}" style="width:100%; max-height:300px; object-fit:cover;">
      <p>${product.description}</p>
      <p class="product-price">Pre√ßo: R$ ${parseFloat(product.price).toFixed(2)}</p>
      <div class="extras-list">
        <h3>Acompanhamentos (escolha de ${product.minAccompaniments} a ${product.maxAccompaniments}):</h3>
        <div class="checkbox-list" id="accompaniments">
          ${product.accompaniments.map((item, index) => `
            <div class="checkbox-item">
              <input type="checkbox" id="acc${index}" name="accompaniment" value="${item}">
              <label for="acc${index}">${item}</label>
            </div>
          `).join('')}
        </div>
        <p id="accompanimentError" class="error-message"></p>
      </div>
      <div class="extras-list">
        <h3>Itens Extras:</h3>
        <div class="checkbox-list" id="extras">
          ${product.extras.map((item, index) => `
            <div class="checkbox-item">
              <input type="checkbox" id="extra${index}" name="extra" value="${item.name}">
              <label for="extra${index}">${item.name} - R$ ${parseFloat(item.price).toFixed(2)}</label>
            </div>
          `).join('')}
        </div>
      </div>
      <button id="addToCartBtn" class="btn" onclick="addToCart(${product.id})">Adicionar ao Carrinho</button>
    `;

    modal.style.display = "block";

    // Adicionar valida√ß√£o para acompanhamentos
    const accCheckboxes = document.querySelectorAll('#accompaniments input[type="checkbox"]');
    accCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => validateAccompaniments(product));
    });
  }

  function validateAccompaniments(product) {
    const checkedAccompaniments = document.querySelectorAll('#accompaniments input[type="checkbox"]:checked');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const errorMessage = document.getElementById('accompanimentError');

    if (checkedAccompaniments.length < product.minAccompaniments || checkedAccompaniments.length > product.maxAccompaniments) {
      addToCartBtn.disabled = true;
      errorMessage.textContent = `Selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos`;
    } else {
      addToCartBtn.disabled = false;
      errorMessage.textContent = '';
    }
  }

  function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
    const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);

    if (accompaniments.length < product.minAccompaniments || accompaniments.length > product.maxAccompaniments) {
      alert(`Por favor, selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos.`);
      return;
    }

    const cartItem = {
      id: Date.now(),
      productId: product.id,
      name: product.name,
      price: product.price,
      accompaniments: accompaniments,
      extras: extras,
      totalPrice: calculateTotalPrice(product, extras)
    };

    cart.push(cartItem);
    localStorage.setItem('cart', JSON.stringify(cart));
    closeModal();
    alert('Produto adicionado ao carrinho!');
  }

  function calculateTotalPrice(product, selectedExtras) {
    let total = product.price;
    selectedExtras.forEach(extraName => {
      const extra = product.extras.find(e => e.name === extraName);
      if (extra) {
        total += extra.price;
      }
    });
    return total;
  }

  function openCart() {
    const modal = document.getElementById('cartModal');
    const cartContent = document.getElementById('cartContent');
    const cartTotal = document.getElementById('cartTotal');

    cartContent.innerHTML = cart.map(item => `
      <div class="cart-item">
        <div class="cart-item-info">
          <h3>${item.name}</h3>
          <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
          <p>Extras: ${item.extras.join(', ')}</p>
          <p>Pre√ßo: R$ ${item.totalPrice.toFixed(2)}</p>
        </div>
        <span class="cart-item-remove" onclick="removeFromCart(${item.id})">üóëÔ∏è</span>
      </div>
    `).join('');

    const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;

    modal.style.display = "block";
  }

  function continueShopping() {
    document.getElementById('cartModal').style.display = "none";
  }

  function removeFromCart(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    localStorage.setItem('cart', JSON.stringify(cart));
    openCart(); // Atualiza a exibi√ß√£o do carrinho
  }

  function checkout() {
    if (cart.length === 0) {
      alert('Seu carrinho est√° vazio. Adicione itens antes de finalizar o pedido.');
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;

    modal.style.display = "block";
  }

  function openCheckout() {
    const checkoutModal = document.getElementById('checkoutModal');
    const orderSummary = document.getElementById('orderSummary');

    // Exibir resumo do pedido
    let summaryHTML = '<h3>Resumo do Pedido:</h3>';
    let total = 0;

    cart.forEach(item => {
      summaryHTML += `
        <p>${item.name} - R$ ${item.totalPrice.toFixed(2)}</p>
        <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
        <p>Extras: ${item.extras.join(', ')}</p>
        <hr>
      `;
      total += item.totalPrice;
    });

    summaryHTML += `<h4>Subtotal: R$ ${total.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
    summaryHTML += `<h3>Total: R$ ${(total + deliveryFee).toFixed(2)}</h3>`;
    orderSummary.innerHTML = summaryHTML;

    // Exibir o modal de checkout
    checkoutModal.style.display = "block";
  }

  function handlePaymentChange() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cashInfo = document.getElementById('cashInfo');
    const pixInfo = document.getElementById('pixInfo');

    if (paymentMethod === 'cash') {
      cashInfo.style.display = 'block';
      pixInfo.style.display = 'none';
    } else if (paymentMethod === 'pix') {
      cashInfo.style.display = 'none';
      pixInfo.style.display = 'block';
    } else {
      cashInfo.style.display = 'none';
      pixInfo.style.display = 'none';
    }
  }

  function handleChangeNeeded() {
    const changeNeeded = document.getElementById('changeNeeded').value;
    const changeAmountDiv = document.getElementById('changeAmountDiv');

    if (changeNeeded === 'yes') {
      changeAmountDiv.style.display = 'block';
    } else {
      changeAmountDiv.style.display = 'none';
    }
  }

  function addNewOrder(order) {
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    orders.push(order);
    localStorage.setItem('orders', JSON.stringify(orders));

    // Trigger the storage event manually to notify the gestor page
    const event = new Event('storage');
    event.key = 'orders';
    event.newValue = JSON.stringify(orders);
    window.dispatchEvent(event);
  }

  document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const address = document.getElementById('address').value;
    const phone = document.getElementById('phone').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const changeNeeded = document.getElementById('changeNeeded') ? document.getElementById('changeNeeded').value : 'N√£o';
    const changeAmount = document.getElementById('changeAmount') ? document.getElementById('changeAmount').value : '';

    // Construir mensagem de WhatsApp
    let message = `Pedido confirmado!\nNome: ${name}\nEndere√ßo: ${address}\nTelefone: ${phone}\nM√©todo de Pagamento: ${paymentMethod}`;
    if (paymentMethod === 'cash') {
      message += `\nPrecisa de troco: ${changeNeeded}`;
      if (changeNeeded === 'yes') {
        message += `\nQuanto de troco: R$ ${parseFloat(changeAmount).toFixed(2)}`;
      }
    }

    // Adicionar itens do pedido √† mensagem
    message += `\n\nItens do Pedido:\n`;
    cart.forEach(item => {
      message += `\n${item.name} - R$ ${item.totalPrice.toFixed(2)}`;
      if (item.accompaniments.length > 0) {
        message += `\nAcompanhamentos: ${item.accompaniments.join(', ')}`;
      }
      if (item.extras.length > 0) {
        message += `\nExtras: ${item.extras.join(', ')}`;
      }
    });
    message += `\n\nSubtotal: R$ ${cart.reduce((sum, item) => sum + item.totalPrice, 0).toFixed(2)}`;
    message += `\nTaxa de Entrega: R$ ${deliveryFee.toFixed(2)}`;
    message += `\nTotal: R$ ${(cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee).toFixed(2)}`;

    // Enviar pedido para o gestor de pedidos
    const order = {
      id: Date.now(),
      name: name,
      address: address,
      phone: phone,
      paymentMethod: paymentMethod,
      changeNeeded: changeNeeded,
      changeAmount: changeAmount,
      items: cart,
      subtotal: cart.reduce((sum, item) => sum + item.totalPrice, 0),
      deliveryFee: deliveryFee,
      total: cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee,
      status: 'preparing'
    };
    addNewOrder(order);

    // Redirecionar para o WhatsApp
    window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(message)}`;

    // Limpar o carrinho e redefinir a forma de pagamento ap√≥s a confirma√ß√£o do pedido
    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));

    // Redefinir a forma de pagamento para 'Cart√£o'
    document.getElementById('paymentMethod').value = 'card';
    handlePaymentChange();

    // Fechar o modal de checkout
    document.getElementById('checkoutModal').style.display = "none";
  });

  // Adicionando a fun√ß√£o de fechar para o modal de checkout
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      this.closest('.modal').style.display = "none";
    }
  });

  function closeModal() {
    document.getElementById('productModal').style.display = "none";
    document.getElementById('cartModal').style.display = "none";
  }

  // Fecha o modal quando o usu√°rio clica fora dele
  window.onclick = function(event) {
    if (event.target == document.getElementById('productModal') ||
        event.target == document.getElementById('cartModal')) {
      closeModal();
    }
  }

  // Fecha o modal quando o usu√°rio clica no bot√£o de fechar
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      closeModal();
    }
  })

  // Inicializa a exibi√ß√£o de categorias e produtos
  displayCategories();
  displayProducts();

  // Carregar dados do localStorage para garantir persist√™ncia
  window.addEventListener('load', () => {
    displayCategories();
    displayProducts();
  });
</script>
</body>
</html>
