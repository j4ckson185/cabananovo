<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cabana A√ßa√≠</title>
<style>
/* Seus estilos aqui */
</style>
</head>
<body>
<header>
  <div class="header-content">
    <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana A√ßa√≠ Logo" class="logo">
    <h1>Cabana A√ßa√≠</h1>
  </div>
  <div class="cart-icon" onclick="openCart()">üõí</div>
</header>
<main>
  <div class="categories" id="categories"></div>
  <div class="product-grid" id="productGrid"></div>
</main>

<div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalContent"></div>
  </div>
</div>

<div id="cartModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Seu Carrinho</h2>
    <div id="cartContent"></div>
    <div id="cartTotal"></div>
    <button class="btn" onclick="openCheckout()">Finalizar Pedido</button>
    <button class="btn" onclick="continueShopping()">Continuar Comprando</button>
  </div>
</div>

<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Finalizar Pedido</h2>
    <form id="checkoutForm">
      <label for="name">Nome:</label>
      <input type="text" id="name" required>

      <label for="address">Endere√ßo:</label>
      <textarea id="address" required></textarea>

      <label for="phone">Telefone:</label>
      <input type="tel" id="phone" required>

      <label for="paymentMethod">M√©todo de Pagamento:</label>
      <select id="paymentMethod" required onchange="handlePaymentChange()">
        <option value="card" selected>Cart√£o</option>
        <option value="cash">Dinheiro</option>
        <option value="pix">PIX</option>
      </select>

      <div id="cashInfo" style="display:none; margin-top: 10px;">
        <label for="changeNeeded">Precisa de troco?</label>
        <select id="changeNeeded" onchange="handleChangeNeeded()">
          <option value="no" selected>N√£o</option>
          <option value="yes">Sim</option>
        </select>
        <div id="changeAmountDiv" style="display:none; margin-top: 10px;">
          <label for="changeAmount">Quanto de troco?</label>
          <input type="number" id="changeAmount" min="0" step="0.01">
        </div>
      </div>

      <div id="pixInfo" style="display:none; margin-top: 10px;">
        <p>Chave PIX: 84 9 8873-1028</p>
        <p>Ap√≥s o envio do PIX, favor enviar o comprovante para o WhatsApp 84 9 8873-1028</p>
      </div>

      <button type="submit" class="btn">Confirmar Pedido</button>
    </form>
    <div id="orderSummary"></div>
  </div>
</div>

<!-- Adicione o Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
  // Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
    authDomain: "cabana-8d55e.firebaseapp.com",
    databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
    projectId: "cabana-8d55e",
    storageBucket: "cabana-8d55e.appspot.com",
    messagingSenderId: "706144237954",
    appId: "1:706144237954:web:345c10370972486afc779b",
    measurementId: "G-96Y337GYT8"
  };

  // Inicialize o Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let products = [];
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const deliveryFee = 3.00;

  async function fetchProducts() {
    const snapshot = await db.collection('products').get();
    products = snapshot.docs.map(doc => doc.data());
    displayProducts(products);
  }

  async function fetchCategories() {
    const snapshot = await db.collection('categories').get();
    const categories = snapshot.docs.map(doc => doc.data().name);
    const categoriesContainer = document.getElementById('categories');
    categoriesContainer.innerHTML = categories.map(category => `
      <button class="category-btn" onclick="filterByCategory('${category}')">${category}</button>
    `).join('');
    categoriesContainer.innerHTML = `<button class="category-btn" onclick="filterByCategory('all')">Todos</button>` + categoriesContainer.innerHTML;
  }

  function filterByCategory(category) {
    const filteredProducts = category === 'all' ? products : products.filter(product => product.category === category);
    displayProducts(filteredProducts);
  }

  function displayProducts(productsToDisplay = products) {
    const productGrid = document.getElementById('productGrid');
    productGrid.innerHTML = productsToDisplay.map(product => `
      <div class="product-card" onclick="openProductDetails(${product.id})">
        <img src="${product.image}" alt="${product.name}" class="product-image">
        <div class="product-info">
          <h3 class="product-title">${product.name}</h3>
          <p class="product-price">R$ ${parseFloat(product.price).toFixed(2)}</p>
          <p class="product-description">${product.description.substring(0, 100)}...</p>
          <button class="btn" onclick="openProductDetails(${product.id}, event)">Ver Detalhes</button>
        </div>
      </div>
    `).join('');
  }

  function openProductDetails(productId, event) {
    if (event) {
      event.stopPropagation();
    }
    const product = products.find(p => p.id === productId);
    const modal = document.getElementById('productModal');
    const modalContent = document.getElementById('modalContent');

    modalContent.innerHTML = `
      <h2>${product.name}</h2>
      <img src="${product.image}" alt="${product.name}" style="width:100%; max-height:300px; object-fit:cover;">
      <p>${product.description}</p>
      <p class="product-price">Pre√ßo: R$ ${parseFloat(product.price).toFixed(2)}</p>
      <div class="extras-list">
        <h3>Acompanhamentos (escolha de ${product.minAccompaniments} a ${product.maxAccompaniments}):</h3>
        <div class="checkbox-list" id="accompaniments">
          ${product.accompaniments.map((item, index) => `
            <div class="checkbox-item">
              <input type="checkbox" id="acc${index}" name="accompaniment" value="${item}">
              <label for="acc${index}">${item}</label>
            </div>
          `).join('')}
        </div>
        <p id="accompanimentError" class="error-message"></p>
      </div>
      <div class="extras-list">
        <h3>Itens Extras:</h3>
        <div class="checkbox-list" id="extras">
          ${product.extras.map((item, index) => `
            <div class="checkbox-item">
              <input type="checkbox" id="extra${index}" name="extra" value="${item.name}">
              <label for="extra${index}">${item.name} - R$ ${parseFloat(item.price).toFixed(2)}</label>
            </div>
          `).join('')}
        </div>
      </div>
      <button id="addToCartBtn" class="btn" onclick="addToCart(${product.id})">Adicionar ao Carrinho</button>
    `;

    modal.style.display = "block";

    // Adicionar valida√ß√£o para acompanhamentos
    const accCheckboxes = document.querySelectorAll('#accompaniments input[type="checkbox"]');
    accCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => validateAccompaniments(product));
    });
  }

  function validateAccompaniments(product) {
    const checkedAccompaniments = document.querySelectorAll('#accompaniments input[type="checkbox"]:checked');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const errorMessage = document.getElementById('accompanimentError');

    if (checkedAccompaniments.length < product.minAccompaniments || checkedAccompaniments.length > product.maxAccompaniments) {
      addToCartBtn.disabled = true;
      errorMessage.textContent = `Selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos`;
    } else {
      addToCartBtn.disabled = false;
      errorMessage.textContent = '';
    }
  }

  function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    const accompaniments = Array.from(document.querySelectorAll('#accompaniments input[type="checkbox"]:checked')).map(cb => cb.value);
    const extras = Array.from(document.querySelectorAll('#extras input[type="checkbox"]:checked')).map(cb => cb.value);

    if (accompaniments.length < product.minAccompaniments || accompaniments.length > product.maxAccompaniments) {
      alert(`Por favor, selecione de ${product.minAccompaniments} a ${product.maxAccompaniments} acompanhamentos.`);
      return;
    }

    const cartItem = {
      id: Date.now(),
      productId: product.id,
      name: product.name,
      price: product.price,
      accompaniments: accompaniments,
      extras: extras,
      totalPrice: calculateTotalPrice(product, extras)
    };

    cart.push(cartItem);
    localStorage.setItem('cart', JSON.stringify(cart));
    openCart(); // Abre o carrinho ap√≥s adicionar o produto
  }

  function calculateTotalPrice(product, selectedExtras) {
    let total = product.price;
    selectedExtras.forEach(extraName => {
      const extra = product.extras.find(e => e.name === extraName);
      if (extra) {
        total += extra.price;
      }
    });
    return total;
  }

  function openCart() {
    const modal = document.getElementById('cartModal');
    const cartContent = document.getElementById('cartContent');
    const cartTotal = document.getElementById('cartTotal');

    cartContent.innerHTML = cart.map(item => `
      <div class="cart-item">
        <div class="cart-item-info">
          <h3>${item.name}</h3>
          <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
          <p>Extras: ${item.extras.join(', ')}</p>
          <p>Pre√ßo: R$ ${item.totalPrice.toFixed(2)}</p>
        </div>
        <span class="cart-item-remove" onclick="removeFromCart(${item.id})">üóëÔ∏è</span>
      </div>
    `).join('');

    const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;

    modal.style.display = "block";
  }

  function continueShopping() {
    document.getElementById('cartModal').style.display = "none";
  }

  function removeFromCart(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    localStorage.setItem('cart', JSON.stringify(cart));
    openCart(); // Atualiza a exibi√ß√£o do carrinho
  }

  function checkout() {
    if (cart.length === 0) {
      alert('Seu carrinho est√° vazio. Adicione itens antes de finalizar o pedido.');
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;

    modal.style.display = "block";
  }

  function openCheckout() {
    const checkoutModal = document.getElementById('checkoutModal');
    const orderSummary = document.getElementById('orderSummary');

    // Exibir resumo do pedido
    let summaryHTML = '<h3>Resumo do Pedido:</h3>';
    let total = 0;

    cart.forEach(item => {
      summaryHTML += `
        <p>${item.name} - R$ ${item.totalPrice.toFixed(2)}</p>
        <p>Acompanhamentos: ${item.accompaniments.join(', ')}</p>
        <p>Extras: ${item.extras.join(', ')}</p>
        <hr>
      `;
      total += item.totalPrice;
    });

    summaryHTML += `<h4>Subtotal: R$ ${total.toFixed(2)}</h4>`;
    summaryHTML += `<h4>Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}</h4>`;
    summaryHTML += `<h3>Total: R$ ${(total + deliveryFee).toFixed(2)}</h3>`;
    orderSummary.innerHTML = summaryHTML;

    // Exibir o modal de checkout
    checkoutModal.style.display = "block";
  }

  function handlePaymentChange() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cashInfo = document.getElementById('cashInfo');
    const pixInfo = document.getElementById('pixInfo');

    if (paymentMethod === 'cash') {
      cashInfo.style.display = 'block';
      pixInfo.style.display = 'none';
    } else if (paymentMethod === 'pix') {
      cashInfo.style.display = 'none';
      pixInfo.style.display = 'block';
    } else {
      cashInfo.style.display = 'none';
      pixInfo.style.display = 'none';
    }
  }

  function handleChangeNeeded() {
    const changeNeeded = document.getElementById('changeNeeded').value;
    const changeAmountDiv = document.getElementById('changeAmountDiv');

    if (changeNeeded === 'yes') {
      changeAmountDiv.style.display = 'block';
    } else {
      changeAmountDiv.style.display = 'none';
    }
  }

  function addNewOrder(order) {
    db.collection('orders').add(order).then((docRef) => {
      console.log("Order added with ID: ", docRef.id);
    }).catch((error) => {
      console.error("Error adding order: ", error);
    });
  }

  document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const address = document.getElementById('address').value;
    const phone = document.getElementById('phone').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const changeNeeded = document.getElementById('changeNeeded') ? document.getElementById('changeNeeded').value : 'N√£o';
    const changeAmount = document.getElementById('changeAmount') ? document.getElementById('changeAmount').value : '';

    // Construir mensagem de WhatsApp
    let message = `Pedido confirmado!\nNome: ${name}\nEndere√ßo: ${address}\nTelefone: ${phone}\nM√©todo de Pagamento: ${paymentMethod}`;
    if (paymentMethod === 'cash') {
      message += `\nPrecisa de troco: ${changeNeeded}`;
      if (changeNeeded === 'yes') {
        message += `\nQuanto de troco: R$ ${parseFloat(changeAmount).toFixed(2)}`;
      }
    }

    // Adicionar itens do pedido √† mensagem
    message += `\n\nItens do Pedido:\n`;
    cart.forEach(item => {
      message += `\n${item.name} - R$ ${item.totalPrice.toFixed(2)}`;
      if (item.accompaniments.length > 0) {
        message += `\nAcompanhamentos: ${item.accompaniments.join(', ')}`;
      }
      if (item.extras.length > 0) {
        message += `\nExtras: ${item.extras.join(', ')}`;
      }
    });
    message += `\n\nSubtotal: R$ ${cart.reduce((sum, item) => sum + item.totalPrice, 0).toFixed(2)}`;
    message += `\nTaxa de Entrega: R$ ${deliveryFee.toFixed(2)}`;
    message += `\nTotal: R$ ${(cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee).toFixed(2)}`;

    // Enviar pedido para o gestor de pedidos
    const order = {
      id: Date.now(),
      name: name,
      address: address,
      phone: phone,
      paymentMethod: paymentMethod,
      changeNeeded: changeNeeded,
      changeAmount: changeAmount,
      items: cart,
      subtotal: cart.reduce((sum, item) => sum + item.totalPrice, 0),
      deliveryFee: deliveryFee,
      total: cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee,
      status: 'preparing'
    };
    addNewOrder(order);

    // Redirecionar para o WhatsApp
    window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(message)}`;

    // Limpar o carrinho e redefinir a forma de pagamento ap√≥s a confirma√ß√£o do pedido
    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));

    // Redefinir a forma de pagamento para 'Cart√£o'
    document.getElementById('paymentMethod').value = 'card';
    handlePaymentChange();

    // Fechar o modal de checkout
    document.getElementById('checkoutModal').style.display = "none";
  });

  // Adicionando a fun√ß√£o de fechar para o modal de checkout
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      this.closest('.modal').style.display = "none";
    }
  });

  function closeModal() {
    document.getElementById('productModal').style.display = "none";
    document.getElementById('cartModal').style.display = "none";
  }

  // Fecha o modal quando o usu√°rio clica fora dele
  window.onclick = function(event) {
    if (event.target == document.getElementById('productModal') ||
        event.target == document.getElementById('cartModal')) {
      closeModal();
    }
  }

  // Fecha o modal quando o usu√°rio clica no bot√£o de fechar
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      closeModal();
    }
  });

  // Inicializa a exibi√ß√£o de categorias e produtos
  fetchCategories();
  fetchProducts();
</script>
</body>
</html>
