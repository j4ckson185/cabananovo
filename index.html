<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabana Açaí - Menu Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');

:root {
   --primary: #7209B7;
   --secondary: #3A0CA3;
   --accent: #F72585;
   --background: #10002B;
   --surface: #240046;
   --text: #E0AAFF;
   --gradient: linear-gradient(135deg, #F72585 0%, #7209B7 50%, #3A0CA3 100%);
   --glass: rgba(255, 255, 255, 0.1);
   --glass-border: rgba(255, 255, 255, 0.2);
   --error: #FF5252;
}

* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
   font-family: 'Montserrat', sans-serif;
}

body {
   background-color: var(--background);
   color: var(--text);
   min-height: 100vh;
   overflow-x: hidden;
}

.background-animation {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   z-index: -1;
   background: 
       radial-gradient(circle at 0% 0%, rgba(247, 37, 133, 0.15) 0%, transparent 50%),
       radial-gradient(circle at 100% 0%, rgba(114, 9, 183, 0.15) 0%, transparent 50%),
       radial-gradient(circle at 50% 100%, rgba(58, 12, 163, 0.15) 0%, transparent 50%);
   animation: backgroundFlow 15s ease infinite alternate;
}

@keyframes backgroundFlow {
   0% { transform: scale(1) rotate(0deg); }
   100% { transform: scale(1.1) rotate(5deg); }
}

header {
   position: fixed;
   top: 0;
   width: 100%;
   background: rgba(16, 0, 43, 0.8);
   backdrop-filter: blur(10px);
   padding: 1rem 2rem;
   z-index: 1000;
   border-bottom: 1px solid var(--glass-border);
}

.header-content {
   max-width: 1400px;
   margin: 0 auto;
   display: flex;
   justify-content: space-between;
   align-items: center;
}

.logo-container {
   display: flex;
   align-items: center;
   gap: 1.5rem;
}

.logo {
   width: 60px;
   height: 60px;
   border-radius: 50%;
   overflow: hidden;
   border: 2px solid var(--accent);
   animation: logoPulse 2s infinite ease-in-out;
}

@keyframes logoPulse {
   0%, 100% { transform: scale(1); }
   50% { transform: scale(1.05); }
}

.logo img {
   width: 100%;
   height: 100%;
   object-fit: cover;
}

.store-name {
   font-size: 2.5rem;
   font-weight: 700;
   background: var(--gradient);
   -webkit-background-clip: text;
   -webkit-text-fill-color: transparent;
   text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.cart-icon {
   position: relative;
   font-size: 2rem;
   color: var(--text);
   cursor: pointer;
   transition: all 0.3s ease;
}

.cart-icon:hover {
   transform: scale(1.1);
   color: var(--accent);
}

.cart-count {
   position: absolute;
   top: -10px;
   right: -10px;
   background: var(--accent);
   color: white;
   width: 25px;
   height: 25px;
   border-radius: 50%;
   display: flex;
   align-items: center;
   justify-content: center;
   font-size: 0.9rem;
   font-weight: 600;
   border: 2px solid var(--glass-border);
   animation: cartBounce 1s infinite;
}

@keyframes cartBounce {
   0%, 100% { transform: scale(1); }
   50% { transform: scale(1.1); }
}

.categories {
   margin-top: 100px;
   padding: 1.5rem;
   display: flex;
   gap: 1rem;
   overflow-x: auto;
   scrollbar-width: none;
   background: rgba(36, 0, 70, 0.5);
   backdrop-filter: blur(10px);
}

.categories::-webkit-scrollbar {
   display: none;
}

.category-btn {
   background: var(--glass);
   border: 1px solid var(--glass-border);
   color: var(--text);
   padding: 1rem 2rem;
   border-radius: 50px;
   cursor: pointer;
   transition: all 0.3s ease;
   font-weight: 500;
   display: flex;
   align-items: center;
   gap: 0.8rem;
   min-width: max-content;
}

.category-btn i {
   font-size: 1.2rem;
}

.category-btn:hover,
.category-btn.active {
   background: var(--gradient);
   transform: translateY(-3px);
   box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
   color: white;
}

.search-container {
   padding: 2rem;
   max-width: 800px;
   margin: 0 auto;
}

.search-bar {
   position: relative;
   width: 100%;
}

.search-input {
   width: 100%;
   padding: 1.2rem 3.5rem;
   background: var(--glass);
   border: 1px solid var(--glass-border);
   border-radius: 50px;
   color: var(--text);
   font-size: 1.1rem;
   transition: all 0.3s ease;
}

.search-input:focus {
   outline: none;
   border-color: var(--accent);
   box-shadow: 0 0 20px rgba(247, 37, 133, 0.2);
}

.search-icon {
   position: absolute;
   left: 1.2rem;
   top: 50%;
   transform: translateY(-50%);
   color: var(--text);
   font-size: 1.3rem;
}

.products-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
   gap: 2rem;
   padding: 2rem;
   max-width: 1400px;
   margin: 0 auto;
}

.product-card {
   display: flex;
   height: auto;
   min-height: 120px;
   padding: 1rem;
   gap: 1rem;
   align-items: center;
   background: rgba(36, 0, 70, 0.7);
   border: 1px solid var(--glass-border);
   border-radius: 20px;
   transition: all 0.3s ease;
   cursor: pointer;
   position: relative;
}

.product-card::before {
   content: '';
   position: absolute;
   inset: 0;
   background: var(--gradient);
   opacity: 0;
   transition: opacity 0.3s ease;
   border-radius: 20px;
}

.product-card:hover {
   transform: translateY(-5px);
   box-shadow: 0 10px 30px rgba(114, 9, 183, 0.3);
}

.product-card:hover::before {
   opacity: 0.1;
}

.product-image {
   width: 120px;
   height: 120px;
   object-fit: cover;
   border-radius: 10px;
   order: 2;
   flex-shrink: 0;
}

.product-info {
   flex: 1;
   order: 1;
   padding: 0.5rem;
   display: flex;
   flex-direction: column;
   justify-content: space-between;
}

.product-category {
   color: var(--accent);
   font-size: 0.9rem;
   text-transform: uppercase;
   letter-spacing: 1px;
   margin-bottom: 0.5rem;
}

.product-title {
   font-size: 1.4rem;
   font-weight: 600;
   color: white;
   margin-bottom: 1rem;
}

.product-description {
   color: var(--text);
   margin-bottom: 1rem;
   line-height: 1.6;
}

.product-footer {
   display: flex;
   justify-content: space-between;
   align-items: center;
}

.product-price {
   font-size: 1.3rem;
   font-weight: 700;
   color: var(--accent);
}

.add-to-cart-btn {
   background: var(--gradient);
   border: none;
   width: 45px;
   height: 45px;
   border-radius: 50%;
   display: flex;
   align-items: center;
   justify-content: center;
   cursor: pointer;
   transition: all 0.3s ease;
}

.add-to-cart-btn:hover {
   transform: scale(1.1) rotate(90deg);
   box-shadow: 0 0 20px rgba(247, 37, 133, 0.4);
}

.add-to-cart-btn i {
   color: white;
   font-size: 1.2rem;
}

.modal {
   display: none;
   position: fixed;
   inset: 0;
   background: rgba(16, 0, 43, 0.95);
   backdrop-filter: blur(10px);
   z-index: 1000;
   overflow-y: auto;
}

.modal-content {
   background: var(--surface);
   border: 1px solid var(--glass-border);
   border-radius: 20px;
   width: 90%;
   max-width: 600px;
   max-height: 90vh;
   margin: 20px auto;
   padding: 1.5rem;
   position: relative;
   overflow-y: auto;
   animation: modalSlide 0.3s ease;
}

@keyframes modalSlide {
   from {
       opacity: 0;
       transform: translateY(-20px);
   }
   to {
       opacity: 1;
       transform: translateY(0);
   }
}

.modal-header {
   position: relative;
   margin-bottom: 1rem;
}

.close-modal {
   position: absolute;
   right: 0;
   top: 0;
   background: none;
   border: none;
   color: var(--text);
   font-size: 2rem;
   cursor: pointer;
   transition: all 0.3s ease;
}

.close-modal:hover {
   color: var(--accent);
   transform: rotate(90deg);
}

.modal-product-image {
   width: 150px;
   height: 150px;
   object-fit: cover;
   border-radius: 10px;
   float: right;
   margin: 0 0 1rem 1rem;
}

.modal-product-info {
   overflow: hidden;
   margin-bottom: 1.5rem;
}

.modal-product-title {
   font-size: 1.5rem;
   font-weight: 600;
   color: white;
   margin-bottom: 0.5rem;
}

.modal-product-description {
   color: var(--text);
   line-height: 1.8;
   margin-bottom: 1rem;
}

.modal-product-price {
   font-size: 1.8rem;
   font-weight: 700;
   color: var(--accent);
}

.toppings-section {
   background: rgba(255, 255, 255, 0.05);
   border-radius: 20px;
   padding: 1.5rem;
   margin: 1.5rem 0;
   clear: both;
}

.toppings-title {
   font-size: 1.2rem;
   font-weight: 600;
   color: white;
   margin-bottom: 1rem;
}

.toppings-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
   gap: 1rem;
}

.topping-item {
   background: var(--glass);
   border: 1px solid var(--glass-border);
   border-radius: 15px;
   padding: 1rem;
   cursor: pointer;
   transition: all 0.3s ease;
   text-align: center;
}

.topping-item:hover {
   background: var(--gradient);
   transform: translateY(-3px);
}

.topping-item.selected {
   background: var(--gradient);
   box-shadow: 0 0 15px rgba(247, 37, 133, 0.3);
}

        .extra-item {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.extra-item:hover {
    background: var(--gradient);
    transform: translateY(-3px);
}

.extra-item.selected {
    background: var(--gradient);
    box-shadow: 0 0 15px rgba(247, 37, 133, 0.3);
}

.modal-buttons {
   display: flex;
   gap: 1rem;
   margin-top: 1.5rem;
}

.modal-btn {
   flex: 1;
   padding: 1rem;
   border: none;
   border-radius: 50px;
   font-size: 1.1rem;
   font-weight: 600;
   cursor: pointer;
   transition: all 0.3s ease;
}

.add-to-cart {
   background: var(--gradient);
   color: white;
}

.add-to-cart:hover {
   transform: translateY(-3px);
   box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
}

.continue-shopping {
   background: var(--glass);
   color: var(--text);
   border: 1px solid var(--glass-border);
}

.continue-shopping:hover {
   background: rgba(255, 255, 255, 0.2);
}

.alert {
   position: fixed;
   top: 20px;
   left: 50%;
   transform: translateX(-50%);
   background: var(--accent);
   color: white;
   padding: 1rem 2rem;
   border-radius: 50px;
   z-index: 2000;
   animation: alertIn 0.3s ease;
}

@keyframes alertIn {
   from { opacity: 0; transform: translate(-50%, -20px); }
   to { opacity: 1; transform: translate(-50%, 0); }
}

.cart-items {
   padding: 1rem;
   max-height: 60vh;
   overflow-y: auto;
}

.cart-item {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 1rem;
   background: var(--glass);
   border-radius: 10px;
   margin-bottom: 1rem;
}

.cart-item-details {
   flex: 1;
   padding-right: 1rem;
}

.cart-item-title {
   font-weight: 600;
   margin-bottom: 0.5rem;
}

.cart-item-title {
   font-weight: 600;
   margin-bottom: 0.5rem;
}

.cart-item-toppings {
   color: var(--text);
   font-size: 0.9rem;
}

.cart-item-price {
   font-weight: 600;
   color: var(--accent);
}

.cart-total {
   padding: 1rem;
   border-top: 1px solid var(--glass-border);
}

.delivery-fee {
   display: flex;
   align-items: center;
   gap: 0.5rem;
   margin: 1rem 0;
}

.delivery-fee i {
   color: var(--accent);
}

.subtotal, .total {
   display: flex;
   justify-content: space-between;
   font-weight: 600;
}

.total {
   color: var(--accent);
   font-size: 1.2rem;
   margin-top: 1rem;
}

.remove-item {
   background: none;
   border: none;
   color: var(--error);
   padding: 0.5rem;
   cursor: pointer;
   transition: transform 0.3s ease;
}

.remove-item:hover {
   transform: scale(1.1);
}

@media (max-width: 768px) {
   .store-name {
       font-size: 1.8rem;
   }

   .logo {
       width: 50px;
       height: 50px;
   }

   .category-btn {
       padding: 0.8rem 1.5rem;
       font-size: 0.9rem;
   }

   .products-grid {
       grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
       padding: 1rem;
   }

   .product-image {
       width: 100px;
       height: 100px;
   }

   .modal-product-image {
       width: 100px;
       height: 100px;
   }

   .modal-buttons {
       flex-direction: column;
   }
}

@media (max-width: 480px) {
   .store-name {
       font-size: 1.4rem;
   }

   .search-input {
       padding: 1rem 3rem;
       font-size: 1rem;
   }

   .product-card {
       margin: 0 1rem;
   }

   .modal-content {
       padding: 1rem;
   }

   .modal-product-image {
       float: none;
       display: block;
       margin: 0 auto 1rem;
   }

   .cart-item {
       flex-direction: column;
       text-align: center;
       gap: 1rem;
   }

.cart-item-details {
   padding-right: 0;
}

/* Form Styles */
.form-container {
   margin: 1rem 0;
}

.form-group {
   margin-bottom: 1.5rem;
}

.form-group label {
   display: block;
   margin-bottom: 0.5rem;
   color: var(--text);
}

.form-group input,
.form-group select {
   width: 100%;
   padding: 1rem;
   background: var(--glass);
   border: 1px solid var(--glass-border);
   border-radius: 10px;
   color: white;
   font-size: 1rem;
}

.form-group input:focus,
.form-group select:focus {
   outline: none;
   border-color: var(--accent);
}

.payment-options {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
   gap: 1rem;
   margin: 1rem 0;
}

.payment-option {
   display: flex;
   align-items: center;
   gap: 0.5rem;
   padding: 1rem;
   background: var(--glass);
   border: 1px solid var(--glass-border);
   border-radius: 10px;
   cursor: pointer;
   transition: all 0.3s ease;
}

.payment-option:hover,
.payment-option.selected {
   background: var(--gradient);
}

.payment-option i {
   font-size: 1.5rem;
}

#changeContainer,
#pixInfo {
   background: var(--glass);
   padding: 1rem;
   border-radius: 10px;
   margin-top: 1rem;
}

#pixInfo {
   color: var(--text);
   line-height: 1.6;
}

.order-summary {
   background: var(--glass);
   padding: 1rem;
   border-radius: 10px;
   margin: 1rem 0;
}

.order-summary h3 {
   color: white;
   margin-bottom: 1rem;
}

.summary-item {
   display: flex;
   justify-content: space-between;
   margin-bottom: 0.5rem;
}

.summary-total {
   border-top: 1px solid var(--glass-border);
   padding-top: 1rem;
   margin-top: 1rem;
   font-weight: 600;
   color: var(--accent);
}

.validation-error {
   color: var(--error);
   font-size: 0.9rem;
   margin-top: 0.5rem;
}

.notification {
   position: fixed;
   bottom: 20px;
   right: 20px;
   background: var(--gradient);
   color: white;
   padding: 1rem 2rem;
   border-radius: 10px;
   animation: notificationSlide 0.3s ease;
   z-index: 2000;
}

@keyframes notificationSlide {
   from {
       transform: translateX(100%);
       opacity: 0;
   }
   to {
       transform: translateX(0);
       opacity: 1;
   }
}

.spinner {
   display: inline-block;
   width: 20px;
   height: 20px;
   border: 2px solid rgba(255,255,255,0.3);
   border-radius: 50%;
   border-top-color: white;
   animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
   to { transform: rotate(360deg); }
}

.disabled {
   opacity: 0.5;
   cursor: not-allowed;
}

.error-shake {
   animation: shake 0.5s ease;
}

@keyframes shake {
   0%, 100% { transform: translateX(0); }
   10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
   20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Final Media Query Adjustments */
@media (max-height: 700px) {
   .modal-content {
       max-height: 85vh;
   }
   
   .cart-items {
       max-height: 40vh;
   }
}

@media (max-width: 360px) {
   .cart-buttons {
       flex-direction: column;
       gap: 0.8rem;
   }

   .form-group input,
   .form-group select {
       padding: 0.8rem;
       font-size: 0.9rem;
   }

    /* Adicione antes do último } da tag <style> */
.store-status {
    max-width: 1400px;
    margin: 100px auto 0;
    animation: fadeIn 0.3s ease;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.categories {
    margin-top: 1rem;
}

@media (max-width: 768px) {
    .store-status {
        margin: 80px 1rem 0;
        font-size: 1rem;
        padding: 0.6rem;
    }
}

@media (max-width: 480px) {
    .store-status {
        margin: 70px 0.5rem 0;
        font-size: 0.9rem;
        padding: 0.5rem;
    }
}

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
}

/* Combo Builder Styles */
.combo-step {
    padding: 1.5rem 0;
}

.step-title {
    font-size: 1.3rem;
    color: white;
    margin-bottom: 1.5rem;
    text-align: center;
}

.size-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.size-option {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.size-option:hover {
    background: var(--gradient);
    transform: translateY(-3px);
}

.size-option.selected {
    background: var(--gradient);
    box-shadow: 0 0 15px rgba(247, 37, 133, 0.3);
}

.size-option h4 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
}

.size-option .price {
    color: var(--accent);
    font-weight: bold;
}

.flavor-section {
    display: grid;
    gap: 1.5rem;
}

.flavor-option h4 {
    margin-bottom: 0.5rem;
    color: white;
}

.combo-progress {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
    padding: 0 1rem;
}

.progress-step {
    width: 22%;
    height: 4px;
    background: var(--glass);
    border-radius: 2px;
    transition: all 0.3s ease;
}

.progress-step.active {
    background: var(--gradient);
}

.combo-summary {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.combo-summary h4 {
    color: white;
    margin-bottom: 1rem;
}

.summary-content {
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.6;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .size-options {
        grid-template-columns: 1fr;
    }
    
    .flavor-section {
        grid-template-columns: 1fr;
    }
}

    /* Estilos para o modal de criação de pedido */
#createOrderModal .modal-content {
    max-width: 500px;
    width: 90%;
    padding: 2rem;
    background: var(--surface);
    border-radius: 15px;
}

#createOrderModal h2 {
    color: white;
    margin-bottom: 1.5rem;
    text-align: center;
    font-size: 1.5rem;
}

#createOrderForm {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

#createOrderForm label {
    color: var(--text);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

#createOrderForm input[type="text"],
#createOrderForm input[type="number"],
#createOrderForm select,
#createOrderForm textarea {
    width: 100%;
    padding: 0.75rem;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: white;
    font-size: 1rem;
}

#createOrderForm textarea {
    min-height: 100px;
    resize: vertical;
}

/* Grupo de método de pagamento */
#createOrderForm .payment-group {
    background: var(--glass);
    padding: 1rem;
    border-radius: 8px;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

#createOrderForm .payment-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#createOrderForm .payment-option input[type="radio"] {
    accent-color: var(--accent);
}

#createOrderForm .payment-option label {
    margin: 0;
    color: white;
}

/* Botão de submit */
#createOrderForm button {
    background: var(--gradient);
    color: white;
    padding: 1rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
    margin-top: 1rem;
}

#createOrderForm button:hover {
    transform: translateY(-2px);
}

/* Responsividade */
@media (max-width: 480px) {
    #createOrderModal .modal-content {
        padding: 1.5rem;
    }

    #createOrderForm .payment-group {
        flex-direction: column;
        gap: 0.5rem;
    }
}

/* Botão de fechar */
#createOrderModal .close {
    position: absolute;
    right: 1rem;
    top: 1rem;
    color: var(--text);
    font-size: 1.5rem;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0.5rem;
}

#createOrderModal .close:hover {
    color: var(--accent);
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.video-container {
    width: 150px;
    height: 150px;
    margin: 1rem auto;
    border-radius: 10px;
    overflow: hidden;
    background: var(--surface);
    display: flex;
    flex-direction: column;
    align-items: center;
}

.product-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
}

@media (max-width: 480px) {
    .video-container {
        width: 120px;
        height: 120px;
    }
}

#createOrderModal .video-container {
    width: 250px;
    height: 250px;
    margin: 2rem auto;
    border-radius: 10px;
    overflow: hidden;
    background: var(--surface);
}

#createOrderModal .product-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 10px;
}

@media (max-width: 480px) {
    #createOrderModal .video-container {
        width: 200px;
        height: 200px;
    }
    .mascot-video-section {
    max-width: 1400px;
    margin: 0 auto 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 1rem;
    position: relative;
}

.mascot-dialog {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1.2rem;
    margin-top: 1rem;
    max-width: 800px;
    width: 100%;
    text-align: center;
    position: relative;
    backdrop-filter: blur(10px);
}

.mascot-dialog::before {
    content: '';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 10px solid var(--glass-border);
}

.mascot-dialog::after {
    content: '';
    position: absolute;
    top: -9px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-bottom: 9px solid var(--surface);
}

.mascot-video {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--accent);
}

@media (max-width: 768px) {
    .mascot-video {
        width: 150px;
        height: 150px;
    }
    
    .mascot-dialog {
        font-size: 0.9rem;
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .mascot-video {
        width: 120px;
        height: 120px;
    }
}

/* Adicionar antes do último } da tag <style> */
/* Adicionar antes do último } da tag <style> */
.time-machine-btn {
    cursor: pointer;
    margin-right: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text);
    transition: all 0.3s ease;
}

.time-machine-btn:hover {
    color: var(--accent);
    transform: scale(1.1);
}

.time-machine-btn i {
    font-size: 1.5rem;
}

.time-machine-content {
    padding: 1rem;
}

.favorites-section {
    margin-bottom: 2rem;
}

.previous-orders-section {
    margin-top: 1rem;
}

.order-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.order-date {
    color: var(--text);
    font-size: 0.9rem;
}

.order-items {
    margin: 1rem 0;
}

.order-item {
    margin-bottom: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid var(--accent);
}

.order-total {
    font-weight: 600;
    color: var(--accent);
    font-size: 1.1rem;
}

.reorder-btn {
    background: var(--gradient);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.reorder-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
}

.favorite-btn {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.favorite-btn i {
    color: var(--text);
    transition: all 0.3s ease;
}

.favorite-btn.active i {
    color: #FFD700;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text);
}

.phone-input-section {
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--glass);
    border-radius: 15px;
    text-align: center;
}

.phone-input-container {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.phone-input-container input {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text);
}

/* Estilo do popup de loja fechada */
.store-closed-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.store-closed-popup.active {
    display: flex;
}

.popup-content {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    max-width: 400px;
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.popup-content h2 {
    color: var(--accent);
    font-size: 1.8rem;
    margin-bottom: 1rem;
}

.popup-content p {
    color: var(--text);
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.popup-content ul {
    list-style: none;
    padding: 0;
    margin-bottom: 1.5rem;
}

.popup-content ul li {
    color: var(--text);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.popup-content button {
    background: var(--gradient);
    color: white;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 50px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.popup-content button:hover {
    transform: translateY(-2px);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Estilo do Assistente de Ocasiões */
.occasion-assistant {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    margin: 1rem;
    padding: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.assistant-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.assistant-header h3 {
    font-size: 1.1rem;
    color: var(--text);
    margin: 0;
}

.assistant-header button {
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.2rem;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.assistant-header button:hover {
    transform: rotate(180deg);
}

.assistant-options {
    display: none;
    margin-top: 1rem;
}

.assistant-options.active {
    display: block;
}

.option {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem;
    margin-bottom: 0.5rem;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option:hover {
    background: var(--gradient);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
}

.option i {
    font-size: 1.2rem;
    color: var(--accent);
}

.option span {
    font-size: 0.95rem;
    color: var(--text);
}

/* Estilo da notificação de recomendação */
.recommendation-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1.5rem;
    max-width: 300px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    animation: slideIn 0.5s ease;
    z-index: 10000;
}

.notification-content h3 {
    font-size: 1.1rem;
    color: var(--text);
    margin-bottom: 1rem;
}

.notification-content ul {
    list-style: none;
    padding: 0;
    margin-bottom: 1rem;
}

.notification-content ul li {
    font-size: 0.95rem;
    color: var(--text);
    margin-bottom: 0.5rem;
}

.notification-content p {
    font-size: 0.9rem;
    color: var(--text);
    margin-bottom: 1rem;
}

.notification-content button {
    background: var(--gradient);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: transform 0.2s ease;
}

.notification-content button:hover {
    transform: translateY(-2px);
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.floating-mascot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.3s ease;
}

.floating-mascot-container {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--accent);
    cursor: pointer;
    position: relative;
    background: var(--surface);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.floating-mascot-video {
    width: 100%;
    height: 140%;
    object-fit: cover;
    object-position: center 30%;
    transform: scale(1.2);
}

.floating-mascot-dialog {
    position: absolute;
    bottom: calc(100% + 15px);
    left: 0;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1rem;
    width: 250px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
}

.floating-mascot-dialog.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.floating-mascot-dialog::before {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 30px;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid var(--glass-border);
}

.floating-mascot-dialog::after {
    content: '';
    position: absolute;
    bottom: -9px;
    left: 30px;
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-top: 9px solid var(--surface);
}

.minimize-mascot {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 5px;
    transition: all 0.3s ease;
    z-index: 1;
}

.minimize-mascot:hover {
    color: var(--accent);
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .floating-mascot-container {
        width: 100px;
        height: 100px;
    }
    
    .floating-mascot-dialog {
        width: 220px;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .floating-mascot-container {
        width: 80px;
        height: 80px;
    }
    
    .floating-mascot-dialog {
        width: 200px;
        font-size: 0.85rem;
        left: -20px;
    }
}

.initial-tip {
    position: absolute;
    bottom: calc(100% + 15px);
    right: 0;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1rem;
    width: 200px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    font-size: 0.9rem;
    color: var(--text);
    animation: fadeIn 0.3s ease;
}

.initial-tip::before {
    content: '';
    position: absolute;
    bottom: -10px;
    right: 30px;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid var(--glass-border);
}

.initial-tip::after {
    content: '';
    position: absolute;
    bottom: -9px;
    right: 30px;
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-top: 9px solid var(--surface);
}

.close-tip {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: var(--text);
    font-size: 0.9rem;
    cursor: pointer;
    padding: 5px;
    transition: all 0.3s ease;
}

.close-tip:hover {
    color: var(--accent);
    transform: scale(1.1);
}

/* Adicione estes estilos na sua tag <style> existente */

.acai-do-dia {
    max-width: 1400px;
    margin: 1rem auto;
    padding: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    position: relative;
    overflow: hidden;
}

.acai-do-dia::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--gradient);
    opacity: 0.1;
    z-index: 0;
}

.acai-deal-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--accent);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    animation: pulse 2s infinite;
}

.acai-content {
    display: flex;
    gap: 2rem;
    align-items: center;
    position: relative;
    z-index: 1;
}

.acai-image {
    width: 200px;
    height: 200px;
    border-radius: 15px;
    object-fit: cover;
}

.acai-info {
    flex: 1;
}

.acai-title {
    font-size: 1.8rem;
    color: white;
    margin-bottom: 0.5rem;
}

.acai-description {
    color: var(--text);
    margin-bottom: 1rem;
    line-height: 1.6;
}

.price-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.original-price {
    color: var(--text);
    text-decoration: line-through;
    font-size: 1.2rem;
}

.deal-price {
    color: var(--accent);
    font-size: 2rem;
    font-weight: 700;
}

.stats-container {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text);
}

.countdown {
    color: var(--text);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.countdown span {
    color: var(--accent);
    font-weight: 600;
}

.add-deal-btn {
    background: var(--gradient);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-deal-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@media (max-width: 768px) {
    .acai-content {
        flex-direction: column;
        text-align: center;
    }

    .acai-image {
        width: 150px;
        height: 150px;
    }

    .stats-container {
        justify-content: center;
        flex-wrap: wrap;
    }

    .countdown {
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .acai-do-dia {
        padding: 1rem;
    }

    .acai-deal-badge {
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.9rem;
    }

    .acai-title {
        font-size: 1.5rem;
    }

    .deal-price {
        font-size: 1.6rem;
    }
}

    .chat-button {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 60px;
    height: 60px;
    background: var(--gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: all 0.3s ease;
}

.chat-button i {
    color: white;
    font-size: 24px;
}

.chat-container {
    position: fixed;
    bottom: 90px;
    left: 20px;
    width: 350px;
    height: 500px;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.chat-header {
    padding: 15px;
    background: var(--gradient);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: var(--background);
}

.chat-input-container {
    padding: 15px;
    background: var(--surface);
    border-top: 1px solid var(--glass-border);
    display: flex;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    background: var(--glass);
    color: var(--text);
}

.send-button {
    background: var(--gradient);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
}

.message {
    margin-bottom: 10px;
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 15px;
    word-wrap: break-word;
}

.user-message {
    background: var(--primary-color);
    color: white;
    margin-left: auto;
    border-radius: 15px 15px 0 15px;
}

.bot-message {
    background: var(--glass);
    color: var(--text);
    margin-right: auto;
    border-radius: 15px 15px 15px 0;
}

    const style = document.createElement('style');
style.textContent = `
    .store-closed-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(16, 0, 43, 0.95);
        backdrop-filter: blur(5px);
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
    }

    .store-closed-message {
        background: var(--surface);
        padding: 2rem;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
        border: 1px solid var(--glass-border);
    }

    .store-closed-message i {
        font-size: 3rem;
        color: var(--accent);
        margin-bottom: 1rem;
    }

    .store-closed-message h2 {
        color: white;
        margin-bottom: 1rem;
    }

    .store-closed-message p {
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .store-closed-message ul {
        list-style: none;
        padding: 0;
    }

    .store-closed-message li {
        color: var(--text);
        margin: 0.5rem 0;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
`;
document.head.appendChild(style);

.audio-button-full {
    width: 100%;
    padding: 12px;
    background: var(--gradient);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    margin-top: 10px;
}

.audio-button-full i {
    margin-right: 8px;
}

.recording-indicator {
    width: 100%;
    padding: 15px;
    background: var(--surface);
    border-radius: 8px;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.audio-waves {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 40px;
    margin-bottom: 15px;
}

.audio-waves span {
    display: inline-block;
    width: 5px;
    height: 5px;
    margin: 0 3px;
    background: var(--accent);
    border-radius: 50%;
    animation: wave 1.5s infinite ease-in-out;
}

.audio-waves span:nth-child(1) { animation-delay: 0s; }
.audio-waves span:nth-child(2) { animation-delay: 0.3s; }
.audio-waves span:nth-child(3) { animation-delay: 0.6s; }
.audio-waves span:nth-child(4) { animation-delay: 0.3s; }
.audio-waves span:nth-child(5) { animation-delay: 0s; }

@keyframes wave {
    0%, 100% { height: 5px; }
    50% { height: 30px; }
}

.stop-recording {
    padding: 10px 20px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.voice-search-btn {
    position: absolute;
    right: 1.2rem;
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.3rem;
    cursor: pointer;
    padding: 0.5rem;
    transition: all 0.3s ease;
}

.voice-search-btn:hover {
    color: var(--accent);
    transform: scale(1.1);
}

.voice-search-btn.listening {
    color: var(--accent);
    animation: pulse 1.5s infinite;
}

.search-input {
    padding-right: 3.5rem !important;
}

.voice-feedback {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--surface);
    padding: 2rem;
    border-radius: 15px;
    border: 1px solid var(--glass-border);
    z-index: 1000;
    text-align: center;
    display: none;
}

.voice-feedback.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#createOrderModal .pix-fallback {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 1rem;
    text-align: center;
    color: var(--text);
}

#createOrderModal #pixInfo {
    background: var(--surface);
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 1rem;
    text-align: center;
}

#createOrderModal #changeContainer {
    background: var(--glass);
    border-radius: 15px;
    padding: 1rem;
    margin-top: 1rem;
}

#createOrderModal .qr-code-container {
    background: white;
    padding: 1rem;
    border-radius: 10px;
    display: inline-block;
    margin: 1rem 0;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.recommendation-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 1.5rem;
    max-width: 350px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    animation: slideIn 0.5s ease;
    z-index: 9999;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.recommendation-notification button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
}

.spinner {
    width: 30px;
    height: 30px;
    border: 3px solid var(--glass-border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 1rem auto;
}

.acai-day-feedback {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    max-width: 90%;
    width: 400px;
}

</style>
</head>
<body>
    <div class="background-animation"></div>
    
    <header>
        <div class="header-content">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg" alt="Cabana Açaí Logo">
                </div>
                <h1 class="store-name">Cabana Açaí</h1>
            </div>
            <div class="cart-icon">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">0</span>
            </div>
        </div>
    </header>
    
    <nav class="categories">
        <button class="category-btn active">
            <i class="fas fa-star"></i>
            Todos
        </button>
        <button class="category-btn">
        <i class="fas fa-magic"></i>
         Monte seu Combo
        </button>
        <button class="category-btn">
            <i class="fas fa-ice-cream"></i>
            Apenas Cremes
        </button>
        <button class="category-btn">
            <i class="fas fa-cloud"></i>
            Açaí com Ninho
        </button>
        <button class="category-btn">
            <i class="fas fa-cookie"></i>
            Açaí com Ovomaltine
        </button>
        <button class="category-btn">
            <i class="fas fa-seedling"></i>
            Açaí com Amendoim
        </button>
        <button class="category-btn">
            <i class="fas fa-leaf"></i>
            Açaí Puro
        </button>
        <button class="category-btn">
            <i class="fas fa-paint-brush"></i>
            Monte seu Açaí
        </button>
    </nav>

<div class="search-container">
    <div class="search-bar">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="O que você quer comer hoje?" id="searchInput">
        <button class="voice-search-btn" onclick="startVoiceSearch()">
            <i class="fas fa-microphone"></i>
        </button>
    </div>
</div>

    <!-- Assistente de Ocasiões -->
<div class="occasion-assistant">
    <div class="assistant-header">
        <h3>Para qual ocasião você está pedindo hoje?</h3>
        <button onclick="toggleOccasionAssistant()">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
<div class="assistant-options" id="assistantOptions">
    <div class="option" onclick="selectOccasion('romantic')">
        <i class="fas fa-heart"></i>
        <span>Encontro Romântico</span>
    </div>
    <div class="option" onclick="selectOccasion('party')">
        <i class="fas fa-glass-cheers"></i>
        <span>Festa com Amigos</span>
    </div>
    <div class="option" onclick="selectOccasion('pre-workout')">
        <i class="fas fa-dumbbell"></i>
        <span>Pré-treino</span>
    </div>
    <div class="option" onclick="selectOccasion('post-workout')">
        <i class="fas fa-running"></i>
        <span>Pós-treino</span>
    </div>
    <div class="option" onclick="selectOccasion('dessert')">
        <i class="fas fa-ice-cream"></i>
        <span>Sobremesa</span>
    </div>
    <div class="option" onclick="selectOccasion('gift')">
        <i class="fas fa-gift"></i>
        <span>Presentear Alguém</span>
    </div>
</div>
</div>

    <div class="products-grid" id="productsGrid">
        <!-- Sample Product Card -->
        <div class="product-card">
            <img src="/api/placeholder/300/200" alt="Açaí com Ninho" class="product-image">
            <div class="product-info">
                <div class="product-category">Açaí com Ninho</div>
                <h3 class="product-title">Açaí com Leite Ninho</h3>
                <p class="product-description">Açaí cremoso coberto com leite ninho em pó e frutas selecionadas.</p>
                <div class="product-footer">
                    <div class="product-price">R$ 18,90</div>
                    <button class="add-to-cart-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- More product cards will be added dynamically -->
    </div>

    <!-- Product Modal -->
<!-- Product Modal -->
<div class="modal" id="productModal">
   <div class="modal-content">
       <div class="modal-header">
           <button class="close-modal">&times;</button>
       </div>
       <img src="/api/placeholder/800/400" alt="" class="modal-product-image">
       <div class="modal-product-info">
           <h2 class="modal-product-title">Açaí com Leite Ninho</h2>
           <p class="modal-product-description">
               Açaí cremoso coberto com leite ninho em pó e frutas selecionadas da melhor qualidade.
           </p>
           <div class="modal-product-price">R$ 18,90</div>
       </div>
       
       <div class="toppings-section">
           <h3 class="toppings-title">Escolha seus Acompanhamentos</h3>
           <div class="toppings-grid">
               <div class="topping-item">Granola</div>
               <div class="topping-item">Leite em Pó</div>
               <div class="topping-item">Morango</div>
               <div class="topping-item">Banana</div>
               <div class="topping-item">Kiwi</div>
               <div class="topping-item">Paçoca</div>
           </div>
       </div>

       <div class="extras-section">
           <h3 class="extras-title">Adicione Itens Extras (opcional)</h3>
           <div class="extras-grid">
               <!-- Items will be loaded dynamically -->
           </div>
       </div>
           
       <div class="modal-buttons">
           <button class="modal-btn add-to-cart">Adicionar ao Carrinho</button>
           <button class="modal-btn continue-shopping">Continuar Comprando</button>
       </div>

    <!-- Combo Builder Modal -->
<div class="modal" id="comboModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-product-title">Monte seu Combo</h2>
            <button class="close-modal">&times;</button>
        </div>
        
        <!-- Step 1: Choose Size -->
<!-- Step 1: Choose Size -->
<div class="combo-step" id="sizeStep">
    <h3 class="step-title">Escolha o tamanho do seu combo</h3>
    <div class="toppings-grid size-options">
        <div class="topping-item size-option" data-size="300ml" data-price="20.99">
            300ml - R$ 20,99
        </div>
        <div class="topping-item size-option" data-size="500ml" data-price="26.99">
            500ml - R$ 26,99
        </div>
        <div class="topping-item size-option" data-size="1L" data-price="49.99">
            1 Litro - R$ 49,99
        </div>
    </div>
</div>

        <!-- Step 2: Choose Flavors -->
<!-- Step 2: Choose Flavors -->
<div class="combo-step" id="flavorStep" style="display: none;">
    <h3 class="step-title">Escolha seus sabores</h3>
    <div class="flavor-section">
        <div class="flavor-option">
            <h4>Açaí 1 - Sabor Principal</h4>
            <select class="form-select" id="flavor1Primary">
                <option value="">Selecione um sabor</option>
                <option value="Açaí Tradicional">Açaí Tradicional</option>
                <option value="Creme de Ninho">Creme de Ninho</option>
                <option value="Creme de Ovomaltine">Creme de Ovomaltine</option>
                <option value="Creme de Amendoim">Creme de Amendoim</option>
                <option value="Creme de Cupuaçu">Creme de Cupuaçu</option>
                <option value="Creme de Morango">Creme de Morango</option>
            </select>
            <h4 style="margin-top: 1rem;">Açaí 1 - Segundo Sabor (Opcional)</h4>
            <select class="form-select" id="flavor1Secondary">
                <option value="">Nenhum</option>
                <option value="Açaí Tradicional">Açaí Tradicional</option>
                <option value="Creme de Ninho">Creme de Ninho</option>
                <option value="Creme de Ovomaltine">Creme de Ovomaltine</option>
                <option value="Creme de Amendoim">Creme de Amendoim</option>
                <option value="Creme de Cupuaçu">Creme de Cupuaçu</option>
                <option value="Creme de Morango">Creme de Morango</option>
            </select>
        </div>
        <div class="flavor-option" style="margin-top: 2rem;">
            <h4>Açaí 2 - Escolha Principal </h4>
            <select class="form-select" id="flavor2Primary">
                <option value="">Nenhum</option>
                <option value="Açaí Tradicional">Açaí Tradicional</option>
                <option value="Creme de Ninho">Creme de Ninho</option>
                <option value="Creme de Ovomaltine">Creme de Ovomaltine</option>
                <option value="Creme de Amendoim">Creme de Amendoim</option>
                <option value="Creme de Cupuaçu">Creme de Cupuaçu</option>
                <option value="Creme de Morango">Creme de Morango</option>
            </select>
            <h4 style="margin-top: 1rem;">Açaí 2 - Segundo Sabor (Opcional, caso queira mais de 1 sabor) </h4>
            <select class="form-select" id="flavor2Secondary">
                <option value="">Nenhum</option>
                <option value="Açaí Tradicional">Açaí Tradicional</option>
                <option value="Creme de Ninho">Creme de Ninho</option>
                <option value="Creme de Ovomaltine">Creme de Ovomaltine</option>
                <option value="Creme de Amendoim">Creme de Amendoim</option>
                <option value="Creme de Cupuaçu">Creme de Cupuaçu</option>
                <option value="Creme de Morango">Creme de Morango</option>
            </select>
        </div>
    </div>
</div>

        <!-- Step 3: Choose Toppings -->
        <div class="combo-step" id="toppingsStep" style="display: none;">
            <h3 class="step-title">Escolha seus acompanhamentos</h3>
            <div class="toppings-sections">
                <div class="acai-toppings">
                    <h4>Acompanhamentos do Açaí 1</h4>
                    <div class="toppings-grid" id="toppings1">
                        <!-- Toppings will be loaded dynamically -->
                    </div>
                </div>
                <div class="acai-toppings" id="acai2Toppings" style="display: none;">
                    <h4>Acompanhamentos do Açaí 2</h4>
                    <div class="toppings-grid" id="toppings2">
                        <!-- Toppings will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Choose Extras -->
        <div class="combo-step" id="extrasStep" style="display: none;">
            <h3 class="step-title">Confira seu pedido</h3>
            <div class="extras-grid">
                <!-- Extras will be loaded dynamically -->
            </div>
            
            <div class="combo-summary">
                <h4>Resumo do seu combo:</h4>
                <div class="summary-content"></div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="combo-progress">
            <div class="progress-step active"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
        </div>

        <!-- Navigation Buttons -->
        <div class="modal-buttons">
            <button class="modal-btn btn-back" style="display: none;">Voltar</button>
            <button class="modal-btn btn-next">Continuar</button>
            <button class="modal-btn btn-add-cart" style="display: none;">Adicionar ao Carrinho</button>
        </div>
    </div>
</div>

    <!-- Cart Modal -->
<div class="modal" id="cartModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Seu Carrinho</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="cart-items"></div>
<div class="cart-total">
    <div class="subtotal">Subtotal: R$ <span>0.00</span></div>
    <div class="delivery-fee">
        <i class="fas fa-motorcycle"></i> Taxa de Entrega: R$ 3,00
    </div>
    <div class="coupon-section" style="margin: 1rem 0;">
        <div class="form-group" style="display: flex; gap: 0.5rem;">
            <input type="text" id="couponCode" placeholder="Código do cupom" class="form-input" style="flex: 1;">
            <button onclick="applyCoupon()" class="btn-primary" style="padding: 0.5rem 1rem; border-radius: 8px; background: var(--accent); color: white; border: none; cursor: pointer;">
                Aplicar
            </button>
        </div>
        <div id="couponMessage" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
    </div>
    <div class="discount" style="display: none;">
        Desconto: -R$ <span>0.00</span>
    </div>
    <div class="total">Total: R$ <span>0.00</span></div>
</div>
        <div class="modal-buttons">
            <button class="modal-btn continue-shopping">Continuar Comprando</button>
            <button class="modal-btn checkout">Finalizar Pedido</button>
        </div>
    </div>
</div>

<!-- Customer Info Modal -->
<div class="modal" id="customerInfoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Seus Dados</h2>
            <button class="close-modal">&times;</button>
        </div>
        <form id="customerInfoForm">
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" required name="fullName">
            </div>
            <div class="form-group">
                <label>WhatsApp (com DDD)</label>
                <input type="tel" required name="whatsapp" pattern="[0-9]{11}">
            </div>
            <button type="submit" class="modal-btn">Avançar</button>
        </form>
    </div>
</div>

<!-- Delivery Info Modal -->
<div class="modal" id="deliveryInfoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Endereço de Entrega</h2>
            <button class="close-modal">&times;</button>
        </div>
        <form id="deliveryInfoForm">
            <div class="form-group">
                <label>Endereço</label>
                <input type="text" required name="address">
            </div>
            <div class="form-group">
                <label>Complemento</label>
                <input type="text" name="complement">
            </div>
            <div class="form-group">
                <label>Apto/Bloco</label>
                <input type="text" name="apt">
            </div>
            <div class="form-group">
                <label>Bairro</label>
                <input type="text" required name="neighborhood">
            </div>
            <div class="form-group">
                <label>CEP</label>
                <input type="text" required name="zipcode">
            </div>
            <div class="form-group">
                <label>Forma de Pagamento</label>
                <div class="payment-options">
                    <label>
                        <input type="radio" name="payment" value="money">
                        <i class="fas fa-money-bill"></i> Dinheiro
                    </label>
                    <label>
                        <input type="radio" name="payment" value="card">
                        <i class="fas fa-credit-card"></i> Cartão na Entrega
                    </label>
                    <label>
                        <input type="radio" name="payment" value="pix">
                        <i class="fas fa-qrcode"></i> PIX
                    </label>
                </div>
            </div>
            <div id="changeContainer" style="display: none;">
                <label>Troco para quanto?</label>
                <input type="number" name="change" step="0.01">
            </div>
            <div id="pixInfo" style="display: none;">
                <p>Envie o PIX para 84 9 8873-1028 - Santander - Jackson</p>
            </div>
            <div class="order-summary"></div>
            <p class="whatsapp-info" style="color: var(--text); font-size: 0.9rem; text-align: center; margin-bottom: 1rem;">
    Após finalizar o pedido, você será redirecionado ao WhatsApp (84) 98767-3202 para acompanhar o status do seu pedido.
</p>
            <button type="submit" class="modal-btn">Finalizar Pedido</button>
        </form>
    </div>
</div>

    <!-- Customer Info Modal -->
<div class="modal" id="customerInfoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Seus Dados</h2>
            <button class="close-modal">&times;</button>
        </div>
        <form id="customerInfoForm">
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" required name="fullName">
            </div>
            <div class="form-group">
                <label>WhatsApp (com DDD)</label>
                <input type="tel" required name="whatsapp" pattern="[0-9]{11}">
            </div>
            <button type="submit" class="modal-btn">Avançar</button>
        </form>
    </div>
</div>

<!-- Delivery Info Modal -->
<div class="modal" id="deliveryInfoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Endereço de Entrega</h2>
            <button class="close-modal">&times;</button>
        </div>
        <form id="deliveryInfoForm">
            <div class="form-group">
                <label>Endereço</label>
                <input type="text" required name="address">
            </div>
            <div class="form-group">
                <label>Complemento</label>
                <input type="text" name="complement">
            </div>
            <div class="form-group">
                <label>Apto/Bloco</label>
                <input type="text" name="apt">
            </div>
            <div class="form-group">
                <label>Bairro</label>
                <input type="text" required name="neighborhood">
            </div>
            <div class="form-group">
                <label>CEP</label>
                <input type="text" required name="zipcode">
            </div>
            <div class="form-group">
            <label>Cupom de Desconto (opcional)</label>
            <input type="text" name="couponCode" placeholder="Digite seu cupom">
            </div>
            <div class="form-group">
                <label>Forma de Pagamento</label>
                <div class="payment-options">
                    <label>
                        <input type="radio" name="payment" value="money">
                        <i class="fas fa-money-bill"></i> Dinheiro
                    </label>
                    <label>
                        <input type="radio" name="payment" value="card">
                        <i class="fas fa-credit-card"></i> Cartão na Entrega
                    </label>
                    <label>
                        <input type="radio" name="payment" value="pix">
                        <i class="fas fa-qrcode"></i> PIX
                    </label>
                </div>
            </div>
            <div id="changeContainer" style="display: none;">
                <label>Troco para quanto?</label>
                <input type="number" name="change" step="0.01">
            </div>
            <div id="pixInfo" style="display: none;">
                <p>Envie o PIX para 84 9 8873-1028 - Santander - Jackson</p>
            </div>
            <div class="order-summary"></div>
            <button type="submit" class="modal-btn">Finalizar Pedido</button>
        </form>
    </div>
</div>

    <!-- Antes de fechar o </body> -->
<div class="modal" id="cartModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Seu Carrinho</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="cart-items"></div>
        <div class="cart-total">
            <div class="subtotal">Subtotal: R$ <span>0.00</span></div>
            <div class="delivery-fee">
                <i class="fas fa-motorcycle"></i> Taxa de Entrega: R$ 3,00
            </div>
            <div class="total">Total: R$ <span>0.00</span></div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn continue-shopping">Continuar Comprando</button>
            <button class="modal-btn checkout">Finalizar Pedido</button>
        </div>
    </div>
</div>

<script>

// Twilio Configuration
const TWILIO_CONFIG = {
    accountSid: 'AC04c1d67a4b599d4cb0d804029109fad3',
    authToken: '17914a6678d7211b1909f7dcc77690f8',
    phoneNumber: '+12362016670',
    targetPhone: '+5584988731028'
};
    
// Firebase initialization
const firebaseConfig = {
    apiKey: "AIzaSyB-pF2lRStLTN9Xw9aYQj962qdNFyUXI2E",
    authDomain: "cabana-8d55e.firebaseapp.com",
    databaseURL: "https://cabana-8d55e-default-rtdb.firebaseio.com",
    projectId: "cabana-8d55e",
    storageBucket: "cabana-8d55e.appspot.com",
    messagingSenderId: "706144237954",
    appId: "1:706144237954:web:345c10370972486afc779b",
    measurementId: "G-96Y337GYT8"
};

firebase.initializeApp(firebaseConfig);
const realtimeDB = firebase.database(); // para funções que usam .ref()
const db = firebase.firestore(); // para novas funções que integram com o PDV

let cart = [];
let currentProducts = [];
let appliedCoupon = null;
let customerInfo = {};
let deliveryInfo = {};
let acaiDoDiaQuantityInCart = 0;
let recognition;
let isListening = false;
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

// Função para abrir produto a partir de parâmetro na URL
window.openProductByUrlParam = function() {
  // Obter os parâmetros da URL
  const urlParams = new URLSearchParams(window.location.search);
  const produtoParam = urlParams.get('produto');
  
  // Se não houver parâmetro, não faz nada
  if (!produtoParam) return;
  
  // Normalizar o nome do produto da URL (remover acentos, converter para minúsculas)
  const normalizedParam = produtoParam.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]/g, "-");
  
  // Aguardar o carregamento dos produtos
  const checkProductsLoaded = setInterval(() => {
    if (currentProducts && currentProducts.length > 0) {
      clearInterval(checkProductsLoaded);
      
      // Procurar o produto que corresponde ao parâmetro
      const foundProduct = currentProducts.find(product => {
        // Normalizar o nome do produto do catálogo
        const normalizedName = product.name.toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]/g, "-");
        
        return normalizedName === normalizedParam;
      });
      
      // Se encontrou o produto, abrir o modal
      if (foundProduct) {
        openProductModal(foundProduct);
      } else {
        console.log(`Produto '${produtoParam}' não encontrado no catálogo.`);
      }
    }
  }, 500); // Verificar a cada 500ms
};

// Função para listar URLs de todos os produtos
window.listAllProductUrls = function() {
  if (!currentProducts || currentProducts.length === 0) {
    console.log("Produtos ainda não foram carregados");
    return;
  }
  
  console.log("=== URLs DE COMPARTILHAMENTO PARA TODOS OS PRODUTOS ===");
  console.log("Copie e cole estes links para compartilhar produtos específicos:");
  
  currentProducts.forEach(product => {
    // Normalizar o nome do produto para a URL
    const normalizedName = product.name.toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]/g, "-");
    
    // Criar a URL completa
    const fullUrl = `${window.location.origin}${window.location.pathname}?produto=${normalizedName}`;
    
    console.log(`${product.name}: ${fullUrl}`);
  });
  
  console.log("===============================================");
};

function gravarAudio() {
    const audioButton = document.querySelector('.audio-button-full');
    const recordingIndicator = document.querySelector('.recording-indicator');
    const replyInput = document.getElementById('replyInput') || document.querySelector('.chat-input');
    
    // Verifica se o navegador suporta reconhecimento de voz
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Seu navegador não suporta reconhecimento de voz. Tente usar Chrome ou Edge.');
        return;
    }
    
    // Se já estiver gravando, para a gravação
    if (isRecording) {
        recognition.stop();
        audioButton.style.display = 'block';
        recordingIndicator.style.display = 'none';
        isRecording = false;
        return;
    }
    
    // Inicializa o objeto de reconhecimento
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = true;
    
    // IMPORTANTE: Desativar resultados interinos para evitar repetições
    recognition.interimResults = false;
    
    // Limpa o transcript ao iniciar nova gravação
    finalTranscript = '';
    replyInput.value = '';
    
    // Mostra o indicador de gravação
    audioButton.style.display = 'none';
    recordingIndicator.style.display = 'flex';
    isRecording = true;
    
    // Evento quando o resultado é reconhecido
    recognition.onresult = function(event) {
        // Processa apenas os novos resultados desde o último evento
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                // Adiciona espaço apenas se já tiver conteúdo
                if (finalTranscript.length > 0) {
                    finalTranscript += ' ';
                }
                
                // Adiciona apenas o novo fragmento de texto
                finalTranscript += event.results[i][0].transcript.trim();
                
                // Atualiza o campo de entrada
                replyInput.value = finalTranscript;
            }
        }
    };
    
    // Eventos para tratar erros
    recognition.onerror = function(event) {
        console.error('Erro no reconhecimento de voz:', event.error);
        pararGravacao();
    };
    
    // Se a gravação terminar automaticamente, reinicie
    recognition.onend = function() {
        if (isRecording) {
            try {
                recognition.start();
            } catch (e) {
                console.error('Erro ao reiniciar gravação:', e);
                pararGravacao();
            }
        }
    };
    
    // Inicia a gravação
    try {
        recognition.start();
    } catch (e) {
        console.error('Erro ao iniciar gravação:', e);
        pararGravacao();
        showNotification('Erro ao iniciar gravação de voz. Tente novamente.');
    }
}

// Função para parar a gravação
function pararGravacao() {
    if (recognition) {
        try {
            recognition.stop();
        } catch (e) {
            console.error('Erro ao parar o reconhecimento:', e);
        }
    }
    
    isRecording = false;
    const audioButton = document.querySelector('.audio-button-full');
    const recordingIndicator = document.querySelector('.recording-indicator');
    
    if (audioButton) audioButton.style.display = 'block';
    if (recordingIndicator) recordingIndicator.style.display = 'none';
}
    
function enviarAudioParaChatbot(audioBlob) {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'pt-BR';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
        const texto = event.results[0][0].transcript;
        addMessageToChat(texto, 'user'); // Adiciona a mensagem do usuário

        // Simulando uma pequena espera antes da resposta do bot
        addMessageToChat('Processando sua mensagem...', 'bot');
        
        // Enviar para o Chatbase
        fetch('https://www.chatbase.co/api/v1/chat', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${CHATBASE_CONFIG.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [{ content: texto, role: 'user' }],
                chatbotId: CHATBASE_CONFIG.chatbotId,
                stream: false,
                temperature: 0
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remove a mensagem de processamento
            const messages = document.querySelector('.chat-messages');
            messages.removeChild(messages.lastChild);
            
            // Adiciona a resposta do chatbot
            if (data.text) {
                addMessageToChat(data.text, 'bot');
            }
        })
        .catch(error => {
            console.error('Erro ao enviar mensagem para o chatbot:', error);
            addMessageToChat('Desculpe, tive um problema ao processar sua mensagem. Pode tentar novamente?', 'bot');
        });
    };

    recognition.onerror = (error) => {
        console.error('Erro no reconhecimento:', error);
        addMessageToChat('Não consegui entender o áudio. Pode tentar novamente?', 'bot');
    };

    // Iniciar o reconhecimento
    recognition.start();
}

async function searchOrderHistory() {
    const phoneInput = document.getElementById('historyPhoneInput');
    const phone = phoneInput.value.replace(/\D/g, '');
    
    if (!phone) {
        showNotification('Por favor, digite seu WhatsApp');
        return;
    }

    const favoritesSection = document.querySelector('.favorites-section');
    const previousOrdersSection = document.querySelector('.previous-orders-section');

    try {
        const ordersRef = firebase.database().ref('orders');
        const query = ordersRef.orderByChild('customer/phone').equalTo(phone);
        
        const snapshot = await query.once('value');
        const orders = [];
        
        snapshot.forEach((childSnapshot) => {
            const order = childSnapshot.val();
            orders.push({
                id: childSnapshot.key,
                ...order,
                timestamp: order.timestamp || Date.now()
            });
        });

        if (orders.length === 0) {
            previousOrdersSection.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search fa-3x" style="color: var(--accent); margin-bottom: 1rem;"></i>
                    <p>Nenhum pedido encontrado para este número.</p>
                </div>
            `;
            return;
        }

        // Ordenar por data mais recente
        orders.sort((a, b) => b.timestamp - a.timestamp);

        // Renderizar favoritos
        const favorites = orders.filter(order => order.isFavorite);
        favoritesSection.innerHTML = `
            <div class="section-title">
                <i class="fas fa-star" style="color: #FFD700;"></i>
                Seus Favoritos
            </div>
            ${favorites.length ? renderOrders(favorites) : '<p class="empty-state">Nenhum pedido favorito ainda</p>'}
        `;

        // Renderizar histórico completo
        previousOrdersSection.innerHTML = `
            <div class="section-title">
                <i class="fas fa-history"></i>
                Histórico de Pedidos
            </div>
            ${renderOrders(orders)}
        `;

        // ADICIONAR AQUI - Event listeners para os botões de "Pedir Novamente"
    const reorderButtons = document.querySelectorAll('.reorder-btn');
    reorderButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            try {
                const items = JSON.parse(this.getAttribute('data-items'));
                cart = []; // Limpa o carrinho antes
                // Garante que todos os itens tenham as propriedades necessárias
                cart.push(...items.map(item => ({
                    name: item.name || 'Item sem nome',
                    price: item.price || 0,
                    description: item.description || '',
                    selectedToppings: item.selectedToppings || [],
                    selectedExtras: item.selectedExtras || []
                })));
                
                updateCartCount();
                document.getElementById('timeMachineModal').style.display = 'none';
                showCartModal(); // Abre o carrinho automaticamente
                showNotification('Itens adicionados ao carrinho');
            } catch (error) {
                console.error('Erro ao reordenar itens:', error);
                showNotification('Erro ao adicionar itens ao carrinho');
            }
        });
    });

    } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        showNotification('Erro ao carregar seu histórico de pedidos');
    }
}

// Adicionar botão do Time Machine ao header
function addTimeMachineButton() {
    const headerContent = document.querySelector('.header-content');
    const cartIcon = document.querySelector('.cart-icon');
    
    const timeMachineBtn = document.createElement('div');
    timeMachineBtn.className = 'time-machine-btn';
    timeMachineBtn.innerHTML = `
        <i class="fas fa-clock"></i>
        <span>Meus Pedidos</span>
    `;
    
    timeMachineBtn.addEventListener('click', showTimeMachine);
    headerContent.insertBefore(timeMachineBtn, cartIcon);
}

// Função para mostrar o Time Machine
// Função para mostrar o Time Machine
// Função para mostrar o Time Machine
function showTimeMachine() {
    const modal = document.getElementById('timeMachineModal');
    const favoritesSection = modal.querySelector('.favorites-section');
    const previousOrdersSection = modal.querySelector('.previous-orders-section');
    
    // Limpa seções anteriores
    favoritesSection.innerHTML = '';
    previousOrdersSection.innerHTML = '';
    
    // Adiciona event listener para o botão de fechar
    const closeButton = modal.querySelector('.close-modal');
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }
    
    modal.style.display = 'block';
}
// Função para renderizar os pedidos
// Modifique a função renderOrders para usar um data-attribute em vez de passar diretamente no onclick
function renderOrders(orders) {
    return orders.map(order => {
        // Escape do JSON para evitar problemas com aspas
        const itemsJson = order.items ? JSON.stringify(order.items).replace(/'/g, '&#39;') : '[]';
        
        return `
            <div class="order-card" data-order-id="${order.id}">
                <div class="order-header">
                    <div class="order-date">
                        ${new Date(order.timestamp).toLocaleDateString('pt-BR')} 
                        às ${new Date(order.timestamp).toLocaleTimeString('pt-BR')}
                    </div>
                    <button class="favorite-btn ${order.isFavorite ? 'active' : ''}" onclick="toggleFavorite('${order.id}')">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
                <div class="order-items">
                    ${order.items.map(item => `
                        <div class="order-item">
                            <div style="font-weight: bold;">${item.name}</div>
                            ${item.selectedToppings && item.selectedToppings.length ? `
                                <div style="font-size: 0.9rem; color: var(--text); margin-top: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Acompanhamentos: ${item.selectedToppings.join(', ')}
                                </div>
                            ` : ''}
                            ${item.selectedExtras && item.selectedExtras.length ? `
                                <div style="font-size: 0.9rem; color: var(--text); margin-top: 0.3rem;">
                                    <i class="fas fa-plus-circle"></i> Extras: ${item.selectedExtras.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <div class="order-total">R$ ${order.total ? order.total.toFixed(2) : '0.00'}</div>
                    <button class="reorder-btn" data-items='${itemsJson}'>
                        <i class="fas fa-redo-alt"></i> Pedir Novamente
                    </button>
                </div>
            </div>
        `;
    }).join('');
}
    
// Função para marcar/desmarcar favorito
async function toggleFavorite(orderId) {
    try {
        const orderRef = firebase.database().ref(`orders/${orderId}`);
        const snapshot = await orderRef.once('value');
        const order = snapshot.val();
        
        await orderRef.update({
            isFavorite: !order.isFavorite
        });
        
        // Atualizar UI
        const btn = document.querySelector(`[data-order-id="${orderId}"] .favorite-btn`);
        btn.classList.toggle('active');
        
        showNotification(order.isFavorite ? 'Removido dos favoritos' : 'Adicionado aos favoritos');
    } catch (error) {
        console.error('Erro ao atualizar favorito:', error);
        showNotification('Erro ao atualizar favorito');
    }
}

// Função para repedir itens
function reorderItems(items) {
    // Limpar carrinho atual
    cart = [];
    
    // Adicionar itens ao carrinho
    cart.push(...items);
    
    // Atualizar UI
    updateCartCount();
    
    // Fechar modal do Time Machine
    document.getElementById('timeMachineModal').style.display = 'none';
    
    // Mostrar carrinho
    showCartModal();
    
    showNotification('Itens adicionados ao carrinho');
}

function updateCustomerAndDeliveryInfo(customer, delivery) {
    customerInfo = customer;
    deliveryInfo = delivery;
}

function showCreateOrderModal() {
   const createOrderModal = document.getElementById('createOrderModal');
   const modalContent = createOrderModal.querySelector('.modal-content');

   // Obter o contador atual do localStorage ou inicializar como 1
   let orderCounter = parseInt(localStorage.getItem('orderCounter') || '1');
   
   // Verificar se o contador está dentro do intervalo (1-9)
   if (orderCounter > 9) {
       orderCounter = 1; // Reiniciar para 1 quando atingir 9
   }
   
   // Gerar o ID do pedido com o formato 5555X
   const orderId = `5555${orderCounter}`;

   document.getElementById('orderId').value = orderId;

   // Limpar campos do formulário
   document.getElementById('customerName').value = '';
   document.getElementById('customerPhone').value = '';
   document.getElementById('street').value = '';
   document.getElementById('streetNumber').value = '';
   document.getElementById('neighborhood').value = '';
   document.getElementById('complement').value = '';
   document.getElementById('zipCode').value = '';
   document.getElementById('notes').value = '';
   
   document.getElementById('paymentMoney').checked = false;
   document.getElementById('paymentCard').checked = false;
   document.getElementById('paymentOnline').checked = false;

   const subtotal = cart.reduce((total, item) => total + item.price, 0);
   const discount = appliedCoupon ? calculateDiscount(subtotal) : 0;
   const deliveryFee = 3.00;
   const total = subtotal - discount + deliveryFee;
   document.getElementById('orderTotal').value = total.toFixed(2);
   
   let orderDetails = '';
   cart.forEach(item => {
       if (item.name.includes('Combo')) {
           orderDetails += `Combo ${item.name}\n`;
           const description = item.description.split('\n').filter(line => line.trim() !== '');
           description.forEach(line => {
               orderDetails += `${line}\n`;
           });
       } else {
           orderDetails += `${item.name}\n`;
           orderDetails += `Acompanhamentos: ${item.selectedToppings.join(', ')}\n`;
           if (item.selectedExtras && item.selectedExtras.length > 0) {
               orderDetails += `Extras: ${item.selectedExtras.join(', ')}\n`;
           }
       }
       orderDetails += `Valor: R$ ${item.price.toFixed(2)}\n\n`;
   });
   document.getElementById('orderDetails').value = orderDetails;

   if (createOrderModal) {
       createOrderModal.style.display = 'block';
   } else {
       console.error('Modal não encontrado');
   }

   setupPaymentEvents();
}

// Adicionar event listener para o botão de checkout
document.addEventListener('DOMContentLoaded', () => {
    const checkoutButton = document.querySelector('.checkout');
    if (checkoutButton) {
        checkoutButton.addEventListener('click', () => {
            console.log('Botão de checkout clicado');
            showCreateOrderModal();
        });
    } else {
        console.error('Botão de checkout não encontrado');
    }
});

// Replace the handleDeliveryInfo function in your digital menu with this version:
async function handleDeliveryInfo(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const deliveryInfo = Object.fromEntries(formData);

    // ADICIONAR ESTA LINHA AQUI, logo após obter o formData
    if (customerInfo && customerInfo.whatsapp) {
        localStorage.setItem('lastCustomerPhone', customerInfo.whatsapp);
    }

    try {
        // Garantir que temos as informações necessárias
        if (!customerInfo || !customerInfo.fullName) {
            throw new Error('Informações do cliente incompletas');
        }

        // Criar o pedido para o Firebase
        const orderData = {
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            customerInfo,
            deliveryInfo,
            items: cart,
            status: 'new'
        };

        // Salvar no Firebase
        const newOrderRef = await realtimeDB.ref('orders').push(orderData);
        
        if (!newOrderRef.key) {
            throw new Error('Falha ao salvar pedido');
        }

        // Formatar e enviar para WhatsApp
        const message = formatOrderForWhatsApp(customerInfo, deliveryInfo);
        window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(message)}`;

    } catch (error) {
        console.error('Erro ao processar pedido:', error);
        alert('Erro ao processar pedido. Por favor, tente novamente.');
    }
}

// Load products from Firebase
function loadMenuProducts() {
  realtimeDB.ref('menu/products').on('value', snapshot => {
    const products = snapshot.val() || {};
    currentProducts = Object.values(products).filter(product => product.status);
    displayProducts(currentProducts);
    
    // Gerar lista de URLs no console
    window.listAllProductUrls();
  });
}

// Load categories from Firebase
function loadCategories() {
    realtimeDB.ref('menu/categories').on('value', snapshot => {
        const categories = snapshot.val() || {};
        updateCategoryButtons(categories);
    });
}

// Combo Builder Logic
let currentStep = 1;
let comboData = {
    size: null,
    flavor1: '',
    flavor2: '',
    toppings1: [],
    toppings2: [],
    extras: []
};

function initComboBuilder() {
    const comboModal = document.getElementById('comboModal');
    const closeBtn = comboModal.querySelector('.close-modal');
    const nextBtn = comboModal.querySelector('.btn-next');
    const backBtn = comboModal.querySelector('.btn-back');
    const addCartBtn = comboModal.querySelector('.btn-add-cart');
    
// Size selection
document.querySelectorAll('.size-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove seleção anterior
        document.querySelectorAll('.size-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.style.background = ''; // Remove background anterior
        });
        
        // Adiciona nova seleção com gradiente
        this.classList.add('selected');
        this.style.background = 'var(--gradient)';
        
        comboData.size = {
            size: this.dataset.size,
            price: parseFloat(this.dataset.price)
        };
        
        nextBtn.disabled = false;
    });
});

        setupFlavorSelectors();

    // Configuração dos botões de navegação
    nextBtn.addEventListener('click', () => {
        if (validateStep()) {
            currentStep++;
            updateComboView();
        }
    });

    backBtn.addEventListener('click', () => {
        currentStep--;
        updateComboView();
    });

    closeBtn.addEventListener('click', () => {
        comboModal.style.display = 'none';
        resetComboBuilder();
    });

    addCartBtn.addEventListener('click', () => {
        addComboToCart();
        comboModal.style.display = 'none';
        resetComboBuilder();
    });

    // Load toppings and extras
    loadToppingsAndExtras();
    
    // Reset inicial
    resetComboBuilder();
}

    function setupFlavorSelectors() {
    const flavor1Primary = document.getElementById('flavor1Primary');
    const flavor1Secondary = document.getElementById('flavor1Secondary');
    const flavor2Primary = document.getElementById('flavor2Primary');
    const flavor2Secondary = document.getElementById('flavor2Secondary');
    const nextBtn = document.querySelector('.btn-next');

    flavor1Primary.addEventListener('change', (e) => {
        comboData.acai1.primaryFlavor = e.target.value;
        nextBtn.disabled = !validateStep();
    });

    flavor1Secondary.addEventListener('change', (e) => {
        comboData.acai1.secondaryFlavor = e.target.value;
    });

    flavor2Primary.addEventListener('change', (e) => {
        comboData.acai2.primaryFlavor = e.target.value;
        if (e.target.value) {
            document.getElementById('acai2Toppings').style.display = 'block';
        } else {
            document.getElementById('acai2Toppings').style.display = 'none';
            comboData.acai2.toppings = [];
        }
    });

    flavor2Secondary.addEventListener('change', (e) => {
        comboData.acai2.secondaryFlavor = e.target.value;
    });
}

// Adiciona função para adicionar o combo ao carrinho
function addComboToCart() {
    const comboPrice = calculateComboPrice();
    const comboName = `Combo ${comboData.size.size}`;

    // Monta os detalhes do Açaí 1
    let acai1Details = `\n• Açaí 1:\n`;
    acai1Details += `  Sabor principal: ${comboData.acai1.primaryFlavor}\n`;
    if (comboData.acai1.secondaryFlavor) {
        acai1Details += `  Segundo sabor: ${comboData.acai1.secondaryFlavor}\n`;
    }
    acai1Details += `  Acompanhamentos: ${comboData.acai1.toppings.join(', ')}\n`;

    // Monta os detalhes do Açaí 2 se houver
    let acai2Details = '';
    if (comboData.acai2.primaryFlavor) {
        acai2Details = `\n• Açaí 2:\n`;
        acai2Details += `  Sabor principal: ${comboData.acai2.primaryFlavor}\n`;
        if (comboData.acai2.secondaryFlavor) {
            acai2Details += `  Segundo sabor: ${comboData.acai2.secondaryFlavor}\n`;
        }
        acai2Details += `  Acompanhamentos: ${comboData.acai2.toppings.join(', ')}`;
    }

    // Extras se houver
    let extrasDetails = '';
    if (comboData.extras.length > 0) {
        extrasDetails = `\n\n• Extras: ${comboData.extras.join(', ')}`;
    }

    const comboItem = {
        name: comboName,
        price: comboPrice,
        selectedToppings: [...comboData.acai1.toppings, ...comboData.acai2.toppings],
        selectedExtras: comboData.extras,
        description: `${acai1Details}${acai2Details}${extrasDetails}`
    };

    cart.push(comboItem);
    updateCartCount();
    showCartModal();
}

function calculateComboPrice() {
    let total = comboData.size.price;
    
    // Adiciona preço dos extras
    if (comboData.extras.length > 0) {
        const extrasGrid = document.querySelector('.extras-grid');
        comboData.extras.forEach(extraName => {
            const extraItem = extrasGrid.querySelector(`[data-name="${extraName}"]`);
            if (extraItem && extraItem.dataset.price) {
                total += parseFloat(extraItem.dataset.price);
            }
        });
    }
    
    return total;
}

// Função para formatar descrição do combo
function formatComboDescription() {
    let desc = `${comboData.flavor1}`;
    if (comboData.flavor2) {
        desc += ` + ${comboData.flavor2}`;
    }
    return desc;
}

function validateStep() {
    switch (currentStep) {
        case 1:
            return comboData.size !== null;
        case 2:
            return comboData.acai1.primaryFlavor !== '';
        case 3:
            // Verifica se tem pelo menos 1 acompanhamento no açaí 1
            if (comboData.acai1.toppings.length < 1) {
                showNotification('Selecione pelo menos 1 acompanhamento para o Açaí 1');
                return false;
            }
            // Se tiver sabor principal no açaí 2, precisa ter pelo menos 1 acompanhamento também
            if (comboData.acai2.primaryFlavor && comboData.acai2.toppings.length < 1) {
                showNotification('Selecione pelo menos 1 acompanhamento para o Açaí 2');
                return false;
            }
            return true;
        case 4:
            return true;
        default:
            return false;
    }
}

function resetComboBuilder() {
    currentStep = 1;
    comboData = {
        size: null,
        acai1: {
            primaryFlavor: '',
            secondaryFlavor: '',
            toppings: []
        },
        acai2: {
            primaryFlavor: '',
            secondaryFlavor: '',
            toppings: []
        },
        extras: []
    };
    updateComboView();
}

function updateComboView() {
    const steps = ['sizeStep', 'flavorStep', 'toppingsStep', 'extrasStep'];
    steps.forEach((step, index) => {
        document.getElementById(step).style.display = 
            index + 1 === currentStep ? 'block' : 'none';
    });

    // Update progress bar
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.toggle('active', index + 1 <= currentStep);
    });

    // Show/hide navigation buttons
    const backBtn = document.querySelector('.btn-back');
    const nextBtn = document.querySelector('.btn-next');
    const addCartBtn = document.querySelector('.btn-add-cart');

    backBtn.style.display = currentStep > 1 ? 'block' : 'none';
    nextBtn.style.display = currentStep < 4 ? 'block' : 'none';
    addCartBtn.style.display = currentStep === 4 ? 'block' : 'none';
    
    // Atualizar estado dos botões
    nextBtn.disabled = !validateStep();

    // Se estiver na etapa final, atualiza o resumo
    if (currentStep === 4) {
        updateComboSummary();
    }
}

function loadToppingsAndExtras() {
    // Load toppings from Firebase
    realtimeDB.ref('toppings').once('value', snapshot => {
        const toppings = snapshot.val();
        if (toppings) {
            const toppingsHtml = Object.values(toppings)
                .filter(topping => topping.available)
                .map(topping => `
                    <div class="topping-item" data-name="${topping.name}">
                        ${topping.name}
                        ${topping.price > 0 ? `<span class="topping-price">+R$ ${topping.price.toFixed(2)}</span>` : ''}
                    </div>
                `).join('');
            
            document.getElementById('toppings1').innerHTML = toppingsHtml;
            document.getElementById('toppings2').innerHTML = toppingsHtml;

            // Add click handlers
            document.querySelectorAll('.topping-item').forEach(item => {
                item.addEventListener('click', () => toggleTopping(item));
            });
        }
    });

    // Load extras from Firebase
    realtimeDB.ref('extras').once('value', snapshot => {
        const extras = snapshot.val();
        if (extras) {
            const extrasHtml = Object.values(extras)
                .filter(extra => extra.available)
                .map(extra => `
                    <div class="extra-item" data-name="${extra.name}" data-price="${extra.price}">
                        ${extra.name}
                        <span class="extra-price">+R$ ${extra.price.toFixed(2)}</span>
                    </div>
                `).join('');
            
            document.querySelector('.extras-grid').innerHTML = extrasHtml;

            // Add click handlers
            document.querySelectorAll('.extra-item').forEach(item => {
                item.addEventListener('click', () => toggleExtra(item));
            });
        }
    });
}

function toggleTopping(item) {
    const toppingName = item.dataset.name;
    const isForFirstAcai = item.closest('#toppings1') !== null;
    
    // Define o limite de acompanhamentos baseado no tamanho
    let maxToppings;
    if (comboData.size.size === '300ml') {
        maxToppings = 3;
    } else if (comboData.size.size === '500ml') {
        maxToppings = 4;
    } else if (comboData.size.size === '1L') {
        maxToppings = 8;
    }
    
    const toppingsArray = isForFirstAcai ? comboData.acai1.toppings : comboData.acai2.toppings;
    
    if (item.classList.contains('selected')) {
        item.classList.remove('selected');
        const index = toppingsArray.indexOf(toppingName);
        if (index > -1) {
            if (isForFirstAcai) {
                comboData.acai1.toppings.splice(index, 1);
            } else {
                comboData.acai2.toppings.splice(index, 1);
            }
        }
    } else {
        if (toppingsArray.length < maxToppings) {
            item.classList.add('selected');
            if (isForFirstAcai) {
                comboData.acai1.toppings.push(toppingName);
            } else {
                comboData.acai2.toppings.push(toppingName);
            }
        } else {
            showNotification(`Máximo de ${maxToppings} acompanhamentos permitidos para este tamanho`);
        }
    }

    // Atualiza o resumo se estiver na última etapa
    if (currentStep === 4) {
        updateComboSummary();
    }

    // Valida se tem pelo menos 1 acompanhamento selecionado
    const nextBtn = document.querySelector('.btn-next');
    if (nextBtn) {
        nextBtn.disabled = !validateStep();
    }
}
    function toggleExtra(item) {
    const extraName = item.dataset.name;
    
    if (item.classList.contains('selected')) {
        item.classList.remove('selected');
        comboData.extras = comboData.extras.filter(e => e !== extraName);
    } else {
        item.classList.add('selected');
        comboData.extras.push(extraName);
    }

    // Atualizar a exibição se necessário
    if (currentStep === 4) {
        updateComboSummary();
    }
}

function updateComboSummary() {
    const summaryContent = document.querySelector('.summary-content');
    let summary = `<strong>Tamanho:</strong> ${comboData.size.size} (R$ ${comboData.size.price})<br><br>`;
    
    summary += `<strong>Açaí 1:</strong><br>`;
    summary += `Sabor Principal: ${comboData.acai1.primaryFlavor}<br>`;
    if (comboData.acai1.secondaryFlavor) {
        summary += `Segundo Sabor: ${comboData.acai1.secondaryFlavor}<br>`;
    }
    summary += `Acompanhamentos: ${comboData.acai1.toppings.join(', ') || 'Nenhum'}<br><br>`;
    
    if (comboData.acai2.primaryFlavor) {
        summary += `<strong>Açaí 2:</strong><br>`;
        summary += `Sabor Principal: ${comboData.acai2.primaryFlavor}<br>`;
        if (comboData.acai2.secondaryFlavor) {
            summary += `Segundo Sabor: ${comboData.acai2.secondaryFlavor}<br>`;
        }
        summary += `Acompanhamentos: ${comboData.acai2.toppings.join(', ') || 'Nenhum'}<br><br>`;
    }
    
    if (comboData.extras.length > 0) {
        summary += `<strong>Extras:</strong> ${comboData.extras.join(', ')}`;
    }
    
    summaryContent.innerHTML = summary;
}

function updateCategoryButtons(categories) {
    const categoriesNav = document.querySelector('.categories');
    categoriesNav.innerHTML = `
        <button class="category-btn active" data-category="all">
            <i class="fas fa-star"></i>
            Todos
        </button>
        <button class="category-btn" data-category="combo">
            <i class="fas fa-magic"></i>
            Monte seu Combo
        </button>
    `;
    
    Object.entries(categories).forEach(([id, category]) => {
        categoriesNav.innerHTML += `
            <button class="category-btn" data-category="${id}">
                <i class="fas fa-${category.icon || 'circle'}"></i>
                ${category.name}
            </button>
        `;
    });
    
    // Adiciona event listeners para todos os botões de categoria
    categoriesNav.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelector('.category-btn.active')?.classList.remove('active');
            button.classList.add('active');
            
            const categoryId = button.dataset.category;
            if (categoryId === 'combo') {
                document.getElementById('comboModal').style.display = 'block';
                resetComboBuilder();
                initComboBuilder();
            } else {
                const filteredProducts = categoryId === 'all' 
                    ? currentProducts 
                    : currentProducts.filter(p => p.category === categoryId);
                displayProducts(filteredProducts);
            }
        });
    });
}

function checkStoreStatus() {
    const existingStatus = document.querySelector('.store-status');
    if (existingStatus) existingStatus.remove();

    const statusDiv = document.createElement('div');
    statusDiv.className = 'store-status';
    statusDiv.style.cssText = `
        width: 100%;
        max-width: 1400px;
        margin: 100px auto 0;
        text-align: center;
        padding: 0.8rem;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 8px;
        background: var(--surface);
        border: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    `;
    
    realtimeDB.ref('schedule').once('value')
        .then(snapshot => {
            const schedule = snapshot.val() || {};
            const isOpen = isStoreOpenNow(schedule);
            
            statusDiv.innerHTML = `
                <span style="font-size: 1.2rem; color: ${isOpen ? '#4CAF50' : '#FF5252'}">●</span>
                <span>Loja ${isOpen ? 'Aberta' : 'Fechada'}</span>
            `;
            
            const categories = document.querySelector('.categories');
            categories.parentNode.insertBefore(statusDiv, categories);

            if (!isOpen) {
                disableOrdering();
                showStoreClosedPopup();
            } else {
                enableOrdering();
            }

            // Inicializa o Açaí do Dia após verificar o status
            initAcaiDoDia();
        })
        .catch(error => {
            console.error('Erro ao verificar status da loja:', error);
            // Em caso de erro, assume que a loja está fechada por segurança
            disableOrdering();
            showStoreClosedPopup();
        });
}

// Verificar status da loja a cada minuto
setInterval(checkStoreStatus, 300000);  // 5 minutos

function isStoreOpenNow(schedule) {
    const now = new Date();
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const today = days[now.getDay()];
    
    const todaySchedule = schedule[today];
    if (!todaySchedule || !todaySchedule.isOpen) return false;
    
    // Converte horário atual para minutos desde meia-noite
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    // Converte horários de abertura/fechamento para minutos
    const [openHour, openMin] = todaySchedule.open.split(':').map(Number);
    const [closeHour, closeMin] = todaySchedule.close.split(':').map(Number);
    
    const openMinutes = openHour * 60 + openMin;
    const closeMinutes = closeHour * 60 + closeMin;
    
    return currentMinutes >= openMinutes && currentMinutes < closeMinutes;
}

// Definir funções no escopo global
window.disableOrdering = function() {
    // Desabilitar botões de adicionar ao carrinho
    const addButtons = document.querySelectorAll('.add-to-cart-btn, .add-deal-btn');
    addButtons.forEach(button => {
        button.disabled = true;
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
    });
    
    // Desabilitar cards de produtos
    document.querySelectorAll('.product-card').forEach(card => {
        card.style.opacity = '0.7';
        card.style.cursor = 'not-allowed';
        card.onclick = (e) => {
            e.preventDefault();
            showStoreClosedPopup();
        };
    });

    // Desabilitar botão de checkout
    const checkoutBtn = document.querySelector('.checkout');
    if (checkoutBtn) {
        checkoutBtn.disabled = true;
        checkoutBtn.style.opacity = '0.5';
        checkoutBtn.style.cursor = 'not-allowed';
        checkoutBtn.onclick = (e) => {
            e.preventDefault();
            showStoreClosedPopup();
        };
    }

    // Desabilitar botão de montar combo
    const comboBtn = document.querySelector('.category-btn[data-category="combo"]');
    if (comboBtn) {
        comboBtn.disabled = true;
        comboBtn.style.opacity = '0.5';
        comboBtn.style.cursor = 'not-allowed';
        comboBtn.onclick = (e) => {
            e.preventDefault();
            showStoreClosedPopup();
        };
    }

    // Adicionar overlay de loja fechada se ainda não existir
    if (!document.querySelector('.store-closed-overlay')) {
        const storeClosedOverlay = document.createElement('div');
        storeClosedOverlay.className = 'store-closed-overlay';
        storeClosedOverlay.innerHTML = `
            <div class="store-closed-message">
                <i class="fas fa-store-alt-slash"></i>
                <h2>Loja Fechada</h2>
                <p>Horário de Funcionamento:</p>
                <ul>
                    <li>Quarta à Sexta: 12:30h às 22:30h</li>
                    <li>Sábado e Domingo: 12:30h às 17:30h</li>
                </ul>
            </div>
        `;
        document.body.appendChild(storeClosedOverlay);
    }
};

window.enableOrdering = function() {
    // Remover overlay de loja fechada
    const overlay = document.querySelector('.store-closed-overlay');
    if (overlay) {
        overlay.remove();
    }

    // Reabilitar botões de adicionar ao carrinho
    const addButtons = document.querySelectorAll('.add-to-cart-btn, .add-deal-btn');
    addButtons.forEach(button => {
        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
    });

    // Reabilitar cards de produtos
    document.querySelectorAll('.product-card').forEach(card => {
        card.style.opacity = '1';
        card.style.cursor = 'pointer';
        card.onclick = null; // Apenas remove o handler de loja fechada
    });

    // Reabilitar botão de checkout
    const checkoutBtn = document.querySelector('.checkout');
    if (checkoutBtn) {
        checkoutBtn.disabled = false;
        checkoutBtn.style.opacity = '1';
        checkoutBtn.style.cursor = 'pointer';
        checkoutBtn.onclick = handleCheckout;
    }

    // Reabilitar botão de montar combo
    const comboBtn = document.querySelector('.category-btn[data-category="combo"]');
    if (comboBtn) {
        comboBtn.disabled = false;
        comboBtn.style.opacity = '1';
        comboBtn.style.cursor = 'pointer';
        // Restaurar o comportamento original do botão de combo
        comboBtn.onclick = () => {
            document.getElementById('comboModal').style.display = 'block';
            resetComboBuilder();
            initComboBuilder();
        };
    }
};

window.showStoreClosedPopup = function() {
    const popup = document.getElementById('storeClosedPopup');
    popup.classList.add('active');
};

function setupEventListeners() {
    // Category buttons
    document.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelector('.category-btn.active')?.classList.remove('active');
            button.classList.add('active');
            
            const category = button.textContent.trim();
            const filteredProducts = category === 'Todos' 
                ? currentProducts 
                : currentProducts.filter(p => p.category === category);
            displayProducts(filteredProducts);
        });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredProducts = currentProducts.filter(product => 
            product.name.toLowerCase().includes(searchTerm) ||
            product.description.toLowerCase().includes(searchTerm)
        );
        displayProducts(filteredProducts);
    });

    // Modal close buttons
document.querySelectorAll('.close-modal').forEach(button => {
    button.addEventListener('click', () => {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
        hideMascot();
    });
});

    // Continue shopping button
    document.querySelector('.continue-shopping').addEventListener('click', () => {
        document.getElementById('productModal').style.display = 'none';
    });

    // Add to cart button
    document.querySelector('.add-to-cart').addEventListener('click', () => {
        const selectedToppings = Array.from(document.querySelectorAll('.topping-item.selected'))
            .map(item => item.textContent);
        addToCart(currentProduct, selectedToppings);
        document.getElementById('productModal').style.display = 'none';
    });
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    realtimeDB.ref(`categories/${product.category}`).once('value')
        .then(snapshot => {
            const category = snapshot.val();
            const categoryName = category ? category.name : 'Categoria';
            
            card.innerHTML = `
                <img src="${product.imageUrl || '/api/placeholder/300/200'}" alt="${product.name}" class="product-image">
                <div class="product-info">
                    <div class="product-category">${categoryName}</div>
                    <h3 class="product-title">${product.name}</h3>
                    <p class="product-description">${product.description}</p>
                    <div class="product-footer">
                        <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.nutrition-btn')) {
                    openProductModal(product);
                }
            });
        });
    
    return card;
}

function askNutrition(productName) {
    const chatContainer = document.querySelector('.chat-container');
    const chatInput = document.querySelector('.chat-input');
    
    if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
        toggleChat();
    }
    
    chatInput.value = `Quais são as informações nutricionais do ${productName}?`;
    sendMessage();
}

async function getCategoryName(categoryId) {
   const snapshot = await realtimeDB.ref()(`categories/${categoryId}`).once('value');
   const category = snapshot.val();
   return category ? category.name : 'Categoria';
}

function displayProducts(productsToShow) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    productsToShow.forEach(product => {
        const card = createProductCard(product);
        grid.appendChild(card);
    });
}
    
let currentProduct = null;

function hideMascot() {
    const mascotContainer = document.querySelector('.mascot-container');
    mascotContainer.style.display = 'none';
}

function openProductModal(product) {
    currentProduct = product;
    const modal = document.getElementById('productModal');
    
    // First remove any existing nutrition button
    const existingNutritionBtn = modal.querySelector('.nutrition-info-btn');
    if (existingNutritionBtn) {
        existingNutritionBtn.remove();
    }

    // Create nutrition button
    const nutritionBtn = document.createElement('button');
    nutritionBtn.className = 'modal-btn nutrition-info-btn';
    nutritionBtn.innerHTML = '<i class="fas fa-heartbeat"></i> Info Nutricional';
    nutritionBtn.onclick = () => askNutrition(product.name);
    nutritionBtn.style.cssText = `
        margin-bottom: 1rem;
        background: var(--gradient);
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 25px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: fit-content;
        margin: 0 auto 1rem auto;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    `;

    nutritionBtn.addEventListener('mouseover', () => {
        nutritionBtn.style.transform = 'translateY(-3px)';
        nutritionBtn.style.boxShadow = '0 5px 15px rgba(247, 37, 133, 0.3)';
    });

    nutritionBtn.addEventListener('mouseout', () => {
        nutritionBtn.style.transform = 'translateY(0)';
        nutritionBtn.style.boxShadow = 'none';
    });

    // Insert button before product image
    const productImage = modal.querySelector('.modal-product-image');
    productImage.parentNode.insertBefore(nutritionBtn, productImage);
    
    // Verifica se já existe um botão de compartilhamento e o remove
    const existingShareBtn = modal.querySelector('.share-whatsapp-btn');
    if (existingShareBtn) {
        existingShareBtn.remove();
    }
    
    // Cria URL com parâmetro do produto
    const normalizedName = product.name.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "-");
    const shareUrl = `${window.location.origin}${window.location.pathname}?produto=${normalizedName}`;
    
    // Cria botão de compartilhamento do WhatsApp
    const shareBtn = document.createElement('button');
    shareBtn.className = 'share-whatsapp-btn';
    shareBtn.innerHTML = '<i class="fab fa-whatsapp"></i> Compartilhar no WhatsApp';
    shareBtn.style.cssText = `
        background: #25D366;
        color: white;
        border: none;
        padding: 0.8rem 1.2rem;
        border-radius: 25px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        margin: 1rem auto;
        transition: all 0.3s ease;
    `;
    
    shareBtn.addEventListener('mouseover', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 5px 10px rgba(37, 211, 102, 0.3)';
    });
    
    shareBtn.addEventListener('mouseout', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    });
    
// Manipula o evento de clique no botão
shareBtn.addEventListener('click', function() {
    // Primeiro, atualize as meta tags para este produto específico
    let ogTitle = document.querySelector('meta[property="og:title"]');
    let ogDescription = document.querySelector('meta[property="og:description"]');
    let ogImage = document.querySelector('meta[property="og:image"]');
    let ogUrl = document.querySelector('meta[property="og:url"]');
    
    // Se não existirem, crie-as
    if (!ogTitle) {
        ogTitle = document.createElement('meta');
        ogTitle.setAttribute('property', 'og:title');
        document.head.appendChild(ogTitle);
    }
    
    if (!ogDescription) {
        ogDescription = document.createElement('meta');
        ogDescription.setAttribute('property', 'og:description');
        document.head.appendChild(ogDescription);
    }
    
    if (!ogImage) {
        ogImage = document.createElement('meta');
        ogImage.setAttribute('property', 'og:image');
        document.head.appendChild(ogImage);
    }
    
    if (!ogUrl) {
        ogUrl = document.createElement('meta');
        ogUrl.setAttribute('property', 'og:url');
        document.head.appendChild(ogUrl);
    }
    
    // Atualize os valores das meta tags
    ogTitle.setAttribute('content', product.name + ' - Cabana Açaí');
    ogDescription.setAttribute('content', product.description || 'Peça seu açaí premium com os melhores sabores e acompanhamentos!');
    ogImage.setAttribute('content', product.imageUrl || 'https://i.ibb.co/bJy9VxR/logo-cabana-png.jpg');
    ogUrl.setAttribute('content', shareUrl);
    
    // Para o compartilhamento no WhatsApp, adiciona um timestamp para evitar cache
    const whatsappShareUrl = `${shareUrl}&t=${Date.now()}`;
    const text = `Olha que delícia! ${product.name} da Cabana Açaí 😋🍇`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + whatsappShareUrl)}`;
    window.open(whatsappUrl, '_blank');
});
    
    // Adiciona o botão ao lado do botão de nutrição
    productImage.parentNode.insertBefore(shareBtn, productImage);
    
    modal.querySelectorAll('.video-container, .upgrade-button, .mascot-container, .upgrade-section, .benefits-section').forEach(el => el.remove());
    
    modal.querySelector('.modal-product-image').src = product.imageUrl || '/api/placeholder/800/400';
    modal.querySelector('.modal-product-title').textContent = product.name;
    modal.querySelector('.modal-product-description').textContent = product.description;
    modal.querySelector('.modal-product-price').textContent = `R$ ${product.price.toFixed(2)}`;
    // Adicionar div de insights após o preço
const priceElement = modal.querySelector('.modal-product-price');
if (priceElement) {
    // Criar div de insights
    const insightDiv = document.createElement('div');
    insightDiv.className = 'product-ai-insights';
    insightDiv.style.cssText = 'margin: 1.5rem 0; padding: 1.5rem; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 15px;';
    
    const insightContent = document.createElement('div');
    insightContent.className = 'insight-content';
    insightContent.style.color = 'var(--text)';
    
    insightDiv.appendChild(insightContent);
    
    // Inserir após o preço
    priceElement.parentNode.insertBefore(insightDiv, priceElement.nextSibling);
}

    // Objeto com os benefícios dos acompanhamentos
    const toppingBenefits = {
        'Amendoim': 'Rico em proteínas e gorduras boas, ajuda na construção muscular e fornece energia duradoura.',
        'Granola': 'Fonte de fibras e carboidratos complexos, fornece energia sustentada para seus treinos.',
        'Chocoball': 'Fonte rápida de energia e carboidratos, perfeito para pré-treino.',
        'Côco Ralado': 'Rico em fibras e gorduras boas, ajuda no funcionamento intestinal e fornece energia.',
        'Ovomaltine': 'Fonte de vitaminas e minerais, contribui para a recuperação muscular.',
        'M&M': 'Fonte rápida de energia e açúcares, ideal para reposição de glicose.',
        'Leite condensado': 'Rico em cálcio e carboidratos, fornece energia imediata.',
        'Calda de Morango': 'Fonte de vitamina C e antioxidantes, fortalece o sistema imunológico.',
        'Calda de Chocolate': 'Rica em antioxidantes e magnésio, ajuda no humor e na disposição.',
        'Farinha Láctea': 'Rica em vitaminas e minerais, contribui para a saúde dos ossos.',
        'Leite em pó': 'Excelente fonte de proteínas e cálcio, fundamental para recuperação muscular.',
        'Banana': 'Rica em potássio, ajuda a controlar a pressão arterial e reduz o risco de doenças cardíacas.'
    };

    // Criar seção de benefícios
    const benefitsSection = document.createElement('div');
    benefitsSection.className = 'benefits-section';
    benefitsSection.style.cssText = `
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 15px;
        display: none;
    `;
    benefitsSection.innerHTML = `
        <h3 style="color: white; margin-bottom: 1rem; font-size: 1.2rem;">Benefícios dos itens escolhidos:</h3>
        <div class="benefits-list" style="color: var(--text); line-height: 1.5;"></div>
    `;

    // Verificar status da loja e mostrar popup quando estiver fechada
    realtimeDB.ref('schedule').once('value')
        .then(snapshot => {
            const schedule = snapshot.val() || {};
            const isOpen = isStoreOpenNow(schedule);
            
            if (!isOpen) {
                const popup = document.getElementById('storeClosedPopup');
                if (popup) {
                    popup.classList.add('active');
                }
            }
        });

    Promise.all([
        realtimeDB.ref('menu/toppings').once('value'),
        realtimeDB.ref('extras').once('value')
    ]).then(([toppingsSnapshot, extrasSnapshot]) => {
        const toppings = toppingsSnapshot.val() || {};
        const extras = extrasSnapshot.val() || {};

        const toppingsGrid = modal.querySelector('.toppings-grid');
        toppingsGrid.innerHTML = Object.values(toppings)
            .filter(topping => topping.available)
            .map(topping => `
                <div class="topping-item" data-topping="${topping.name}">
                    ${topping.name}
                    ${topping.price > 0 ? `<span class="topping-price">+R$ ${topping.price.toFixed(2)}</span>` : ''}
                </div>
            `).join('');

        // Função para atualizar benefícios
        function updateBenefits() {
            const selectedToppings = Array.from(document.querySelectorAll('.topping-item.selected'))
                .map(item => item.textContent.trim().replace(/\+R\$.*$/, '').trim());
            
            const benefitsList = benefitsSection.querySelector('.benefits-list');
            benefitsList.innerHTML = '';
            
            if (selectedToppings.length > 0) {
                benefitsSection.style.display = 'block';
                selectedToppings.forEach(topping => {
                    if (toppingBenefits[topping]) {
                        benefitsList.innerHTML += `
                            <p style="margin-bottom: 0.8rem;">
                                <strong style="color: white;">${topping}:</strong> 
                                ${toppingBenefits[topping]}
                            </p>
                        `;
                    }
                });
            } else {
                benefitsSection.style.display = 'none';
            }
        }

        const toppingItems = toppingsGrid.querySelectorAll('.topping-item');
        toppingItems.forEach(item => {
            item.addEventListener('click', () => {
                const isCurrentlySelected = item.classList.contains('selected');
                const selectedToppings = document.querySelectorAll('.topping-item.selected');
                
                if (isCurrentlySelected) {
                    item.classList.remove('selected');
                } else {
                    if (selectedToppings.length < product.toppings.max) {
                        item.classList.add('selected');
                    } else {
                        showNotification(`Você pode selecionar no máximo ${product.toppings.max} acompanhamento${product.toppings.max > 1 ? 's' : ''}!`);
                    }
                }
                validateToppingsSelection(product.toppings.min, product.toppings.max);
                updateTotalPrice(product);
                updateBenefits();
            });
        });

        const extrasGrid = modal.querySelector('.extras-grid');
        extrasGrid.innerHTML = Object.values(extras)
            .filter(extra => extra.available)
            .map(extra => `
                <div class="extra-item" data-extra="${extra.name}">
                    ${extra.name}
                    ${extra.price > 0 ? `<span class="extra-price">+R$ ${extra.price.toFixed(2)}</span>` : ''}
                </div>
            `).join('');

        const extraItems = extrasGrid.querySelectorAll('.extra-item');
        extraItems.forEach(item => {
            item.addEventListener('click', () => {
                item.classList.toggle('selected');
                updateTotalPrice(product);
            });
        });

        // Inserir seção de benefícios antes da seção de extras
        const extrasSection = modal.querySelector('.extras-section');
        if (extrasSection) {
            extrasSection.parentNode.insertBefore(benefitsSection, extrasSection);
        }

        // Mensagem e botão para produtos de 300ml ou 500ml
        if ((product.name.includes('300ml') || product.name.includes('500ml')) && !product.name.includes('1 Litro')) {
            const upgradeSection = document.createElement('div');
            upgradeSection.className = 'upgrade-section';
            upgradeSection.style.cssText = `
                margin: 1.5rem 0;
                padding: 1.5rem;
                background: var(--glass);
                border: 1px solid var(--glass-border);
                border-radius: 15px;
                text-align: center;
                color: var(--text);
                font-size: 1.1rem;
                line-height: 1.5;
            `;

            const nextSize = product.name.includes('300ml') ? '500ml' : '1 Litro';
            const priceDiff = product.name.includes('300ml') ? '5' : '10';

            upgradeSection.innerHTML = `
                <p>${product.name.includes('300ml') 
                    ? 'Sabia que por apenas R$5 a mais você leva quase o dobro de açai, creme e Acompanhamentos? Só clicar no botão abaixo:'
                    : 'Sabia que por apenas R$10 a mais você leva o dobro de açai, o dobro de creme e o dobro de Acompanhamentos? Só clicar no botão abaixo:'
                }</p>
            `;

            const upgradeButton = document.createElement('button');
            upgradeButton.className = 'modal-btn upgrade-button';
            upgradeButton.innerHTML = `Ver opção de ${nextSize}`;
            upgradeButton.onclick = () => switchToSize(nextSize, product.name);
            upgradeButton.style.cssText = `
                background: var(--gradient);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                margin-top: 1rem;
                cursor: pointer;
                width: 100%;
                transition: transform 0.2s ease;
            `;
            upgradeButton.addEventListener('mouseover', () => {
                upgradeButton.style.transform = 'translateY(-2px)';
            });
            upgradeButton.addEventListener('mouseout', () => {
                upgradeButton.style.transform = 'translateY(0)';
            });

            const modalButtons = modal.querySelector('.modal-buttons');
            modalButtons.insertAdjacentElement('beforebegin', upgradeSection);
            upgradeSection.appendChild(upgradeButton);
        }
    });

    modal.style.display = 'block';
}
    
function switchToSize(newSize, currentName) {
    const newProductName = currentName.replace(/500ml|300ml|1 Litro/g, newSize);
    const modal = document.getElementById('productModal');
    
    // Fechar modal atual
    modal.style.display = 'none';
    
    // Buscar o novo produto
    realtimeDB.ref('menu/products').once('value')
        .then(snapshot => {
            const products = snapshot.val();
            const newProduct = Object.values(products)
                .find(p => p.name === newProductName && p.status);
            
            if (newProduct) {
                setTimeout(() => {
                    openProductModal(newProduct);
                }, 100);
            }
        });
}

// Função para gerar um fingerprint do dispositivo
async function generateDeviceFingerprint() {
    const components = [
        navigator.userAgent,
        navigator.language,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency,
        screen.width,
        screen.height,
        navigator.deviceMemory,
        navigator.platform
    ];
    
    const fingerprint = components.join('|');
    const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(fingerprint));
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Função para obter o IP do usuário
async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('Erro ao obter IP:', error);
        return null;
    }
}
    
function validateToppingsSelection(min, max) {
    const selectedToppings = document.querySelectorAll('.topping-item.selected').length;
    
    if (selectedToppings < min) {
        showNotification(`Selecione no mínimo ${min} acompanhamento${min > 1 ? 's' : ''}!`);
        return false;
    }
    
    if (selectedToppings > max) {
        showNotification(`Você pode selecionar no máximo ${max} acompanhamento${max > 1 ? 's' : ''}!`);
        return false;
    }
    
    return true;
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function updateTotalPrice(product) {
    const selectedToppings = document.querySelectorAll('.topping-item.selected');
    const selectedExtras = document.querySelectorAll('.extra-item.selected');
    let totalPrice = product.price;
    
    selectedToppings.forEach(topping => {
        const priceText = topping.querySelector('.topping-price')?.textContent;
        if (priceText) {
            const extraPrice = parseFloat(priceText.replace(/[^0-9.,]/g, '').replace(',', '.'));
            totalPrice += extraPrice;
        }
    });

    selectedExtras.forEach(extra => {
        const priceText = extra.querySelector('.extra-price')?.textContent;
        if (priceText) {
            const extraPrice = parseFloat(priceText.replace(/[^0-9.,]/g, '').replace(',', '.'));
            totalPrice += extraPrice;
        }
    });

    document.querySelector('.modal-product-price').textContent = `R$ ${totalPrice.toFixed(2)}`;
}

function addToCart(product, selectedToppings) {
    console.log('Iniciando addToCart');
    // Verificar se já tem telefone cadastrado
    if (!localStorage.getItem('cartPhone')) {
        console.log('Telefone não encontrado, mostrando modal');
        // Armazenar temporariamente o produto
        window.pendingCartAddition = { product, selectedToppings };
        
        // Criar e mostrar modal de telefone
        createPhoneCollectionModal();
        document.getElementById('phoneCollectionModal').style.display = 'block';
        return;
    }

    // Se já tem número, continua com a adição normal ao carrinho
    const selectedExtras = Array.from(document.querySelectorAll('.extra-item.selected'))
        .map(extra => {
            const priceText = extra.querySelector('.extra-price')?.textContent;
            const extraPrice = priceText ? parseFloat(priceText.replace(/[^0-9.,]/g, '').replace(',', '.')) : 0;
            return {
                name: extra.textContent.trim(),
                price: extraPrice
            };
        });

    const totalExtrasPrice = selectedExtras.reduce((total, extra) => total + extra.price, 0);
    const totalPrice = product.price + totalExtrasPrice;

    if (product.isAcaiDoDia && acaiDoDiaQuantityInCart >= 2) {
        showNotification('Limite de 2 unidades do Açaí do Dia por pedido');
        return;
    }

    cart.push({
        ...product,
        selectedToppings,
        selectedExtras: selectedExtras.map(extra => extra.name),
        price: totalPrice,
        originalPrice: product.originalPrice || product.price
    });

    if (product.isAcaiDoDia) {
        acaiDoDiaQuantityInCart++;
    }

    updateCartCount();
    
    // Fecha o modal do produto e mostra o carrinho
    document.getElementById('productModal').style.display = 'none';
    showCartModal();
}
    
async function applyCoupon() {
    const couponCode = document.getElementById('couponCode').value.toUpperCase();
    const messageDiv = document.getElementById('couponMessage');
    
    if (!couponCode) {
        messageDiv.innerHTML = '<span style="color: var(--error);">Digite um código de cupom</span>';
        return;
    }

    try {
        // Verificar o cupom no Firebase
        const couponsSnapshot = await realtimeDB.ref('coupons').orderByChild('code').equalTo(couponCode).once('value');
        const coupons = couponsSnapshot.val();
        
        if (!coupons) {
            messageDiv.innerHTML = '<span style="color: var(--error);">Cupom inválido</span>';
            appliedCoupon = null;
            updateCartTotal();
            return;
        }

        const coupon = Object.values(coupons)[0];

        // Se for cupom de primeira compra
        if (coupon.isFirstPurchase) {
            // Gerar identificadores únicos
            const deviceFingerprint = await generateDeviceFingerprint();
            const userIP = await getUserIP();
            
            // Verificar no Firebase se já existe uso do cupom com esses identificadores
            const usedCouponsRef = realtimeDB.ref('usedCoupons');
            const query = usedCouponsRef
                .orderByChild('couponCode')
                .equalTo('PRIMEIRACOMPRA');
            
            const usedCouponsSnapshot = await query.once('value');
            const usedCoupons = usedCouponsSnapshot.val() || {};
            
            const hasUsed = Object.values(usedCoupons).some(usage => 
                usage.deviceFingerprint === deviceFingerprint || 
                usage.userIP === userIP
            );

            if (hasUsed) {
                messageDiv.innerHTML = '<span style="color: var(--error);">Este cupom já foi utilizado</span>';
                appliedCoupon = null;
                updateCartTotal();
                return;
            }

            // Armazenar identificadores para uso posterior
            window.deviceFingerprint = deviceFingerprint;
            window.userIP = userIP;
        }

        messageDiv.innerHTML = '<span style="color: #4CAF50;">Cupom aplicado com sucesso!</span>';
        appliedCoupon = coupon;
        updateCartTotal();
        
    } catch (error) {
        console.error('Erro ao aplicar cupom:', error);
        messageDiv.innerHTML = '<span style="color: var(--error);">Erro ao aplicar cupom</span>';
    }
}

function calculateDiscount(subtotal) {
    if (!appliedCoupon) return 0;
    
    if (appliedCoupon.type === 'percentage') {
        return (subtotal * appliedCoupon.discount) / 100;
    } else {
        return appliedCoupon.discount;
    }
}


function showCartModal() {
    const modal = document.getElementById('cartModal');
    const cartItems = modal.querySelector('.cart-items');
    cartItems.innerHTML = '';
    
    let subtotal = 0;
    cart.forEach((item, index) => {
        subtotal += item.price || 0;
        const isCombo = (item.name || '').includes('Combo');
        
        cartItems.innerHTML += `
            <div class="cart-item">
                <div class="cart-item-details">
                    <h3 class="cart-item-title">${item.name || 'Item sem nome'}</h3>
                    ${item.description ? `<p class="cart-item-description" style="white-space: pre-line;">${item.description}</p>` : ''}
                    
                    ${item.selectedToppings && item.selectedToppings.length ? `
                        <div style="font-size: 0.9rem; color: var(--text); margin-top: 0.5rem;">
                            <i class="fas fa-check-circle"></i> Acompanhamentos: ${item.selectedToppings.join(', ')}
                        </div>
                    ` : ''}
                    
                    ${item.selectedExtras && item.selectedExtras.length ? `
                        <div style="font-size: 0.9rem; color: var(--text); margin-top: 0.3rem;">
                            <i class="fas fa-plus-circle"></i> Extras: ${item.selectedExtras.join(', ')}
                        </div>
                    ` : ''}
                </div>
                <div class="cart-item-price">R$ ${(item.price || 0).toFixed(2)}</div>
                <button class="remove-item" onclick="removeFromCart(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });

    updateCartTotal(subtotal);
    modal.style.display = 'block';
}

function updateCartTotal(subtotal = null) {
    const modal = document.getElementById('cartModal');
    if (subtotal === null) {
        subtotal = cart.reduce((total, item) => total + item.price, 0);
    }
    
    const discount = calculateDiscount(subtotal);
    const deliveryFee = 3.00;
    const total = subtotal - discount + deliveryFee;
    
    modal.querySelector('.subtotal span').textContent = subtotal.toFixed(2);
    
    const discountDiv = modal.querySelector('.discount');
    if (discount > 0) {
        discountDiv.style.display = 'block';
        discountDiv.querySelector('span').textContent = discount.toFixed(2);
    } else {
        discountDiv.style.display = 'none';
    }
    
    modal.querySelector('.total span').textContent = total.toFixed(2);
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartCount();
    showCartModal(); // Atualiza a exibição do carrinho
}

function validateToppingsSelection(min, max) {
    const selectedToppings = document.querySelectorAll('.topping-item.selected').length;
    const addToCartBtn = document.querySelector('.modal-btn.add-to-cart');
    
    if (selectedToppings < min) {
        showNotification(`Selecione no mínimo ${min} acompanhamento${min > 1 ? 's' : ''}`);
        addToCartBtn.disabled = true;
        return false;
    }
    
    if (selectedToppings > max) {
        showNotification(`Selecione no máximo ${max} acompanhamento${max > 1 ? 's' : ''}`);
        addToCartBtn.disabled = true;
        return false;
    }
    
    addToCartBtn.disabled = false;
    return true;
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function handleCheckout() {
    document.getElementById('cartModal').style.display = 'none';
    document.getElementById('customerInfoModal').style.display = 'block';
}

function calculateToppingsPrice(selectedToppings) {
    let total = 0;
    selectedToppings.forEach(topping => {
        const price = topping.split(' - R$')[1];
        if (price) {
            total += parseFloat(price);
        }
    });
    return total;
}

function handleCustomerInfo(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const customer = Object.fromEntries(formData);
    
    // Atualiza as informações do cliente
    updateCustomerAndDeliveryInfo(customer, {});
    
    document.getElementById('customerInfoModal').style.display = 'none';
    document.getElementById('deliveryInfoModal').style.display = 'block';
}

async function handleDeliveryInfo(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const deliveryInfo = Object.fromEntries(formData);

    updateCustomerAndDeliveryInfo(customerInfo, delivery);
    
    // Calcular totais
    const subtotal = cart.reduce((total, item) => total + item.price, 0);
    const discount = appliedCoupon ? calculateDiscount(subtotal) : 0;
    const deliveryFee = 3.00;
    const total = subtotal - discount + deliveryFee;

    try {
        // Adiciona log antes de salvar
        console.log('Tentando salvar pedido:', {
            customerInfo,
            deliveryInfo,
            items: cart,
            subtotal,
            discount,
            deliveryFee,
            total
        });

        // Criar o pedido para o Firebase
        const orderData = {
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            customerInfo,
            deliveryInfo: {
                ...deliveryInfo,
                payment: deliveryInfo.payment === 'pix' ? 'online' : deliveryInfo.payment,
            },
            items: cart.map(item => ({
                ...item,
                price: parseFloat(item.price),
                originalPrice: parseFloat(item.originalPrice || item.price),
                selectedToppings: item.selectedToppings || [],
                selectedExtras: item.selectedExtras || [],
                observation: [
                    ...(item.selectedToppings?.length ? [`Acompanhamentos: ${item.selectedToppings.join(", ")}`] : []),
                    ...(item.selectedExtras?.length ? [`Extras: ${item.selectedExtras.join(", ")}`] : [])
                ].join("\n")
            })),
            subtotal: parseFloat(subtotal),
            discount: parseFloat(discount),
            deliveryFee: parseFloat(deliveryFee),
            total: parseFloat(total),
            cupom: appliedCoupon ? appliedCoupon.code : null,
            status: 'open',
            orderTotal: parseFloat(total),
            paymentMethod: deliveryInfo.payment === 'pix' ? 'online' : deliveryInfo.payment,
            id: "5555",
            creationDate: new Date().toISOString(),
            deliveryPoint: {
                address: `${deliveryInfo.address}, ${deliveryInfo.neighborhood}`,
                street: deliveryInfo.address,
                neighborhood: deliveryInfo.neighborhood,
                complement: deliveryInfo.complement || "",
                postalCode: deliveryInfo.zipcode,
                city: "Natal",
                region: "RN",
                country: "BR"
            },
            customer: {
                customerName: customerInfo.fullName,
                customerPhone: customerInfo.whatsapp
            }
        };

        // Salvar pedido no Firebase
        const newOrderRef = await realtimeDB.ref()('orders').push(orderData);
        
        // Log após salvar
        console.log('Pedido salvo com sucesso, ID:', newOrderRef.key);

        // Somente após confirmar que o pedido foi salvo, redirecionar para o WhatsApp
        if (newOrderRef.key) {
            const message = formatOrderForWhatsApp(customerInfo, deliveryInfo);
            const encodedMessage = encodeURIComponent(message);
            window.location.href = `https://wa.me/5584988731028?text=${encodedMessage}`;
        } else {
            throw new Error('Falha ao salvar o pedido');
        }

    } catch (error) {
        // Log de erro
        console.error('Erro ao processar pedido:', error);
        alert('Erro ao processar pedido. Por favor, tente novamente.');
    }
}

function calculatePercentageDiscount(total, percentage) {
    return total * (percentage / 100);
}
    
function updateCartCount() {
    const cartCount = document.querySelector('.cart-count');
    cartCount.textContent = cart.length;
    cartCount.style.display = cart.length ? 'flex' : 'none';
}

function formatOrderForWhatsApp() {
    try {
        const paymentMethodMap = {
            'money': 'Dinheiro',
            'card': 'Cartão',
            'pix': 'PIX',
            'online': 'PIX'
        };

        // Verificar se o carrinho existe e tem itens
        if (!cart || cart.length === 0) {
            throw new Error('Carrinho vazio');
        }

        let message = `*🛍️ Novo Pedido - Cabana Açaí*\n\n`;

        // Informações do cliente - Leitura direta do formulário
        const form = document.getElementById('createOrderForm');
        if (!form) {
            throw new Error('Formulário não encontrado');
        }

        const customerName = form.querySelector('#customerName')?.value || 'Não informado';
        const customerPhone = form.querySelector('#customerPhone')?.value || 'Não informado';
        const street = form.querySelector('#street')?.value || 'Não informado';
        const streetNumber = form.querySelector('#streetNumber')?.value || 'S/N';
        const neighborhood = form.querySelector('#neighborhood')?.value || 'Não informado';
        const complement = form.querySelector('#complement')?.value || '';
        const zipCode = form.querySelector('#zipCode')?.value || 'Não informado';
        const paymentMethod = form.querySelector('input[name="paymentMethod"]:checked')?.value || 'money';

        // Dados do cliente
        message += `*Cliente:* ${customerName}\n`;
        message += `*WhatsApp:* ${customerPhone}\n\n`;

        // Endereço
        message += `*📍 Endereço de Entrega:*\n`;
        message += `${street}, ${streetNumber}\n`;
        if (complement) {
            message += `Complemento: ${complement}\n`;
        }
        message += `Bairro: ${neighborhood}\n`;
        message += `CEP: ${zipCode}\n\n`;

        // Itens do pedido
        message += `*🍨 Itens do Pedido:*\n`;
        cart.forEach((item, index) => {
            message += `${index + 1}. ${item.name}\n`;
            if (item.selectedToppings?.length > 0) {
                message += `   Acompanhamentos: ${item.selectedToppings.join(', ')}\n`;
            }
            if (item.selectedExtras?.length > 0) {
                message += `   Extras: ${item.selectedExtras.join(', ')}\n`;
            }
            if (item.description) {
                message += `   ${item.description}\n`;
            }
            message += `   Valor: R$ ${item.price.toFixed(2)}\n\n`;
        });

        // Cálculos
        const subtotal = cart.reduce((total, item) => total + item.price, 0);
        const discount = appliedCoupon ? calculateDiscount(subtotal) : 0;
        const deliveryFee = 3.00;
        const total = subtotal - discount + deliveryFee;

        // Resumo financeiro
        message += `*💰 Resumo do Pedido:*\n`;
        message += `Subtotal: R$ ${subtotal.toFixed(2)}\n`;
        if (discount > 0) {
            message += `Desconto: -R$ ${discount.toFixed(2)}\n`;
        }
        message += `Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}\n`;
        message += `*Total: R$ ${total.toFixed(2)}*\n\n`;

        // Pagamento
        message += `*💳 Forma de Pagamento:* ${paymentMethodMap[paymentMethod]}\n`;

        // Troco
        if (paymentMethod === 'money') {
            const changeAmount = document.getElementById('changeAmount')?.value;
            if (changeAmount) {
                message += `Troco para: R$ ${changeAmount}\n`;
            }
        }

        // Observações
        const notes = document.getElementById('notes')?.value;
        if (notes?.trim()) {
            message += `\n*📝 Observações:* ${notes.trim()}\n`;
        }

        return message;
    } catch (error) {
        console.error('Erro ao formatar pedido:', error);
        return 'Erro ao formatar pedido. Por favor, tente novamente.';
    }
}
    
function setupPaymentEvents() {
    console.log('Configurando eventos de pagamento do createOrderModal');
    
    // Selecionar elementos dentro do createOrderModal
    const modal = document.getElementById('createOrderModal');
    if (!modal) return;

    const paymentInputs = modal.querySelectorAll('input[name="paymentMethod"]');
    const changeContainer = modal.querySelector('#changeContainer');
    const pixInfo = modal.querySelector('#pixInfo');
    const notes = modal.querySelector('#notes');
    
    paymentInputs.forEach(radio => {
        radio.addEventListener('change', (e) => {
            console.log('Método de pagamento selecionado:', e.target.value);
            
            // Resetar displays
            if (changeContainer) changeContainer.style.display = 'none';
            if (pixInfo) pixInfo.style.display = 'none';
            if (notes) notes.value = '';
            
            switch(e.target.value) {
                case 'money':
                    console.log('Configurando pagamento em dinheiro');
                    if (changeContainer) {
                        changeContainer.style.display = 'block';
                        const changeAmount = changeContainer.querySelector('#changeAmount');
                        if (changeAmount) {
                            changeAmount.onchange = () => {
                                if (notes && changeAmount.value) {
                                    notes.value = `Troco para R$ ${changeAmount.value}`;
                                }
                            };
                        }
                    }
                    break;
                    
                case 'pix':
                case 'online':
                    console.log('Configurando pagamento PIX');
                    if (pixInfo) {
                        pixInfo.style.display = 'block';
                        const orderTotal = modal.querySelector('#orderTotal')?.value || '0.00';
                        console.log('Valor total para PIX:', orderTotal);
                        
                        try {
                            const qrCode = generatePixQRCode(orderTotal);
                            pixInfo.innerHTML = '';
                            pixInfo.appendChild(qrCode);
                        } catch (error) {
                            console.error('Erro ao gerar QR Code:', error);
                            pixInfo.innerHTML = `
                                <div class="pix-fallback">
                                    <strong>Pagamento PIX</strong><br>
                                    <p>Chave PIX (WhatsApp): 84 9 8873-1028</p>
                                    <p>Banco: Santander</p>
                                    <p>Nome: Jackson</p>
                                    <p>Valor: R$ ${orderTotal}</p>
                                    <button class="modal-btn" onclick="showComprovanteUpload()" style="margin-top: 10px;">
                                        <i class="fas fa-check"></i> Já paguei, enviar comprovante
                                    </button>
                                </div>
                            `;
                        }
                    }
                    break;
            }
        });
    });
}
    
// Versão corrigida da função submitOrder
async function submitOrder() {
  try {
    // Modificar o botão para "Aguarde..."
    const submitButton = document.querySelector('#createOrderForm button[type="button"]');
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aguarde...';
    submitButton.style.backgroundColor = '#888'; // Cor mais escura/cinza
    submitButton.disabled = true; // Desabilita o botão para evitar múltiplos cliques
    
    // Obter dados do formulário para validação
    const street = document.getElementById('street').value;
    const streetNumber = document.getElementById('streetNumber').value;
    const neighborhood = document.getElementById('neighborhood').value;
    const zipCode = document.getElementById('zipCode').value;
    
    // Validar o endereço
    const addressValidation = validateAddress(street, streetNumber, neighborhood, zipCode);
    if (!addressValidation.valid) {
      showNotification(addressValidation.message);
      highlightErrorField(addressValidation.field);
      
      // Restaurar o botão
      submitButton.innerHTML = 'Finalizar Pedido';
      submitButton.style.backgroundColor = '';
      submitButton.disabled = false;
      
      return;
    }
    
    // Se o endereço for válido, mostrar resumo do pedido
    showOrderSummaryModal(async function() {
      // ESTE CÓDIGO ORIGINAL É MANTIDO INTACTO
      // Obter o contador atual do localStorage ou inicializar como 1
      let orderCounter = parseInt(localStorage.getItem('orderCounter') || '1');
      
      // Verificar se o contador está dentro do intervalo (1-9)
      if (orderCounter > 9) {
          orderCounter = 1; // Reiniciar para 1 quando atingir 9
      }
      
      // Gerar o ID do pedido com o formato 5555X
      const orderId = `5555${orderCounter}`;
      
      // Incrementar o contador para o próximo pedido
      localStorage.setItem('orderCounter', (orderCounter + 1).toString());
          
      // Mapear métodos de pagamento
      const paymentMethodMap = {
          'money': 'Dinheiro',
          'card': 'Cartão',
          'online': 'PIX',
          'pix': 'PIX'
      };

      // Verificar se o carrinho está vazio
      if (!cart || cart.length === 0) {
          alert('Seu carrinho está vazio!');
          return;
      }

      // Ler dados diretamente do formulário
      const customerName = document.getElementById('customerName').value;
      const customerPhone = document.getElementById('customerPhone').value;
      const street = document.getElementById('street').value;
      const streetNumber = document.getElementById('streetNumber').value;
      const neighborhood = document.getElementById('neighborhood').value;
      const complement = document.getElementById('complement').value;
      const zipCode = document.getElementById('zipCode').value;
      const notes = document.getElementById('notes').value;
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'money';
      
      // Validar campos obrigatórios
      if (!customerName || !customerPhone || !street || !streetNumber || !neighborhood || !zipCode) {
          alert('Por favor, preencha todos os campos obrigatórios');
          return;
      }

      // Calcular valores
      const subtotal = cart.reduce((total, item) => total + item.price, 0);
      const discount = appliedCoupon ? calculateDiscount(subtotal) : 0;
      const deliveryFee = 3.00;
      const total = subtotal - discount + deliveryFee;

      // Preparar objeto para a API no formato original
      const order = {
          id: orderId, // Usando o novo ID gerado com número sequencial
          status: "open",
          paymentMethod: paymentMethod === 'pix' ? 'online' : paymentMethod,
          orderTotal: total,
          orderDetails: cart.map(item => `${item.name} - R$ ${item.price.toFixed(2)}`).join('\n'),
          notes: notes || '',
          deliveryPoint: {
              address: `${street}, ${streetNumber}, ${neighborhood}`,
              street: street,
              houseNumber: streetNumber,
              complement: complement || '',
              postalCode: zipCode,
              city: "Natal",
              region: "RN",
              country: "BR"
          },
          customer: {
              customerPhone: customerPhone,
              customerName: customerName
          }
      };

      // Enviar para API primeiro, mas com timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 segundos timeout

      try {
          const response = await fetch('https://us-central1-cabana-8d55e.cloudfunctions.net/foodyDeliveryApi/createOrder', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': '8d7c77946d534444a168bb7da794febf'
              },
              body: JSON.stringify(order),
              signal: controller.signal
          });
          
          clearTimeout(timeoutId);

          if (!response.ok) {
              throw new Error(`Erro HTTP! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('Pedido criado:', result);
      } catch (error) {
          if (error.name === 'AbortError') {
              console.log('Timeout na API, continuando com WhatsApp...');
          } else {
              console.error('Erro na API:', error);
          }
          // Continua o fluxo mesmo com erro na API
      }

      // Construir mensagem WhatsApp
      let message = `*🛍️ Novo Pedido Nº ${orderId} - Cabana Açaí*\n\n`;
      
      // Dados do cliente
      message += `*Cliente:* ${customerName}\n`;
      message += `*WhatsApp:* ${customerPhone}\n\n`;
      
      // Endereço
      message += `*📍 Endereço de Entrega:*\n`;
      message += `${street}, ${streetNumber}\n`;
      if (complement) {
          message += `Complemento: ${complement}\n`;
      }
      message += `Bairro: ${neighborhood}\n`;
      message += `CEP: ${zipCode}\n\n`;
      
      // Itens do pedido
      message += `*🍨 Itens do Pedido:*\n`;
      cart.forEach((item, index) => {
          message += `${index + 1}. ${item.name}\n`;
          if (item.selectedToppings && item.selectedToppings.length > 0) {
              message += `   Acompanhamentos: ${item.selectedToppings.join(', ')}\n`;
          }
          if (item.selectedExtras && item.selectedExtras.length > 0) {
              message += `   Extras: ${item.selectedExtras.join(', ')}\n`;
          }
          message += `   Valor: R$ ${item.price.toFixed(2)}\n\n`;
      });
      
      // Resumo financeiro
      message += `*💰 Resumo do Pedido:*\n`;
      message += `Subtotal: R$ ${subtotal.toFixed(2)}\n`;
      if (discount > 0) {
          message += `Desconto: -R$ ${discount.toFixed(2)}\n`;
      }
      message += `Taxa de Entrega: R$ ${deliveryFee.toFixed(2)}\n`;
      message += `*Total: R$ ${total.toFixed(2)}*\n\n`;
      
      // Pagamento
      message += `*💳 Forma de Pagamento:* ${paymentMethodMap[paymentMethod]}\n`;
      
      // Se for dinheiro, verificar troco
      if (paymentMethod === 'money') {
          const changeAmount = document.getElementById('changeAmount')?.value;
          if (changeAmount) {
              message += `Troco para: R$ ${changeAmount}\n`;
          }
      }
      
      // Observações
      if (notes?.trim()) {
          message += `\n*📝 Observações:* ${notes}\n`;
      }

      // Salvar no Firebase
      const orderData = {
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          status: 'new',
          customer: {
              name: customerName,
              phone: customerPhone
          },
          address: {
              street,
              number: streetNumber,
              neighborhood,
              complement: complement || '',
              zipCode,
              city: 'Natal',
              state: 'RN'
          },
          payment: {
              method: paymentMethod,
              change: document.getElementById('changeAmount')?.value || null
          },
          items: cart,
          subtotal,
          deliveryFee,
          total,
          notes: notes || ''
      };

      const newOrderRef = await realtimeDB.ref('orders').push(orderData);
      
      if (!newOrderRef.key) {
          throw new Error('Falha ao salvar o pedido');
      }

      // Se houver cupom aplicado, registrar seu uso
      if (appliedCoupon && appliedCoupon.isFirstPurchase) {
          const usedCouponData = {
              couponCode: appliedCoupon.code,
              deviceFingerprint: window.deviceFingerprint,
              userIP: window.userIP,
              usedAt: firebase.database.ServerValue.TIMESTAMP,
              orderTotal: total
          };

          await realtimeDB.ref('usedCoupons').push(usedCouponData);
      }

      // Redirecionar para WhatsApp
      window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(message)}`;
    });

  } catch (error) {
    console.error('Erro ao processar pedido:', error);
    alert('Erro ao processar pedido. Por favor, tente novamente.');
    
    // Restaurar o botão
    const submitButton = document.querySelector('#createOrderForm button[type="button"]');
    submitButton.innerHTML = 'Finalizar Pedido';
    submitButton.style.backgroundColor = '';
    submitButton.disabled = false;
  }
}

// Função para mostrar o resumo do pedido em um modal
function showOrderSummaryModal(onConfirmCallback) {
  // Criar um modal para o resumo do pedido
  const summaryModal = document.createElement('div');
  summaryModal.className = 'modal';
  summaryModal.id = 'orderSummaryModal';
  summaryModal.style.display = 'block';
  summaryModal.style.zIndex = '2000'; // Garantir que fique acima de outros modais
  
  // Calcular totais
  const subtotal = cart.reduce((total, item) => total + item.price, 0);
  const discount = appliedCoupon ? calculateDiscount(subtotal) : 0;
  const deliveryFee = 3.00;
  const total = subtotal - discount + deliveryFee;
  
  // Obter informações do formulário
  const customerName = document.getElementById('customerName').value;
  const street = document.getElementById('street').value;
  const streetNumber = document.getElementById('streetNumber').value;
  const neighborhood = document.getElementById('neighborhood').value;
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'money';
  const paymentMethodText = paymentMethod === 'money' ? 'Dinheiro' : (paymentMethod === 'card' ? 'Cartão' : 'PIX');
  
  // Construir HTML do modal
  let modalHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Confirme seu Pedido</h2>
        <button class="close-modal" onclick="document.getElementById('orderSummaryModal').remove();">&times;</button>
      </div>
      <div style="padding: 1rem;">
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: white; margin-bottom: 0.5rem;">Informações de Entrega</h3>
          <p style="color: var(--text);">
            <strong>Nome:</strong> ${customerName}<br>
            <strong>Endereço:</strong> ${street}, ${streetNumber}, ${neighborhood}<br>
            <strong>Pagamento:</strong> ${paymentMethodText}
          </p>
        </div>
        
        <h3 style="color: white; margin-bottom: 1rem;">Itens do Pedido</h3>
  `;
  
  // Adicionar cada item do carrinho
  cart.forEach(item => {
    modalHTML += `
      <div style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border);">
        <div style="font-weight: 600; color: white;">${item.name}</div>
        ${item.selectedToppings && item.selectedToppings.length ? `
          <div style="font-size: 0.9rem; color: var(--text); margin-top: 0.3rem;">
            <i class="fas fa-check-circle" style="color: var(--accent);"></i> Acompanhamentos: ${item.selectedToppings.join(', ')}
          </div>
        ` : ''}
        ${item.selectedExtras && item.selectedExtras.length ? `
          <div style="font-size: 0.9rem; color: var(--text); margin-top: 0.3rem;">
            <i class="fas fa-plus-circle" style="color: var(--accent);"></i> Extras: ${item.selectedExtras.join(', ')}
          </div>
        ` : ''}
        <div style="display: flex; justify-content: flex-end; font-weight: 600; color: var(--accent); margin-top: 0.5rem;">
          R$ ${item.price.toFixed(2)}
        </div>
      </div>
    `;
  });
  
  // Adicionar os totais
  modalHTML += `
        <div style="margin-top: 1.5rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Subtotal:</span>
            <span>R$ ${subtotal.toFixed(2)}</span>
          </div>
          ${discount > 0 ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #4CAF50;">
              <span>Desconto:</span>
              <span>-R$ ${discount.toFixed(2)}</span>
            </div>
          ` : ''}
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Taxa de Entrega:</span>
            <span>R$ ${deliveryFee.toFixed(2)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-weight: 700; color: var(--accent); font-size: 1.2rem; margin-top: 0.5rem; border-top: 1px solid var(--glass-border); padding-top: 0.5rem;">
            <span>Total:</span>
            <span>R$ ${total.toFixed(2)}</span>
          </div>
        </div>
        
        <div class="modal-buttons" style="margin-top: 1.5rem;">
          <button class="modal-btn add-to-cart" id="confirmOrderBtn">
            Confirmar Pedido
          </button>
          <button class="modal-btn continue-shopping" onclick="document.getElementById('orderSummaryModal').remove(); document.querySelector('#createOrderForm button[type=\\'button\\']').innerHTML = 'Finalizar Pedido'; document.querySelector('#createOrderForm button[type=\\'button\\']').disabled = false; document.querySelector('#createOrderForm button[type=\\'button\\']').style.backgroundColor = '';">
            Editar Pedido
          </button>
        </div>
      </div>
    </div>
  `;
  
  summaryModal.innerHTML = modalHTML;
  document.body.appendChild(summaryModal);
  
  // Adicionar evento ao botão de confirmar
  document.getElementById('confirmOrderBtn').addEventListener('click', function() {
    document.getElementById('orderSummaryModal').remove();
    if (typeof onConfirmCallback === 'function') {
      onConfirmCallback();
    }
  });
}

// Função para validação de endereço
function validateAddress(street, number, neighborhood, zipcode) {
  // Verificar se o endereço tem conteúdo válido
  if (!street || street.trim().length < 3) {
    return {
      valid: false,
      message: "Por favor, informe um endereço válido",
      field: "street"
    };
  }
  
  // Verificar se o número está presente
  if (!number) {
    return {
      valid: false,
      message: "Por favor, informe o número do endereço",
      field: "streetNumber"
    };
  }
  
  // Verificar se o bairro está presente
  if (!neighborhood || neighborhood.trim().length < 2) {
    return {
      valid: false,
      message: "Por favor, informe um bairro válido",
      field: "neighborhood"
    };
  }
  
  // Verificar formato do CEP (básico)
  const cepRegex = /^\d{5}-?\d{3}$/;
  if (!zipcode || !cepRegex.test(zipcode.replace(/\s/g, ''))) {
    return {
      valid: false,
      message: "Por favor, informe um CEP válido no formato 59000-000",
      field: "zipCode"
    };
  }
  
  return { valid: true };
}

// Função para destacar campos com erro
function highlightErrorField(fieldId) {
  const field = document.getElementById(fieldId);
  if (field) {
    // Salvar o estilo original
    const originalBorder = field.style.border;
    
    // Adicionar estilo de erro
    field.style.border = '2px solid var(--error)';
    field.classList.add('error-shake');
    field.focus();
    
    // Restaurar o estilo original após 3 segundos
    setTimeout(() => {
      field.style.border = originalBorder;
      field.classList.remove('error-shake');
    }, 3000);
  }
}

// Modificar função submitOrder existente
const originalSubmitOrder = submitOrder;
submitOrder = async function(...args) {
    // Marcar pedido como completo
    localStorage.setItem('orderCompleted', 'true');
    
    // Atualizar status na planilha
    const phone = localStorage.getItem('cartPhone');
    if (phone) {
        await updateSMSStatus(phone, 'completed');
    }

    // Continuar com o envio normal do pedido
    return originalSubmitOrder.apply(this, args);
};
    
function formatOrderForWhatsApp(customerInfo, deliveryInfo) {
    const paymentMethodMap = {
        'money': 'Dinheiro',
        'card': 'Cartão',
        'online': 'PIX'
    };

    // Usar o mesmo ID de pedido gerado
    const orderId = document.getElementById('orderId').value;

    let message = `*🛍️ Novo Pedido Nº ${orderId} - Cabana Açaí*\n\n`;
    
    // Informações do cliente
    message += `*Cliente:* ${deliveryInfo.customerName}\n`;
    message += `*WhatsApp:* ${customerInfo.whatsapp}\n\n`;
    
    // Endereço
    message += `*📍 Endereço de Entrega:*\n`;
    message += `${deliveryInfo.street}, ${deliveryInfo.streetNumber}\n`;
    if (deliveryInfo.complement) message += `Complemento: ${deliveryInfo.complement}\n`;
    message += `Bairro: ${deliveryInfo.neighborhood}\n`;
    message += `CEP: ${deliveryInfo.zipCode}\n\n`;
    
    // Detalhes do pedido do textarea
    message += `*🍨 Itens do Pedido:*\n`;
    const orderDetails = document.getElementById('orderDetails').value;
    message += `${orderDetails}\n`;

    // Total do pedido
    const orderTotal = document.getElementById('orderTotal').value;
    
    // Resumo do pedido
    message += `*💰 Resumo do Pedido:*\n`;
    message += `*Total:* R$ ${parseFloat(orderTotal).toFixed(2)}\n`;
    
    // Pagamento
    message += `*💳 Forma de Pagamento:* ${paymentMethodMap[deliveryInfo.payment]}\n`;
    if (deliveryInfo.payment === 'money' && deliveryInfo.change) {
        message += `Troco para: R$ ${deliveryInfo.change}\n`;
    }
    
    // Observações
    const notes = document.getElementById('notes').value;
    if (notes) {
        message += `*Observações:* ${notes}\n`;
    }
    
    return message;
}

function closeCreateOrderModal() {
    document.getElementById('createOrderModal').style.display = 'none';
}

window.addEventListener('load', function() {
  const mascot = document.getElementById('mascot');
  const messages = [
    "Olá! Bem-vindo à Cabana Açaí! 😊",
    "Que tal um açaí delicioso hoje? 🍇",
    "Experimente nossos combos! 🥄",
    "Posso ajudar você a escolher? 😃"
  ];
  let messageIndex = 0;
  
  // Mostra o mascote com fade
  setTimeout(() => {
    mascot.style.opacity = '1';
  }, 500);
  
  mascot.addEventListener('click', function() {
    const bubble = mascot.querySelector('.speech-bubble p');
    messageIndex = (messageIndex + 1) % messages.length;
    bubble.textContent = messages[messageIndex];
  });
});

async function submitOrderFromDigitalMenu() {
    const order = {
        id: document.getElementById('orderId').value,
        status: document.getElementById('status').value,
        paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
        orderTotal: Number(document.getElementById('orderTotal').value),
        notes: document.getElementById('notes').value,
        orderDetails: document.getElementById('orderDetails').value,
        deliveryPoint: {
            address: `${document.getElementById('street').value}, ${document.getElementById('streetNumber').value}, ${document.getElementById('neighborhood').value}`,
            street: document.getElementById('street').value,
            houseNumber: document.getElementById('streetNumber').value,
            complement: document.getElementById('complement').value,
            postalCode: document.getElementById('zipCode').value,
            city: "Natal",
            region: "RN",
            country: "BR"
        },
        customer: {
            customerPhone: document.getElementById('customerPhone').value,
            customerName: document.getElementById('customerName').value
        }
    };
    
    try {
        // Usar a mesma URL do PDV
        const response = await fetch('https://us-central1-cabana-8d55e.cloudfunctions.net/foodyDeliveryApi/createOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': '8d7c77946d534444a168bb7da794febf' // Substitua pelo token real
            },
            body: JSON.stringify(order)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Pedido criado:', result);
        
        // Redirecionar para WhatsApp
        const message = formatOrderForWhatsApp(customerInfo, order);
        window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(message)}`;
        
    } catch (error) {
        console.error('Erro ao criar pedido:', error);
        alert('Erro ao criar pedido: ' + error.message);
    }
}

// Função para adicionar o mascote nos produtos
// Sistema de rastreamento de visualizações
const productViewHistory = {
    lastProduct: null,
    viewCounts: {},
    sizeViewCounts: {
        '500ml': 0,
        '1L': 0
    },
    usedMessages: {
        '500ml': new Set(),
        '1L': new Set()
    },
    dicsText: "Quer dicas de acompanhamentos ou saber curiosidades sobre a origem dos sabores? é só clicar ou dar um toque em mim.",
    
    getVideoUrl: function(size, count) {
        if (size === '1L') {
            return 'https://firebasestorage.googleapis.com/v0/b/cabana-8d55e.firebasestorage.app/o/Acai%201%20Litro.mp4?alt=media&token=6caa0bef-e4f9-44ee-823e-5d1205f3ed1f';
        } else {
            // Para 500ml, alterna entre os dois vídeos
            const isAlternateVideo = count % 2 === 1; // Se for ímpar, usa o vídeo alternativo
            return isAlternateVideo 
                ? 'https://firebasestorage.googleapis.com/v0/b/cabana-8d55e.firebasestorage.app/o/V%C3%ADdeo%20sem%20t%C3%ADtulo%20(1).mp4?alt=media&token=f8f4d13e-d648-486d-ac49-5325c681f625'
                : 'https://firebasestorage.googleapis.com/v0/b/cabana-8d55e.firebasestorage.app/o/V%C3%ADdeo%20sem%20t%C3%ADtulo.mp4?alt=media&token=66d8d710-8d8b-4861-b493-fa6a107145f8';
        }
    },

    getNextMessage: function(size, messages) {
        const usedSet = this.usedMessages[size];
        
        if (usedSet.size >= messages.length) {
            usedSet.clear();
        }
        
        const availableMessages = messages.filter(msg => !usedSet.has(msg));
        const selectedMessage = availableMessages[Math.floor(Math.random() * availableMessages.length)];
        
        usedSet.add(selectedMessage);
        
        return `${selectedMessage} ${this.dicsText}`;
    },
    
    getContextualMessage: function(productTitle) {
        const is1L = productTitle.includes('1L') || productTitle.includes('1 Litro');
        const size = is1L ? '1L' : '500ml';
        const sizeCount = this.sizeViewCounts[size];
        const isReturningToSameProduct = this.lastProduct === productTitle;

        // Mensagens para produtos de 500ml
        const messages500ml = {
            firstView: "Oi, td bem? Me chamo Sabrina, sou especialista em Açaí. " + this.dicsText,
            sameSize: [
                "O de 500ml é perfeito pra matar a vontade, né? 😋",
                "Gostou do tamanho 500ml? É o nosso best-seller!",
                "500ml é o tamanho ideal pra um momento de açaí perfeito!",
                "Tá curtindo os nossos de 500ml? São demais, né?",
                "Esse tamanho é o queridinho da galera!",
                "O Açaí de 500ml é tipo aquele amigo que nunca decepciona 😉",
                "Com 500ml dá pra experimentar vários acompanhamentos!",
                "Sabia que o de 500ml é o tamanho mais pedido?",
                "500ml: nem muito, nem pouco... é o tamanho perfeito!",
                "Tá explorando os sabores de 500ml? Ótima escolha!"
            ],
            returningProduct: [
                "Esse açaí tá te chamando, hein? 😋",
                "Voltou pra esse sabor? Ele é especial mesmo!",
                "Tá pensando bem nesse, né? Ótima escolha!"
            ]
        };

        // Mensagens para produtos de 1 Litro
        const messages1L = {
            firstView: "Oi, td bem? Me chamo Sabrina, sou especialista em Açaí. " + this.dicsText,
            sameSize: [
                "1 Litro é 1 Litro, né? Não tem comparação, kkk",
                "Tou vendo que você quer mesmo é 1 Litro, vamos lá.. arrasa aí nos acompanhamentos!",
                "Já decidiu pelo 1 Litro? Você sabe o que quer! 😎",
                "Com 1 Litro a diversão dura mais! 🎉",
                "Quem escolhe 1 Litro sabe das coisas! 😉",
                "1 Litro é pra quem não brinca em serviço! 💪",
                "Tá no time do 1 Litro? É assim que se faz!",
                "1 Litro é garantia de festa boa! 🎈",
                "Mais açaí = mais felicidade! E 1 Litro tem de sobra!",
                "Com 1 Litro você vira o mestre do açaí! 👑"
            ],
            returningProduct: [
                "Esse 1 Litro tá te conquistando, né? 😊",
                "Voltou pro grandão? É uma excelente escolha!",
                "Tá pensando nesse 1 Litro? Vai ser sucesso!"
            ]
        };

        const messages = is1L ? messages1L : messages500ml;

        // Lógica de seleção de mensagem
        if (sizeCount === 0) {
            return messages.firstView;
        } else if (isReturningToSameProduct && this.viewCounts[productTitle] > 1) {
            // Se voltou ao mesmo produto exato
            const returningMessages = messages.returningProduct;
            const index = Math.min(this.viewCounts[productTitle] - 2, returningMessages.length - 1);
            return `${returningMessages[index]} ${this.dicsText}`;
        } else {
            // Se já viu outro produto do mesmo tamanho
            return this.getNextMessage(size, messages.sameSize);
        }
    },
    updateHistory: function(productTitle) {
        const is1L = productTitle.includes('1L') || productTitle.includes('1 Litro');
        const size = is1L ? '1L' : '500ml';
        
        if (this.lastProduct !== productTitle) {
            this.sizeViewCounts[size] += 1;
        }
        
        this.viewCounts[productTitle] = (this.viewCounts[productTitle] || 0) + 1;
        this.lastProduct = productTitle;
    }
};

// Função para adicionar o mascote nos produtos
function addMascotToProduct(modalContent, productSize) {
    // Remove qualquer container de mascote existente
    const existingMascot = modalContent.querySelector('.mascot-section');
    if (existingMascot) {
        existingMascot.remove();
    }

    // Pegar o título do produto
    const productTitle = modalContent.querySelector('.modal-product-title').textContent;

    // Definir URL do vídeo baseado no tamanho e contagem
    const videoUrl = productViewHistory.getVideoUrl(productSize, productViewHistory.sizeViewCounts[productSize]);

    // Criar container do mascote e diálogo como uma seção separada
    const mascotSection = document.createElement('div');
    mascotSection.className = 'mascot-section';
    mascotSection.style.cssText = `
        margin: 2rem 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    `;

    // Container do mascote
    const mascotContainer = document.createElement('div');
    mascotContainer.className = 'sabrina-mascot-container';
    mascotContainer.style.cssText = `
        width: 200px;
        height: 200px;
        position: relative;
        cursor: pointer;
    `;

    // Adicionar vídeo
    const video = document.createElement('video');
    video.style.cssText = `
        width: 100%;
        height: 100%;
        border-radius: 10px;
        object-fit: cover;
    `;
    video.src = videoUrl;
    video.loop = true;

    // Container para o balão de diálogo
    const dialogContainer = document.createElement('div');
    dialogContainer.style.cssText = `
        position: relative;
        width: 300px;
        margin-top: 15px;
        margin-bottom: 20px;
    `;

    // Adicionar balão de diálogo
    const dialogBubble = document.createElement('div');
    dialogBubble.className = 'dialog-bubble';
    dialogBubble.style.cssText = `
        background: var(--glass);
        border: 1px solid var(--glass-border);
        padding: 1rem;
        border-radius: 15px;
        font-size: 0.9rem;
        color: var(--text);
        backdrop-filter: blur(10px);
        text-align: left;
        position: relative;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    `;
    dialogBubble.textContent = productViewHistory.getContextualMessage(productTitle);

    // Adicionar a seta do diálogo
    const dialogArrow = document.createElement('div');
    dialogArrow.style.cssText = `
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 10px solid var(--glass-border);
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
    `;

    // Adicionar a seta interna do diálogo
    const dialogArrowInner = document.createElement('div');
    dialogArrowInner.style.cssText = `
        width: 0;
        height: 0;
        border-left: 9px solid transparent;
        border-right: 9px solid transparent;
        border-bottom: 9px solid var(--glass);
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
    `;

    dialogBubble.appendChild(dialogArrow);
    dialogBubble.appendChild(dialogArrowInner);
    dialogContainer.appendChild(dialogBubble);
    mascotContainer.appendChild(video);
    mascotSection.appendChild(mascotContainer);
    mascotSection.appendChild(dialogContainer);

    // Adicionar evento de clique
    let isPlaying = false;
    mascotContainer.addEventListener('click', () => {
        if (isPlaying) {
            video.pause();
        } else {
            video.play();
        }
        isPlaying = !isPlaying;
    });

    // Adicionar estilos responsivos
    const style = document.createElement('style');
    style.textContent = `
        .mascot-section {
            margin: 2rem 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }
        @media (max-width: 768px) {
            .sabrina-mascot-container {
                width: 150px;
                height: 150px;
            }
            .mascot-section div[style*="width: 300px"] {
                width: 250px !important;
            }
            .dialog-bubble {
                font-size: 0.8rem;
                padding: 0.75rem;
            }
        }
        @media (max-width: 480px) {
            .sabrina-mascot-container {
                width: 120px;
                height: 120px;
            }
            .mascot-section div[style*="width: 300px"] {
                width: 200px !important;
            }
            .dialog-bubble {
                font-size: 0.75rem;
                padding: 0.75rem;
            }
        }
    `;
    document.head.appendChild(style);

    // Inserir todo o conteúdo do mascote antes da seção de acompanhamentos
    const toppingsSection = modalContent.querySelector('.toppings-section');
    if (toppingsSection) {
        toppingsSection.parentNode.insertBefore(mascotSection, toppingsSection);
    }
}

// Atualizar a função openProductModal 
const originalOpenProductModal = openProductModal;
openProductModal = async function(product) {
    // Chama a implementação original primeiro
    originalOpenProductModal(product);
    
    // Pegar referência ao modal
    const modal = document.getElementById('productModal');
    
    // Remover insights anteriores
    const existingInsights = modal.querySelectorAll('.product-ai-insights');
    existingInsights.forEach(insight => insight.remove());

    // Adicionar novo insight após o preço
    const priceElement = modal.querySelector('.modal-product-price');
    if (priceElement) {
        // Criar div de insights
        const insightDiv = document.createElement('div');
        insightDiv.className = 'product-ai-insights';
        insightDiv.style.cssText = 'margin: 1.5rem 0; padding: 1.5rem; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 15px;';
        
        const insightContent = document.createElement('div');
        insightContent.className = 'insight-content';
        insightContent.style.color = 'var(--text)';
        
        insightDiv.appendChild(insightContent);
        
        // Inserir após o preço
        priceElement.parentNode.insertBefore(insightDiv, priceElement.nextSibling);

        // Mostrar loading
        insightContent.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="spinner" style="width: 20px; height: 20px; border: 2px solid var(--glass-border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>Carregando descrição...</span>
            </div>
        `;

        // Obter insight do chatbot
        const insight = await getProductInsight(product.name);
        
        if (insight) {
            // Anima a transição do texto
            insightContent.style.opacity = '0';
            setTimeout(() => {
                insightContent.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <i class="fas fa-lightbulb" style="color: var(--accent); font-size: 1.2rem; margin-top: 3px;"></i>
                        <div>
                            <div style="color: white; margin-bottom: 4px; font-weight: 500;">Descrição do Produto</div>
                            <div style="line-height: 1.5;">${insight}</div>
                        </div>
                    </div>
                `;
                insightContent.style.opacity = '1';
            }, 300);
        } else {
            insightContent.innerHTML = '';
        }
    }
};
    
// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Limpar dados do carrinho anterior (ADICIONAR ESTAS LINHAS PRIMEIRO)
    localStorage.removeItem('cartPhone');
    localStorage.removeItem('cartTimestamp');
    localStorage.removeItem('orderCompleted');
    console.log('LocalStorage limpo');
   
    console.log('DOM Carregado'); // Log para diagnóstico

    addTimeMachineButton(); // Adiciona o botão do Time Machine
    openProductByUrlParam();
    
    // Configurar estrutura do chat
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer) {
        chatContainer.innerHTML = `
            <div class="chat-header">
                <span>Chat Cabana Açaí</span>
                <i class="fas fa-times" onclick="toggleChat()"></i>
            </div>
            <div class="chat-messages"></div>
            <div class="chat-input-container">
                <div class="input-row">
                    <input type="text" class="chat-input" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="audio-row">
                    <button class="audio-button-full" onclick="gravarAudio()">
                        <i class="fas fa-microphone"></i> Gravar Áudio
                    </button>
                </div>
                <div class="recording-indicator" style="display: none;">
                    <div class="audio-waves">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <button class="stop-recording" onclick="pararGravacao()">
                        <i class="fas fa-stop"></i> Parar Gravação
                    </button>
                </div>
            </div>
        `;
    }
    
    // Evento para o ícone do carrinho
    const cartIcon = document.querySelector('.cart-icon');
    if (cartIcon) {
        cartIcon.addEventListener('click', showCartModal);
    } else {
        console.error('Ícone do carrinho não encontrado');
    }
    
    // Evento para botão de checkout
    const checkoutButton = document.querySelector('.checkout');
    if (checkoutButton) {
        checkoutButton.addEventListener('click', () => {
            console.log('Botão de checkout clicado');
            showCreateOrderModal();
        });
    } 

    // Event listeners para fechar modais
    document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Firebase listeners
    loadMenuProducts();
    loadCategories();
    checkStoreStatus();
    setInterval(checkStoreStatus, 60000);
    setupPaymentEvents();

    // Configuração do Intersection Observer para o mascote
    const mascotVideo = document.querySelector('.mascot-video');
    if (mascotVideo) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    mascotVideo.play();
                } else {
                    mascotVideo.pause();
                }
            });
        }, {
            threshold: 0.5
        });

        observer.observe(mascotVideo);

        mascotVideo.addEventListener('click', () => {
            if (mascotVideo.paused) {
                mascotVideo.play();
            } else {
                mascotVideo.pause();
            }
        });
    }
      // Adicione estas linhas no final, antes do fechamento da função
  setTimeout(function() {
    window.openProductByUrlParam();
  }, 1000);
}); // Fechamento do DOMContentLoaded
   
   // Categories
// Dentro da função updateCategoryButtons ou onde estiver o listener das categorias
document.querySelectorAll('.category-btn').forEach(button => {
    button.addEventListener('click', () => {
        document.querySelector('.category-btn.active')?.classList.remove('active');
        button.classList.add('active');
        
        const categoryId = button.dataset.category;
        if (categoryId === 'combo') {
            const comboModal = document.getElementById('comboModal');
            if (comboModal) {
                comboModal.style.display = 'block';
                resetComboBuilder(); // Reseta o estado do combo
                initComboBuilder(); // Inicializa o combo builder
            }
        } else {
            const filteredProducts = categoryId === 'all' 
                ? currentProducts 
                : currentProducts.filter(p => p.category === categoryId);
            displayProducts(filteredProducts);
        }
    });
});


   // Search
   document.getElementById('searchInput').addEventListener('input', (e) => {
       const searchTerm = e.target.value.toLowerCase();
       const filteredProducts = currentProducts.filter(product => 
           product.name.toLowerCase().includes(searchTerm) ||
           product.description.toLowerCase().includes(searchTerm)
       );
       displayProducts(filteredProducts);
   });

   // Modal closes
document.querySelectorAll('.close-modal').forEach(button => {
    button.addEventListener('click', (e) => {
        const modal = e.target.closest('.modal');
        if (modal) {
            modal.style.display = 'none';
        }
    });
});

// Continue shopping buttons
document.querySelectorAll('.continue-shopping').forEach(button => {
    button.addEventListener('click', () => {
        // Close all modals
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
        
        // Scroll to top of the page
        window.scrollTo(0, 0);
    });
});
    
   // Cart
   document.querySelector('.cart-icon').addEventListener('click', showCartModal);
   document.querySelector('.checkout').addEventListener('click', handleCheckout);
   document.getElementById('customerInfoForm').addEventListener('submit', handleCustomerInfo);
   document.getElementById('deliveryInfoForm').addEventListener('submit', handleDeliveryInfo);
   
   // Payment options
   document.querySelectorAll('input[name="payment"]').forEach(radio => {
       radio.addEventListener('change', (e) => {
           document.getElementById('changeContainer').style.display = 
               e.target.value === 'money' ? 'block' : 'none';
           document.getElementById('pixInfo').style.display = 
               e.target.value === 'pix' ? 'block' : 'none';
       });
   });

   // Continue shopping
   document.querySelector('.continue-shopping').addEventListener('click', () => {
       document.getElementById('cartModal').style.display = 'none';
   });

   // Add to cart from modal
   document.querySelector('.add-to-cart').addEventListener('click', () => {
       const selectedToppings = Array.from(document.querySelectorAll('.topping-item.selected'))
           .map(item => item.textContent.trim());
       if (validateToppingsSelection(currentProduct.toppings.min, currentProduct.toppings.max)) {
           addToCart(currentProduct, selectedToppings);
           document.getElementById('productModal').style.display = 'none';
       }
   });
    function closeStoreClosedPopup() {
    const popup = document.getElementById('storeClosedPopup');
    if (popup) {
        popup.classList.remove('active');
    }
}
    // Função para alternar a exibição das opções
function toggleOccasionAssistant() {
    const options = document.getElementById('assistantOptions');
    options.classList.toggle('active');
}

async function selectOccasion(occasion) {
    const occasionMap = {
        'romantic': 'um encontro romântico',
        'party': 'uma festa com amigos',
        'pre-workout': 'antes do treino',
        'post-workout': 'depois do treino',
        'dessert': 'uma sobremesa especial',
        'gift': 'presentear alguém especial'
    };

    // Criar e mostrar feedback imediatamente
    const notification = document.createElement('div');
    notification.className = 'recommendation-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <div style="text-align: center;">
                <h3 style="color: white; margin-bottom: 1rem;">
                    🤔 Pensando na melhor sugestão...
                </h3>
                <p style="color: var(--text); margin-bottom: 1rem;">
                    ✨ Escolhendo algo especial para ${occasionMap[occasion]} ✨
                </p>
                <div class="spinner"></div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);

    try {
        const prompt = `Sugira o melhor produto para ${occasionMap[occasion]}, em no máximo 15 palavras. Seja direto, sem sugerir pedido ou oferecer ajuda.`;
        
        const response = await fetch('https://www.chatbase.co/api/v1/chat', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 6564b636-1a71-4a0f-9863-7c87e586384a',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [{ content: prompt, role: 'user' }],
                chatbotId: 'PpgNSIgeYN1FCucFGP4w3',
                stream: false,
                temperature: 0
            })
        });

        const data = await response.json();
        const recommendation = data.text;

        notification.innerHTML = `
            <div class="notification-content">
                <h3 style="color: white; margin-bottom: 1rem;">
                    <i class="fas fa-star" style="color: var(--accent);"></i>
                    Sugestão para ${occasionMap[occasion]}
                </h3>
                <div style="background: var(--glass); padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                    ${recommendation}
                </div>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: var(--gradient); color: white; border: none; padding: 0.8rem 1.5rem; 
                        border-radius: 25px; cursor: pointer; width: 100%; margin-top: 1rem;">
                    Entendi
                </button>
            </div>
        `;

        // Remover notificação após 12 segundos
        setTimeout(() => {
            notification.remove();
        }, 12000);

    } catch (error) {
        console.error('Erro ao obter sugestão:', error);
        notification.remove();
    }
}

async function getProductInsight(productName) {
    try {
        const prompt = `uma descrição em poucas palavras do ${productName}, diga apenas '${productName}: descrição'`;
        
        const response = await fetch('https://www.chatbase.co/api/v1/chat', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 6564b636-1a71-4a0f-9863-7c87e586384a',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [{ content: prompt, role: 'user' }],
                chatbotId: 'PpgNSIgeYN1FCucFGP4w3',
                stream: false,
                temperature: 0
            })
        });

        const data = await response.json();
        return data.text;
    } catch (error) {
        console.error('Erro ao obter insight:', error);
        return null;
    }
}

function showRecommendation(message, products, toppings) {
    const notification = document.createElement('div');
    notification.className = 'recommendation-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <h3>${message}</h3>
            <ul>
                ${products.map(product => `<li>${product}</li>`).join('')}
            </ul>
            <p><strong>Acompanhamentos recomendados:</strong> ${toppings.join(', ')}</p>
            <button onclick="this.parentElement.parentElement.remove()">Fechar</button>
        </div>
    `;
    document.body.appendChild(notification);

    // Remover a notificação após 12 segundos
    setTimeout(() => {
        notification.remove();
    }, 12000);
}

// Função para filtrar produtos pela ocasião
function filterProductsByOccasion(products) {
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach(card => {
        const productName = card.querySelector('.product-title').textContent;
        if (products.includes(productName)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

    function startVoiceSearch() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showNotification('Seu navegador não suporta pesquisa por voz');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = false;
    recognition.interimResults = false;

    const voiceBtn = document.querySelector('.voice-search-btn');
    const searchInput = document.getElementById('searchInput');

    // Feedback visual
    let feedbackDiv = document.querySelector('.voice-feedback');
    if (!feedbackDiv) {
        feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'voice-feedback';
        document.body.appendChild(feedbackDiv);
    }

    voiceBtn.classList.add('listening');
    feedbackDiv.innerHTML = `
        <i class="fas fa-microphone" style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;"></i>
        <p>Ouvindo... Fale o que você procura</p>
    `;
    feedbackDiv.classList.add('active');

    recognition.onresult = function(event) {
        const result = event.results[0][0].transcript.toLowerCase();
        searchInput.value = result;
        voiceBtn.classList.remove('listening');
        feedbackDiv.classList.remove('active');
        
        // Busca exata pela palavra-chave
        const palavraChave = result.trim();
        const filteredProducts = currentProducts.filter(product => {
            const productNameLower = product.name.toLowerCase();
            return productNameLower.includes(palavraChave);
        });

        displayProducts(filteredProducts);

        if (filteredProducts.length === 0) {
            showNotification('Nenhum produto encontrado com esse nome');
            displayProducts(currentProducts); // Mostra todos os produtos
        }
    };

    recognition.onerror = function(event) {
        console.error('Erro no reconhecimento de voz:', event.error);
        voiceBtn.classList.remove('listening');
        feedbackDiv.classList.remove('active');
        showNotification('Ops! Não consegui entender. Tente novamente.');
    };

    recognition.onend = function() {
        voiceBtn.classList.remove('listening');
        feedbackDiv.classList.remove('active');
    };

    recognition.start();
}

function initAcaiDoDia() {
    // Selecionar produto aleatório uma vez por dia
    const today = new Date().toLocaleDateString();
    let selectedProduct = JSON.parse(localStorage.getItem('acaiDoDia'));
    
if (!selectedProduct || selectedProduct.date !== today) {
    localStorage.removeItem('acaiDoDiaUnitsSold'); // Reseta contagem quando muda o dia
    realtimeDB.ref('menu/products').once('value')
        .then(snapshot => {
                const products = Object.values(snapshot.val() || {})
                    .filter(p => p.status && 
                             (p.name.includes('500ml') || p.name.includes('1 Litro')) &&
                             !p.name.includes('300ml'));
                
                const randomProduct = products[Math.floor(Math.random() * products.length)];
                selectedProduct = {
                    ...randomProduct,
                    date: today,
                    originalPrice: randomProduct.price,
                    price: randomProduct.price * 0.85 // 15% de desconto
                };
                
                localStorage.setItem('acaiDoDia', JSON.stringify(selectedProduct));
                createAcaiDoDiaElement(selectedProduct);
            });
    } else {
        createAcaiDoDiaElement(selectedProduct);
    }
}

function createAcaiDoDiaElement(product) {
    // Primeiro, verifica se já existe um Açaí do Dia na página
    const existingAcai = document.querySelector('.acai-do-dia');
    if (existingAcai) {
        existingAcai.remove(); // Remove se já existir
    }

    const acaiHTML = `
        <div class="acai-do-dia">
            <div class="acai-deal-badge">Açaí do Dia</div>
            <div class="acai-content">
                <img src="${product.imageUrl || '/api/placeholder/400/400'}" alt="${product.name}" class="acai-image">
                <div class="acai-info">
                    <h2 class="acai-title">${product.name}</h2>
                    <p class="acai-description">${product.description}</p>
                    <div class="price-container">
                        <span class="original-price">R$ ${product.originalPrice.toFixed(2)}</span>
                        <span class="deal-price">R$ ${product.price.toFixed(2)}</span>
                    </div>
                    <div class="stats-container">
                        <div class="stat-item">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="units-sold">7 unidades vendidas hoje</span>
                        </div>
                        <div class="countdown">
                            <i class="fas fa-clock"></i>
                            <span>Oferta expira em: <span class="time-left"></span></span>
                        </div>
                    </div>
                    <button class="add-deal-btn" onclick="addAcaiDoDiaToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                        Adicionar à Sacola
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const storeStatus = document.querySelector('.store-status');
    if (storeStatus) {
        storeStatus.insertAdjacentHTML('afterend', acaiHTML);
        updateCountdown();
        setInterval(updateCountdown, 1000);
        simulateUnitsSold();
    }
}

async function getOccasionSuggestion(occasion) {
    try {
        const prompt = `Sugira o melhor produto para ${occasion}, considerando os acompanhamentos, seja breve e direto, sem falar preços, sem me pedir pra fazer pedido, apenas sugestão.`;
        
        const response = await fetch('https://www.chatbase.co/api/v1/chat', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 6564b636-1a71-4a0f-9863-7c87e586384a',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [{ content: prompt, role: 'user' }],
                chatbotId: 'PpgNSIgeYN1FCucFGP4w3',
                stream: false,
                temperature: 0
            })
        });

        const data = await response.json();
        return data.text;
    } catch (error) {
        console.error('Erro ao obter sugestão:', error);
        return null;
    }
}

function updateCountdown() {
    const now = new Date();
    const endOfDay = new Date();
    endOfDay.setHours(23, 59, 59, 999);
    
    const timeLeft = endOfDay - now;
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    
    const timeLeftElement = document.querySelector('.time-left');
    if (timeLeftElement) {
        timeLeftElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
    }
}

function simulateUnitsSold() {
    const startTime = new Date();
    startTime.setHours(12, 30, 0);
    
    const now = new Date();
    const elapsedMinutes = (now - startTime) / (1000 * 60);
    
    // Pega o valor salvo ou calcula um novo
    let unitsSold = localStorage.getItem('acaiDoDiaUnitsSold');
    if (!unitsSold) {
        unitsSold = Math.max(7, Math.min(75, Math.floor(7 + (elapsedMinutes / 15))));
        localStorage.setItem('acaiDoDiaUnitsSold', unitsSold);
    }
    
    const unitsElement = document.querySelector('.units-sold');
    if (unitsElement) {
        unitsElement.textContent = `${unitsSold} unidades vendidas hoje`;
    }
    
    // Incrementa a cada 3 minutos se ainda não atingiu o máximo
    setTimeout(() => {
        if (unitsSold < 75) {
            unitsSold = Math.min(75, parseInt(unitsSold) + 1);
            localStorage.setItem('acaiDoDiaUnitsSold', unitsSold);
        }
        simulateUnitsSold();
    }, 600000);
}

function addAcaiDoDiaToCart(product) {
    if (acaiDoDiaQuantityInCart >= 2) {
        showNotification('Limite de 2 unidades do Açaí do Dia por pedido');
        return;
    }
    
    // Ao invés de adicionar ao carrinho, abre o modal do produto
    openProductModal({
        ...product,
        price: product.price, // Mantém o preço promocional
        isAcaiDoDia: true // Flag para identificar que é o açaí do dia
    });
}
    const CHATBASE_CONFIG = {
    apiKey: '6564b636-1a71-4a0f-9863-7c87e586384a',
    chatbotId: 'PpgNSIgeYN1FCucFGP4w3'
};

let chatHistory = [];

function toggleChat() {
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
        chatContainer.style.display = 'flex';
        // Adicionar mensagem inicial se não houver mensagens
        const messages = document.querySelector('.chat-messages');
        if (!messages.children.length) {
            addMessageToChat('Olá! Como posso ajudar você hoje? Você pode digitar ou gravar um áudio!', 'bot');
        }
    } else {
        chatContainer.style.display = 'none';
    }
}

async function sendMessage() {
    const input = document.querySelector('.chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Adiciona mensagem do usuário
    addMessageToChat(message, 'user');
    input.value = '';

    try {
        const response = await fetch('https://www.chatbase.co/api/v1/chat', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${CHATBASE_CONFIG.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [
                    ...chatHistory,
                    { content: message, role: 'user' }
                ],
                chatbotId: CHATBASE_CONFIG.chatbotId,
                stream: false,
                temperature: 0
            })
        });

        const data = await response.json();
        
        if (data.text) {
            addMessageToChat(data.text, 'bot');
            chatHistory.push(
                { content: message, role: 'user' },
                { content: data.text, role: 'assistant' }
            );
        }

    } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        addMessageToChat('Desculpe, ocorreu um erro ao processar sua mensagem.', 'bot');
    }
}

function addMessageToChat(message, type) {
    const messagesContainer = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    if (type === 'bot') {
        messageDiv.innerHTML = `<span class="bot-prefix">🤖</span>${message}`;
    } else {
        messageDiv.textContent = message;
    }
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function startVoiceOrderChat() {
    toggleChat(); // Abre o chat se estiver fechado
    const messages = document.querySelector('.chat-messages');
    if (!messages.children.length) {
        addMessageToChat('Olá! Vou ajudar você a fazer seu pedido por voz. Você pode me dizer o que gostaria de pedir ou usar o botão de gravação abaixo.', 'bot');
    }
    
    // Se o chat já estiver aberto, adiciona uma nova mensagem
    addMessageToChat('O que você gostaria de pedir hoje?', 'bot');
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        const input = document.querySelector('.chat-input');
        const message = input.value.trim();
        if (message) {
            sendMessage(message);
            input.value = '';
        }
    }
}

// Certifique-se que a função createPhoneCollectionModal está presente
function createPhoneCollectionModal() {
    const existingModal = document.getElementById('phoneCollectionModal');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'phoneCollectionModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <h2>Para prosseguir com seu pedido</h2>
            <p>Digite seu WhatsApp com DDD para continuar:</p>
            <div class="form-group">
                <input type="tel" id="customerPhoneCart" 
                    placeholder="Ex: 84988888888" 
                    pattern="[0-9]{11}" 
                    required
                    style="width: 100%; padding: 10px; margin: 10px 0;">
                <div id="phoneError" style="color: var(--error); display: none;">
                    Digite um número válido com DDD (11 dígitos)
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="validateAndStorePhone()">Continuar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Variável global para armazenar temporariamente o produto a ser adicionado
let pendingCartAddition = null;

async function validateAndStorePhone() {
    const phoneInput = document.getElementById('customerPhoneCart');
    const phoneError = document.getElementById('phoneError');
    const phone = phoneInput.value.replace(/\D/g, '');

    if (phone.length !== 11) {
        phoneError.style.display = 'block';
        return;
    }

    try {
        console.log('Iniciando processo de validação do telefone...');
        const timestamp = new Date().toISOString();
        
        // Registrar na planilha
        const data = {
            phone: phone,
            timestamp: timestamp,
            cartItems: JSON.stringify(cart),
            status: 'active'
        };

        // Registrar no Google Sheets
        await recordAbandonedCart(data);
        
        // Salvar localmente
        localStorage.setItem('cartPhone', phone);
        localStorage.setItem('cartTimestamp', timestamp);

        // Fechar modal do telefone
        document.getElementById('phoneCollectionModal').style.display = 'none';

        // Adicionar o produto pendente ao carrinho
        if (window.pendingCartAddition) {
            addToCart(
                window.pendingCartAddition.product,
                window.pendingCartAddition.selectedToppings
            );
            window.pendingCartAddition = null;
        }

        console.log('Iniciando monitoramento do carrinho...');
        startCartMonitoring(); // Iniciar monitoramento imediatamente

    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao processar seu número. Tente novamente.');
    }
}

// Função para registrar carrinho abandonado na planilha
async function recordAbandonedCart(data) {
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbwS5DcA_NuUsFaHlcnGV-78kfmNKog-1KtXv_Scn6q-6o85c3SSUMPsSk8LXIggKoUW0w/exec';
    
    const response = await fetch(scriptUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });

    return response;
}

// Função para enviar SMS usando Twilio
async function sendSMSReminder(type) {
    const phone = localStorage.getItem('cartPhone');
    if (!phone) {
        console.error('Número de telefone não encontrado');
        return;
    }

    const message = type === '10min' 
        ? '📢🔥 Tá na hora de se deliciar com um açaí incrível! 🍓✨ Faça seu pedido agora e receba rapidinho! 👉 http://cabanaacai.netlify.app/'
        : '⏳🍨 Ainda tá com vontade de um açaí top? A gente tá pronto pra te atender! 😋 Não deixa pra depois! 👉 https://cabanaacai.netlify.app/';

    const twilioAccount = 'AC04c1d67a4b599d4cb0d804029109fad3';
    const twilioToken = '4061a06f7cbacc1262afa1f2356e69b3';
    const twilioNumber = '+12362016670';

    try {
        const response = await fetch(`https://api.twilio.com/2010-04-01/Accounts/${twilioAccount}/Messages.json`, {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa(`${twilioAccount}:${twilioToken}`),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'To': `+55${phone}`,
                'From': twilioNumber,
                'Body': message
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erro Twilio: ${errorData.message || 'Erro desconhecido'}`);
        }

        const result = await response.json();
        console.log('SMS enviado com sucesso:', result);

        // Atualizar status na planilha
        await updateSMSStatus(phone, type);

    } catch (error) {
        console.error('Erro detalhado ao enviar SMS:', error);
        
        // Tentar novamente em 1 minuto se for um erro temporário
        if (error.message.includes('429') || error.message.includes('503')) {
            setTimeout(() => sendSMSReminder(type), 60000);
        }
    }
}

// Função para monitorar carrinho abandonado
function startCartMonitoring() {
    const timestamp = localStorage.getItem('cartTimestamp');
    if (!timestamp) {
        console.log('Timestamp não encontrado');
        return;
    }

    // Tempos para teste
    const tenMinutes = 30 * 1000;  // 30 segundos
    const oneHour = 60 * 1000;     // 1 minuto

    const now = new Date().getTime();
    const cartTime = new Date(timestamp).getTime();

    console.log('Iniciando monitoramento...');
    console.log('Hora atual:', new Date(now).toLocaleString());
    console.log('Hora do carrinho:', new Date(cartTime).toLocaleString());

    // Primeira mensagem (30 segundos)
    setTimeout(() => {
        console.log('Verificando status para mensagem de 30 segundos...');
        if (!localStorage.getItem('orderCompleted')) {
            console.log('Enviando primeira mensagem');
            sendSMSReminder('10min');
        } else {
            console.log('Pedido já completado');
        }
    }, 30000); // Forçando 30 segundos

    // Segunda mensagem (1 minuto)
    setTimeout(() => {
        console.log('Verificando status para mensagem de 1 minuto...');
        if (!localStorage.getItem('orderCompleted')) {
            console.log('Enviando segunda mensagem');
            sendSMSReminder('1hour');
        } else {
            console.log('Pedido já completado');
        }
    }, 60000); // Forçando 1 minuto
}

// Função para atualizar status do SMS na planilha
async function updateSMSStatus(phone, type) {
    const data = {
        phone: phone,
        smsType: type,
        status: 'sent'
    };

    await recordAbandonedCart(data);
}

// 1. Primeiro a função do CRC16
function calculateCRC16(str) {
    function crc16(data) {
        let crc = 0xFFFF;
        const polynomial = 0x1021;

        for (let i = 0; i < data.length; i++) {
            crc ^= (data[i] << 8);
            for (let j = 0; j < 8; j++) {
                if (crc & 0x8000) {
                    crc = ((crc << 1) ^ polynomial) & 0xFFFF;
                } else {
                    crc = (crc << 1) & 0xFFFF;
                }
            }
        }
        return crc;
    }

    const data = Array.from(str).map(c => c.charCodeAt(0));
    return crc16(data).toString(16).toUpperCase().padStart(4, '0');
}

function openPaymentApp(amount, event) {
    // Prevenir comportamento padrão
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // URLs dos principais bancos
    const bankUrls = {
        nubank: `https://nubank.com.br/pagar/pix/${amount}`,
        itau: 'https://www.itau.com.br/pix',
        santander: 'https://www.santander.com.br/pix',
        bradesco: 'https://banco.bradesco/pix',
        bb: 'https://www.bb.com.br/pix',
        caixa: 'https://www.caixa.gov.br/pix',
        inter: 'https://www.bancointer.com.br/pix',
    };

    // Criar modal de seleção de banco
    const bankModal = document.createElement('div');
    bankModal.id = 'bankSelectionModal';
    bankModal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--surface);
        padding: 20px;
        border-radius: 15px;
        z-index: 10000;
        width: 90%;
        max-width: 400px;
        border: 1px solid var(--glass-border);
    `;

    bankModal.innerHTML = `
        <h3 style="color: white; margin-bottom: 15px; text-align: center;">Escolha seu banco</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
            ${Object.entries(bankUrls).map(([bank, url]) => `
                <button onclick="openBankUrl('${url}', event)" 
                    style="background: var(--glass); border: 1px solid var(--glass-border); color: white; 
                    padding: 10px; border-radius: 8px; cursor: pointer; text-transform: capitalize;">
                    ${bank}
                </button>
            `).join('')}
        </div>
        <button onclick="closeBankModal(event)" 
            style="width: 100%; margin-top: 15px; background: var(--accent); color: white; 
            border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
            Fechar
        </button>
    `;

    document.body.appendChild(bankModal);

    // Atualizar status
    const statusDiv = document.getElementById('paymentStatus');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div style="color: #FFA500;">
                <i class="fas fa-info-circle"></i> Após realizar o pagamento, aguarde a confirmação automática.
            </div>
        `;
    }

    // Iniciar verificação de pagamento
    initializePixPayment(amount);
}

// Função para abrir URL do banco em nova aba
function openBankUrl(url, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    window.open(url, '_blank');
}

// Função para fechar modal de seleção de banco
function closeBankModal(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const bankModal = document.getElementById('bankSelectionModal');
    if (bankModal) {
        bankModal.remove();
    }
}

function initializePixPayment(amount, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // Adicione estas duas linhas no início para gerar um novo ID de sessão
    window.currentSessionId = generateSessionId();
    console.log("Nova sessão de pagamento iniciada: " + window.currentSessionId);

    const statusDiv = document.getElementById('paymentStatus');
    
    statusDiv.innerHTML = `
        <div style="background: var(--glass); padding: 10px; border-radius: 8px; margin: 10px 0;">
            <i class="fas fa-qrcode"></i> 
            QR Code PIX gerado! Escaneie e faça o pagamento.
            <br><small>Após o pagamento, aguarde a confirmação automática.</small>
        </div>
    `;

    // Iniciar verificação
    startPaymentCheck(amount);
}

// Função que recebe resposta do PIX
function handlePixResponse(response) {
    const statusDiv = document.getElementById('paymentStatus');
    
    if (response.error) {
        statusDiv.innerHTML = `
            <div style="background: var(--error); padding: 10px; border-radius: 8px; margin: 10px 0; color: white;">
                <i class="fas fa-exclamation-circle"></i> 
                Erro ao gerar QR Code. Tente novamente.
            </div>
        `;
        return;
    }

    statusDiv.innerHTML = `
        <div style="background: var(--glass); padding: 10px; border-radius: 8px; margin: 10px 0;">
            <i class="fas fa-qrcode"></i> 
            QR Code PIX gerado! Escaneie e faça o pagamento.
            <br><small>Após o pagamento, aguarde a confirmação automática.</small>
        </div>
    `;
}

function startPaymentCheck(amount) {
    const statusDiv = document.getElementById('paymentStatus');
    const statusDetailDiv = document.getElementById('paymentStatusDetail');
    let checkCount = 0;
    const maxChecks = 120; // 6 minutos (3s * 120)
    
    // Obter ou criar ID de sessão
    if (!window.currentSessionId) {
        window.currentSessionId = generateSessionId();
        console.log("Novo ID de sessão criado: " + window.currentSessionId);
    }
    const sessionId = window.currentSessionId;
    
    // Substituir pela URL correta do seu script
    const webhookUrl = 'https://script.google.com/macros/s/AKfycbxudaDaCy9jnqswuw9JR7OAdScJQTFSO5Vs_msLH0Sbqd5OQrGtzQ9Ypkcz0QUVuBKOIA/exec';
    
    // Mostrar status inicial
    statusDiv.innerHTML = `
        <div style="background: var(--glass); padding: 10px; border-radius: 8px; margin: 10px 0;">
            <i class="fas fa-spinner fa-spin"></i> 
            Aguardando confirmação do PIX...
            <br><small>Não feche esta janela até a confirmação.</small>
        </div>
    `;
    
    // Exibir o contêiner de detalhes caso esteja escondido
    if (statusDetailDiv) {
        statusDetailDiv.style.display = 'block';
        statusDetailDiv.innerHTML = `
            <div style="text-align: center;">
                <p>Iniciando verificação de pagamento...</p>
                <small>ID de Sessão: ${sessionId.substring(0, 8)}...</small>
            </div>
        `;
    }
    
    // Função para verificar o pagamento
    const checkPayment = () => {
        console.log(`Verificação ${checkCount+1} para valor ${amount}, sessão ${sessionId}`);
        
        // Adicionar timestamp e ID de sessão para evitar cache
        const url = `${webhookUrl}?action=check_payment&amount=${amount}&session=${sessionId}&cache=${Date.now()}`;
        
        fetch(url)
            .then(response => response.text())
            .then(text => {
                try {
                    // Tentar analisar como JSON
                    let data;
                    try {
                        data = JSON.parse(text);
                        console.log("Resposta recebida:", data);
                        
                        // Se for aprovado
                        if (data.status === 'approved') {
                            // Mostrar quando o pagamento foi aprovado
                            const timeAgo = data.timeAgo ? `(há ${data.timeAgo} segundos)` : '';
                            
                            if (statusDetailDiv) {
                                statusDetailDiv.innerHTML = `
                                    <div style="color: #4CAF50; text-align: center;">
                                        <i class="fas fa-check-circle" style="font-size: 2rem;"></i>
                                        <h3 style="margin: 10px 0;">Pagamento Confirmado! ${timeAgo}</h3>
                                        <p>Recebemos seu pagamento com sucesso.</p>
                                        <p>Seu pedido está sendo processado.</p>
                                        <small>ID de Sessão: ${sessionId.substring(0, 8)}...</small>
                                    </div>
                                `;
                            }
                            
                            // Também atualizar o status principal
                            statusDiv.innerHTML = `
                                <div style="background: #4CAF50; color: white; padding: 10px; border-radius: 8px; margin: 10px 0;">
                                    <i class="fas fa-check-circle"></i> 
                                    Pagamento PIX recebido! Você pode continuar com seu pedido.
                                </div>
                            `;
                            
                            // Habilitar botão de finalizar
                            const submitButton = document.querySelector('#createOrderForm button[type="button"]');
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = 'Finalizar Pedido';
                                submitButton.style.backgroundColor = '';
                                submitButton.style.opacity = '1';
                            }
                            
                            // Parar de verificar
                            clearInterval(checkInterval);
                            return;
                        } else {
                            // Status pendente
                            if (statusDetailDiv) {
                                statusDetailDiv.innerHTML = `
                                    <div style="text-align: center;">
                                        <i class="fas fa-clock" style="font-size: 1.5rem;"></i>
                                        <p style="margin: 10px 0;">Ainda estamos aguardando a confirmação do seu pagamento.</p>
                                        <small>Status: ${data.status || 'pendente'}</small>
                                        <br><small>ID de Sessão: ${sessionId.substring(0, 8)}...</small>
                                    </div>
                                `;
                            }
                        }
                    } catch (e) {
                        // Se não for JSON, mostra o texto como está
                        console.error("Erro ao analisar JSON:", e, "Texto recebido:", text);
                        if (statusDetailDiv) {
                            statusDetailDiv.innerHTML = `
                                <div style="color: var(--error); text-align: center;">
                                    <p>Aguardando confirmação do servidor...</p>
                                    <small>Resposta do servidor não é um formato válido</small>
                                    <br><small>ID de Sessão: ${sessionId.substring(0, 8)}...</small>
                                </div>
                            `;
                        }
                    }
                    
                    // Continuar verificando
                    checkCount++;
                    
                    if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        statusDiv.innerHTML = `
                            <div style="background: var(--glass); padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <i class="fas fa-info-circle"></i> 
                                Tempo limite excedido. Se você já pagou, clique no botão abaixo para continuar.
                                <button onclick="continueAfterPix()" style="margin-top: 10px; width: 100%; padding: 8px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Já realizei o pagamento
                                </button>
                            </div>
                        `;
                    } else {
                        // Apenas atualizar tempo decorrido
                        statusDiv.innerHTML = `
                            <div style="background: var(--glass); padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <i class="fas fa-spinner fa-spin"></i> 
                                Aguardando confirmação do PIX... (${Math.floor(checkCount/20)}min ${(checkCount % 20) * 3}s)
                                <br><small>Não feche esta janela até a confirmação.</small>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error("Erro ao processar resposta:", error);
                    if (statusDetailDiv) {
                        statusDetailDiv.innerHTML = `
                            <div style="color: var(--error); text-align: center;">
                                <p>Erro ao verificar pagamento: ${error.message}</p>
                                <small>ID de Sessão: ${sessionId.substring(0, 8)}...</small>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error("Erro na verificação:", error);
                checkCount++;
                
                if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    statusDiv.innerHTML = `
                        <div style="background: var(--glass); padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <i class="fas fa-exclamation-circle"></i> 
                            Erro ao verificar pagamento. Se você já pagou, clique no botão abaixo para continuar.
                            <button onclick="continueAfterPix()" style="margin-top: 10px; width: 100%; padding: 8px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Já realizei o pagamento
                            </button>
                        </div>
                    `;
                }
            });
    };
    
    // Verificar imediatamente
    checkPayment();
    
    // E então a cada 3 segundos
    const checkInterval = setInterval(checkPayment, 3000);
}

// Função para permitir continuar sem confirmação
function continueAfterPix() {
    const submitButton = document.querySelector('#createOrderForm button[type="button"]');
    if (submitButton) {
        submitButton.disabled = false;
        submitButton.innerHTML = 'Finalizar Pedido';
        submitButton.style.backgroundColor = '';
        submitButton.style.opacity = '1';
    }
    
    const statusDiv = document.getElementById('paymentStatus');
    statusDiv.innerHTML = `
        <div style="background: #FFA500; color: white; padding: 10px; border-radius: 8px; margin: 10px 0;">
            <i class="fas fa-info-circle"></i> 
            Continuando sem confirmação automática. Se você já realizou o pagamento, prossiga normalmente.
        </div>
    `;
}

// Adicione esta função para gerar IDs únicos
function generateSessionId() {
    return Date.now().toString() + Math.random().toString(36).substring(2, 9);
}

// Modifique a função generatePixQRCode para criar um ID de sessão
function generatePixQRCode(total) {
    // Gerar ID de sessão único
    const sessionId = generateSessionId();
    // Armazenar o ID na janela para uso posterior
    window.currentSessionId = sessionId;
    
    console.log("Nova sessão de pagamento criada: " + sessionId);
    
    // Dados do PIX atualizados
    const pixKey = "06561938402";
    const merchantName = "JACKSON";
    const city = "NATAL";
    
    // Formatar valor
    const amount = parseFloat(total.toString().replace(/[^\d.,]/g, '').replace(',', '.')).toFixed(2);
    
    // Container principal
    const qrContainer = document.createElement('div');
    qrContainer.id = 'pixQRCode';
    qrContainer.style.cssText = `
        text-align: center;
        padding: 15px;
        background: var(--glass);
        border-radius: 15px;
        border: 1px solid var(--glass-border);
        max-width: 100%;
        margin: 0 auto;
    `;

    qrContainer.innerHTML = `
        <h3 style="margin-bottom: 10px; color: white;">Pagamento via PIX</h3>
        <div id="paymentStatus" style="margin-bottom: 15px; color: var(--text);"></div>

         <!-- Adicionar este novo elemento para o status detalhado -->
        <div id="paymentStatusDetail" style="margin-bottom: 15px; background: var(--glass); padding: 10px; border-radius: 8px; display: none;"></div>
        
        <!-- Container do QR Code -->
        <div style="background: white; padding: 10px; border-radius: 10px; display: inline-block; margin: 10px auto;">
            <div id="qrCodeElement"></div>
        </div>

        <div style="margin: 15px 0; padding: 10px; background: var(--surface); border-radius: 10px;">
            <div style="margin-bottom: 10px;">
                <strong>Dados da Chave PIX</strong><br>
                <span style="color: var(--text);">
                    Chave PIX: ${pixKey}<br>
                    Banco: Mercado Pago<br>
                    Nome: Jackson<br>
                    Valor: R$ ${amount}
                </span>
            </div>
            
            <div style="margin-top: 15px;">
                <strong>Chave PIX</strong>
                <div style="position: relative; margin-top: 5px;">
                    <input type="text" value="${pixKey}" 
                        readonly 
                        style="width: 100%; padding: 8px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text); font-size: 12px;">
                    <button onclick="copyPixKey(this, event)" 
                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: var(--accent); color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">
                        Copiar
                    </button>
                </div>
            </div>
        </div>
    `;

    // Gerar QR Code após inserir no DOM
    setTimeout(() => {
        new QRCode(qrContainer.querySelector('#qrCodeElement'), {
            text: `00020126580014BR.GOV.BCB.PIX0136${pixKey}5204000053039865802BR5913${merchantName}6006${city}62070503***6304${calculateCRC16(generatePixString(pixKey, merchantName, city, amount))}`,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        // Iniciar verificação de pagamento automaticamente
        startPaymentCheck(amount);
    }, 100);

    return qrContainer;
}

// Função que recebe resposta do check
function handlePaymentCheck(response) {
    const statusDiv = document.getElementById('paymentStatus');
    
    if (response.status === 'approved') {
        clearInterval(window.currentCheckInterval);
        
        statusDiv.innerHTML = `
            <div style="background: #4CAF50; color: white; padding: 10px; border-radius: 8px; margin: 10px 0;">
                <i class="fas fa-check-circle"></i> 
                Pagamento PIX recebido! Você pode continuar com seu pedido.
            </div>
        `;

        // Habilitar botão de finalizar
        const submitButton = document.querySelector('#createOrderForm button[type="button"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Finalizar Pedido';
            submitButton.style.opacity = '1';
        }
    }
}
    
function generatePixString(pixKey, merchantName, city, amount) {
    // Função para formatar tamanho do campo (ID + tamanho + valor)
    function formatField(id, value) {
        const len = value.length.toString().padStart(2, '0');
        return `${id}${len}${value}`;
    }

    // Campos obrigatórios do PIX
    const fields = [
        formatField('00', '01'),                     // Versão do payload
        formatField('01', '12'),                     // Tipo de chave PIX
        formatField('26', formatField('00', 'br.gov.bcb.pix') + 
                         formatField('01', pixKey)),  // Chave PIX
        formatField('52', '0000'),                   // Categoria comerciante
        formatField('53', '986'),                    // Moeda (BRL = 986)
        formatField('54', amount.toString()),        // Valor da transação
        formatField('58', 'BR'),                     // País
        formatField('59', merchantName),             // Nome do comerciante
        formatField('60', city),                     // Cidade do comerciante
        formatField('62', formatField('05', '***'))  // ID da transação
    ];

    return fields.join('');
}

function updatePaymentStatus(status) {
    const statusDiv = document.getElementById('paymentStatus');
    
    switch(status) {
        case 'success':
            statusDiv.innerHTML = `
                <div style="color: #4CAF50;">
                    <i class="fas fa-check-circle"></i> 
                    Pagamento confirmado com sucesso!
                </div>
            `;
            // Habilitar botão de continuar
            const submitButton = document.querySelector('#createOrderForm button[type="button"]');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
            }
            break;
            
        case 'timeout':
            statusDiv.innerHTML = `
                <div style="color: var(--error);">
                    <i class="fas fa-exclamation-circle"></i> 
                    Tempo de espera esgotado. Se você já pagou, continue com o pedido normalmente.
                </div>
            `;
            break;
            
        case 'error':
            statusDiv.innerHTML = `
                <div style="color: var(--error);">
                    <i class="fas fa-exclamation-circle"></i> 
                    Erro ao verificar pagamento. Se você já pagou, continue com o pedido normalmente.
                </div>
            `;
            break;
    }
}

// Função atualizada para copiar a chave PIX
function copyPixKey(button, event) {
    event.preventDefault(); // Previne o comportamento padrão
    event.stopPropagation(); // Impede a propagação do evento
    
    const input = button.parentElement.querySelector('input');
    input.select();
    document.execCommand('copy');
    
    // Feedback visual
    const originalText = button.textContent;
    button.textContent = 'Copiado!';
    button.style.background = '#4CAF50';
    
    setTimeout(() => {
        button.textContent = originalText;
        button.style.background = 'var(--accent)';
    }, 2000);
}

function showComprovanteUpload(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    const pixInfo = document.getElementById('pixQRCode');
    if (!pixInfo) return;

    pixInfo.innerHTML = `
        <div style="padding: 15px; background: var(--surface); border-radius: 10px;">
            <h4 style="margin-bottom: 15px; color: white;">Enviar Comprovante</h4>
            <input type="file" 
                id="comprovante" 
                accept="image/*,.pdf" 
                style="width: 100%; margin-bottom: 15px; padding: 10px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text);"
                onchange="handleComprovanteUpload(this)">
            <div id="uploadStatus" style="margin-top: 10px;"></div>
        </div>
    `;
}

// Nova função para lidar com a notificação
function handleNotificacao(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    notificarLojaPagamento();
}

async function handleComprovanteUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const uploadStatus = document.getElementById('uploadStatus');
    uploadStatus.innerHTML = `
        <div style="color: var(--text); padding: 10px; background: var(--glass); border-radius: 8px;">
            <i class="fas fa-spinner fa-spin"></i> 
            Processando comprovante...
        </div>
    `;

    try {
        // Converter para Base64
        const base64 = await convertFileToBase64(file);
        
        // Armazenar temporariamente
        localStorage.setItem('comprovanteTemp', base64);
        localStorage.setItem('comprovanteNome', file.name);
        
        // Mostrar sucesso e botão de notificação
        uploadStatus.innerHTML = `
            <div style="color: #4CAF50; padding: 10px; background: var(--glass); border-radius: 8px;">
                <i class="fas fa-check-circle"></i> 
                Comprovante carregado com sucesso!
            </div>
            <button onclick="notificarLojaPagamento()" class="modal-btn add-to-cart" style="margin-top: 15px;">
                <i class="fas fa-bell"></i> 
                Notificar Loja Sobre Pagamento
            </button>
        `;
    } catch (error) {
        uploadStatus.innerHTML = `
            <div style="color: var(--error); padding: 10px; background: var(--glass); border-radius: 8px;">
                <i class="fas fa-exclamation-circle"></i> 
                Erro ao carregar comprovante. Tente novamente.
            </div>
        `;
    }
}

async function notificarLojaPagamento() {
    const uploadStatus = document.getElementById('uploadStatus');
    const customerName = document.getElementById('customerName')?.value || 'Cliente';
    const orderTotal = document.getElementById('orderTotal')?.value || '0.00';

    uploadStatus.innerHTML = `
        <div style="color: var(--text); padding: 10px; background: var(--glass); border-radius: 8px;">
            <i class="fas fa-spinner fa-spin"></i> 
            Notificando a loja...
        </div>
    `;

    const message = `Novo Pagamento PIX Recebido!
Cliente: ${customerName}
Valor: R$ ${orderTotal}
Data: ${new Date().toLocaleString()}`;

    try {
        // Usar XMLHttpRequest em vez de form
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://script.google.com/macros/s/AKfycbxl8-3Ni3u1RaL0w9L8wpcWKmHrIsGw2_UEScH1uIYLUSQ2EEFps4AVvgVGeP9ci3aQ/exec', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                uploadStatus.innerHTML = `
                    <div style="color: #4CAF50; padding: 10px; background: var(--glass); border-radius: 8px;">
                        <i class="fas fa-check-circle"></i> 
                        Loja notificada sobre seu pagamento!
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            Você pode continuar com seu pedido normalmente.
                        </p>
                    </div>
                `;
            } else {
                throw new Error('Falha ao enviar notificação');
            }
        };
        
        xhr.onerror = function() {
            throw new Error('Erro de rede ao enviar notificação');
        };
        
        xhr.send('message=' + encodeURIComponent(message));

    } catch (error) {
        console.error('Erro ao notificar:', error);
        uploadStatus.innerHTML = `
            <div style="color: var(--error); padding: 10px; background: var(--glass); border-radius: 8px;">
                <i class="fas fa-exclamation-circle"></i> 
                Erro ao notificar a loja. Por favor, continue com seu pedido normalmente.
            </div>
        `;
    }
}

function changePaymentMethod() {
    // Limpar QR Code e voltar para seleção de pagamento
    const qrContainer = document.getElementById('pixQRCode');
    if (qrContainer) {
        qrContainer.remove();
    }
    
    // Resetar seleção de pagamento
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Mostrar opções de pagamento novamente
    document.querySelector('.payment-group').style.display = 'flex';
}

async function sendOrderWithComprovante() {
    const comprovanteFile = document.getElementById('comprovante').files[0];
    if (!comprovanteFile) {
        showNotification('Por favor, anexe o comprovante');
        return;
    }
    
    try {
        // Converter arquivo para base64
        const base64File = await convertFileToBase64(comprovanteFile);
        
        // Modificar a mensagem do WhatsApp para incluir informação do pagamento
        const originalMessage = formatOrderForWhatsApp();
        const paymentInfo = "\n\n💳 *Pagamento via PIX*\nStatus: ✅ Pago\nComprovante: Anexado";
        const fullMessage = originalMessage + paymentInfo;
        
        // Abrir WhatsApp com a mensagem modificada
        window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(fullMessage)}`;
        
    } catch (error) {
        console.error('Erro ao processar comprovante:', error);
        showNotification('Erro ao processar comprovante. Tente novamente.');
    }
}

function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

</script>
<<!-- Modal para Criar Novo Pedido -->
<!-- Modal para Criar Novo Pedido -->
<div id="createOrderModal" class="modal">
    <div class="modal-content">
        <button class="close" onclick="closeCreateOrderModal()">&times;</button>
        <h2>Finalizar Pedido</h2>
        <form id="createOrderForm">
            <!-- Campos ocultos -->
            <input type="hidden" id="orderId">
            <input type="hidden" id="status" value="open">
            <input type="hidden" id="orderTotal">
            
            <!-- Dados do Cliente -->
            <label for="customerName">Nome Completo*</label>
            <input type="text" id="customerName" required placeholder="Digite seu nome completo">
            
            <label for="customerPhone">WhatsApp*</label>
            <input type="text" id="customerPhone" required placeholder="(84) 98888-8888">
            
            <!-- Endereço -->
            <label for="street">Logradouro*</label>
            <input type="text" id="street" required placeholder="Nome da rua">
            
            <label for="streetNumber">Número*</label>
            <input type="text" id="streetNumber" required placeholder="Número da casa/apto">
            
            <label for="neighborhood">Bairro*</label>
            <input type="text" id="neighborhood" required placeholder="Seu bairro">
            
            <label for="complement">Complemento</label>
            <input type="text" id="complement" placeholder="Apto, bloco, referência...">
            
            <label for="zipCode">CEP*</label>
            <input type="text" id="zipCode" required placeholder="59000-000">
            
            <!-- Detalhes do Pedido -->
            <label for="orderDetails">Itens do Pedido</label>
            <textarea id="orderDetails" readonly></textarea>
            
            <!-- Método de Pagamento -->
            <label>Forma de Pagamento*</label>
            <div class="payment-group">
                <div class="payment-option">
                    <input type="radio" id="paymentMoney" name="paymentMethod" value="money" required>
                    <label for="paymentMoney">Dinheiro</label>
                </div>
                <div class="payment-option">
                    <input type="radio" id="paymentCard" name="paymentMethod" value="card">
                    <label for="paymentCard">Cartão</label>
                </div>
                <div class="payment-option">
                    <input type="radio" id="paymentOnline" name="paymentMethod" value="online">
                    <label for="paymentOnline">PIX</label>
                </div>
            </div>
            <div id="changeContainer" style="display: none; margin-top: 10px;">
    <label>Troco para quanto?</label>
    <input type="number" id="changeAmount" step="0.01">
</div>
<div id="pixInfo" style="display: none; margin-top: 15px;">
    <!-- O QR Code será inserido aqui via JavaScript -->
</div>
            
            <label for="notes">Observações</label>
            <textarea id="notes" placeholder="Alguma observação sobre seu pedido?"></textarea>
            
            <button type="button" onclick="submitOrder()">Finalizar Pedido</button>
        </form>
    </div>
</div>
<div class="modal" id="timeMachineModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Seus Pedidos</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="time-machine-content">
            <div class="phone-input-section">
                <p>Digite seu WhatsApp com DDD para ver seu histórico:</p>
                <div class="phone-input-container">
                    <input type="tel" id="historyPhoneInput" placeholder="Ex: 84988500756" class="form-input">
                    <button onclick="searchOrderHistory()" class="modal-btn">Buscar</button>
                </div>
            </div>
            <div class="favorites-section"></div>
            <div class="previous-orders-section"></div>
        </div>
    </div>
</div>
</div>
    <!-- Popup de loja fechada -->
<div id="storeClosedPopup" class="store-closed-popup">
    <div class="popup-content">
        <h2>Loja Fechada</h2>
        <p>No momento, a loja está fechada. Confira nossos horários de funcionamento:</p>
        <ul>
            <li><strong>Quarta à Sexta:</strong> 12:30h às 22:30h</li>
            <li><strong>Sábado e Domingo:</strong> 12:30h às 17:30h</li>
        </ul>
        <button onclick="closeStoreClosedPopup()">Fechar</button>
    </div>
</div>
<div class="chat-button" onclick="toggleChat()">
    <i class="fas fa-comments"></i>
</div>

<div class="chat-container">
    <!-- O conteúdo será inserido via JavaScript -->
</div>
    <div class="chat-messages"></div>
    <div class="chat-input-container">
        <input type="text" class="chat-input" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
        <button class="send-button" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
</body>
</html>
