<script>
  // Adicione esta função
  function addNewOrder(order) {
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    orders.push(order);
    localStorage.setItem('orders', JSON.stringify(orders));

    // Trigger the storage event manually to notify the gestor page
    const event = new Event('storage');
    event.key = 'orders';
    event.newValue = JSON.stringify(orders);
    window.dispatchEvent(event);
  }

  document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const address = document.getElementById('address').value;
    const phone = document.getElementById('phone').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const changeNeeded = document.getElementById('changeNeeded') ? document.getElementById('changeNeeded').value : 'Não';
    const changeAmount = document.getElementById('changeAmount') ? document.getElementById('changeAmount').value : '';

    // Construir mensagem de WhatsApp
    let message = `Pedido confirmado!\nNome: ${name}\nEndereço: ${address}\nTelefone: ${phone}\nMétodo de Pagamento: ${paymentMethod}`;
    if (paymentMethod === 'cash') {
      message += `\nPrecisa de troco: ${changeNeeded}`;
      if (changeNeeded === 'yes') {
        message += `\nQuanto de troco: R$ ${parseFloat(changeAmount).toFixed(2)}`;
      }
    }

    // Adicionar itens do pedido à mensagem
    message += `\n\nItens do Pedido:\n`;
    cart.forEach(item => {
      message += `\n${item.name} - R$ ${item.totalPrice.toFixed(2)}`;
      if (item.accompaniments.length > 0) {
        message += `\nAcompanhamentos: ${item.accompaniments.join(', ')}`;
      }
      if (item.extras.length > 0) {
        message += `\nExtras: ${item.extras.join(', ')}`;
      }
    });
    message += `\n\nSubtotal: R$ ${cart.reduce((sum, item) => sum + item.totalPrice, 0).toFixed(2)}`;
    message += `\nTaxa de Entrega: R$ ${deliveryFee.toFixed(2)}`;
    message += `\nTotal: R$ ${(cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee).toFixed(2)}`;

    // Enviar pedido para o gestor de pedidos
    const order = {
      id: Date.now(),
      name: name,
      address: address,
      phone: phone,
      paymentMethod: paymentMethod,
      changeNeeded: changeNeeded,
      changeAmount: changeAmount,
      items: cart,
      subtotal: cart.reduce((sum, item) => sum + item.totalPrice, 0),
      deliveryFee: deliveryFee,
      total: cart.reduce((sum, item) => sum + item.totalPrice, 0) + deliveryFee,
      status: 'preparing'
    };
    addNewOrder(order);

    // Redirecionar para o WhatsApp
    window.location.href = `https://wa.me/5584988731028?text=${encodeURIComponent(message)}`;

    // Limpar o carrinho e redefinir a forma de pagamento após a confirmação do pedido
    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));

    // Redefinir a forma de pagamento para 'Cartão'
    document.getElementById('paymentMethod').value = 'card';
    handlePaymentChange();

    // Fechar o modal de checkout
    document.getElementById('checkoutModal').style.display = "none";
  });

</script>
